<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-09-30 ÖÜËÄ 13:08 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Racket Guide ç¬”è®°</title>
<meta name="generator" content="Org mode">
<meta name="author" content="saltb0rn">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"> -->
<meta name="referrer" content="same-origin">
<link rel="stylesheet" type="text/css" href="../../../css/stylesheet.css"/>
<link rel="icon" type="image/png" href="../../../img/icon.png" />
<!-- <script type="text/javascript" src="../../../js/live.js" defer></script> -->
<script src="../../../js/main.js" defer></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
    <nav>
        <a href="../../../"><img src="../../../img/logo.png" alt="Logo is on the way"/></a>
        <ul>
            <li><a accesskey="H" href="../../../"> Home </a></li>
            <li><a accesskey="T" href="../../../tags"> Tags </a></li>
            <li><a accesskey="A" href="../../../about"> About </a></li>
            <li><a accesskey="L" href="../../../todos"> Todos </a></li>
        </ul>
    </nav>
</div>
<div id="content">
<h1 class="title">Racket Guide ç¬”è®°</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org9692153">Th Racket Guide</a>
<ul>
<li><a href="#org14d7163">3 Built-in Datatypes</a>
<ul>
<li><a href="#orgc9d97a8">Booleans</a></li>
<li><a href="#org2918333">Numbers</a></li>
<li><a href="#orged00d6a">Characters</a></li>
<li><a href="#org249fb78">Strings(Unicode)</a></li>
<li><a href="#org6c15070">Bytes and Byte String</a></li>
<li><a href="#orgd294ae7">Symbols</a></li>
<li><a href="#org6d10f94">Keywords</a></li>
<li><a href="#orgd458846">Pairs and Lists</a></li>
<li><a href="#org5ae48bb">Vectors</a></li>
<li><a href="#orge281e5e">Hash Tables</a></li>
<li><a href="#orgba0a824">Boxes</a></li>
<li><a href="#org1412b41">Void and Undefined</a></li>
</ul>
</li>
<li><a href="#orga563c6d">4 Expressions and Definitions</a>
<ul>
<li><a href="#org9604dcb">Functions</a></li>
<li><a href="#orgdb96982">Local Binding</a></li>
<li><a href="#orgcc66972">Conditionals</a></li>
<li><a href="#org7f825eb">Sequencing</a></li>
<li><a href="#org91b36e9">Assignment: set!</a></li>
<li><a href="#org114eb44">Quoting and Quasiquoting</a></li>
<li><a href="#org4049068">Simple Dispatch: case</a></li>
<li><a href="#org0dd1036">Dynamic Binding: parameterize</a></li>
</ul>
</li>
<li><a href="#orgcaf6350">5 Programmer-Defined Datatypes</a></li>
<li><a href="#org83ec79a">6 Modules</a>
<ul>
<li><a href="#org3ad2ec2">Module Basis</a></li>
<li><a href="#orgdc9f2c2">Module Syntax</a></li>
<li><a href="#org711e108">Module Paths</a></li>
<li><a href="#org1b8ed4e">Imports: require</a></li>
<li><a href="#org8c8aad9">Exports: provide</a></li>
<li><a href="#org759927a">Assignment and Redefinition</a></li>
<li><a href="#org83f02b3">Modules and Macros</a></li>
</ul>
</li>
<li><a href="#org5639039">7 Contracts</a>
<ul>
<li><a href="#org6be70b3">Contracts and Boundaries</a></li>
<li><a href="#orgd28295a">Simple Contracts on Functions</a></li>
<li><a href="#orgc99d161">Contracts on Functions in General</a></li>
<li><a href="#orge0b9810">Contracts: A Thorough Example</a></li>
<li><a href="#org819c3a8">Contracts on Structures</a></li>
<li><a href="#orga856cc7">Abstract Contracts using #:exists and #:âˆƒ</a></li>
<li><a href="#orgdaf84d9">Additional Examples</a></li>
<li><a href="#orgf1e2ff5">Building New Contracts</a></li>
<li><a href="#org8e92256">Gotchas</a></li>
</ul>
</li>
<li><a href="#org5f8d5a9">8 Input and Output</a>
<ul>
<li><a href="#orgdaceee8">Varieties of Ports</a></li>
<li><a href="#orgf167bd1">Default Ports</a></li>
<li><a href="#org877fcf7">Reading and Writing Racket Data</a></li>
<li><a href="#orga892110">Datatypes and Serialization</a></li>
<li><a href="#org1df3d4c">Bytes, Characters, and Encoding</a></li>
<li><a href="#orgcf802c4">I/O Patterns</a></li>
</ul>
</li>
<li><a href="#org7714c01">9 Regular Expressions</a></li>
<li><a href="#org2608008">10 Exceptions and Control</a>
<ul>
<li><a href="#org1c21f8a">Exceptions</a></li>
<li><a href="#orgd4a4b62">Prompts and Aborts</a></li>
<li><a href="#orgd51a502">Continuations</a></li>
</ul>
</li>
<li><a href="#org6612078">11 Iterations and Comprehensions</a>
<ul>
<li><a href="#orgc0b75d2">Sequence Constructors</a></li>
<li><a href="#org5add9d8">for and for*</a></li>
<li><a href="#org87fc560">for/list and for*/list</a></li>
<li><a href="#org2d6af24">for/vector and for*/vector</a></li>
<li><a href="#org781cc4b">for/and and for/or</a></li>
<li><a href="#org9e61567">for/first and for/last</a></li>
<li><a href="#org3ca87a2">for/fold and for*/fold</a></li>
<li><a href="#org025e4e1">Multiple-Valued Sequences</a></li>
<li><a href="#org5ff8661">Breaking and Iteration</a></li>
<li><a href="#org4db1372">Iteration Performance</a></li>
</ul>
</li>
<li><a href="#orgb7beb62">12 Pattern Matching</a></li>
<li><a href="#org781e29f">13 Classes and Objects</a></li>
<li><a href="#orgbd2755e">14 Units (Components)</a>
<ul>
<li><a href="#org07609c6">Signatures and Units</a></li>
<li><a href="#org709d364">Invoking Units</a></li>
<li><a href="#org02cdeba">Linking Units</a></li>
<li><a href="#org5c91921">First-Class Units</a></li>
<li><a href="#orgb727cf1">Whole-module Signatures and Units</a></li>
<li><a href="#org4d43661">Contracts for Units</a></li>
<li><a href="#orga19877a">unit versus module</a></li>
</ul>
</li>
<li><a href="#orgbdab07a">15 Reflection and Dynamic Evaluation</a>
<ul>
<li><a href="#org3c18322">Eval</a></li>
<li><a href="#org575d1f0">Manipulating Namespaces</a></li>
<li><a href="#org1dc4984">Scripting Evaluation and Using load</a></li>
</ul>
</li>
<li><a href="#org511051b">16 Macros</a>
<ul>
<li><a href="#orgf1e20c5">Pattern-Based Macros</a></li>
<li><a href="#org98063eb">General Macro Transformers</a></li>
<li><a href="#orgb253b0b">Module Instantiations and Visits</a></li>
</ul>
</li>
<li><a href="#orgf3e8392">17 Creating Languages</a>
<ul>
<li><a href="#orgb01e0c3">Module Languages</a></li>
<li><a href="#org0ddb047">Reader Extensions</a></li>
<li><a href="#orgb4c3cce">Defining new #lang Languages</a></li>
</ul>
</li>
<li><a href="#org4a67f63">18 Concurrency and Synchronization</a>
<ul>
<li><a href="#orgc379862">Threads</a></li>
<li><a href="#orgcb0bd86">Thread Mailboxes</a></li>
<li><a href="#org80863d4">Semaphores</a></li>
<li><a href="#org1a6579f">Channels</a></li>
<li><a href="#org343a511">Buffered Asynchronous Channels</a></li>
<li><a href="#org89212b7">Synchronizable Events and sync</a></li>
<li><a href="#org6f5d205">Building Your Own Synchronization Patterns</a></li>
</ul>
</li>
<li><a href="#org9f2bfec">19 Performance</a>
<ul>
<li><a href="#orga966c27">Performance in DrRacket</a></li>
<li><a href="#org97a51f3">The Bytecode and Just-in-Time (JIT) Compilers</a></li>
<li><a href="#org5bea670">Modules and Performance</a></li>
<li><a href="#org4adeef0">Function-Call Optimizations</a></li>
<li><a href="#orga2361bd">Mutation and Performance</a></li>
<li><a href="#org3fa0fec">letrec Performance</a></li>
<li><a href="#orgcc996dd">Fixnum and Flonum Optimizations</a></li>
<li><a href="#org298326f">Unchecked, Unsafe Operations</a></li>
<li><a href="#org65dee6d">Foreign Pointers</a></li>
<li><a href="#orge813de8">Regular Expression Performance</a></li>
<li><a href="#org4c9476d">Memory Management</a></li>
<li><a href="#org74d11c2">Reachability and Garbage Collection</a></li>
<li><a href="#orgea794ed">Weak Boxes and Testing</a></li>
<li><a href="#org33458d5">Reducing Garbage Collection Pauses</a></li>
</ul>
</li>
<li><a href="#org5e10185">20 Parallelism</a>
<ul>
<li><a href="#org65829ed">Parallelism with Futures</a></li>
<li><a href="#orga7aada4">Parallelism with Places</a></li>
<li><a href="#org3e5f80e">Distributed Places</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="abstract" id="org4bb0196">
<p>
è¿™ç¯‡ç¬”è®°çš„æœ€æ—©æ˜¯ä» <code>2018-9-8</code> å¼€å§‹å†™çš„.
</p>

<p>
æ¥è§¦ <code>Racket</code> æœ‰ä¸€æ®µæ—¶é—´äº†,æ¯” <code>Emacs Lisp</code> è¦æ™šä¸€ç‚¹,ä¸€ç›´æ²¡æœ‰å¾ˆè®¤çœŸçš„è¯»è¿‡å®˜æ–¹ <code>Racket Guide</code> æ‰‹å†Œ.
</p>

<p>
å‡ ä¸ªæœˆå‰è¯»äº† <code>EOPL</code> è¿™æœ¬ä¹¦ä¹‹åå°±å¾ˆå–œæ¬¢è¿™é—¨è¯­è¨€äº†,ä¸è¿‡ç©ºä½™æ—¶é—´ä¸å¤š,æ‰€ä»¥åªèƒ½ç”¨ç¢ç‰‡æ—¶é—´æ¥è¯»,é¡ºä¾¿å†™å†™ç¬”è®°.
</p>

<p>
è™½ç„¶"æŠ„æ–‡æ¡£"è¿™æ–¹å¼å­¦è¯­è¨€"å¾ˆè ¢",ä½†æ˜¯ååˆ†æœ‰æ•ˆ,å› ä¸ºæ–‡æ¡£çš„ä¸€äº›æè¿°å¯èƒ½ä¸å¤ªç¬¦åˆè‡ªå·±,è¿™ç§æ—¶å€™å°±éœ€è¦è‡ªå·±æŠŠæ„Ÿæƒ³å’Œé‡ç‚¹è®°å½•ä¸‹æ¥,è¿™æ ·è¯»å®Œä¸€éä¼šå¤§æœ‰æ”¶è·.
</p>

<p>
å…¶å®æ–‡æ¡£è¿˜æœ‰ <code>Racket Reference</code> çš„,ä¸è¿‡ä¸ªäººè§‰å¾—å¦‚æœæ˜¯æ¦‚å¿µçš„è¯è¿˜æ˜¯çœ‹ <code>Guide</code> æ¯”è¾ƒå¥½, <code>Reference</code> ä¸»è¦åå‘äº <code>APIs</code> æ–‡æ¡£.
</p>

<p>
æˆ‘ä¸»è¦æ˜¯æ•´ç†æ–‡æ¡£ä¸Šçš„ <code>working examples</code> å’Œå†™ä¸€äº›è‡ªå·±çš„ <code>working examples</code> å’Œæ„Ÿæƒ³,ä¸ºäº†ç†è§£åšç¬”è®°ä¼šæ¶‰åŠä¸€äº›å…¶å®ƒè¯­è¨€çš„ç‰¹æ€§æ¥åšç±»æ¯”,ä¸æ¶µç›–æ‰€æœ‰ç« èŠ‚,åªå†™æ¯”è¾ƒé‡è¦çš„ç« èŠ‚.
</p>

<p>
è¿˜æœ‰å°±æ˜¯æœ‰ä¸€éƒ¨åˆ†æ–‡æ¡£çš„å†…å®¹ä¸å¤ªæ˜ç™½,æ¯”å¦‚è¯­æ³•æ±¡æŸ“è¿™ç§,ä¹‹åæˆ‘ä¼šèŠ±æ—¶é—´å»äº†è§£.
</p>

<p>
ä¸ªäººä¸å¤ªæ¨èçœ‹æˆ‘è¿™ç¯‡ç¬”è®°,æˆ‘ä¸»è¦æ˜¯ç»™è‡ªå·±åšå¤‡å¿˜å’Œç†è§£çš„,ä¼šæœ‰å¾ˆå¤šç¬”è¯¯æˆ–è€…ç†è§£é”™è¯¯.
</p>

<p>
ä½†æ˜¯ä¹Ÿè¦çŸ¥é“ä¸€ä»¶äº‹,å®˜æ–¹æ–‡æ¡£çš„é”™è¯¯ä¹Ÿæœ‰ä¸å°‘,æœ‰äº›ä¾‹å­æ˜¯ä¸èƒ½æ­£å¸¸è¿è¡Œçš„,æ¯”å¦‚ç¬¬14ç« çš„å…³äºç»™å•å…ƒæ·»åŠ çº¦æŸæ˜¯æœ‰é—®é¢˜çš„,æ‰€ä»¥è‡ªå·±è¯»å®˜æ–¹æ–‡æ¡£çš„äººè¦æ³¨æ„äº†.
</p>

<p>
è¿˜æœ‰è¯»å®Œ <code>Guide</code> ä»¥åçš„æ—¶é—´é‡Œé¢éƒ½æ˜¯ <code>Reference</code> çš„ä¸»åœºäº†, <code>Reference</code> æœ‰å¾ˆå¤š <code>Guide</code> æ²¡æœ‰çš„ä¸œè¥¿ç­‰ç€å»æŒ–æ˜,æ¯”å¦‚æ–°çš„æ•°æ®ç±»å‹,æ–°çš„ç»†èŠ‚, <code>Guide</code> åªæ˜¯ä¸ªå¼€å§‹.
</p>

</div>

<div id="outline-container-org9692153" class="outline-2">
<h2 id="org9692153">Th Racket Guide</h2>
<div class="outline-text-2" id="text-org9692153">
</div>
<div id="outline-container-org14d7163" class="outline-3">
<h3 id="org14d7163">3 Built-in Datatypes</h3>
<div class="outline-text-3" id="text-org14d7163">
<p>
<code>Racket</code> çš„æ•°æ®æ˜¯æœ‰å¯å˜(mutable)ä¸ä¸å¯å˜(immutable)ä¹‹åˆ†.
</p>

<p>
å¯ä»¥ä½¿ç”¨ <code>immutable?</code> form è¿›è¡Œå¤§æ¦‚åˆ¤æ–­. <code>immutable?</code> åªèƒ½ç”¨äº <code>string, byte string, vector, hash table å’Œ box</code> .
</p>

<p>
è¿™äº›ç±»å‹çš„æ•°æ®æ‰èƒ½è¿”å› <code>#t</code> , <code>pair?</code> ä¹Ÿæ˜¯ <code>immutable</code> å´è¿”å› <code>#f</code>, å› ä¸º <code>pair?</code> éšå«ç€ä¸å¯å˜çš„ç‰¹æ€§.
</p>

<pre class="example" id="org428bcba">

Emacs Lisp å’Œ Common Lisp é‡Œé¢æœ‰ self-evaluating form è¿™ä¸ªæ¦‚å¿µ, åœ¨ Emacs Lisp ä¸­çš„å®šä¹‰:

A self-evaluating form is any form that is not a list or symbol.

Self-evaluating forms evaluate to themselves:

the result of evaluation is the same object that was evaluated.

Racketé‡Œé¢è¿˜è¦åŠ ä¸Šä¸€ä¸ª pair,é™¤äº†list,pairå’Œsymbol,æ‰€æœ‰æ•°æ®æ˜¯self-evaluating forms.

æ¯”å¦‚(+ 1 2)ç»“æœä¸º3,'(+ 1 2)å°±æ˜¯ä¸€ä¸ªåˆ—è¡¨,æ²¡æœ‰æ±‚å€¼,æ‰€ä»¥(+ 1 2)ä¸æ˜¯ä¸€ä¸ª self-evaluating form.

å†æ¯”å¦‚'1å°±æ˜¯1,'#tå°±æ˜¯#t,è¿™äº›å°±æ˜¯self-evaluating forms.
</pre>
</div>

<div id="outline-container-orgc9d97a8" class="outline-4">
<h4 id="orgc9d97a8">Booleans</h4>
<div class="outline-text-4" id="text-orgc9d97a8">
<p>
é™¤äº† <code>#f</code> , <code>Racket</code> é‡Œé¢æ‰€æœ‰å¯¹è±¡çš„å¸ƒå°”å€¼éƒ½ä¸º <code>#t</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">(boolean? #t) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(boolean? #f) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(boolean? 1)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(<span style="color: #F0DFAF; font-weight: bold;">if</span> (void) 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2918333" class="outline-4">
<h4 id="org2918333">Numbers</h4>
<div class="outline-text-4" id="text-org2918333">
<p>
ä¸€ä¸ª <code>Racket</code> æ•°å­—ä¸æ˜¯ç²¾ç¡®çš„(exact)å°±æ˜¯ä¸ç²¾ç¡®çš„(inexact).
</p>

<ul class="org-ul">
<li>ç²¾ç¡®æ•°(exact number)

<ul class="org-ul">
<li>ä¸€ä¸ªä»»æ„å¤§æˆ–è€…å°çš„æ•´æ•°</li>

<li>ä¸€ä¸ªç”±ä¸¤ä¸ªä»»æ„å¤§æˆ–å°çš„æ•´æ•°ç»„æˆæ¯”ä¾‹çš„æœ‰ç†æ•°, æ¯”å¦‚ <code>1/2</code> , <code>999999/2</code> , <code>-3/4</code> .</li>

<li>ä¸€ä¸ªæœ‰å®éƒ¨å’Œè™šéƒ¨çš„å¤æ•°, æ¯”å¦‚ <code>1+2i</code> , <code>1/2+3/4i</code> .</li>
</ul></li>

<li>ä¸ç²¾ç¡®æ•°(inexact number)

<ul class="org-ul">
<li><code>IEEE</code> æµ®ç‚¹æ•°, æ¯”å¦‚ <code>2.0</code> , <code>2.0+3.0i</code> æˆ– <code>-inf.0+nan.0i</code></li>

<li>ä¸€ä¸ªå®éƒ¨å’Œè™šéƒ¨éƒ½æ˜¯ <code>IEEE</code> æµ®ç‚¹æ•°çš„å¤æ•°,ä¸€ä¸ªä¾‹å¤–,å®éƒ¨ä¸º0å’Œè™šéƒ¨ä¸ºä¸ç²¾ç¡®æ•°ç»„åˆçš„å¤æ•°.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orged00d6a" class="outline-4">
<h4 id="orged00d6a">Characters</h4>
<div class="outline-text-4" id="text-orged00d6a">
<p>
ä¸€ä¸ª <code>Racket</code> å­—ç¬¦å¯¹åº”ä¸€ä¸ªUnicodeæ ‡é‡å€¼(Unicode scalar value).ç²—ç•¥åœ°è¯´,ä¸€ä¸ªæ ‡é‡å€¼å°±æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°,
</p>

<p>
å®ƒçš„è¡¨ç¤º(representation)æœ€å¤§å¯ä»¥ç”¨21ä½(bits)è¿›è¡Œå‚¨å­˜,å¯¹åº”è‡ªç„¶è¯­è¨€é‡Œé¢å­—ç¬¦çš„æ¦‚å¿µ.
</p>

<p>
<code>Racket</code> é‡Œé¢åˆ†å¯æ‰“å°å­—ç¬¦ä¸ä¸å¯æ‰“å°å­—ç¬¦.ä»¥ <code>#\</code> (æˆ–è€… <code>'#\</code>)å¼€å¤´çš„å­—ç¬¦å°±æ˜¯å¯æ‰“å°å­—ç¬¦,ä»¥ <code>#\u</code> (æˆ–è€… <code>'#\</code>)å¼€å¤´çš„å­—ç¬¦å°±æ˜¯ä¸å¯æ‰“å°å­—ç¬¦.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

#\a
'#\A
#\u03BB
(integer-&gt;char 17) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#\A</span>
(char-&gt;integer #\A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">65</span>
(display #\A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">A</span>
(char-&gt;alphabetic? #\A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(char-numeric? #\0) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(char-whitespace? #\newline) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(char-downcase #\A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#\a</span>
(char-upcase #\&#223;) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#\&#223;</span>
(char=? #\a #\A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(char-ci=? #\a #\A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(eqv? #\a #\A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org249fb78" class="outline-4">
<h4 id="org249fb78">Strings(Unicode)</h4>
<div class="outline-text-4" id="text-org249fb78">
<p>
å­—ç¬¦ä¸²æ˜¯é•¿åº¦å›ºå®šçš„å­—ç¬¦æ•°ç»„.
</p>

<p>
å­—ç¬¦ä¸²ä½¿ç”¨åŒå¼•å·("")åŒ…å›´å†…å®¹,å­—ç¬¦ä¸²é‡Œé¢çš„åŒå¼•å·å’Œåæ–œçº¿(backslash,\)éœ€è¦è¢«åæ–œçº¿åè½¬ä¹‰(escaped).
</p>

<p>
å®ƒåŒ…æ‹¬ä¸€äº›å¸¸ç”¨çš„å­—ç¬¦ä¸²è½¬ä¹‰ <code>\n</code> (linefeed,æ¢è¡Œ), <code>\r</code> (carriage return,å›è½¦).
</p>


<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #CC9393;">"Apple"</span>
<span style="color: #CC9393;">"\u03BB"</span> <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"&#955;"</span>
(display <span style="color: #CC9393;">"Apple"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Apple</span>
(write <span style="color: #CC9393;">"Apple"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"Apple"</span>
(print <span style="color: #CC9393;">"Apple"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"Apple"</span>
(string-ref <span style="color: #CC9393;">"Apple"</span> 0) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#\A</span>
(make-string 5 #\.) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"....."</span>
(string-set! s 2 #\&#955;) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"..&#955;.."</span>
(display <span style="color: #CC9393;">"\"\\\""</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"\"</span>
(string&lt;? <span style="color: #CC9393;">"apple"</span> <span style="color: #CC9393;">"Banana"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(string-ci&lt;? <span style="color: #CC9393;">"apple"</span> <span style="color: #CC9393;">"Banana"</span>) <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">#t</span>
(string-upcase <span style="color: #CC9393;">"Stra&#223;e"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"STRASSE"</span>
(<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-locale <span style="color: #CC9393;">"C"</span>])
  (string-locale-upcase <span style="color: #CC9393;">"Stra&#223;e"</span>)) <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">"STRA&#223;E"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6c15070" class="outline-4">
<h4 id="org6c15070">Bytes and Byte String</h4>
<div class="outline-text-4" id="text-org6c15070">
<p>
ä¸€ä¸ªå­—èŠ‚(byte)å°±æ˜¯ä¸€ä¸ª0åˆ°255ä¹‹é—´çš„ç²¾ç¡®æ•´æ•°.
</p>

<p>
ä¸€ä¸ªå­—èŠ‚ä¸²(byte string)å°±æ˜¯ä¸€ä¸ªå­—èŠ‚åºåˆ—.å­—èŠ‚ä¸²æ˜¯ä»¥ <code>#</code> (æˆ–è€… <code>'#</code>)å¼€å¤´çš„å­—ç¬¦ä¸².
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(byte? 0) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(byte? 256) <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">#f</span>

#<span style="color: #CC9393;">"Apple"</span>
(bytes-ref #<span style="color: #CC9393;">"Apple"</span> 0) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">65</span>
(make-bytes 3 65) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3 &#20010; 65, #"AAA"</span>
(bytes-set! (make-bytes 3 65) 0 1)

(bytes-&gt;string/utf-8 #<span style="color: #CC9393;">"\316\273"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"&#955;"</span>
(bytes-&gt;string/latin-1 #<span style="color: #CC9393;">"\316\273"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"&#206;&#187;"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd294ae7" class="outline-4">
<h4 id="orgd294ae7">Symbols</h4>
<div class="outline-text-4" id="text-orgd294ae7">
<p>
ç¬¦å·(symbol)æ˜¯ä¸€ä¸ªåŸå­å€¼,ä»¥ä¸€ä¸ª <code>'</code> å¼€å¤´çš„æ ‡è¯†ç¬¦(identifier)å°±æ˜¯ä¸€ä¸ªç¬¦å·å€¼.
</p>

<p>
æ³¨æ„ä¸‹é¢çš„å­—ç¬¦ä¸èƒ½ä½œä¸ºæ ‡è¯†ç¬¦å·çš„å¼€å¤´å­—ç¬¦,
</p>

<pre class="example" id="org50de87c">
( ) [ ] { } " , ' ` ; # | \
</pre>

<p>
å®é™…ä¸Š, <code>'#%</code> æ˜¯å¯ä»¥çš„. <code>.</code> ä¹Ÿä¸èƒ½å•ç‹¬ä½œä¸ºæ ‡è¯†ç¬¦.
</p>

<p>
ç¬¦å·åˆ† <code>interned</code> å’Œ <code>uninterned</code> .é™¤äº† <code>gensym</code> å’Œ <code>string-&gt;uninterned-symbol</code> ç”Ÿæˆçš„ç¬¦å·å¤–,éƒ½æ˜¯ <code>uninterned</code> ç¬¦å·.
</p>

<p>
ç¬¦å·æ˜¯å¤§å°å†™æ•æ„Ÿçš„.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(eq? 'a 'a) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(eq? 'a (string-&gt;symbol <span style="color: #CC9393;">"a"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(eq? 'a 'b) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(eq? 'a 'A) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(eq? 'a (quote a)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t,'&#23601;&#26159;quote&#30340;&#31616;&#20889;.</span>
#ci'A       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'a</span>
(string-&gt;symbol <span style="color: #CC9393;">"one, two"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'|one, two|</span>
(string-&gt;symbol <span style="color: #CC9393;">"6"</span>)        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'|6|</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">s</span> (gensym)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#29983;&#25104;&#20219;&#24847;&#31526;&#21495;,&#32477;&#23545;&#19981;&#20250;&#19982;&#31995;&#32479;&#37324;&#38754;&#30340;&#31526;&#21495;&#30456;&#21516;</span>
(write 'Apple) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; Apple</span>
(display 'Apple) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; Apple</span>
(write '<span style="color: #CC9393;">|6|</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; |6|</span>
(display '<span style="color: #CC9393;">|6|</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; 6</span>
(eq? 'a (string-&gt;uninterned-symbol <span style="color: #CC9393;">"a"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d10f94" class="outline-4">
<h4 id="org6d10f94">Keywords</h4>
<div class="outline-text-4" id="text-org6d10f94">
<p>
å…³é”®è¯(keyword)å€¼ç±»ä¼¼ä¸ä¸€ä¸ªç¬¦å·(symbol),å®ƒçš„æ‰“å°æ˜¯ä»¥ <code>#:</code> (æˆ–è€… <code>'#:</code>)å¼€å¤´.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(string-&gt;keyword <span style="color: #CC9393;">"apple"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'#apple</span>
(eq? '<span style="color: #DCDCCC; font-weight: bold;">#:apple</span> (string-&gt;keyword <span style="color: #CC9393;">"apple"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd458846" class="outline-4">
<h4 id="orgd458846">Pairs and Lists</h4>
<div class="outline-text-4" id="text-orgd458846">
<p>
<code>pair</code> å’Œ <code>list</code> çš„åŒºåˆ«: <code>pair</code> æ˜¯ä¸€ä¸ªå¯¹å€¼, <code>list</code> æ˜¯ä¸€ä¸ªåˆ—è¡¨.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(cons 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 . 2) ; &#26159;pair,&#19981;&#26159;list,&#31216;&#20026; non-list pairs</span>
(cons 1 (list 2 3)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 2 3),&#26159;pair,&#20063;&#26159;list</span>
(pair? '(1 . 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(list? '(1 . 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(pair? '(1 2 3)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(list? '(1 2 3)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>

(cons 0 (cons 1 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(0 1 . 2)</span>
</pre>
</div>

<p>
å…¶å® <code>(cons 1 (list 2 3))</code> ç­‰äº <code>(1 . (2 . (3 . ())))</code> .
</p>

<p>
<code>Racket</code> é‡Œé¢,æ‰“å° <code>pair</code> æ˜¯éµå®ˆä¸€æ¡è§„åˆ™: ä½¿ç”¨ <code>.(dot)</code> é™¤édotåé¢è·Ÿéšç€å·¦æ‹¬å·(open parenthesis),å¹¶ä¸”ç§»é™¤åŒ¹é…çš„å·¦æ‹¬å·å’Œå³æ‹¬å·.
</p>

<p>
è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ <code>(cons 0 (cons 1 2))</code> -&gt; <code>(0 . (1 . 2))</code> -&gt; <code>(0 1 . 2)</code> , <code>(cons 1 (list 2 3))</code> -&gt; <code>(1 2 3)</code> .
</p>

<p>
æ ¹æ®è¿™æ¡è§„åˆ™,å¯ä»¥è¿™ä¹ˆç”¨dot,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(+ 1 . (2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3, &#30456;&#24403;&#20110; (+ 1 2)</span>
(1 . &lt; . 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t, &#36825;pair&#30456;&#24403;&#20110; (&lt; 1 2), &#36825;&#21483;two-dot convention,&#19981;&#26159;Lisp&#30340;&#20256;&#32479;.</span>
'(1 . &lt; . 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(&lt; 1 2)</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p</span> (cons 1 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#19981;&#21487;&#21464;&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">mp</span> (mcons 1 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21487;&#21464;&#29256;&#26412;</span>
(mpair? mp) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(pair? mp) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(set-mcar! mp 0)
(write mp) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; {0 . 2}</span>
</pre>
</div>

<pre class="example" id="org717963b">
Racketçš„è¯­æ³•(Racket Syntax)ä¸æ˜¯ç›´æ¥æ ¹æ®å­—ç¬¦æµ(character stream)å®šä¹‰çš„,æ˜¯ç”± reader layer å’Œ expander layer å…±åŒå†³å®šçš„.

å½“è¿è¡Œç¨‹åºçš„æ—¶å€™,è¿‡ç¨‹å¦‚ä¸‹:

1. reader layer: æŠŠå­—ç¬¦æµ(æºä»£ç æ–‡ä»¶æµæˆ–è€…REPLçš„è¾“å…¥æµ)å¤„ç†æˆä¸€ä¸ªè¯­æ³•å¯¹è±¡(syntax object,16ç« ä¼šè®²);

2. expander layer: æŠŠè¿™ä¸ªè¯­æ³•å¯¹è±¡(é€’å½’å¾—)å¤„ç†æˆä¸€ä¸ªå®Œå…¨è§£æå¥½(full parsed)çš„è¯­æ³•å¯¹è±¡,è¿™ä¸ªè¯­æ³•å¯¹è±¡å°±æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼.

è¿˜æ˜¯æœ‰ä¸€ä¸ª printer layer çš„,ä½†æ˜¯å®ƒä¸å†³å®šè¯­æ³•,ä¸è¿‡æ‰“å°å’Œè¯»å–çš„è§„åˆ™æ˜¯ä¸€æ ·.æ¯”å¦‚ä¸€ä¸ªç©ºåˆ—è¡¨ä¼šè¢«æ‰“å°æˆä¸€å¯¹æ‹¬å·,è¯»å–ä¸€å¯¹æ‹¬å·ä¹Ÿä¼šäº§ç”Ÿä¸€ä¸ªåˆ—è¡¨.


</pre>
</div>
</div>

<div id="outline-container-org5ae48bb" class="outline-4">
<h4 id="org5ae48bb">Vectors</h4>
<div class="outline-text-4" id="text-org5ae48bb">
<p>
ä¸€ä¸ª <code>vector</code> å°±æ˜¯ä¸€ä¸ªæ•°ç»„(<code>fixed-length arrary</code> ,æ•°ç»„æœ¬æ¥å°±æ˜¯å›ºå®šé•¿åº¦çš„),æ—¢å¯ä»¥æ˜¯å¯å˜çš„(mutable)ä¹Ÿå¯ä»¥æ˜¯ä¸å¯å˜çš„(immutable).
</p>

<p>
ç›´æ¥å†™çš„æ˜¯ä¸å¯å˜çš„(ä¸‹é¢ä¼šä»¥è¿™ç§å½¢å¼å±•ç¤º).
</p>

<p>
ä¸åƒ <code>list</code> , <code>vector</code> æ”¯æŒå¸¸é‡æ—¶é—´(constant-time)çš„è®¿é—®å’Œå…ƒç´ æ›´æ–°.
</p>

<p>
<code>vector</code> çš„æ‰“å°æ˜¯ä»¥ <code>'#</code> å¼€å¤´çš„,è¦é€šè¿‡æ‰“å°å®šä¹‰ <code>vector</code> å¯ä»¥ç”¨ <code>'#</code> æˆ–è€… <code>#</code> åšä¸ºå‰ç¼€,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

'#(<span style="color: #CC9393;">"a"</span> <span style="color: #CC9393;">"b"</span> <span style="color: #CC9393;">"c"</span>)
#(<span style="color: #CC9393;">"a"</span> <span style="color: #CC9393;">"b"</span> <span style="color: #CC9393;">"c"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21644;&#19978;&#38754;&#30340;&#32467;&#26524;&#19968;&#26679;</span>
'#(name (that tune))
#4(bladwin bruce) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36825;&#20010;&#29305;&#27530;&#19968;&#28857;,&#35774;&#23450;&#20102;&#38271;&#24230;&#20026;4,&#21097;&#20313;&#30340;&#20301;&#23376;&#30001;&#26368;&#21518;&#19968;&#20010;&#20803;&#32032;&#22635;&#20805;, #(bladwin bruce bruce bruce)</span>
(vector-ref #(<span style="color: #CC9393;">"a"</span> <span style="color: #CC9393;">"b"</span> <span style="color: #CC9393;">"c"</span>) 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"b"</span>
(vector-ref #(name (that tune)) 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(that tune)</span>
(list-&gt;vector (vector-&gt;list #(<span style="color: #CC9393;">"one"</span> <span style="color: #CC9393;">"two"</span> <span style="color: #CC9393;">"three"</span>))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#("one" "two" "three")</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge281e5e" class="outline-4">
<h4 id="orge281e5e">Hash Tables</h4>
<div class="outline-text-4" id="text-orge281e5e">
<p>
å“ˆå¸Œè¡¨(hash table)å®ç°äº†ä»é”®(keys)åˆ°å€¼(values)çš„æ˜ å°„,é”®å’Œå€¼éƒ½å¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ª <code>Racket</code> å€¼,è®¿é—®å’Œæ›´æ–°æ“ä½œéƒ½æ˜¯åœ¨å¸¸é‡æ—¶é—´å†…å®Œæˆ.
</p>

<p>
å¯ä»¥ä½¿ç”¨ <code>equal?, eqv? å’Œ eq?</code> æ¥å¯¹é”®è¿›è¡Œæ¯”è¾ƒ,è¿™å–å†³ä¸å“ˆå¸Œè¡¨æ˜¯ <code>make-hash, make-hasheqv æˆ–è€… make-hasheq</code> ç§çš„å“ªä¸ªåˆ›å»ºçš„.
</p>

<p>
3ç§æ–¹å¼å¾—åˆ°å“ˆå¸Œè¡¨åˆ†åˆ«å« <code>equal?-based table, eqv?-based table å’Œ eq?-based table</code> ,
</p>

<p>
åˆ†åˆ«å‰ç¼€ä¸º <code>#hash, #hasheqv å’Œ #hasheq</code> (ä½ å¯ä»¥åˆ†åˆ«ç»™å®ƒä»¬çš„å‰é¢åŠ ä¸Š').
</p>

<p>
å“ˆå¸Œè¡¨æ˜¯å¯å˜æˆ–è€…ä¸å¯å˜çš„,æ‰‹å†™çš„æ˜¯ä¸å¯å˜çš„,ç”¨ä¸Šé¢çš„3ä¸ªæ„é€ å‡½æ•°ç”Ÿæˆçš„æ˜¯å¯å˜çš„.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">equal?-ht</span> (make-hash))
(hash) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#19981;&#21487;&#21464;</span>
#hash()

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ht</span> (hash <span style="color: #CC9393;">"apple"</span> 'red <span style="color: #CC9393;">"banana"</span> 'yellow))
(hash-ref ht <span style="color: #CC9393;">"apple"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'red</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ht2</span> (hash-set ht <span style="color: #CC9393;">"orange"</span> 'orange))
(hash-ref ht2 <span style="color: #CC9393;">"orange"</span>) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'orange</span>
(hash-count ht) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>
(hash-count ht2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">eqv?-ht</span> (make-hasheqv))
#hasheqv()

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">eq?-ht</span> (make-hasheq))
#hasheq()

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21704;&#24076;&#34920;&#36824;&#26377;&#25226;key&#21464;&#20026;weak,&#21482;&#35201;key&#33021;&#22815;&#35775;&#38382;&#23601;&#21487;&#20197;&#35775;&#38382;&#23545;&#24212;&#30340;&#20540;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ht-weak-key</span> (make-weak-hasheq))
(hash-set! ht-weak-key (gensym) <span style="color: #CC9393;">"can you see me?"</span>)
(collect-garbage)
(hash-count ht-weak-key) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">0</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20294;&#26159;&#24369;&#21704;&#24076;&#34920;&#30340;&#20540;&#21453;&#36807;&#26469;&#24341;&#29992;&#38190;&#30340;&#26102;&#20505;,gc&#20063;&#22238;&#25910;&#19981;&#20102;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ht-strong-value</span> (make-weak-hasheq))
(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([g (gensym)])
  (hash-set! ht-strong-value g (list g)))
(collect-garbage)
(hash-count ht-strong-value) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#31181;&#26102;&#20505;&#35201;&#29992; ephemeron &#35299;&#20915;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ht-free-strong-value</span> (make-weak-hasheq))
(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([g (gensym)])
  (hash-set! ht-free-strong-value g (make-ephemeron g (list g))))
(collect-garbage)
(hash-count ht-free-strong-value) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">0</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba0a824" class="outline-4">
<h4 id="orgba0a824">Boxes</h4>
<div class="outline-text-4" id="text-orgba0a824">
<p>
<code>box</code> æ—¢å¯ä»¥å¯å˜ä¹Ÿå¯ä»¥ä¸å¯å˜.åƒå•ä¸ªå…ƒç´ çš„ <code>vector</code> .
</p>

<p>
å¯ä»¥ä»¥ <code>#&amp;</code> æˆ–è€… <code>'#&amp;</code> ä½œä¸ºæ‰“å°å‰ç¼€.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">b</span> (box <span style="color: #CC9393;">"apple"</span>))
'#&amp;<span style="color: #CC9393;">"apple"</span>
#&amp;<span style="color: #CC9393;">"apple"</span>
(unbox b)
(set-box! b '(banana boat))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1412b41" class="outline-4">
<h4 id="org1412b41">Void and Undefined</h4>
<div class="outline-text-4" id="text-org1412b41">
<p>
<code>(void) =&gt; #&lt;void&gt;</code> , <code>#&lt;void&gt;</code> æ˜¯ Racket çš„å¸¸é‡,ç„¶è€Œåœ¨ <code>REPL</code> è°ƒç”¨ <code>void</code> æ˜¯ä¸ä¼šæœ‰ä»»ä½•ä¸œè¥¿è¢«æ‰“å°.
</p>

<p>
ç”¨ <code>displayln</code> ä¹‹ç±»çš„å°±å¯ä»¥, <code>void</code> æ¥æ”¶ä»»ä½•å‚æ•°å¹¶ä¸”ä¼šæ— è§†å®ƒä»¬çš„å€¼è¿”å› <code>#&lt;void&gt;</code> ,
</p>

<p>
å¦‚æœä¸æƒ³è¢«æŸä¸ª <code>expressioin</code> çš„è¿”å›å€¼å½±å“,å¯ä»¥æŠŠ <code>expression</code> ä½œä¸º <code>void</code> çš„å‚æ•°.
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (displayln (void))
<span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;void&gt;</span>
&gt; (displayln (void 1 2 3))
<span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;void&gt;</span>
</pre>
</div>

<p>
<code>undefined</code> ä¹Ÿæ˜¯ <code>Racket</code> çš„å¸¸é‡,å¯ä»¥é€šè¿‡ <code>(require racket/undefined)</code> æ¥ä½¿ç”¨å®ƒ,ä¸€èˆ¬æˆ‘ä»¬ä¸ä¼šä½¿ç”¨å®ƒ,
</p>

<p>
å®ƒåªè¦åœ¨å¼•ç”¨æ²¡æœ‰å®šä¹‰çš„å€¼å¼•å‘å¼‚å¸¸å°±å¯ä»¥äº†.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(require racket/undefined)
undefined
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga563c6d" class="outline-3">
<h3 id="orga563c6d">4 Expressions and Definitions</h3>
<div class="outline-text-3" id="text-orga563c6d">
<p>
è¿™ä¸ªç« èŠ‚ä¸œè¥¿å¾ˆæ‚,æ‰€ä»¥å¾ˆå¤šä¸œè¥¿ä¼šè·³è¿‡,æŒ‘ä¸€äº›é‡ç‚¹.
</p>
</div>

<div id="outline-container-org9604dcb" class="outline-4">
<h4 id="org9604dcb">Functions</h4>
<div class="outline-text-4" id="text-org9604dcb">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#19979;&#38754;&#26159;&#22266;&#23450;&#21442;&#25968;&#20989;&#25968;&#30340;&#23450;&#20041;&#20197;&#21450;&#35843;&#29992;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x y) (+ x y)))

(func-lambda 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>
((<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x y) (+ x y)) 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21311;&#21517;&#20989;&#25968;&#30452;&#25509;&#35843;&#29992;,&#30456;&#24403;&#20110;&#19978;&#38754;&#20004;&#21477;&#30340;&#31616;&#20889;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define</span> x y) (+ x y)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#31532;&#19968;&#31181;&#30340;shorthand</span>

(func-define 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#26607;&#37324;&#21270;&#23450;&#20041;</span>
<span style="color: #7F9F7F;">func : variable -&gt; procedure</span>
<span style="color: #7F9F7F;">procedure : variable -&gt; number</span>
<span style="color: #7F9F7F;">|#</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> ((<span style="color: #93E0E3;">func-curry</span> x) y) (+ x y)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36825;&#31181;&#23450;&#20041;&#26041;&#24335;&#23545;&#19979;&#38754;&#30340;&#20063;&#26159;&#21487;&#20197;&#29992;&#30340;</span>

((func-curry 1) 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#26469;&#20004;&#20010;&#26080;&#21442;&#25968;&#30340;&#23450;&#20041;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda-no-args</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () 1))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define-no-args</span>) 1)

(func-lambda-no-args) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

(func-define-no-args) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#19981;&#23450;&#38271;(Rest)&#21442;&#25968;&#20989;&#25968;&#23450;&#20041;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda-rest</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> x x))

(func-lambda-rest 1 2 3) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 2 3)</span>

(func-lambda-rest) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'()</span>

((<span style="color: #F0DFAF; font-weight: bold;">lambda</span> x (car x)) 1 2 3) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define-rest</span> . x) x)

(func-define-rest 1 2 3) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 2 3)</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda-pos-rest</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x . y) (list x y)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define-pos-rest</span> x . y) (list x y)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the same</span>

(func-lambda-pos-rest 1 2 3 4) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 (2 3 4))</span>

(func-define-pos-rest 1 2 3 4) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 (2 3 4))</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#21487;&#36873;(Optional)&#21442;&#25968;&#20989;&#25968;&#23450;&#20041;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda-optional</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ([x 1]) (+ x 1)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define-optional</span> [x 1]) (+ x 1))

(func-lambda-optional) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

(func-define-optional) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

(func-lambda-optional 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(func-define-optional 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda-pos-optional</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x [y 2]) (+ x y)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define-pos-optional</span> x [y 2]) (+ x y))

(func-lambda-pos-optional 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(func-define-pos-optional 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(func-lambda-pos-optional 1 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

(func-define-pos-optional 1 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#20851;&#38190;&#35789;(Keyword)&#21442;&#25968;&#20989;&#25968;&#23450;&#20041;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda-keyword</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> y) (+ x y)))

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">(define func-lambda-keyword (lambda (#:rand y x) (+ x y)))</span>
<span style="color: #7F9F7F;">; x&#21442;&#25968;&#39034;&#24207;&#35843;&#25442;&#20063;&#26159;&#21487;&#20197;&#30340;</span>
<span style="color: #7F9F7F;">|#</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define-keyword</span> x <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> y) (+ x y))

(func-lambda-keyword 1 <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(func-lambda-keyword <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> 2 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(func-define-keyword 1 <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(func-define-keyword <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> 2 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32473;&#20851;&#38190;&#35789;&#35774;&#23450;&#40664;&#35748;&#20540;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">func-lambda-default-keyword</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> [y 1]) (+ x y)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">func-define-default-keyword</span> x <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> [y 1]) (+ x y))

(func-lambda-default-keyword 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

(func-lambda-default-keyword 1 <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(func-define-default-keyword 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

(func-define-default-keyword 1 <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">lambda&#19981;&#30452;&#25509;&#25903;&#25345;&#21019;&#24314;&#25509;&#21463;"rest" keywords&#20989;&#25968;,</span>

<span style="color: #7F9F7F;">&#20026;&#20102;&#26500;&#24314;&#19968;&#20010;&#25509;&#21463;&#25152;&#26377;&#20851;&#38190;&#35789;&#21442;&#25968;&#30340;&#20989;&#25968;,&#21487;&#20197;&#36890;&#36807;make-keyword-procedure&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;.</span>

<span style="color: #7F9F7F;">&#25552;&#20379;&#32473;make-keyword-procedure&#30340;&#20989;&#25968;&#38656;&#35201;3&#20010;&#21442;&#25968;,&#21069;&#38754;&#20004;&#20010;&#20998;&#21035;&#26159;&#20851;&#38190;&#35789;&#21644;&#20851;&#38190;&#35789;&#23545;&#24212;&#30340;&#20540;,</span>

<span style="color: #7F9F7F;">&#26368;&#21518;&#19968;&#20010;&#23601;&#26159;&#25152;&#26377;&#30340;positional&#21442;&#25968;.</span>
<span style="color: #7F9F7F;">|#</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">trace-wrap</span> f)
  (make-keyword-procedure
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (kws kw-args . rest)
     (printf <span style="color: #CC9393;">"Called with ~s ~s ~s\n"</span> kws kw-args rest)
     (keyword-apply f kws kw-args rest))))

((trace-wrap func-lambda-default-keyword) 1 <span style="color: #DCDCCC; font-weight: bold;">#:rand</span> 15) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; "Called with (#:rand) (15) (1)", &#36820;&#22238; 16</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#21442;&#25968;&#25968;&#37327;&#25935;&#24863;(artiy-sensitive)&#30340;&#20989;&#25968;,&#26681;&#25454;&#21442;&#25968;&#25968;&#37327;&#26469;&#21305;&#37197;&#20989;&#25968;&#20307;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">case-lambda &#19981;&#30452;&#25509;&#25903;&#25345;&#20851;&#38190;&#35789;&#21442;&#25968;&#21644;&#21487;&#36873;&#21442;&#25968;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">f-case-lambda</span>
  (<span style="color: #F0DFAF; font-weight: bold;">case-lambda</span>
    [(x) x]
    [(x y) (+ x y)]
    [(x . y) (apply + x y)]))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#26469;&#20010;&#20301;&#32622;&#21442;&#25968;(positional argument),&#21097;&#20313;&#21442;&#25968;(rest argument),&#21487;&#36873;&#21442;&#25968;(optional argument)&#21644;&#20851;&#38190;&#35789;&#21442;&#25968;(keyword argument)&#30340;&#28151;&#21512;</span>
<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#38500;&#20102;&#21097;&#20313;&#21442;&#25968;&#35201;&#25918;&#26368;&#21518;&#19968;&#20301;&#22806;,&#20854;&#23427;&#21442;&#25968;&#30340;&#20301;&#32622;&#27809;&#20160;&#20040;&#35201;&#27714;.(&#34429;&#28982;&#21097;&#20313;&#21442;&#25968;&#21518;&#38754;&#36824;&#21487;&#20197;&#20854;&#23427;&#31867;&#22411;&#30340;&#21442;&#25968;,&#23450;&#20041;&#30340;&#26102;&#20505;&#27809;&#38169;,&#20294;&#36825;&#26679;&#22909;&#20687;&#21462;&#19981;&#20102;&#21518;&#38754;&#30340;&#21442;&#25968;&#20540;).</span>
<span style="color: #7F9F7F;">|#</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">f-lambda-mix</span>
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (pos [opt 0] <span style="color: #DCDCCC; font-weight: bold;">#:key1</span> kopt1 <span style="color: #DCDCCC; font-weight: bold;">#:key2</span> [kopt2 0] . rest) (apply + pos opt kopt1 kopt2 rest)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-define-mix</span> pos [opt 0] <span style="color: #DCDCCC; font-weight: bold;">#:key1</span> kopt1 <span style="color: #DCDCCC; font-weight: bold;">#:key2</span> [kopt2 0] . rest)
  (apply + pos opt kopt1 kopt2 rest))

(f-lambda-mix 1 2 <span style="color: #DCDCCC; font-weight: bold;">#:key1</span> 3 <span style="color: #DCDCCC; font-weight: bold;">#:key2</span> 4 5 6 7) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">28</span>

(f-define-mix 1 2 <span style="color: #DCDCCC; font-weight: bold;">#:key1</span> 3 <span style="color: #DCDCCC; font-weight: bold;">#:key2</span> 4 5 6 7) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">28</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#20989;&#25968;&#30340;&#35843;&#29992;</span>
<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#19978;&#38754;&#24050;&#32463;&#26377;&#28436;&#31034;&#20102;,&#31245;&#24494;&#35828;&#19968;&#19979; apply, &#33267;&#20110;keyword-apply,&#19978;&#38754;&#24050;&#32463;&#26377;&#20363;&#23376;&#20102;&#23601;&#19981;&#35828;</span>
<span style="color: #7F9F7F;">|#</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#19968;&#20010;&#25509;&#25910;&#33267;&#23569;&#19968;&#20010;&#25972;&#25968;&#30340;&#20989;&#25968;,&#24182;&#19988;&#31639;&#20986;&#24635;&#21644;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">sum-apply</span> x . rest)
  (apply + x rest))

(sum-apply 1 2 3 4) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">10,rest&#26159; list?</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">apply &#20063;&#25903;&#25345;&#20851;&#38190;&#35789;&#21442;&#25968;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">sum-apply-keyword</span> <span style="color: #DCDCCC; font-weight: bold;">#:key</span> x . rest)
  (apply + x rest))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25442;&#21442;&#25968;&#39034;&#24207;&#20063;&#26159;&#21487;&#20197;&#30340;</span>
(apply sum-apply-keyword <span style="color: #DCDCCC; font-weight: bold;">#:key</span> 1 '(2 3 4)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">10</span>
(apply sum-apply-keyword '(2 3 4) <span style="color: #DCDCCC; font-weight: bold;">#:key</span> 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">10</span>


<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#20320;&#21487;&#33021;&#30475;&#21040;&#36807; struct &#36825;&#31867;&#25805;&#20316;&#31526;&#21495;&#30340;BNF&#35821;&#27861;,&#23427;&#20204;&#20301;&#32622;&#24120;&#25968;&#21487;&#20197;&#36319;&#21487;&#36873;&#21442;&#25968;&#19968;&#26679;&#21487;&#36873;.</span>
<span style="color: #7F9F7F;">&#35201;&#26126;&#30333;,&#23427;&#20204;&#34429;&#28982;&#20063;&#26159;&#21487;&#20197;&#35843;&#29992;,&#20294;&#19981;&#26159;&#20989;&#25968;&#32780;&#26159;macros.&#20989;&#25968;&#26159;&#19981;&#21487;&#33021;&#23450;&#20041;&#25104;&#37027;&#26679;&#30340;.</span>
<span style="color: #7F9F7F;">|#</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdb96982" class="outline-4">
<h4 id="orgdb96982">Local Binding</h4>
<div class="outline-text-4" id="text-orgdb96982">
<p>
è¯æ³•ç»‘å®š
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">let&#26377;&#20004;&#31181;&#29992;&#27861;</span>
<span style="color: #7F9F7F;">|#</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (x y) (values 3 4))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#26412;&#22320;&#32465;&#23450;&#21464;&#37327;,&#21464;&#37327;&#30340;&#20351;&#29992;&#21482;&#33021;&#22312;let&#30340;&#20316;&#29992;&#22495;&#37324;&#38754;&#20351;&#29992;,&#20250;shadow let&#22806;&#38754;&#30340;&#21516;&#21517;&#21464;&#37327;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([x 1]
      [y 2])
  (+ x y)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3,&#19981;&#26159;7</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#26412;&#22320;&#32465;&#23450;&#20989;&#25968;,&#20248;&#20808;&#32423;&#19982;&#21464;&#37327;&#30340;&#19968;&#26679;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">fac</span> ([x 10]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26412;&#22320;&#32465;&#23450;&#20102;&#19968;&#20010; fac &#20989;&#25968;</span>
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
      1
      (* x (fac (sub1 x))))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3628800</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#20063;&#35768;&#20320;&#24819;&#36825;&#26679;&#20889;,&#30340;&#30830;&#21487;&#20197;&#25226;lambda&#34920;&#36798;&#24335;&#32465;&#23450;&#32473;&#21464;&#37327;&#28982;&#21518;&#35843;&#29992;,&#20294;&#26159;&#19979;&#38754;&#30340;&#36825;&#20363;&#23376;&#26159;&#19981;&#34892;&#30340;,</span>

<span style="color: #7F9F7F;">&#22240;&#20026;lambda&#34920;&#36798;&#24335;&#24341;&#29992;&#20102;&#32465;&#23450;&#30340;&#21464;&#37327;,&#28982;&#32780;&#22312;lambda&#34920;&#36798;&#24335;&#37324;&#38754;&#30340;fac&#26159;&#19981;&#21487;&#35265;&#30340;,&#25152;&#20197;&#35201;&#29992;&#19978;&#38754;&#31532;&#20108;&#31181;&#24418;&#24335;.</span>

<span style="color: #7F9F7F;">(let ([fac (lambda (x)</span>
<span style="color: #7F9F7F;">             (if (zero? x)</span>
<span style="color: #7F9F7F;">                 1</span>
<span style="color: #7F9F7F;">                 (* x (fac (sub1 x)))))])</span>
<span style="color: #7F9F7F;">  (fac 10))</span>

<span style="color: #7F9F7F;">&#20854;&#23454;&#36824;&#26377;&#21478;&#22806;&#19968;&#31181;&#35299;&#20915;&#26041;&#27861;,&#31561;&#19968;&#19979;&#20877;&#35828;.</span>
<span style="color: #7F9F7F;">|#</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">let*&#31867;&#20284;let,&#19981;&#36807;&#21482;&#33021;&#32465;&#23450;&#21464;&#37327;&#20197;&#21450;&#32465;&#23450;&#21464;&#37327;&#20043;&#38388;&#21487;&#20197;&#30456;&#20114;&#24341;&#29992;</span>
<span style="color: #7F9F7F;">|#</span>

(<span style="color: #F0DFAF; font-weight: bold;">let*</span> ([x 1]
       [y x]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">y &#32465;&#23450;&#20102; x &#30340;&#20540;,&#22312; let &#20013;&#26159;&#19981;&#21487;&#20197;&#36825;&#20040;&#20570;&#30340;</span>
  (+ x y)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#30456;&#24403;&#20110;</span>

(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([x 1])
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([y x])
    (+ x y))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#19978;&#38754;&#35828;&#20102;,let&#19981;&#33021;&#32465;&#23450;&#36882;&#24402;&#20989;&#25968;&#21040;&#21464;&#37327;&#20013;,&#19981;&#36807;&#25442;&#25104;letrec&#23601;&#21487;&#20197;</span>
<span style="color: #7F9F7F;">|#</span>
(<span style="color: #F0DFAF; font-weight: bold;">letrec</span> ([fac (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x)
                (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
                    1
                    (* x (fac (sub1 x)))))])
  (fac 10)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3628800</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#36824;&#26377;&#21508;&#31181;&#21464;&#31181;,let-values,let*-values&#21644;letrec-values&#31561;&#31561;&#23601;&#19981;&#35828;&#20102;.</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc66972" class="outline-4">
<h4 id="orgcc66972">Conditionals</h4>
<div class="outline-text-4" id="text-orgcc66972">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">if</span>
(<span style="color: #F0DFAF; font-weight: bold;">if</span> #t 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">when</span>
(<span style="color: #F0DFAF; font-weight: bold;">when</span> #f 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">void</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">unless</span>
(<span style="color: #F0DFAF; font-weight: bold;">unless</span> #f 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">and or</span>
(<span style="color: #F0DFAF; font-weight: bold;">and</span> 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>
(<span style="color: #F0DFAF; font-weight: bold;">and</span> 1 #f) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(<span style="color: #F0DFAF; font-weight: bold;">and</span> #f 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(<span style="color: #F0DFAF; font-weight: bold;">or</span> 1 2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
(<span style="color: #F0DFAF; font-weight: bold;">or</span> 1 #f) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
(<span style="color: #F0DFAF; font-weight: bold;">or</span> #f 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">cond</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19979;&#38754;&#20363;&#23376;&#23637;&#31034;&#20840;&#37096;&#29992;&#27861;,</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-cond</span> cond-expr)
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    [(number? cond-expr) (+ 1 cond-expr)]
    [(boolean? cond-expr)]
    [(procedure? cond-expr) =&gt; (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v)               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36825;&#37324;&#25226;&#27979;&#35797;&#32467;&#26524;&#20256;&#20837;&#32473;&#20102; =&gt; &#21518;&#38754;&#30340;&#20989;&#25968;</span>
                                 (<span style="color: #F0DFAF; font-weight: bold;">when</span> v
                                   (displayln (format <span style="color: #CC9393;">"The cond-expr a function ~a"</span> v))))]
    [else (displayln <span style="color: #CC9393;">"Not an value unstandable"</span>)]))      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#27809;&#26377;&#19968;&#20010;&#21305;&#37197;&#25165;&#25191;&#34892;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f825eb" class="outline-4">
<h4 id="org7f825eb">Sequencing</h4>
<div class="outline-text-4" id="text-org7f825eb">
<p>
<code>begin, begin0</code> æ¥æ”¶å¤šä¸ªè¡¨è¾¾å¼,å¹¶ä¸”æŒ‰é¡ºåºæ‰§è¡Œ.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">if &#30340;&#27599;&#20010;&#20998;&#25903;&#21482;&#33021;&#21482;&#33021;&#25509;&#21463;&#19968;&#20010;&#34920;&#36798;&#24335;,&#22914;&#26524;&#24819;&#22312;&#26576;&#19968;&#20010;&#20998;&#25903;&#25353;&#24207;&#25191;&#34892;&#22810;&#20010;&#34920;&#36798;&#24335;&#24182;&#19988;&#36820;&#22238;&#26368;&#21518;&#19968;&#20010;&#34920;&#36798;&#24335;&#30340;&#20540;,&#21487;&#20197;&#29992;begin</span>
(<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? 1)
    (void)
    (<span style="color: #F0DFAF; font-weight: bold;">begin</span>
      (display <span style="color: #CC9393;">"1 is not 0"</span>)
      (newline)
      2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36824;&#26377;&#19968;&#20010;begin0,&#19982;begin&#31867;&#20284;,&#19981;&#21516;&#22312;&#20110;&#23427;&#36820;&#22238;&#31532;&#19968;&#20010;&#34920;&#36798;&#24335;&#30340;&#20540;</span>

(<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? 1)
    (void)
    (begin0
      2
      (display <span style="color: #CC9393;">"1 is not 0"</span>)
      (newline))) <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">2</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#26377;&#24456;&#22810;forms,&#27604;&#22914;lambda,cond,when,unless&#31561;&#31561;&#19981;&#38656;&#35201;begin&#20063;&#25903;&#25345;&#25353;&#24207;&#25191;&#34892;,&#35828;&#36825;&#31181;form&#26263;&#21547;&#19968;&#20010;begin form.</span>

<span style="color: #7F9F7F;">&#23427;&#20204;&#37117;&#26159;Macro,&#23637;&#24320;&#30340;&#35805;&#30340;&#30830;&#26377;&#19968;&#20010;begin form.</span>
<span style="color: #7F9F7F;">|#</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org91b36e9" class="outline-4">
<h4 id="org91b36e9">Assignment: set!</h4>
<div class="outline-text-4" id="text-org91b36e9">
<p>
è¿™è‡ªå·±ä¸»è¦æ˜¯ä»‹ç»ä»€ä¹ˆæ—¶å€™ç”¨ <code>set!</code> .
</p>

<p>
ä¸ªäººè§‰å¾—,æ²¡æœ‰åŠæ³•æˆ–è€…èƒ½æ›´å…·å¯è¯»æ€§çš„æƒ…å†µä¸‹ç”¨ <code>set!</code> æ˜¯æ²¡é—®é¢˜çš„;å¯ä»¥ä¸ç”¨ <code>set!</code> çš„æƒ…å†µä¸‹ç”¨ <code>set!</code> å°±æœ‰é—®é¢˜äº†.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">OK</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">next-number!</span>
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([n 0])
    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
      (set! n (add1 n))
      n)))

(next-number!) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
(next-number!) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>
(next-number!) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Bad,&#22240;&#20026;&#36825;&#20010;&#21487;&#20197;&#29992;&#23614;&#36882;&#24402;&#25110;&#32773;&#30452;&#25509;&#29992;(apply + arg ...)&#35299;&#20915;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">sum</span> lst)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([s 0])
    (<span style="color: #F0DFAF; font-weight: bold;">for-each</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (i) (set! s (+ i s)))
              lst)
    s))
</pre>
</div>

<p>
ä¸æ­£ç¡®ä½¿ç”¨ <code>set!</code> æœ‰ä¸¤æ–¹é¢çš„åå½±å“:
</p>

<ul class="org-ul">
<li>æ€§èƒ½,æ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦åˆ†é…ç©ºé—´;</li>

<li>å¯è¯»æ€§,è¦æ—¶åˆ»è·Ÿè¸ªå˜é‡/å¯¹è±¡çš„å€¼,å¤§å‹é¡¹ç›®é˜…è¯»èµ·æ¥ä¼šå¾ˆä¸æ–¹ä¾¿,æ¨¡ç³Šç»‘å®š.</li>
</ul>
</div>
</div>

<div id="outline-container-org114eb44" class="outline-4">
<h4 id="org114eb44">Quoting and Quasiquoting</h4>
<div class="outline-text-4" id="text-org114eb44">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(quote symbol)
'symbol       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the same</span>
'(this is a list)

(quasiquote symbol)
`symbol       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the same</span>
`(this is a list)

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">quote form &#30340;&#31616;&#20889;&#26159; '; quasiquote form &#30340;&#31616;&#20889;&#26159; `.</span>

<span style="color: #7F9F7F;">&#19978;&#38754; quasiquote &#21644; quote &#30340;&#32467;&#26524;&#37117;&#26159;&#30456;&#21516;&#30340;.</span>

<span style="color: #7F9F7F;">&#19981;&#21516;&#30340;&#22320;&#26041;&#22312;&#20110;, quasiquote &#20801;&#35768;&#20351;&#29992; unquote &#25805;&#20316;&#35753;&#23427;&#30340;&#21442;&#25968;&#36816;&#31639;&#20197;&#21450; unquote-splicing &#25805;&#20316;&#21435;&#25481;list&#30340;&#25324;&#21495;.</span>

<span style="color: #7F9F7F;">unquote form &#30340;&#31616;&#20889;&#26159; ,; unquote-splicing form &#30340;&#31616;&#20889;&#26159; ,@.</span>
<span style="color: #7F9F7F;">|#</span>

(quote (This is (+ 1 2))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(This is (+ 1 2))</span>

(quasiquote (This is (unquote (+ 1 2)))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(This is 3)</span>
`(This is ,(+ 1 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the same</span>

(quasiquote ((unquote-splicing (list 1 '+ 2)) is 3)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 + 2 is 3)</span>
`(,@(list 1 '+ 2) is 3)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4049068" class="outline-4">
<h4 id="org4049068">Simple Dispatch: case</h4>
<div class="outline-text-4" id="text-org4049068">
<p>
è¿™æ˜¯è·Ÿ <code>Pattern Matching</code> ç›¸å…³çš„ form.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31532;&#19968;&#20010;&#20363;&#23376;&#31867;&#20284; cond &#30340;&#29992;&#27861;</span>
(<span style="color: #F0DFAF; font-weight: bold;">case</span> (random 1 7)
  [(1) 'one]
  [(2) 'two]
  [(3) 'three]
  [(4) 'four]
  [(5) 'five]
  [else 'six])

(<span style="color: #F0DFAF; font-weight: bold;">case</span> (random 1 7)
  [(1 2 3) 'less-than-4]
  [(4 5 6) 'bigger-than-3])

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#27809;&#26377;&#25104;&#21151;&#21305;&#37197;&#30340;&#39033;&#23601;&#20250;&#25253;&#38169;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0dd1036" class="outline-4">
<h4 id="org0dd1036">Dynamic Binding: parameterize</h4>
<div class="outline-text-4" id="text-org0dd1036">
<p>
å…ˆä»è¯­è¨€ä½¿ç”¨è€…çš„è§’åº¦æ¥è¯´æ˜ä¸€ä¸‹è¯æ³•ä½œç”¨åŸŸ(static scope, lexical scope or lexical binding)å’ŒåŠ¨æ€ä½œç”¨åŸŸ(dynamic scope or dynamic binding),
</p>

<p>
(ä¸ä»å®ç°ç›´è¯‘å™¨çš„ç»†èŠ‚è¯´,ä¸»è¦æ˜¯æˆ‘ç›®å‰è¿˜æ²¡å®ç°è¿‡åŠ¨æ€ä½œç”¨åŸŸçš„è¯­è¨€,äº†è§£ä¸æ·±;å¦å¤–ä¸€ä¸ªåŸå› ç…§é¡¾æ²¡æœ‰äº†è§£è¿‡ç›´è¯‘å™¨çš„è¯»è€…).
</p>

<p>
ä¸¤è€…çš„å·®åˆ«åœ¨äºå¯¹å¾…è‡ªç”±å˜é‡æ–¹å¼ä¸ä¸€æ ·:
</p>

<ul class="org-ul">
<li><p>
è¯æ³•ç»‘å®šä¼šåœ¨å®šä¹‰æ—¶å€™æŠŠç¯å¢ƒæ‰“åŒ…è¿›å‡½æ•°çš„å®šä¹‰,è¿™é‡Œçš„ç¯å¢ƒå°±æ˜¯å˜é‡çš„ç»‘å®šè¡¨,ä»å¼•ç”¨çš„åœ°æ–¹å‘å¤–æŸ¥æ‰¾è‡ªç”±å˜é‡çš„ç»‘å®š.
</p>

<p>
æ¯æ¬¡è°ƒç”¨å‡½æ•°çš„æ—¶å€™ä¼šæ ¹æ®å‚æ•°å’Œå·²ç»è¢«æ‰“åŒ…çš„å˜é‡ç»‘å®šè¡¨ç»™å‡½æ•°å®šä¹‰æ›´æ–°ç»‘å®šè¡¨,è¿™å¼ ç»‘å®šè¡¨ä¸å…¨å±€çš„ç»‘å®šè¡¨æ˜¯äº’ä¸å½±å“,
</p>

<p>
ä¹Ÿå°±æ˜¯è¯´è¯æ³•ç»‘å®šæœ‰å¤šä¸ªç¯å¢ƒ(æ¯è°ƒç”¨ä¸€æ¬¡å‡½æ•°äº§ç”Ÿä¸€ä¸ª).
</p></li>

<li>åŠ¨æ€ç»‘å®šå°±åˆšå¥½ç›¸å,ä¸ç»´æŠ¤è‡ªç”±å˜é‡çš„ç»‘å®š,è€Œæ˜¯åœ¨è°ƒç”¨çš„åœ°æ–¹ç›´æ¥ä½¿ç”¨å½“å‰çš„ç¯å¢ƒ,è¿™æ„å‘³ç€æ‰€æœ‰å˜é‡éƒ½åœ¨åŒä¸€å¼ ç»‘å®šè¡¨é‡Œé¢,åœ¨ä¸åŒåœ°æ–¹ä»¥åŒæ ·å‚æ•°è°ƒç”¨åŒä¸€ä¸ªå‡½æ•°å¯èƒ½ä¼šæœ‰ä¸åŒç»“æœ.</li>
</ul>


<p>
å¯èƒ½æœ‰ç‚¹éš¾ç†è§£,çœ‹ä¸‹é¢ä¾‹å­å°±æ‡‚äº†,ç•™æ„ x çš„å˜åŒ–.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#35789;&#27861;&#32465;&#23450;&#28436;&#31034;</span>
#lang racket

(module mod1 racket
  (provide get-x x next-y!)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-x</span>) x)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">x</span> 0)
  (get-x) <span style="color: #5F7F5F;">;</span>
  (set! x 1)
  (get-x) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#20010;&#20363;&#23376;&#28436;&#31034;&#26356;&#26032; next-y! &#30340;&#33258;&#30001;&#21464;&#37327;&#32465;&#23450;&#34920;</span>
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">next-y!</span>
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> ((y 0))
      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
        (<span style="color: #F0DFAF; font-weight: bold;">let</span> ((res y))
          (set! y (add1 y))
          res)))))

(module mod2 racket
  (require (submod <span style="color: #CC9393;">".."</span> mod1))
  (provide next-y!)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">x</span> 2)
  (get-x)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32467;&#26524;&#26159;1&#19981;&#26159;2,&#22240;&#20026; get-x &#37324;&#38754;&#30340;&#33258;&#30001;&#21464;&#37327; x &#24341;&#29992;&#30340;&#26159; mod1 &#37324;&#38754;&#30340; x,</span>

(require 'mod2)
(next-y!) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">0</span>
(next-y!) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
(next-y!) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>
</pre>
</div>

<p>
<code>Racket</code> (åº”è¯¥æ˜¯æ²¡æœ‰çœŸæ­£çš„åŠ¨æ€ç»‘å®šçš„,æœ¬è´¨ä¸Šè¿˜æ˜¯è¯æ³•ç»‘å®š) <code>parameterize</code> å¯ä»¥å®ç°åŠ¨æ€ç»‘å®šçš„æ•ˆæœ,è¿è¡Œæ—¶å€™æ ¹æ®è°ƒç”¨å€™çš„ç¯å¢ƒæŸ¥æ‰¾å’Œå†³å®šè‡ªç”±å˜é‡.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#21160;&#24577;&#32465;&#23450;</span>
#lang racket

(module mod1 racket
  (provide get-x x)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-x</span>) (x))
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">x</span> (make-parameter 1))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#19968;&#20010;parameter(&#19981;&#26159;&#20256;&#20837;&#32473;&#20989;&#25968;&#30340;&#21442;&#25968;,&#36825;&#37324;&#30340;parameter&#26159;&#29992;&#20110;&#20351;&#29992;&#21160;&#24577;&#32465;&#23450;&#30340;&#20989;&#25968;,&#26159;&#19968;&#20010;&#31181;&#23545;&#35937;)</span>

(module mod2 racket
  (require (submod <span style="color: #CC9393;">".."</span> mod1))
  (get-x) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
  (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([x 2])
    (get-x)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2,&#36825;&#37324;&#21160;&#24577;&#25913;&#21464;&#20102;&#33258;&#30001;&#21464;&#37327; x &#30340;&#32465;&#23450;,</span>
  (get-x)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>

(require 'mod2)
</pre>
</div>

<p>
<code>parameterize</code> ç›¸å¯¹ <code>set!</code> æœ‰ä¸å°‘æœ‰ç‚¹:
</p>

<ul class="org-ul">
<li>è‡ªåŠ¨é‡è®¾å˜é‡çš„å€¼,å¯ä»¥ç”¨åœ¨å¼‚å¸¸å¤„ç†ä¸­,å¼‚å¸¸å‘ç”Ÿæ—¶å€™å¯ä»¥ç”¨äºè¿˜åŸå˜é‡.</li>

<li>è·Ÿå°¾é€’å½’ç›¸æ€§å¥½.åœ¨ <code>APS(Accumulator passing style)</code> ä¸­,å¯ä»¥åœ¨ <code>parameterize</code> form è®¡ç®—æœ€ä¸€ä¸ªè¡¨è¾¾å¼.</li>

<li>å¯ä»¥æ­£ç¡®åœ°è·Ÿçº¿ç¨‹å·¥ä½œ.åœ¨å½“å‰çº¿ç¨‹çš„è¿ç®—ä¸­ç”¨ <code>parameterize</code> form è°ƒæ•´å€¼,å¯ä»¥é¿å…ä¸å…¶å®ƒçº¿ç¨‹å‘ç”Ÿ(race conditions)ç«äº‰æ¡ä»¶.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgcaf6350" class="outline-3">
<h3 id="orgcaf6350">5 Programmer-Defined Datatypes</h3>
<div class="outline-text-3" id="text-orgcaf6350">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21487;&#20197;&#36890;&#36807;&#32467;&#26500;&#20307;&#26469;&#23450;&#20041;&#26032;&#30340;&#25968;&#25454;&#31867;&#22411;,&#38754;&#21521;&#23545;&#35937;&#32534;&#31243;&#26159;&#21478;&#22806;&#19968;&#31181;&#26041;&#27861;&#23450;&#20041;&#26032;&#30340;&#25968;&#25454;&#31867;&#22411;,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20010;&#20154;&#24863;&#35273;Racket&#30340;&#32467;&#26500;&#20307;&#22826;&#24378;&#22823;&#20102;,&#21487;&#20197;&#29702;&#35299;&#20026;&#20160;&#20040;&#38754;&#21521;&#23545;&#35937;&#32534;&#31243;&#22312;Racket&#20013;&#19981;&#27969;&#34892;.</span>

(struct posn (x y))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32467;&#26500;&#20307;&#40664;&#35748;&#27809;&#26377;&#32422;&#26463;,&#24819;&#24314;&#31435;&#32422;&#26463;&#21442;&#32771;&#31532;7&#31456;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p1</span> (posn 1 2))

(posn-x p1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
(posn-y p1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">struct-id          : &#26500;&#36896;&#20989;&#25968;(constructor function),&#23454;&#20363;&#21270;&#32467;&#26500;&#20307;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">struct-id?         : &#35859;&#35789;&#20989;&#25968;(predicate function),&#21028;&#26029;&#32467;&#26500;&#20307;&#26159;&#21542;&#32467;&#26500;&#20307;&#31867;&#22411;&#30340;&#23454;&#20363;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">struct-id-field-id : &#35775;&#38382;&#26041;&#27861;(accessor),&#33719;&#21462;&#32467;&#26500;&#20307;&#30340;&#23383;&#27573;&#30340;&#20540;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">struct:struct-id   : a structure type descriptor,&#19968;&#20010;&#34920;&#31034;&#32467;&#26500;&#20307;&#31867;&#22411;&#30340;&#20540;</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">Copying and Update</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p2</span> (struct-copy posn p1 [x 3])) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">p2&#20026; (posn 3 2)</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">Structure Subtypes</span>

(struct 3d-posn posn (z))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">3dp</span> (3d-posn 1 2 3))

(posn? 3dp) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>

(3d-posn-z 3dp) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(posn-x 3dp) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1, &#27809;&#26377;3d-posn-x&#21644;3d-posn-y&#30340;&#36873;&#25321;&#22120;</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">Opaque versus Transparent Structure Types</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#40664;&#35748;&#26159;opaque,&#29616;&#22312;&#35774;&#23450;&#20026;transparent</span>
(struct posn-t (x y)
  <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pt</span> (posn-t 1 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360;pt&#20250;&#26174;&#31034;(posn-t 12),&#22914;&#26524;&#26159;opaque&#30340;&#35805;&#20250;&#26174;&#31034; #&lt;posn-t&gt;</span>

(struct? pt)             <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t,(struct? p1)&#36820;&#22238;#f,&#23545;opaque&#20351;&#29992;&#21482;&#33021;&#36820;&#22238;#f</span>

(struct-info pt)         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(values &lt;struct-type:posn-t&gt; #f),(struct-info p1)&#36820;&#22238;(values #f #t)</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">Structure Comparisons</span>
(struct glass (width height) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">trglass</span> (glass 1 2))

(equal? trglass (glass 1 2))     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>

(struct lead (width height))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">slab</span> (lead 1 2))

(equal? slab slab)               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>

(equal? slab (lead 1 2))         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f, &#23545;&#20110;opaque&#31867;&#22411;&#30340;&#32467;&#26500;&#20307;&#26469;&#35828;&#26159;&#19981;&#33021;&#24444;&#27492;&#20043;&#38388;&#23545;&#27604;</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36824;&#26159;&#26377;&#21487;&#20197;&#22312;&#19981;&#25226;&#32467;&#26500;&#20307;&#21464;&#20026;transparent&#30340;&#24773;&#20917;&#19979;&#20570;equal?&#23545;&#27604;&#30340;.</span>
(struct lead-comparable (width height)
  <span style="color: #DCDCCC; font-weight: bold;">#:methods</span>
  gen:equal+hash
  [(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">equal-proc</span> a b equal?-recur)
     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">compare a and b</span>
     <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">equal?-recur&#26159;equal?/recur,&#29992;&#26469;&#22788;&#29702;&#36882;&#24402;&#30456;&#31561;&#27604;&#36739;&#27979;&#35797;,&#22240;&#20026;&#25968;&#25454;&#24490;&#29615;&#26159;&#19981;&#20250;&#33258;&#21160;&#22788;&#29702;&#30340;.</span>
     (<span style="color: #F0DFAF; font-weight: bold;">and</span> (equal?-recur (lead-comparable-width a) (lead-comparable-width b))
          (equal?-recur (lead-comparable-height a) (lead-comparable-height b))))
   (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">hash-proc</span> a hash-recur)
     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">compute primary hash code of a</span>
     (+ (hash-recur (lead-comparable-width a))
        (* 3 (hash-recur (lead-comparable-height a)))))
   (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">hash2-proc</span> a hash2-recur)
     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">compute secondary hash code of a</span>
     (+ (hash2-recur (lead-comparable-width a))
        (hash2-recur (lead-comparable-height a))))])

(equal? (lead-comparable 1 2) (lead-comparable 1 2))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">h</span> (make-hash))

(hash-set! h (lead 1 2) 3)
(hash-ref h (lead 1 2) (void))         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">t&#36820;&#22238;void,&#22240;&#20026;opaque&#32467;&#26500;&#20307;&#26159;&#19981;&#25903;&#25345; hash</span>

(hash-set! h (glass 1 2) 4)
(hash-ref h (glass 1 2))

(hash-set! h (lead-comparable 1 2) 3)
(hash-ref h (lead-comparable 1 2))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">Structure Type Generativity</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#27599;&#19968;&#27425;&#36816;&#31639;&#19968;&#27425; struct form &#23427;&#37117;&#20135;&#29983;&#19968;&#20010;&#19981;&#21516;&#20110;&#24050;&#23384;&#22312;&#30340;&#32467;&#26500;&#20307;&#31867;&#22411;,&#21738;&#24597;&#20854;&#23427;&#32467;&#26500;&#20307;&#31867;&#22411;&#26377;&#30528;&#30456;&#21516;&#21517;&#23383;&#21644;&#23383;&#27573;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">add-bigger-fish</span> lst)
  (struct fish (size) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    [(null? lst) (list (fish 1))]
    [else (cons (fish (* 2 (fish-size (car lst))))
                lst)]))

(add-bigger-fish null)
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(add-bigger-fish (add-bigger-fish null)) ; &#36825;&#37324;&#25253;&#38169;,&#22240;&#20026;&#31532;&#20108;&#27425;&#35843;&#29992;&#30340;&#32467;&#26500;&#20307;&#24050;&#32463;&#19981;&#26159;fish&#20102;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#27491;&#30830;&#30340;&#20570;&#27861;&#26159;&#25226;&#32467;&#26500;&#20307;&#30340;&#23450;&#20041;&#25918;&#21040;&#20989;&#25968;&#22806;</span>

(struct fish (size) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">add-bigger-fish-fixed</span> lst)
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    [(null? lst) (list (fish 1))]
    [else (cons (fish (* 2 (fish-size (car lst))))
                lst)]))

(add-bigger-fish-fixed null)
(add-bigger-fish-fixed (add-bigger-fish-fixed null))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">Prefab Structrue Types</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">prefab&#26159;"previously fabricated"&#30340;&#32553;&#20889;,&#19968;&#20010;prefab&#32467;&#26500;&#20307;&#26159;&#19968;&#20010;transparent&#32467;&#26500;&#20307;&#65292;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19981;&#36807;&#27809;&#26377;transparent&#32467;&#26500;&#20307;&#37027;&#20040;&#25277;&#35937;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">#s(prefab-pson 10 20)&#23601;&#26159;&#19968;&#20010;prefab&#32467;&#26500;&#20307;,&#23427;&#26159;"self-quoting"&#30340;,&#20063;&#23601;&#26159;&#31561;&#20110;'#s(prefab-pson 10 20)</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pre-p</span> #s(prefab-posn 10 20))
(struct prefab-posn (x y) <span style="color: #DCDCCC; font-weight: bold;">#:prefab</span>)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23450;&#20041;prefab&#32467;&#26500;&#20307;&#31867;&#22411;&#35201;&#22768;&#26126;&#20026;#:prefab&#31867;&#22411;</span>
(prefab-posn-x pre-p)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19968;&#20010;prefab&#32467;&#26500;&#20307;&#20063;&#21487;&#20197;&#26377;prefab&#23376;&#32467;&#26500;&#20307;&#31867;&#22411;</span>
(struct sub-prefab-posn prefab-posn (z))
(struct sub-prefab-pson-2 prefab-posn (z) <span style="color: #DCDCCC; font-weight: bold;">#:prefab</span>)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36319;opaque&#21644;transparent&#31867;&#22411;&#30456;&#27604;,prefab&#32467;&#26500;&#20307;&#36866;&#21512;&#29992;&#20110;&#20570;&#24207;&#21015;&#21270;</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">More Structure Type Options</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">struct form &#30340;&#23436;&#20840;&#35821;&#27861;&#26377;&#24456;&#22810;&#36873;&#39033;,&#22312;structure-type level&#21644;field level&#37117;&#25552;&#20379;&#25903;&#25345;</span>
(struct dot (x y) <span style="color: #DCDCCC; font-weight: bold;">#:mutable</span>)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">d</span> (dot 1 2))
(set-dot-x! d 10) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">set-struct-id-field-id!&#35774;&#32622;&#26041;&#27861;(mutator)&#21482;&#33021;&#22312;&#22768;&#26126;&#20102;#:mutable&#25165;&#21487;&#20197;&#20351;&#29992;</span>
(set-dot-y! d 100)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20551;&#22914;&#21482;&#35753;&#26576;&#20010;&#23383;&#27573;&#21487;&#20197;&#26356;&#25913;</span>
(struct dot-mutable-x ([x <span style="color: #DCDCCC; font-weight: bold;">#:mutable</span>] y))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">d-mutable-x</span> (dot-mutable-x 1 2))
(set-dot-mutable-x-x! d-mutable-x 11)
<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(set-dot-mutable-x-y! d-mutable-x 12) &#20250;&#25253;&#38169;</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">auto&#23383;&#27573;&#21644;auto-value,&#30456;&#24403;&#20110;&#35774;&#23450;&#40664;&#35748;&#20540;&#23383;&#27573;.auto&#23383;&#27573;&#26159;mutable&#30340;(&#36890;&#36807;&#21453;&#23556;&#25805;&#20316;),</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19981;&#36807;&#35774;&#32622;&#26041;&#27861;&#21482;&#33021;&#22312;&#25351;&#23450; #:mutable &#20043;&#21518;&#25165;&#33021;&#20351;&#29992;</span>
(struct posn-auto (x y [z <span style="color: #DCDCCC; font-weight: bold;">#:auto</span> <span style="color: #DCDCCC; font-weight: bold;">#:mutable</span>])
  <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>
  <span style="color: #DCDCCC; font-weight: bold;">#:auto-value</span> 0)

(set-posn-auto-z! (posn-auto 1 2) 10)

<span style="color: #5F7F5F;">;;</span>
(struct thing (name)
  <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">guard&#20989;&#25968;&#26159;&#19968;&#20010;&#22810;&#20540;&#20989;&#25968;,&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#20026;&#32467;&#26500;&#20307;&#31867;&#22411;&#21517;&#23383;,&#21069;&#38754;&#30340;&#25152;&#26377;&#21442;&#25968;&#37117;&#20026;&#23383;&#27573;,</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#31526;&#21512;&#35201;&#27714;&#26368;&#21518;&#35201;&#27714;&#36820;&#22238;&#25152;&#26377;&#23383;&#27573;&#30340;&#20540;.</span>
  <span style="color: #DCDCCC; font-weight: bold;">#:guard</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (name type-name)
            (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
              [(string? name) name]
              [(symbol? name) (symbol-&gt;string name)]
              [else (error type-name
                           <span style="color: #CC9393;">"bad name: ~e"</span>
                           name)])))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23376;&#32467;&#26500;&#20307;&#31867;&#22411;&#20250;&#32487;&#25215;&#36229;&#32467;&#26500;&#20307;&#31867;&#22411;&#30340;guard&#20989;&#25968;,&#20197;&#21069;&#26816;&#26597;&#36807;&#30340;&#23383;&#27573;&#21487;&#20197;&#19981;&#29992;&#20877;&#27425;&#26816;&#26597;</span>
(struct person thing (age)
  <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>
  <span style="color: #DCDCCC; font-weight: bold;">#:guard</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (name age type-name)
            (<span style="color: #F0DFAF; font-weight: bold;">if</span> (negative? age)
                (error type-name <span style="color: #CC9393;">"bad age: ~e"</span> age)
                (values name age))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32467;&#26500;&#20307;&#31867;&#22411;&#36319;&#31867;&#24046;&#19981;&#22810;,&#20063;&#26377;&#33258;&#24049;&#30340;&#26041;&#27861;(generic interface),&#36319;Python&#30340;__method__&#24046;&#19981;&#22810;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#27604;&#22914;gen:dict&#20801;&#35768;&#32467;&#26500;&#20307;&#31867;&#22411;&#24403;&#20316;&#23383;&#20856;&#20351;&#29992;;gen:custom-write&#20801;&#35768;&#33258;&#23450;&#20041;&#32467;&#26500;&#20307;&#22914;&#20309;&#34987;&#25171;&#21360;.</span>

(struct cake (candles)
  <span style="color: #DCDCCC; font-weight: bold;">#:methods</span> gen:custom-write
  [(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">write-proc</span> cake port mode)
     (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">n</span> (cake-candles cake))
     (show <span style="color: #CC9393;">"   ~a   ~n"</span> n #\. port)
     (show <span style="color: #CC9393;">" .-~a-. ~n"</span> n #\| port)
     (show <span style="color: #CC9393;">" | ~a | ~n"</span> n #\space port)
     (show <span style="color: #CC9393;">"---~a---~n"</span> n #\- port))
   (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">show</span> fmt n ch port)
     (fprintf port fmt (make-string n ch)))])

(display (cake 5))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20851;&#32852;&#32467;&#26500;&#20307;&#31867;&#22411;&#30340;&#23646;&#24615;&#21644;&#20540;,&#27604;&#22914;prop:procedure&#23646;&#24615;&#21487;&#20197;&#25226;&#32467;&#26500;&#20307;&#23454;&#20363;&#24403;&#20316;&#19968;&#20010;&#20989;&#25968;&#26469;&#20351;&#29992;</span>
(struct greeter (name)
  <span style="color: #DCDCCC; font-weight: bold;">#:property</span> prop:procedure
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (self other)
    (string-append
     <span style="color: #CC9393;">"Hi "</span> other
     <span style="color: #CC9393;">", I'm "</span> (greeter-name self))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">john-greet</span> (greeter <span style="color: #CC9393;">"John"</span>))

(john-greet <span style="color: #CC9393;">"Mary"</span>)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36824;&#26377;&#21478;&#22806;&#19968;&#31181;&#20570;&#27861;&#21487;&#20197;&#32473;&#32467;&#26500;&#20307;&#25552;&#20379;super-id,&#36890;&#36807;#:super&#35774;&#23450;super-type,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#31181;&#20570;&#27861;&#26377;&#19968;&#20010;&#22909;&#22788;&#23601;&#26159;&#20197;&#21069;&#30340;&#26087;&#26041;&#27861;&#21482;&#33021;&#20256;&#20837;super-id(&#19981;&#26159;&#19968;&#20010;&#34920;&#36798;&#24335;,&#19981;&#33021;&#34987;&#36816;&#31639;),</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32780;#:super&#21487;&#20197;&#25552;&#20379;&#19968;&#20010;super-expr(&#20135;&#29983;&#19968;&#20010;structure type descriptor)&#26469;&#35774;&#23450;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">m/struct-constructor</span> super-type)
  (struct m/struct ()
    <span style="color: #DCDCCC; font-weight: bold;">#:super</span> super-type
    <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)
  m/struct)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">sub-posn</span> (m/struct-constructor struct:posn))
</pre>
</div>
</div>
</div>

<div id="outline-container-org83ec79a" class="outline-3">
<h3 id="org83ec79a">6 Modules</h3>
<div class="outline-text-3" id="text-org83ec79a">
</div>
<div id="outline-container-org3ad2ec2" class="outline-4">
<h4 id="org3ad2ec2">Module Basis</h4>
<div class="outline-text-4" id="text-org3ad2ec2">
</div>
<ul class="org-ul">
<li><a id="orge711f91"></a>Organizing Modules<br>
<div class="outline-text-5" id="text-orge711f91">
<p>
<code>directory</code> çš„æ–‡ä»¶å¦‚ä¸‹
</p>

<div class="org-src-container">
<pre class="src src-sh">salt@salt:~/Downloads/directory$ tree
.
&#9500;&#9472;&#9472; mod.rkt
&#9492;&#9472;&#9472; subdir
    &#9500;&#9472;&#9472; mod-1.rkt
    &#9492;&#9472;&#9472; mod-2.rkt

1 directory, 3 files
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">mod.rkt</span>
#lang racket
(require <span style="color: #CC9393;">"subdir/mod-1.rkt"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">subdir/mod-1.rkt</span>
#lang racket
(provide variable)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">variable</span> 1)
(displayln variable)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">subdir/mod-2.rkt</span>
#lang racket
(require <span style="color: #CC9393;">"mod-1.rkt"</span>)
</pre>
</div>

<p>
<code>mod.rkt</code>, <code>mod-1.rkt</code> å’Œ <code>mod-2.rkt</code> æ˜¯æ¨¡å—,å…¶ä¸­ <code>mod.rkt</code> å’Œ <code>mod-2.rkt</code> å¯¼å…¥ <code>mod-1.rkt</code> æ¨¡å—.
</p>
</div>
</li>

<li><a id="org6719e40"></a>Library Collections<br>
<div class="outline-text-5" id="text-org6719e40">
<p>
ä¸€ä¸ªåº“å°±æ˜¯ä¸€ä¸ªç»„å±‚æ¬¡åˆ†æ˜çš„å·²å®‰è£…åº“æ¨¡å—.ä¸€ä¸ªåº“é‡Œé¢çš„æ¨¡å—æ˜¯é€šè¿‡ä¸€ä¸ªunquotedå’Œæ²¡æœ‰åç¼€çš„è·¯å¾„å¼•ç”¨çš„.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(require racket/trait)
</pre>
</div>

<p>
ä¸Šé¢è¿™ä¸ªä¾‹å­é‡Œé¢çš„ <code>racket/trait</code> å°±æ˜¯ä¸€ä¸ªåº“é‡Œé¢çš„ä¸€ä¸ªæ¨¡å—.
</p>

<p>
å½“ <code>require form</code> é‡åˆ°ä¸€ä¸ªunquotedè·¯å¾„çš„æ—¶å€™ä¼šè‡ªåŠ¨æŠŠå®ƒè½¬æ¢æˆæ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´è·¯å¾„:
</p>

<ol class="org-ol">
<li><p>
å¦‚æœ <code>unquoted</code> è·¯å¾„ä¸­æ²¡æœ‰ <code>/</code>, é‚£ä¹ˆ <code>require</code> ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ª <code>/main</code> .
</p>

<p>
æ¯”å¦‚, <code>(require racket)</code> ç­‰äº <code>(require racket/main)</code> .
</p></li>

<li><code>require</code> ä¼šè‡ªåŠ¨ç»™è·¯å¾„åŠ ä¸Š <code>".rkt"</code> åç¼€.</li>

<li>æ ¹æ®ä¸Šé¢ä¸¤æ­¥çš„ç»“æœ,åœ¨åº“çš„å®‰è£…è·¯å¾„æŸ¥æ‰¾æ¨¡å—.</li>
</ol>
</div>
</li>

<li><a id="org7c98356"></a>Packages and Collections<br>
<div class="outline-text-5" id="text-org7c98356">
<p>
åŒ…å°±æ˜¯åº“çš„é›†åˆ,è¿™äº›åŒ…å¯ä»¥é€šè¿‡ <code>Racket package manager</code> å®‰è£…(æˆ–è€…é¢„è£…)å¾—åˆ°.
</p>
</div>
</li>

<li><a id="orgbea3138"></a>Adding Collections<br>
<div class="outline-text-5" id="text-orgbea3138">
<p>
ä¸Šé¢çš„ <code>directory</code> å…¶å®æ˜¯ä¸€ä¸ªåŒ…,æ˜¯å¯ä»¥å®‰è£…çš„,ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤.
</p>

<div class="org-src-container">
<pre class="src src-sh">salt@salt:~/Downloads/directory$ raco pkg install
Linking current directory as a package
raco setup: version: 6.11
raco setup: platform: x86_64-linux [3m]
raco setup: installation name: 6.11
raco setup: variants: 3m
raco setup: main collects: /usr/share/racket/collects
raco setup: collects paths:
raco setup:   /home/salt/.racket/6.11/collects
raco setup:   /usr/share/racket/collects
raco setup: main pkgs: /usr/share/racket/pkgs
raco setup: pkgs paths:
raco setup:   /usr/share/racket/pkgs
raco setup:   /home/salt/.racket/6.11/pkgs
raco setup: links files:
raco setup:   /usr/share/racket/links.rktd
raco setup:   /home/salt/.racket/6.11/links.rktd
raco setup: main docs: /usr/share/doc/racket
raco setup: --- updating info-domain tables ---
raco setup: --- pre-installing collections ---
raco setup: --- installing foreign libraries ---
raco setup: --- installing shared files ---
raco setup: --- compiling collections ---
raco setup: --- parallel build using 4 jobs ---
raco setup: 3 making: &lt;pkgs&gt;/directory
raco setup: 3 making: &lt;pkgs&gt;/directory/subdir
raco setup: --- creating launchers ---
raco setup: --- installing man pages ---
raco setup: --- building documentation ---
raco setup: --- installing collections ---
raco setup: --- post-installing collections ---
</pre>
</div>

<p>
åœ¨ä»£ç ä¸­å¯ä»¥è¿™æ ·å¼•ç”¨è¿™ä¸ª <code>collection</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(require directory/mod)
</pre>
</div>

<p>
å®é™…ä¸Š,ä½ å‡ ä¹å¯ä»¥å¯¹ä»»ä½•æ–‡ä»¶å¤¹è¿›è¡Œå®‰è£…, <code>raco</code> å®‰è£…æœ¬åœ°çš„åŒ…éƒ½æ˜¯å»ºç«‹è½¯é“¾æ¥å¼•ç”¨åŒ….
</p>

<p>
åˆ©ç”¨è¿™ç‚¹,åœ¨å¹³æ—¶å¼€å‘åŒ…çš„æ—¶å€™å¯ä»¥å…ˆå®‰è£…å¼€å‘ç›®å½•ç„¶åå¼€å‘,è¿™æ ·å¯ä»¥è¾¹å¼€å‘è¾¹æµ‹è¯•.(è¿™ç‚¹çœŸçš„æ˜¯å¥½è¯„).
</p>

<p>
æµ‹è¯•å®Œååˆ«å¿˜äº†ç§»é™¤æµ‹è¯•åŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">salt@salt:~/Downloads/directory$ raco pkg remove directory
Removing directory
raco setup: version: 6.11
raco setup: platform: x86_64-linux [3m]
raco setup: installation name: 6.11
raco setup: variants: 3m
raco setup: main collects: /usr/share/racket/collects
raco setup: collects paths:
raco setup:   /home/salt/.racket/6.11/collects
raco setup:   /usr/share/racket/collects
raco setup: main pkgs: /usr/share/racket/pkgs
raco setup: pkgs paths:
raco setup:   /usr/share/racket/pkgs
raco setup:   /home/salt/.racket/6.11/pkgs
raco setup: links files:
raco setup:   /usr/share/racket/links.rktd
raco setup:   /home/salt/.racket/6.11/links.rktd
raco setup: main docs: /usr/share/doc/racket
raco setup: --- updating info-domain tables ---
raco setup: --- pre-installing collections ---
raco setup: --- installing foreign libraries ---
raco setup: --- installing shared files ---
raco setup: --- compiling collections ---
raco setup: --- parallel build using 4 jobs ---
raco setup: --- creating launchers ---
raco setup: --- installing man pages ---
raco setup: --- building documentation ---
raco setup: --- installing collections ---
raco setup: --- post-installing collections ---
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgdc9f2c2" class="outline-4">
<h4 id="orgdc9f2c2">Module Syntax</h4>
<div class="outline-text-4" id="text-orgdc9f2c2">
<p>
<code>#lang</code> ç”¨äºæ¨¡å—æ–‡ä»¶çš„å¼€å¤´,ç”¨äºå£°æ˜æ¨¡å—åå­—(é»˜è®¤ä¸ºæ²¡æœ‰æ–‡ä»¶åç¼€çš„æ¨¡å—æ–‡ä»¶åå­—)å’Œåˆå§‹çš„æ¨¡å—è·¯å¾„(ç”¨äºåˆå§‹åŒ–å¯¼å…¥),ä¸èƒ½ç”¨äº <code>REPL</code> ä¸­,å¹¶ä¸”ä¸€ä¸ªæ¨¡å—æ–‡ä»¶ä¸èƒ½æœ‰å¤šä¸ª <code>#lang</code> å£°æ˜.
</p>

<p>
<code>module</code> form æ˜¯ <code>#lang</code> çš„ç®€å†™,è¦æ‰‹åŠ¨æŒ‡å®šæ¨¡å—åå­—,å¯ä»¥ç”¨åœ¨ <code>REPL</code> ä¸­,ä¸€ä¸ªæ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ª <code>module</code> forms.
</p>
</div>

<ul class="org-ul">
<li><a id="orga3dcd83"></a>The module Form<br>
<div class="outline-text-5" id="text-orga3dcd83">
<p>
æŠŠå‰é¢ <code>directory</code> çš„ä¾‹å­æ”¹ä¸º
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">mod.rkt</span>
(module mod racket
  (require <span style="color: #CC9393;">"subdir/mod-1.rkt"</span>))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">subdir/mod-1.rkt</span>
(module mod-1 racket
  (provide variable)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">variable</span> 1)
  (displayln variable))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">subdir/mod-2.rkt</span>
(module mod-2 racket
  (require <span style="color: #CC9393;">"mod-1.rkt"</span>))
</pre>
</div>

<p>
è¿è¡Œ <code>module</code> form å®šä¹‰é‡Œé¢çš„è¡¨è¾¾å¼æ˜¯ä¸ä¼šè¿è¡Œ,é™¤é <code>require</code> å®ƒä»¬.
</p>

<p>
ä¾‹å¦‚åœ¨ <code>REPL</code> ä¸­è¿è¡Œ <code>mod-1</code> é‡Œé¢çš„ä»£ç ,
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (require <span style="color: #CC9393;">'mod-1)</span>
<span style="color: #CC9393;">1</span>
<span style="color: #CC9393;">&gt;</span>
</pre>
</div>
</div>
</li>

<li><a id="org9f11fdb"></a>The #lang Shorthand<br>
<div class="outline-text-5" id="text-org9f11fdb">
<p>
ä¸Šé¢å·²ç»è¯´çš„æŒºæ¸…æ¥šäº†,ä¸å†è¯´.
</p>
</div>
</li>

<li><a id="orgc90dec2"></a>Submodules<br>
<div class="outline-text-5" id="text-orgc90dec2">
<p>
æ¨¡å—é‡Œé¢å¯ä»¥åµŒå¥—æ¨¡å—,è¢«åµŒå¥—çš„æ¨¡å—å«åšå­æ¨¡å—.å­æ¨¡å—ä¹Ÿå¯ä»¥åµŒå¥—å­æ¨¡å—.åŒä¸€é—­åˆæ¨¡å—é‡Œé¢ä¸èƒ½æœ‰ç›¸åŒåå­—çš„å­æ¨¡å—.
</p>

<p>
å­æ¨¡å—å¯ä»¥ç›´æ¥è¢«é—­åˆ(enclosing)çš„æ¨¡å—ä¸€ä¸ª <code>quoted name</code> è°ƒç”¨.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(module s-mod racket
  (displayln <span style="color: #CC9393;">"You are requiring the s-mod module"</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">mod-name</span> 's-mod))

(require 's-mod)
(displayln mod-name)
</pre>
</div>

<p>
å¦‚æœä¸æ˜¯è¢«é—­åˆæ¨¡å—å¼•ç”¨çš„è¯,é‚£å°±å¾—ç”¨ <code>submod path</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(module s-mod racket
  (displayln <span style="color: #CC9393;">"You are requiring the s-mod module"</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">mod-name</span> 's-mod))

(module s-mod-2 racket
  (require (submod <span style="color: #CC9393;">".."</span> s-mod))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">".." &#34920;&#31034; s-mod-2 &#30340;&#19978;&#19968;&#32423;&#21035;&#27169;&#22359;,&#36825;&#37324;&#19981;&#30693;&#36947;&#19978;&#19968;&#32423;&#27169;&#22359;&#30340;&#21517;&#23383;&#25165;&#29992; ".."</span>

(require 's-mod-2)
</pre>
</div>

<p>
åœ¨çŸ¥é“ä¸Šä¸€çº§æ¨¡å—åå­—çš„æƒ…å†µä¸‹,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(module mod
  (module s-mod racket
    (displayln <span style="color: #CC9393;">"You are requiring the s-mod module"</span>)
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">mod-name</span> 's-mod)))

(require (submod 'mod s-mod))
</pre>
</div>

<p>
<code>module*</code> form ç±»ä¼¼äº <code>module</code> form.åŒºåˆ«åœ¨äº:
</p>

<ol class="org-ol">
<li>é€šè¿‡ <code>module</code> å®šä¹‰çš„å­æ¨¡å—å¯ä»¥è¢«å®ƒçš„é—­åˆæ¨¡å— <code>require</code>, è€Œå­æ¨¡å—ä¸å¯ä»¥ <code>require</code> é—­åˆæ¨¡å—æˆ–è€…è¯æ³•å¼•ç”¨é—­åˆæ¨¡å—çš„ç»‘å®š.</li>

<li><p>
é€šè¿‡ <code>module*</code> å®šä¹‰çš„å­æ¨¡å—å¯ä»¥ <code>require</code> å®ƒçš„é—­åˆæ¨¡å—,ä½†æ˜¯é—­åˆæ¨¡å—ä¸èƒ½ <code>require</code> å­æ¨¡å—.
</p>

<p>
å¦å¤– <code>module*</code> from å¯ä»¥æŒ‡å®šå®ƒçš„çš„äºŒä¸ªå‚æ•° <code>initial-module-path</code> ä¸º <code>#f</code>,
</p>

<p>
è¿™æ ·å­æ¨¡å—å¯ä»¥çœ‹åˆ°å®ƒçš„é—­åˆæ¨¡å—çš„æ‰€æœ‰ç»‘å®š,åŒ…æ‹¬æ²¡æœ‰è¢« <code>provide</code> çš„ç»‘å®š.
</p></li>
</ol>

<p>
æœ‰ä¸€ä¸ªç”¨æ³•å°±æ˜¯é€šè¿‡ <code>module*</code> å®šä¹‰çš„å­æ¨¡å— <code>provide</code> é—­åˆæ¨¡å—æ²¡æœ‰å¯¼å‡ºçš„ç»‘å®š.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">enclose.rkt</span>
#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">enclosing-function</span>)
  (displayln <span style="color: #CC9393;">"I am defined by enclosing module but not exported"</span>))

(module* extras #f
  (provide enclosing-function))
</pre>
</div>

<p>
<code>require</code> <code>extras</code> é‡Œé¢çš„ç»‘å®š
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (require (submod <span style="color: #CC9393;">"enclose.rkt"</span> extras))
</pre>
</div>
</div>
</li>


<li><a id="org3f0bac2"></a>Main and Test Submodules<br>
<div class="outline-text-5" id="text-org3f0bac2">
<p>
ä¸Šé¢å·²ç»æ¼”ç¤ºäº†, <code>module</code>, <code>module*</code> å®šä¹‰çš„æ¨¡å—æ˜¯ä¸ä¼šè¿è¡Œçš„,å‡†ç¡®æ¥è¯´æ˜¯é—­åˆæ¨¡å—æ²¡æœ‰ <code>require</code> å®ƒçš„å­æ¨¡å—çš„æƒ…å†µä¸‹,å­æ¨¡å—æ˜¯ä¸ä¼šè¿è¡Œçš„.
</p>

<p>
ä½†æ˜¯æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„å­æ¨¡å—åå­—æ˜¯å¯ä»¥è¿è¡Œçš„, <code>main</code> å’Œ <code>test</code> . (æˆ‘è§‰å¾—ä¸æ–‡ä»¶åŒåçš„å­æ¨¡å—ä¹Ÿæ˜¯æŒºç‰¹æ®Šçš„)
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">mod.rkt</span>
#lang racket
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">mod-name</span> 'mod)

(module* main #f
  (displayln (format <span style="color: #CC9393;">"I am ~s"</span> mod-name)))

(module* test #f
  (displayln (eq? mod-name 'mod)))
</pre>
</div>

<p>
åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ,
</p>

<div class="org-src-container">
<pre class="src src-sh">salt@salt:~$ raco test mod.rkt
raco test: (submod <span style="color: #CC9393;">"mod.rkt"</span> test)
<span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">t</span>
salt@salt:~$ racket mod.rkt
I am mod
</pre>
</div>

<p>
ä¸€èˆ¬è¿™ä¸¤ä¸ªå­æ¨¡å—éƒ½æ˜¯é€šè¿‡ <code>module+</code> å®šä¹‰çš„,å®ƒç›¸å½“äºç¬¬äºŒä¸ªå‚æ•°ä¸º <code>#f</code> çš„ <code>module*</code> ,æ­¤å¤–å®ƒæ”¯æŒå®šä¹‰å¤šä¸ªé‡åçš„å­æ¨¡å—,è¿™äº›é‡åçš„å­æ¨¡å—ä¼šè‡ªåŠ¨åˆå¹¶èµ·æ¥.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org711e108" class="outline-4">
<h4 id="org711e108">Module Paths</h4>
<div class="outline-text-4" id="text-org711e108">
<p>
<code>require</code> æˆ–è€… <code>module</code> form é‡Œé¢çš„ç¬¬äºŒä¸ªå‚æ•° <code>initial-module-path</code> å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§forms:
</p>

<ul class="org-ul">
<li><p>
(quote id)
</p>

<p>
å¼•ç”¨éæ–‡ä»¶æ¨¡å— (non-file module).
</p></li>

<li><p>
rel-string
</p>

<p>
ç›¸å¯¹è·¯å¾„å­—ç¬¦ä¸², <code>Unix-style</code> è§„èŒƒçš„ <code>/</code> , <code>..</code> å’Œ <code>.</code> ,åˆ†åˆ«ä»£è¡¨æ ¹ç›®å½•,ä¸Šä¸€çº§åˆ«ç›®å½•å’ŒåŒçº§ç›®å½•.
</p>

<p>
<code>rel-string</code> ä¸€å®šä¸èƒ½ä»¥ <code>/</code> æœ€ä¸ºå¼€å¤´æˆ–è€…ç»“å°¾.
</p>

<p>
å¦‚æœç›¸å¯¹è·¯å¾„æ˜¯ä»¥ <code>".ss"</code> ç»“å°¾çš„,å®ƒä¼šè¢«è½¬æ¢æˆ <code>".rkt"</code> . å½“å°è¯•åŠ è½½æ–‡ä»¶çš„æ—¶å€™,
</p>

<p>
å¦‚æœå®ç°äº†è¢«å¼•ç”¨æ¨¡å—çš„æ–‡ä»¶çš„ç¡®æ˜¯ä»¥ <code>".ss"</code> åç¼€çš„è¯,é‚£ä¹ˆåç¼€ä¼šè¢«å˜ä¼š <code>".ss"</code> .è¿™ä¹ˆåšæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆçš„ Racket æ–‡ä»¶.
</p></li>

<li><p>
id
</p>

<p>
å·²ç»å®‰è£…çš„åº“çš„æ¨¡å—è·¯å¾„ <code>unquoted identifier</code>. <code>/</code> ç”¨äºåˆ†éš”æ¨¡å—è·¯å¾„çš„è·¯å¾„å…ƒç´ ,å…ƒç´ æ˜¯æŒ‡ collection å’Œ sub-collection, è€Œä¸æ˜¯
</p>

<p>
ç›®å½•å’Œå­ç›®å½•.
</p></li>

<li><p>
(lib rel-string)
</p>

<p>
è·Ÿ <code>unquoted-identifier</code> è·¯å¾„ç±»ä¼¼,ä¸è¿‡,è·¯å¾„æ˜¯ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„,ä¸æ˜¯ <code>identifier</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">(lib <span style="color: #CC9393;">"racket"</span>)
(lib <span style="color: #CC9393;">"racket/main"</span>)
(lib <span style="color: #CC9393;">"racket/main.rkt"</span>)
(lib racket)
</pre>
</div>

<p>
è¿™å››ä¸ªæ˜¯ä¸€æ ·çš„. <code>id</code> æ˜¯ <code>lib</code> çš„ç®€å†™.
</p></li>

<li><p>
<code>(planet id)</code>
</p>

<p>
é€šè¿‡ <code>PLaneT</code> æœåŠ¡å™¨åˆ©ç”¨ <code>id</code> è®¿é—®ç¬¬ä¸‰æ–¹åº“,ç¬¬ä¸€æ¬¡æ—¶å€™å®‰è£…éœ€è¦çš„åº“. <code>id</code> çš„è§„èŒƒå’Œä¸Šé¢çš„ä¸€æ ·.
</p></li>

<li><p>
<code>(planet package-string)</code>
</p>

<p>
<code>(planet id)</code> çš„å­—ç¬¦ä¸²ç‰ˆæœ¬.
</p></li>

<li><p>
<code>(planet rel-string (user-string pkg-string vers ...))</code>
</p>

<p>
åƒ <code>lib</code> ä¸€æ ·çš„ <code>rel-string</code>, ä¸è¿‡åé¢è¿˜æœ‰ä½œè€…,åŒ…å’Œåº“çš„ç‰ˆæœ¬.
</p></li>

<li><p>
<code>(file string)</code>
</p>

<p>
æƒ³ä¸å‡ºè·Ÿ <code>rel-string</code> æœ‰ä»€ä¹ˆåŒºåˆ«.
</p></li>

<li><p>
<code>(submod base element ...+)</code>
</p>

<p>
å­æ¨¡å—ä¸Šé¢å·²ç»æœ‰ä¾‹å­.è¿™é‡Œå°±ä¸è¯´äº†.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org1b8ed4e" class="outline-4">
<h4 id="org1b8ed4e">Imports: require</h4>
<div class="outline-text-4" id="text-org1b8ed4e">
<p>
å¯¼å…¥åˆ«çš„æ¨¡å—,å¤§è‡´ç”¨æ³•.
</p>

<p>
<code>(require require-spec ...)</code>
</p>

<p>
ä»¥ä¸‹æ˜¯ <code>require-spec</code> å…è®¸çš„ forms:
</p>

<ul class="org-ul">
<li><p>
<code>module-path</code>
</p>

<p>
å¯¼å…¥æ¨¡å—çš„æ‰€æœ‰ç»‘å®š
</p></li>

<li><p>
<code>(only-in require-spec id-maybe-renamed ...)</code>
</p>

<p>
å¯¼å…¥æŒ‡å®šçš„æ¨¡å—ç»‘å®š
</p></li>

<li><p>
<code>(except-in require-spec id ...)</code>
</p>

<p>
å¯¼å…¥æŒ‡å®šä»¥å¤–çš„æ¨¡å—ç»‘å®š
</p></li>

<li><p>
<code>(rename-in require-spec [orig-id bind-id] ...)</code>
</p>

<p>
æŠŠå¯¼å…¥çš„æ¨¡å—ç»‘å®šé‡å‘½å
</p></li>

<li><p>
<code>(prefix-in prefix-id require-spec)</code>
</p>

<p>
<code>rename-in</code> çš„ç®€å†™,ç»™ <code>require-spec</code> æ¯ä¸ªç»‘å®šæ·»åŠ ä¸€ä¸ª <code>prefix-id</code> å‰ç¼€.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org8c8aad9" class="outline-4">
<h4 id="org8c8aad9">Exports: provide</h4>
<div class="outline-text-4" id="text-org8c8aad9">
<p>
é»˜è®¤æƒ…å†µä¸‹,æ¨¡å—çš„å®šä¹‰éƒ½æ˜¯ç§æœ‰çš„, <code>provide</code> æŒ‡å®šå¯ä»¥è¢«åˆ«çš„æ¨¡å— <code>require</code> çš„å®šä¹‰.
</p>

<p>
<code>(provide provide-spec ...)</code>
</p>

<p>
<code>provide-spec</code> æ‰€å…è®¸çš„ forms å¦‚ä¸‹:
</p>

<ul class="org-ul">
<li><p>
<code>identifier</code>
</p>

<p>
æŒ‡å®šæ¨¡å—å†…è¦å¯¼å‡ºçš„ç»‘å®š
</p></li>

<li><p>
<code>(rename-out [orig-id export-id] ...)</code>
</p>

<p>
é‡å‘½è¦å¯¼å‡ºçš„æ¨¡å—ç»‘å®š
</p></li>

<li><p>
<code>(struct-out struct-id)</code>
</p>

<p>
æŠŠç»“æ„ä½“çš„ç›¸å…³ç»‘å®šå…¨éƒ¨å¯¼å‡º(å› ä¸ºå®šä¹‰ç»“æ„ä½“ä¹Ÿä¼šè‡ªåŠ¨äº§ç”Ÿå¾ˆå¤šå¯¹åº”çš„æ–¹æ³•).
</p></li>

<li><p>
<code>(all-defined-out)</code>
</p>

<p>
æ¨¡å—å†…çš„æ‰€æœ‰ç»‘å®šå…¨éƒ¨å¯¼å‡º
</p></li>

<li><p>
<code>(all-from-out module-path)</code>
</p>

<p>
å¯¼å‡ºæŒ‡å®šæ¨¡å—å†…æ‰€æœ‰å…è®¸å¯¼å‡ºçš„ç»‘å®š
</p></li>

<li><p>
<code>(except-out provide-sepc id ...)</code>
</p>

<p>
å¯¼å‡ºæŒ‡å®šä»¥å¤–çš„æ¨¡å—å®šä¹‰
</p></li>

<li><p>
<code>(prefix-out prefix-id provide-spec)</code>
</p>

<p>
ç»™ <code>provide-spec</code> çš„æ¯ä¸ªç»‘å®šæ·»åŠ  <code>prefix-id</code> å‰ç¼€å¹¶ä¸”å¯¼å‡º.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org759927a" class="outline-4">
<h4 id="org759927a">Assignment and Redefinition</h4>
<div class="outline-text-4" id="text-org759927a">
<p>
å…³äº <code>set!</code> ç”¨åœ¨æ¨¡å— <code>A</code> å†…éƒ¨å®šä¹‰çš„å˜é‡ä¸Š,è¿™æ˜¯å…è®¸çš„.
</p>

<p>
ç„¶è€Œä¸èƒ½åœ¨å¯¼å…¥æ¨¡å— <code>A</code> çš„æ¨¡å— <code>B</code> ä¸­å¯¹æ¨¡å— <code>A</code> å¯¼å‡ºçš„å®šä¹‰ä½¿ç”¨ <code>set!</code>.
</p>

<p>
ä¸è¿‡æ¨¡å— <code>B</code> å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>define</code> "é‡æ–°å®šä¹‰" æ¨¡å— <code>A</code> ä¸­çš„å®šä¹‰.
</p>

<p>
å…³äºæ¨¡å—çš„é‡å®šä¹‰,é»˜è®¤æ˜¯ä¸å…è®¸çš„,ä¸è¿‡å¯ä»¥é€šè¿‡ <code>(compile-enforce-module-constants #f)</code> å…è®¸æ¨¡å—é‡æ–°å®šä¹‰.
</p>
</div>
</div>

<div id="outline-container-org83f02b3" class="outline-4">
<h4 id="org83f02b3">Modules and Macros</h4>
<div class="outline-text-4" id="text-org83f02b3">
<p>
åœ¨ Macros ç« èŠ‚é‡è¯¦ç»†è®².
</p>
</div>
</div>
</div>

<div id="outline-container-org5639039" class="outline-3">
<h3 id="org5639039">7 Contracts</h3>
<div class="outline-text-3" id="text-org5639039">
<p>
<code>contract</code> çš„æ„æ€æ˜¯åå®š,åˆåŒ,ä¸è¿‡æˆ‘è§‰å¾—ç¿»è¯‘æˆçº¦æŸæŒºåˆé€‚çš„,æ‰€ä»¥ä¸‹é¢å°±ç”¨çº¦æŸè¿™ä¸€è¯.
</p>
</div>

<div id="outline-container-org6be70b3" class="outline-4">
<h4 id="org6be70b3">Contracts and Boundaries</h4>
<div class="outline-text-4" id="text-org6be70b3">
<p>
æ˜¯åœ¨å›¢ä½“ä¹‹é—´å»ºç«‹ä¸€ä¸ªè¾¹ç•Œ,åœ¨è¿™ä¸ªè¾¹ç•Œä¹‹é—´æ‰§è¡Œé™åˆ¶æ£€æŸ¥,è¿™å°±æ˜¯ <code>Racket</code> çš„çº¦æŸ.
</p>

<p>
çº¦æŸæœ‰ä¸¤ç§ä¸åŒçš„åˆ›å»ºæ–¹å¼,ä¸åŒæ–¹å¼å¯¼è‡´ä¸åŒçš„çº¦æŸè¾¹ç•Œ: <code>module boundaries</code> å’Œ <code>nested contract boundaries</code> .
</p>

<p>
<code>Racket</code> é¼“åŠ±ä¸»è¦ç”¨ <code>module boundaries</code> çº¦æŸ.
</p>

<ul class="org-ul">
<li><p>
æ¨¡å—è¾¹ç•Œ
</p>

<p>
å¯ä»¥ç»™åˆ«çš„æ¨¡å—æä¾›çº¦æŸ,ä¸¤æ–¹å›¢ä½“,åˆ†åˆ«æ˜¯å®šä¹‰çº¦æŸçš„æ¨¡å—å’Œå¼•ç”¨è¯¥æ¨¡å—çš„å…¶ä»–æ¨¡å—.
</p>

<p>
(å˜é‡åœ¨å®šä¹‰çš„æ¨¡å—ä¸­ä¹Ÿæ˜¯å—åˆ°çº¦æŸçš„,è€Œå‡½æ•°åˆ™ä¸ä¼šåœ¨å®šä¹‰çš„æ¨¡å—ä¸­å—åˆ°çº¦æŸ.åé¢ä¼šæœ‰ä¾‹å­.)
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out [amount positive?]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">amount</span> 1)
</pre>
</div></li>

<li><p>
åµŒå¥—çº¦æŸè¾¹ç•Œ
</p>

<p>
(é»˜è®¤)åªåœ¨å†…éƒ¨æä¾›çº¦æŸ,å½“ç„¶ä¹Ÿå¯ä»¥ <code>provide</code> å—çº¦æŸçš„å®šä¹‰ç»™åˆ«çš„æ¨¡å—,è¿™äº›å®šä¹‰åœ¨åˆ«çš„æ¨¡å—ä¹Ÿæ˜¯å—çº¦æŸçš„,
</p>

<p>
ä½†æ˜¯ä¸ªäººçŒœæµ‹æä¾›ç»™å¤–éƒ¨å®šä¹‰ä¸æ˜¯åµŒå¥—çº¦æŸè¾¹ç•Œçš„ç›®çš„,å› ä¸ºæ²¡æœ‰ <code>define/contract</code> å°±å¾ˆéš¾(ä¹Ÿè®¸å¯ä»¥é€šè¿‡å­æ¨¡å—æ¥çº¦æŸ)
</p>

<p>
æˆ–è€…æ²¡æœ‰åŠæ³•åªçº¦æŸæ¨¡å—å†…éƒ¨äº†, <code>define/contract</code> å®é™…ä¸Šæ˜¯ä½œä¸ºä¸€ç§æä¾›æ›´å°ç²’åº¦çš„çº¦æŸæ‰‹æ®µ.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(define/contract amount positive? 1)
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgd28295a" class="outline-4">
<h4 id="orgd28295a">Simple Contracts on Functions</h4>
<div class="outline-text-4" id="text-orgd28295a">
<p>
<code>Racket</code> å¯¹äºå‡½æ•°çš„çº¦æŸçš„æè¿°é‡‡ç”¨äº†æ•°å­¦å¯¹å‡½æ•°æè¿°çš„è§„èŒƒ. <code>f : domain -&gt; range</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
          [f-1 (-&gt; positive-integer? any)] <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">f-1&#20989;&#25968;&#25509;&#21463;&#19968;&#20010;&#27491;&#25972;&#25968;&#20316;&#20026;&#21442;&#25968;,&#36820;&#22238;&#20219;&#20309;&#20540;</span>
          [f-2 (positive-integer? . -&gt; . any)] <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">f-2&#30340;&#32422;&#26463;&#36319;f-1&#30340;&#32422;&#26463;&#19968;&#26679;,&#20889;&#27861;&#19981;&#19968;&#26679;&#32780;&#24050;</span>
          [f-3 (-&gt; number?)] <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">f-3&#20989;&#25968;&#19981;&#25509;&#21463;&#21442;&#25968;,&#36820;&#22238;&#19968;&#20010;&#25968;&#23383;&#20316;&#20026;&#36820;&#22238;&#20540;</span>
          [f-void (-&gt; void?)] <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">f-void &#19981;&#25509;&#21463;&#20219;&#20309;&#20989;&#25968;,&#20063;&#19981;&#36820;&#22238;&#20219;&#20309;&#20540;</span>
          [f-higher-order (-&gt; (-&gt; number? number? number?) number?)]
          <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">f-higher-order&#20989;&#25968;,&#25509;&#21463;&#19968;&#20010;&#20989;&#25968;&#20316;&#20026;&#21442;&#25968;,&#35813;&#21442;&#25968;&#25509;&#21463;&#20004;&#20010;&#25968;&#23383;&#20316;&#20026;&#21442;&#25968;&#36820;&#22238;&#19968;&#20010;&#25968;&#23383;,</span>
          <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#26368;&#21518;f-higher-order&#36820;&#22238;&#19968;&#20010;&#25968;&#23383;.</span>
          [f-lambda-c (-&gt; (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (var) (positive? var)) positive?)] <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#20351;&#29992;&#19968;&#20010;&#21311;&#21517;&#32422;&#26463;</span>
          [improved-f-lambda-c
           (-&gt; (flat-named-contract
                'improved-f-lambda-c
                (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (var) (positive? var)))
               positive?) ]  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#30456;&#27604;&#19978;&#38754;&#30340;&#21311;&#21517;&#32422;&#26463;,&#36825;&#27425;&#32473;&#21311;&#21517;&#32422;&#26463;&#25552;&#20379;&#20102;&#19968;&#20010;&#21517;&#23383;</span>
          ))


(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-1</span> num) (+ num 1))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-2</span> num) (+ num 1))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-3</span>) 1)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-void</span>) (void))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-higher-order</span> func) (func 1 2))

(define/contract (f-1-c num)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23884;&#22871;&#20989;&#25968; f-1-c</span>
  (-&gt; positive-integer? any/c)
  (+ num 1))

(f-1 -1)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#19981;&#20250;&#25253;&#38169;,&#21487;&#26159;&#29992;&#22312;&#21035;&#30340;&#27169;&#22359;&#36825;&#26679;&#29992;&#23601;&#25253;&#38169;,&#36825;&#23601;&#26159; module boundaries, &#28982;&#32780; module boundaries &#30340;&#21464;&#37327;&#19981;&#19968;&#26679;,&#21363;&#20351;&#22312;&#23450;&#20041;&#30340;&#27169;&#22359;&#20013;&#20063;&#20250;&#21463;&#21040;&#32422;&#26463;.</span>

(f-1-c 1) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#19981;&#33021;</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">any/c &#21644; any &#30340;&#24046;&#21035;&#22312;&#20110;,any/c &#38480;&#21046;&#21333;&#20010;&#20219;&#20309;&#20540;,any &#26159;&#30495;&#30340;&#20219;&#20309;&#20540;(&#19981;&#35770;&#22810;&#20010;&#36824;&#26159;&#21333;&#20010;)&#37117;&#21487;&#20197;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#27604;&#22914; =(values 1 2)= &#31526;&#21512; =any= &#32422;&#26463;, &#20294;&#26159;&#19981;&#31526;&#21512; =any/c= &#32422;&#26463;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32422;&#26463;&#36824;&#21487;&#20197;&#23450;&#20041;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">my-positive-int?</span> var)          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#33258;&#23450;&#20041;&#30340;&#32422;&#26463;,&#26159;&#19968;&#20010;&#20989;&#25968;,&#35201;&#27714;&#36820;&#22238;&#20540;&#26159;&#24067;&#23572;&#31867;&#22411;.</span>
  (<span style="color: #F0DFAF; font-weight: bold;">and</span> (integer? var) (positive? var)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21033;&#29992; and/c &#25110;&#32773; or/c &#28151;&#21512;&#32422;&#26463;,&#19979;&#38754;&#29992; and/c &#31034;&#33539;, or/c &#20063;&#26159;&#19968;&#26679;&#30340;&#29992;&#27861;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">my-positive-int/c</span>
  (and/c integer? positive?))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#33258;&#23450;&#20041;&#30340;&#21311;&#21517;&#32422;&#26463;&#25253;&#38169;&#25552;&#31034;&#20449;&#24687;&#19981;&#20250;&#23436;&#21892;,&#36825;&#38656;&#35201;&#33258;&#34892;&#23436;&#21892;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(f-lambda-c -1) &#20250;&#25253;&#38169;,&#20294;&#26159;&#25552;&#31034;&#30340;&#20449;&#24687;&#20250;&#26377;&#36825;&#20040;&#19968;&#34892;"expected: ???"</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-lambda-c</span> var) var)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19968;&#20010;&#23436;&#21892;&#36807;&#25552;&#31034;&#20449;&#24687;&#30340;&#33258;&#23450;&#20041;&#21311;&#21517;&#32422;&#26463;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(improved-f-lambda-c -1) &#20250;&#25253;&#38169;,&#20294;&#26159;&#25552;&#31034;&#30340;&#20449;&#24687;&#26356;&#21152;&#23436;&#21892;&#20102;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">improved-f-lambda-c</span> var) var)

</pre>
</div>

<p>
é’ˆå¯¹ module boundaries çš„å‡½æ•°çº¦æŸå†è¡¥ä¸Šä¸€ä¸ªä¾‹å­.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(module mod racket
  (provide
    (contract-out
      [ask-amount (-&gt; positive-integer? positive-integer?)]
      [amount positive-integer?]))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">amount</span> 150)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26080;&#35770;&#22312;&#23450;&#20041;amount&#27169;&#22359;&#30340;&#20869;&#37096;/&#24341;&#29992;amount&#30340;&#27169;&#22359;,&#22914;&#20309;&#20063;&#19981;&#33021;&#36829;&#21453;amount&#30340;&#32422;&#26463;.</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(set! amount -1) or (define amount -1) &#37117;&#26159;&#19981;&#34892;&#30340;.</span>
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">ask-amount</span> amount) amount)

  (ask-amount -1))               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22312;&#23450;&#20041; ask-amount &#30340;&#20869;&#37096;&#36829;&#21453;&#32422;&#26463;&#27809;&#20107;</span>

(require 'mod)
(ask-amount -1)                  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22312;&#24341;&#29992;&#23427;&#30340;&#27169;&#22359;&#20013;&#20351;&#29992;&#23601;&#25253;&#38169;&#20102;</span>
</pre>
</div>

<p>
è¿™æ˜¯ <code>Racket</code> ä¸€ä¸ª"å¥‡è‘©"çš„åœ°æ–¹,ä¸è¿‡è¿™ä¹ˆè®¾è®¡çœŸç›¸åº”è¯¥æ˜¯è¿™æ ·çš„,å› ä¸ºå˜é‡è¢«åˆ«çš„æ¨¡å— <code>require</code> ä¹‹åæ˜¯ä¸èƒ½ç”¨ <code>set!</code> æ”¹å˜å®ƒçš„å€¼,
</p>

<p>
(åœ¨åˆ«çš„æ¨¡å—é‡æ–° <code>define</code> å¯¼å…¥å˜é‡å°±ä¸æ˜¯ <code>require</code> çš„å˜é‡äº†.)æ‰€ä»¥è¦å¯¹å˜é‡çº¦æŸä¹Ÿåªæœ‰åœ¨å®šä¹‰çš„æ—¶å€™äº†.
</p>

<p>
å†ç»“åˆ <code>module boundaries</code> çš„å®šä¹‰"çº¦æŸçš„èŒƒå›´åœ¨æ¨¡å—ä¸æ¨¡å—ä¹‹é—´,æä¾›çº¦æŸçš„æ¨¡å—ä¸å±äºè¿™ä¸ªèŒƒå›´å†…"è¿›è¡Œç†è§£.
</p>

<p>
è¿™æ ·å°±å¯ä»¥è§£é‡Šä¸ºä½•å¯¹å˜é‡å’Œå‡½æ•°æœ‰ä¸åŒçš„å¯¹å¾…æ–¹å¼.
</p>

<p>
å½“ç„¶è¿™æ˜¯ä¸ªäººçŒœæµ‹,çœŸç›¸åªæœ‰ <code>Racket</code> è®¾è®¡è€…çŸ¥é“.
</p>

<p>
å…³äºè¿åçº¦æŸçš„æŠ¥é”™ä¿¡æ¯,åˆ†ç±»6ä¸ªéƒ¨åˆ†
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#24102;&#32422;&#26463;&#30340;&#20989;&#25968;&#21517;&#23383;</span>
improved-f-lambda-c: contract violation
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#36829;&#21453;&#32422;&#26463;&#30340;&#30340;&#31934;&#30830;&#25551;&#36848;</span>
  expected: improved-f-lambda-c
  given: -1
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#23436;&#25972;&#30340;&#32422;&#26463;&#21152;&#19978;&#23637;&#31034;&#21738;&#20010;&#26041;&#38754;&#34987;&#36829;&#21453;</span>
  <span style="color: #F0DFAF; font-weight: bold;">in</span>: the 1st argument of
      (-&gt; improved-f-lambda-c positive?)
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#25552;&#20379;&#32422;&#26463;&#30340;&#27169;&#22359;</span>
  contract from: (anonymous-module mod)
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">who was blamed</span>
  blaming: anonymous-module
   (assuming the contract is correct)
  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#25253;&#38169;&#30340;&#28304;&#20195;&#30721;&#20301;&#32622;</span>
  at: unsaved-editor:13.6
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc99d161" class="outline-4">
<h4 id="orgc99d161">Contracts on Functions in General</h4>
<div class="outline-text-4" id="text-orgc99d161">
<p>
<code>-&gt;</code> æ˜¯ç”¨æ¥çº¦æŸå›ºå®šå‚æ•°çš„å‡½æ•°çš„,å¹¶ä¸”è¾“å…¥å’Œè¾“å‡ºæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„,
</p>

<p>
å¯¹äºæœ‰å¯é€‰å‚æ•°,å…³é”®å­—å‚æ•°çš„å‡½æ•°å°±éœ€è¦é¢å¤–çš„ <code>-&gt;*</code> å’Œ <code>-&gt;i</code> .
</p>
</div>

<ul class="org-ul">
<li><a id="orgd20f1b6"></a>Optional Arguments<br>
<div class="outline-text-5" id="text-orgd20f1b6">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#19968;&#20010;&#38656;&#35201;&#20004;&#20010;&#24517;&#36873;&#21442;&#25968;&#21644;&#19968;&#20010;&#21487;&#36873;&#21442;&#25968;&#30340;&#20989;&#25968; f-with-optional-arg</span>

(provide
  (contract-out
    [f-with-optional-an-arg
      (-&gt;* (string? natural-number/c)   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#24517;&#39035;&#21442;&#25968;&#20004;&#20010;</span>
           (char?)                      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21487;&#36873;&#21442;&#25968;&#19968;&#20010;</span>
           string?)]))                  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36820;&#22238;&#20540;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-with-optional-an-arg</span> pos-str pos-num [opt-char #\space])
  (string-append (build-string pos-num (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) opt-char))
                 pos-str
                 (build-string pos-num (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) opt-char))))
</pre>
</div>
</div>
</li>


<li><a id="org090787b"></a>Rest Arguments<br>
<div class="outline-text-5" id="text-org090787b">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide
  (contract-out
    [f-with-rest-args
      (-&gt;* (real?)                      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#19968;&#20010;&#24517;&#35201;&#21442;&#25968;</span>
      ()                                <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#27809;&#26377;&#21487;&#36873;&#21442;&#25968;</span>
      <span style="color: #DCDCCC; font-weight: bold;">#:rest</span>                            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#21097;&#20313;&#21442;&#25968;</span>
      (listof real?)                    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21097;&#20313;&#21442;&#25968;&#26159;&#19968;&#20010; list</span>
      real?)]))                         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">output</span>


(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-with-rest-args</span> n . rest)
  (apply + n rest))

(f-with-rest-args 1 2 3 4 5)
</pre>
</div>
</div>
</li>


<li><a id="org6e2231e"></a>Keyword Arguments &amp; Optional Keyword Arguments<br>
<div class="outline-text-5" id="text-org6e2231e">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide
  (contract-out
    [f-with-an-keyword-arg
      (-&gt; string?
          <span style="color: #DCDCCC; font-weight: bold;">#:key</span> boolean?
          void?)]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-with-an-keyword-arg</span> msg <span style="color: #DCDCCC; font-weight: bold;">#:key</span> verbose)
  (<span style="color: #F0DFAF; font-weight: bold;">when</span> verbose (displayln msg)))

(f-with-an-keyword-arg <span style="color: #CC9393;">"Message"</span> <span style="color: #DCDCCC; font-weight: bold;">#:key</span> #t)
</pre>
</div>

<p>
ä¹Ÿå¯ä»¥ç”¨ <code>-&gt;*</code> å£°æ˜è¿™ä¸ªçº¦æŸ
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide
  (contract-out
    [f-with-an-keyword-arg
      (-&gt;* (string? <span style="color: #DCDCCC; font-weight: bold;">#:key</span> boolean?)
           ()
           void?)]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-with-an-keyword-arg</span> msg <span style="color: #DCDCCC; font-weight: bold;">#:key</span> verbose)
  (<span style="color: #F0DFAF; font-weight: bold;">when</span> verbose (displayln msg)))

(f-with-an-keyword-arg <span style="color: #CC9393;">"Message"</span> <span style="color: #DCDCCC; font-weight: bold;">#:key</span> #t)
</pre>
</div>

<p>
å¯¹äºå¸¦å¯é€‰çš„ <code>keyword</code> å‚æ•°å‡½æ•°,æ ¹æ®ä¸Šé¢çš„ä¾‹å­ä¿®æ”¹.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide
  (contract-out
    [f-with-an-keyword-arg
      (-&gt;* (string?)
           ( <span style="color: #DCDCCC; font-weight: bold;">#:key</span> boolean?)
           void?)]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-with-an-keyword-arg</span> msg <span style="color: #DCDCCC; font-weight: bold;">#:key</span> [verbose #t])
  (<span style="color: #F0DFAF; font-weight: bold;">when</span> verbose (displayln msg)))

(f-with-an-keyword-arg <span style="color: #CC9393;">"Message"</span>)
</pre>
</div>
</div>
</li>


<li><a id="org74ba0e3"></a>Contracts for case-lambda<br>
<div class="outline-text-5" id="text-org74ba0e3">
<p>
<code>case-lambda</code> å®šä¹‰ä¸€ä¸ªå¯ä»¥æ ¹æ®ä¸åŒçš„å‚æ•°æ‰§è¡Œä¸åŒçš„æ–¹æ³•ä½“çš„å‡½æ•°,å¯¹äºè¿™ç§å‡½æ•°çš„çº¦æŸ,è¦ç”¨ <code>case-&gt;</code> æ¥å®šä¹‰
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
           [f-case-lambda
             (case-&gt;
               (integer? integer? . -&gt; . void?)
               (string? . -&gt; . void?))]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">f-case-lambda</span>
  (<span style="color: #F0DFAF; font-weight: bold;">case-lambda</span>
    [(a b) (displayln (format <span style="color: #CC9393;">"~a + ~a = ~a"</span> a b (+ a b)))]
    [(msg) (displayln msg)]))

(f-case-lambda 1 2)
(f-case-lambda <span style="color: #CC9393;">"Hello, world"</span>)
</pre>
</div>
</div>
</li>


<li><a id="org91f6d53"></a>Argument and Result Dependencies<br>
<div class="outline-text-5" id="text-org91f6d53">
<p>
<code>-&gt;i</code> å®šä¹‰ä¸€ä¸ª <code>indy</code> ä¾èµ–çº¦æŸ(an indy dependent contract), i è¡¨ç¤º <code>indy</code>.
</p>

<p>
<code>indy</code> æ„å‘³ç€è´£ä»»(blame)åº”è¯¥ç»™çº¦æŸæœ¬èº«. ä¾èµ–çº¦æŸæ„å‘³ç€å‡½æ•°çš„èŒƒå›´(range)å–å†³äºå‚æ•°çš„å€¼.
</p>

<p>
è¿™é‡Œä¼šä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ç†Ÿæ‚‰ä¸€ä¸‹,å‰©ä¸‹çš„ç”¨æ³•è‡ªå·±çœ‹ <code>referenceæ–‡æ¡£</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide
  (contract-out
    [f-indy (-&gt;i ([num1 positive-integer?]               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">f-indy &#38656;&#35201;&#20004;&#20010;&#27491;&#25972;&#25968;&#20570;&#20026;&#21442;&#25968;</span>
                  [num2 positive-integer?])
                 [result (num1 num2)                     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36820;&#22238;&#20540;&#30340;&#32422;&#26463;&#20381;&#36182;: num1 &#21644; num2</span>
                         (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res) (equal? (+ num1 num2) res))])])) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32422;&#26463;,&#36820;&#22238;&#20540;&#19968;&#23450;&#35201;&#31561;&#20110;&#20004;&#20010;&#21442;&#25968;&#30340;&#21644;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-indy</span> a b)
  (+ a b))
</pre>
</div>
</div>
</li>


<li><a id="orgba9b41f"></a>Checking State Changes<br>
<div class="outline-text-5" id="text-orgba9b41f">
<p>
è¿™é‡Œçš„æœ€åä¸€ä¸ªä¾‹å­ç»è¿‡å®è·µå‘ç°è·Ÿæ–‡æ¡£ä¸ä¸€æ ·.(ç¬¬ä¸€ä¸ªä¾‹å­ä¸äº†è§£å› æ­¤ç›´æ¥è·³è¿‡).è¿™æœ‰å¯èƒ½æ˜¯ä¸€ä¸ª <code>bug</code> .
</p>
</div>
</li>


<li><a id="orgf474f3b"></a>Multiple Result Values<br>
<div class="outline-text-5" id="text-orgf474f3b">
<p>
å¯¹äºå¤šå€¼å‡½æ•° <code>multiple-value function</code> çš„çº¦æŸ,å¯ä»¥ç›´æ¥ç”¨ <code>values</code> form è§£å†³.
</p>

<p>
ç”¨ <code>-&gt;</code> å®šä¹‰çº¦æŸ,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
           [f-multi-value (-&gt; char? positive?
                              (values string? positive?))]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-multi-value</span> c n)
  (values (build-string n (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) c))
          n))
</pre>
</div>

<p>
ç”¨ <code>-&gt;*</code> å®šä¹‰çº¦æŸ,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
          [f-multi-value (-&gt;* (char? positive?) ()
                              (values string? positive?))]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-multi-value</span> c n)
  (values (build-string n (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) c))
</pre>
</div>

<p>
ç”¨ <code>-&gt;!</code> å®šä¹‰çº¦æŸ,å‡å¦‚è¦æ±‚è¿”å›çš„å­—ç¬¦ä¸²ä¸€å®šè¦åŒ…å«å‚æ•°å­—ç¬¦,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
          [f-multi-value (-&gt;i ([c char?]
                               [n positive-integer?])
                              (values
                               [s (c n) (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (var) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">var &#26159; s &#30340;&#20540;</span>
                                          (member
                                           c
                                           (string-&gt;list var)))]
                               [l (n) positive-integer?]))]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-multi-value</span> c n)
  (values (build-string n (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) n)) n))
</pre>
</div>
</div>
</li>


<li><a id="orgf4e2006"></a>Fixed but Statically Unknown Arities<br>
<div class="outline-text-5" id="text-orgf4e2006">
<p>
é’ˆå¯¹é‚£ç§ä»»æ„å‡½æ•°æ¥å—å¯¹åº”å‚æ•°çš„çº¦æŸ,æ¯”å¦‚ç±»ä¼¼ <code>apply</code> çš„å‡½æ•°,çº¦æŸåº”è¯¥è¿™ä¹ˆå†™
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(module mod racket
  (provide
   (contract-out
    [f-unknown-arities
     (-&gt;i ([proc (args)                        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">proc &#20381;&#36182;&#22312;&#23427;&#20043;&#21518;&#30340; args</span>
                 (<span style="color: #F0DFAF; font-weight: bold;">and</span>
                  (unconstrained-domain-&gt;      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">unconstrained-domain-&gt; &#34920;&#31034;&#19981;&#32422;&#26463; domain.</span>
                   (or/c false/c number?))
                  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (f) (procedure-arity-includes?
                               f
                               (length args))))]
           [args (listof any/c)])
          ()
          any)]))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">f-unknown-arities</span> proc args)
    (apply proc args)))

(require 'mod)

(f-unknown-arities + '(1 2 3 4))
</pre>
</div>

<p>
è¿™ä¸ªä¾‹å­ä¸èƒ½ç”¨ <code>-&gt;*</code> å®šä¹‰ <code>proc</code> çš„çº¦æŸ,ç¬¬ä¸€çœ¼å¯èƒ½ä¼šè¿™ä¹ˆå†™,
</p>

<div class="org-src-container">
<pre class="src src-scheme">(-&gt;* ()
     <span style="color: #DCDCCC; font-weight: bold;">#:rest</span> (listof any/c)
     (listof any/c))

</pre>
</div>

<p>
ç„¶è€Œå¦‚æœ <code>(f-unknown-arities (lambda (x) x) '(1))</code> å°±ä¼šè¿åçº¦æŸ,å› ä¸ºè¿™å‡½æ•°è¦æ±‚ä¸€ä¸ªå¿…é¡»å‚æ•°,
</p>

<p>
è€Œè¿™ä¸ªçº¦æŸåªæ˜¯é’ˆå¯¹åªæœ‰å¯é€‰å‚æ•°çš„å‡½æ•°.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orge0b9810" class="outline-4">
<h4 id="orge0b9810">Contracts: A Thorough Example</h4>
<div class="outline-text-4" id="text-orge0b9810">
<p>
è¿™ç« æ˜¯é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥å±•ç¤ºçº¦æŸçš„ä½¿ç”¨çš„,å‰é¢æˆ‘å·²ç»æ€»ç»“è¿‡ä¸å°‘äº†,ç›´æ¥è·³è¿‡.
</p>
</div>
</div>

<div id="outline-container-org819c3a8" class="outline-4">
<h4 id="org819c3a8">Contracts on Structures</h4>
<div class="outline-text-4" id="text-org819c3a8">
<p>
æ¨¡å—å¤„ç†ç»“æ„ä½“æœ‰ä¸¤ç§æ–¹å¼:
</p>

<p>
å¯¹å¾…ç»“æ„ä½“å®šä¹‰,æ¨¡å—ä¼šå¯¼å‡ºç»“æ„ä½“ç›¸å…³æ“ä½œå‡½æ•°,æ¯”å¦‚åˆ›å»ºç»“æ„ä½“,è®¿é—®å­—æ®µ,ä¿®æ”¹ç»“æ„ä½“å’ŒåŒºåˆ†ç»“æ„ä½“.
</p>

<p>
å¯¹å¾…ç»“æ„ä½“(ä¸å®šä¹‰ä¸ä¸€æ ·,ç±»ä¼¼ä¸å®ä¾‹å’Œç±»çš„åŒºåˆ«),æ¨¡å—åªä¼šå¯¼å‡ºæŒ‡å®šçš„ç»“æ„ä½“å¹¶ä¸”ä¿è¯å­—æ®µçº¦æŸ.
</p>
</div>

<ul class="org-ul">
<li><a id="org532731c"></a>Guarantees for a Specific Value<br>
<div class="outline-text-5" id="text-org532731c">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
          [pos (struct/c posn number? number?)]))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21482;&#23548;&#20986;&#32467;&#26500;&#20307;,&#21482;&#20445;&#35777;&#36825;&#20010;&#32467;&#26500;&#20307;&#30340;&#32422;&#26463;</span>

(struct posn (x y))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pos</span> (posn 10 20))
</pre>
</div>
</div>
</li>


<li><a id="org8790ebd"></a>Guarantees for All Values<br>
<div class="outline-text-5" id="text-org8790ebd">
<p>
ä¸Šé¢åªæ˜¯ç¡®ä¿æŒ‡å®šçš„ç»“æ„ä½“çš„çº¦æŸ,ä¸‹é¢æ¼”ç¤ºä¿è¯æ‰€æœ‰ <code>posn</code> å®šä¹‰çš„ç»“æ„ä½“å—åˆ°çº¦æŸ.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
          [struct posn ((x number?) (y number?))]
          [p-okay posn?]
          [p-sick posn?]))
(struct posn (x y))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p-okay</span> (posn 10 20))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p-sick</span> (posn 'a 'b))
</pre>
</div>

<p>
è¿™ä¸ªåªæœ‰åœ¨å¯¼å…¥åå¹¶ä¸”è°ƒç”¨ <code>(posn-x p-sick)</code> æ‰ä¼šè¿åçº¦æŸ.å¦‚æœæƒ³è¦ä¿®å¤è¿™ä¸ªé—®é¢˜,é‚£ä¹ˆå°±è¦ç”¨åˆ°æŒ‡å®šç‰¹å®šç»“æ„ä½“çš„æ–¹æ³•.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide (contract-out
          [struct posn ((x number?) (y number?))]
          [p-okay posn?]
          [p-sick (struct/c posn number? number?)]))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#29992; struct/c &#32422;&#26463;&#26426;&#26500;&#20307;&#30340;&#32452;&#25104;&#37096;&#20998;</span>
(struct posn (x y))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p-okay</span> (posn 10 20))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p-sick</span> (posn 'a 'b))
</pre>
</div>
</div>
</li>


<li><a id="org3143263"></a>Checking Properties of Data Structures<br>
<div class="outline-text-5" id="text-org3143263">
<p>
ä¸‹é¢è¿™ä¸ªæ˜¯ä¸€ä¸ªäºŒå‰æœç´¢æ ‘
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(struct node (val left right))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">determines if `n' is in the binary search tree `b',</span>
<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">exploiting the binary search tree invariant</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">in?</span> n b)
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    [(null? b) #f]
    [else (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
            [(= n (node-val b))
             #t]
            [(&lt; n (node-val b))
             (in? n (node-left b))]
            [(&gt; n (node-val b))
             (in? n (node-right b))])]))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">a predicate that identifies binary search trees</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">bst-between?</span> b low high)
  (<span style="color: #F0DFAF; font-weight: bold;">or</span> (null? b)
      (<span style="color: #F0DFAF; font-weight: bold;">and</span> (&lt;= low (node-val b) high)
           (bst-between? (node-left b) low (node-val b))
           (bst-between? (node-right b) (node-val b) high))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">bst?</span> b) (bst-between? b -inf.0 +inf.0))

(provide (struct-out node))
(provide (contract-out
          [bst? (any/c . -&gt; . boolean?)]
          [in? (number? bst? . -&gt; . boolean?)]))
</pre>
</div>


<p>
<code>in?</code> æ–¹æ³•é‡Œé¢çš„ <code>cond</code> æ˜¯ <code>in?</code> è·å¾—é€Ÿåº¦çš„åœ°æ–¹: æ¯æ¬¡é€’å½’éƒ½é¿å…æœç´¢æ•´ä¸ªå­æ ‘.
</p>

<p>
ç„¶è€Œ, <code>bst-between?</code> å´éå†äº†æ•´ä¸ªæ ‘,è¿™æ„å‘³è€… <code>in?</code> çš„æé€Ÿå¤±å»æ„ä¹‰äº†.
</p>

<p>
<code>struct/dc</code> åƒ <code>struct/c</code> ä¸€æ ·ä¸ºç»“æ„ä½“å®šä¹‰çº¦æŸ,å®ƒè¿˜å¯ä»¥æŠŠå­—æ®µæ ‡è®°ä¸º <code>lazy</code> ,
</p>

<p>
è¿™æ ·å°±å¯ä»¥åªæœ‰åœ¨è®¿é—®å­—æ®µçš„æ—¶å€™è§¦å‘çº¦æŸæ£€æŸ¥,ä¸è¿‡ä¸å…è®¸æŠŠå¯å˜å­—æ®µè®¾ä¸º <code>lazy</code> .
</p>

<p>
å¯ä»¥é€šè¿‡ <code>struct/dc</code> æ¥è§£å†³ <code>bst-between?</code> çš„é—®é¢˜: æŠŠ <code>bst-between?</code> å®šä¹‰ä¸ºçº¦æŸ <code>bst-between/c</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(struct node (val left right))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">determines if `n' is in the binary search tree `b'</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">in?</span> n b)
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    [(null? b) #f]
    [else (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
            [(= n (node-val b))
             #t]
            [(&lt; n (node-val b))
             (in? n (node-left b))]
            [(&gt; n (node-val b))
             (in? n (node-right b))])]))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">bst-between : number number -&gt; contract</span>
<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">builds a contract for binary search trees</span>
<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">whose values are between low and high</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">bst-between/c</span> low high)
  (or/c null?
        (struct/dc node [val (between/c low high)]
                        [left (val) <span style="color: #DCDCCC; font-weight: bold;">#:lazy</span> (bst-between/c low val)]
                        [right (val) <span style="color: #DCDCCC; font-weight: bold;">#:lazy</span> (bst-between/c val high)])))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">bst/c</span> (bst-between/c -inf.0 +inf.0))

(provide (struct-out node))
(provide (contract-out
          [bst/c contract?]                   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">contract? &#34920;&#31034;&#26159;&#21542;&#26159;&#32422;&#26463;</span>
          [in? (number? bst/c . -&gt; . boolean?)]))
</pre>
</div>

<p>
å³ä½¿ä¸Šé¢æ˜¯æé«˜äº†æ•ˆç‡,ä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤§çš„çº¦æŸå¼€é”€(constant over),æ‰€ä»¥ <code>contract</code> åº“æä¾›äº†ä¸€ä¸ª <code>define-opt/c</code> è§£å†³è¿™ä¸ªé—®é¢˜.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(define-opt/c (bst-between/c low high)
  (or/c null?
        (struct/dc node [val (between/c low high)]
                        [left (val) <span style="color: #DCDCCC; font-weight: bold;">#:lazy</span> (bst-between/c low val)]
                        [right (val) <span style="color: #DCDCCC; font-weight: bold;">#:lazy</span> (bst-between/c val high)])))
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orga856cc7" class="outline-4">
<h4 id="orga856cc7">Abstract Contracts using #:exists and #:âˆƒ</h4>
<div class="outline-text-4" id="text-orga856cc7">
<p>
<code>Racket</code> æä¾›å­˜åœ¨çº¦æŸ(existential contracts), <code>#:exists</code> å’Œ <code>#:âˆƒ</code> ,ä¸¤ä¸ªéƒ½ä¸€æ ·,
</p>

<p>
å¦‚æœä¸æ–¹ä¾¿è¾“å…¥ <code>#:âˆƒ</code> å°±ç›´æ¥ç”¨ <code>#:exists</code> . å®ƒå¯ä»¥ä¿è¯çº¦æŸçš„æŠ½è±¡,ä¸æŠŠçº¦æŸçš„ç»†èŠ‚æš´éœ²ç»™åˆ«çš„æ¨¡å—.
</p>

<p>
é“ç†éƒ½æ‡‚,å¯æ˜¯æ–‡æ¡£çš„ä¾‹å­æ²¡æœ‰è®²æ˜ç™½æ˜¯æ€ä¹ˆç”¨è¿™ä¸ª <code>flag</code> .
</p>
</div>
</div>

<div id="outline-container-orgdaf84d9" class="outline-4">
<h4 id="orgdaf84d9">Additional Examples</h4>
<div class="outline-text-4" id="text-orgdaf84d9">
<p>
ä¸€å †ä¾‹å­,ä»¥åå†çœ‹.
</p>
</div>
</div>

<div id="outline-container-orgf1e2ff5" class="outline-4">
<h4 id="orgf1e2ff5">Building New Contracts</h4>
<div class="outline-text-4" id="text-orgf1e2ff5">
<p>
é¦–å…ˆå£°æ˜ä¸€ä¸‹,è¿™è·Ÿä¸Šé¢çš„ç»„åˆçº¦æŸçš„å®šä¹‰æ–¹å¼ä¸ä¸€æ ·.
</p>

<p>
(ä¸ªäººè§‰å¾—è¿™ä¸€ç« æ˜¯åœ¨è®²çº¦æŸçš„å®ç°çš„,å¹³å¸¸çš„ç»„åˆçº¦æŸå·²ç»å·®ä¸å¤šå¤Ÿç”¨äº†,å› æ­¤å¾ˆå¤šéƒ½çœ‹ä¸å¤ªæ‡‚,ç•™åˆ°ä»¥åç†è§£äº†).
</p>

<p>
çº¦æŸåœ¨å†…éƒ¨è¡¨ç¤ºä¸ºä¸€ä¸ªå‡½æ•°,å¦‚ä¸‹æ‰€ç¤º:
</p>

<p>
<code>contract : blame-object -&gt; projection</code>
</p>

<p>
<code>projection : an-arbitrary-value -&gt; a-value-satifies-the-corresponding-contract</code>
</p>

<p>
ä½†æ˜¯ç³»ç»Ÿçº¦æŸä¸ä¼šä½¿ç”¨è¿™ç§ <code>projection = çš„,çœŸæ­£çš„ =projection</code> åº”è¯¥æ˜¯è¿™æ ·çš„:
</p>

<p>
<code>real-projection : blame-object -&gt; projection</code>
</p>

<p>
ä¹Ÿå°±æ˜¯è¯´çœŸæ­£çš„ <code>projection</code> å°±æ˜¯å†…éƒ¨è¡¨ç¤ºçš„ <code>contract</code>. (å…³ç³»æœ‰ç‚¹ä¹±,ä¸‹æ–‡ä¼šç”¨ real projection å’Œ projection åšä¸ºåŒºåˆ†).
</p>

<p>
ä¸€ä¸ªæ•´æ•° <code>projection</code> çš„è¡¨ç¤º(representation)ä¾‹å­:
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">int-proj</span> blame)                      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">real projection &#21517;&#23383;&#20026; int-proj,&#25509;&#21463;&#19968;&#20010;blame&#23545;&#35937;</span>
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (x)                                      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36825;&#20010;lambda&#20989;&#25968;&#23601;&#26159;&#19968;&#20010;projection</span>
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (integer? x)
        x                                     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36825;&#20010;projection&#20250;&#22312;&#21028;&#26029;&#25104;&#21151;&#21518;&#36820;&#22238;&#28385;&#36275;&#32422;&#26463;&#30340;&#20540;</span>
        (raise-blame-error                    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21028;&#26029;&#22833;&#36133;&#23601;&#25253;&#38169;,raise-blame-error&#23601;&#26159;&#32422;&#26463;&#25253;&#38169;&#30340;form</span>
         blame
         x
         '(expected: <span style="color: #CC9393;">"&lt;integer&gt;"</span> given: <span style="color: #CC9393;">"~e"</span>)
         x))))
</pre>
</div>

<p>
æ¥ç€ä¸Šé¢æ¥ä¸€ä¸ªå‡½æ•° <code>projection</code> çš„è¡¨ç¤ºä¾‹å­:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">int-&gt;int-proj</span> blame)
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">blame-swap&#20132;&#25442;&#20004;&#20010;&#32422;&#26463;&#30340;&#22242;&#20307;(parties),&#36825;&#37324;&#26159;negative party.&#35201;&#28040;&#32791;&#21442;&#25968;&#23545;&#24212;&#20989;&#25968;&#30340;domain</span>
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">dom</span> (int-proj (blame-swap blame)))
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#37324;&#26159;positive party,&#35201;&#36820;&#22238;&#25968;&#20540;&#23545;&#24212;&#20989;&#25968;&#30340;range</span>
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">rng</span> (int-proj blame))
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (f)
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (procedure? f)
             (procedure-arity-includes? f 1))
        (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (x) (rng (f (dom x))))             <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21028;&#26029;&#25104;&#21151;&#23601;&#26159;&#36820;&#22238;&#19968;&#20010;&#20989;&#25968;</span>
        (raise-blame-error
         blame
         f
         '(expected <span style="color: #CC9393;">"a procedure of one argument"</span> given: <span style="color: #CC9393;">"~e"</span>)
         f))))
</pre>
</div>

<p>
å¯¹æ­¤è¯´æ˜ä¸€ä¸‹,çº¦æŸæ€»æ˜¯åœ¨ä¸¤ä¸ª <code>parties</code> ä¹‹é—´å»ºç«‹çš„.
</p>

<p>
å…¶ä¸­ä¸€ä¸ª <code>party</code> å«åš <code>server</code> ,æ ¹æ®çº¦æŸä¼šæä¾›ä¸€äº›å€¼,å¦å¤–ä¸€ä¸ª <code>party</code> å«åš <code>client</code> ,å®ƒä¼šæ ¹æ®çº¦æŸæ¶ˆè´¹è¿™äº›å€¼.
</p>

<p>
<code>Server</code> å«åš <code>the positive position</code> å’Œ <code>client</code> å«åš <code>the negative position</code> .
</p>

<p>
<code>The positive party</code> ä¹Ÿå°±æ˜¯ <code>server</code>, å¯¹åº”çš„ <code>the negative position</code> å« <code>client</code> .
</p>


<p>
ç»™ç¬¬äºŒä¸ªä¾‹å­ä½œä¸€ä¸‹ä¿®æ”¹,ä½¿ç”¨ <code>blame-add-context</code> æ›¿æ¢ <code>blame-swap</code> ,å¯ä»¥å®Œå–„é”™è¯¯æç¤º,
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-simple-function-contract</span> dom-proj range-proj)
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (blame)                                                            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">real projection</span>
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">dom</span> (dom-proj (blame-add-context blame
                                             <span style="color: #CC9393;">"the argument of"</span>
                                             <span style="color: #DCDCCC; font-weight: bold;">#:swap?</span> #t)))
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">rng</span> (range-proj (blame-add-context blame
                                               <span style="color: #CC9393;">"the range of"</span>)))
    (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (f)                                                              <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">projection</span>
      (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (procedure? f)
               (procedure-arity-includes? f 1))
          (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (x) (rng (f (dom x))))
          (raise-blame-error
           blame
           f
           '(expected <span style="color: #CC9393;">"a procedure of one argument"</span> given: <span style="color: #CC9393;">"~e"</span>)
           f)))))
</pre>
</div>

<p>
æœ‰ä¸€ç§ <code>late neg projection</code> , è¿™ç§ <code>projection</code> æ¥å—ä¸€ä¸ªä¸å¸¦ <code>negative party</code> çš„ <code>blame</code> å¯¹è±¡åšä¸ºå‚æ•°,
</p>

<p>
å¹¶ä¸”è¿”å›ä¸€ä¸ªå‡½æ•°.è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå¯¹åº”çº¦æŸçš„å€¼å’Œ <code>negative party</code> çš„åå­—,å¹¶ä¸”è¿”å›å¸¦çº¦æŸçš„å€¼(æœ‰ç‚¹æä¸æ‡‚çº¦æŸçš„å†…
</p>

<p>
éƒ¨è¿è¡Œæœºåˆ¶äº†).
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">int-&gt;int-proj</span> blame)
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">projection (&#20316;&#20026;&#32422;&#26463;&#20989;&#25968;&#30340;&#36820;&#22238;&#20540;,&#32780;&#19988;&#20063;&#31526;&#21512; projection &#30340;&#23450;&#20041;)</span>
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">dom-blame</span> (blame-add-context blame
                                       <span style="color: #CC9393;">"the argument of"</span>
                                       <span style="color: #DCDCCC; font-weight: bold;">#:swap?</span> #t))
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">rng-blame</span> (blame-add-context blame <span style="color: #CC9393;">"the range of"</span>))
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">check-int</span> v to-blame neg-party)
    (<span style="color: #F0DFAF; font-weight: bold;">unless</span> (integer? v)
      (raise-blame-error
       to-blame <span style="color: #DCDCCC; font-weight: bold;">#:missing-party</span> neg-party
       v
       '(expected <span style="color: #CC9393;">"an integer"</span> given: <span style="color: #CC9393;">"~e"</span>)
       v)))
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (f neg-party)                                             <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25509;&#21463;&#23545;&#24212;&#32422;&#26463;&#30340;&#20540;&#21644; negative party &#30340;&#21517;&#23383;</span>
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (procedure? f)
             (procedure-arity-includes? f 1))
        (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (x)                                                 <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25509;&#21463;&#24102;&#32422;&#26463;&#30340;&#20540;,&#21253;&#35065;&#20989;&#25968;</span>
          (check-int x dom-blame neg-party)
          (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ans</span> (f x))
          (check-int ans rng-blame neg-party)
          ans)
        (raise-blame-error
         blame <span style="color: #DCDCCC; font-weight: bold;">#:missing-party</span> neg-party
         f
         '(expected <span style="color: #CC9393;">"a procedure of one argument"</span> given: <span style="color: #CC9393;">"~e"</span>)
         f))))
</pre>
</div>

<p>
ä¸Šé¢è¿™ç§ <code>projection</code> ä¸º <code>f</code> åˆ›å»ºäº†ä¸€ä¸ªåŒ…è£¹å‡½æ•°(wrapper function),ä½†æ˜¯è¿™ä¸ª <code>equal?</code> ä¸èƒ½ç”¨åœ¨åŒ…è£¹å‡½æ•°ä¸Šé¢,
</p>

<p>
ä¹Ÿä¸ä¼šè®© <code>runtime system</code> çŸ¥é“è¿”å›å‡½æ•°å’Œè¾“å…¥å‡½æ•° <code>f</code> ä¹‹é—´çš„å…³ç³».
</p>

<p>
å¯ä»¥ç”¨ <code>chaperone-procedure</code> è§£å†³è¿™ä¸ªé—®é¢˜.
</p>

<p>
(è¿™é‡Œæœ‰ç‚¹æ²¡çœ‹æ‡‚,ç‰¹åˆ«æ˜¯chaperone-procedureçš„ç”¨æ³•).
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">int-&gt;int-proj</span> blame)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">dom-blame</span> (blame-add-context blame
                                       <span style="color: #CC9393;">"the argument of"</span>
                                       <span style="color: #DCDCCC; font-weight: bold;">#:swap?</span> #t))
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">rng-blame</span> (blame-add-context blame <span style="color: #CC9393;">"the range of"</span>))
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">check-int</span> v to-blame neg-party)
    (<span style="color: #F0DFAF; font-weight: bold;">unless</span> (integer? v)
      (raise-blame-error
       to-blame <span style="color: #DCDCCC; font-weight: bold;">#:missing-party</span> neg-party
       v
       '(expected <span style="color: #CC9393;">"an integer"</span> given: <span style="color: #CC9393;">"~e"</span>)
       v)))
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (f neg-party)
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (procedure? f)
             (procedure-arity-includes? f 1))
        (chaperone-procedure
         f
         (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (x)
           (check-int x dom-blame neg-party)
           (values (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (ans)
                     (check-int ans rng-blame neg-party)
                     ans)
                   x)))
        (raise-blame-error
         blame <span style="color: #DCDCCC; font-weight: bold;">#:missing-party</span> neg-party
         f
         '(expected <span style="color: #CC9393;">"a procedure of one argument"</span> given: <span style="color: #CC9393;">"~e"</span>)
         f))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">int-&gt;int-contract</span>                       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#32422;&#26463;</span>
  (make-contract
   <span style="color: #DCDCCC; font-weight: bold;">#:name</span> 'int-&gt;int
   <span style="color: #DCDCCC; font-weight: bold;">#:late-neg-projection</span> int-&gt;int-proj))

(define/contract (f x)                          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#20351;&#29992;&#32422;&#26463;</span>
  int-&gt;int-contract
  <span style="color: #CC9393;">"not an int"</span>)
</pre>
</div>
</div>


<ul class="org-ul">
<li><a id="orgac96ff7"></a>Contract Struct Properties<br>
<div class="outline-text-5" id="text-orgac96ff7">
<p>
è¿‡äº†ä¸€éæ²¡çœ‹æ‡‚.ä»¥åå†ç ”ç©¶,å…ˆæ•´ç†ç¬”è®°.
</p>

<p>
<code>make-chaperone-contract</code> ç”¨æ¥åˆ›å»ºä¸€æ¬¡æ€§(one-off)çº¦æŸæ˜¯æ²¡é—®é¢˜,ç„¶è€Œå¤§éƒ¨ä»½æ—¶é—´éƒ½ä¼šä½¿ç”¨ä¸åŒçš„çº¦æŸæ¥è¿›è¡ŒåŒºåˆ†(ä¸€æ¬¡æ€§çº¦æŸä¸é€‚ç”¨).
</p>

<p>
æœ€å¥½çš„åšæ³•æ˜¯ä½¿ç”¨ <code>struct</code> å’Œ <code>prop:contract</code> , <code>prop:chaperone-contract</code> å’Œ <code>prop:flat-contract</code> å…¶ä¸­ä¹‹ä¸€æ¥åšè¿™ç§äº‹ã€‚
</p>

<p>
æ¯”å¦‚,æˆ‘ä»¬æƒ³è¦å†™ä¸€ä¸ª <code>-&gt;</code> çº¦æŸçš„ç®€å•ç‰ˆæœ¬,åªæ˜¯ä¸€ä¸ªrangeçº¦æŸå’Œä¸€ä¸ªdomainçº¦æŸ.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(struct simple-arrow (dom rng)
  <span style="color: #DCDCCC; font-weight: bold;">#:property</span> prop:chaperone-contract
  (build-chaperone-contract-property                <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26500;&#36896;&#38656;&#35201;&#30340;&#30417;&#25252;&#32422;&#26463;&#23646;&#24615;(chaperone contract property)</span>
   <span style="color: #DCDCCC; font-weight: bold;">#:name</span>
   (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (arr) (simple-arrow-name arr))
   <span style="color: #DCDCCC; font-weight: bold;">#:late-neg-projection</span>
   (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (arr) (simple-arrow-late-neg-proj arr))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">To do the automatic coercion of values like integer? and #f into contracts,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">we need to call coerce-chaperone-contract (note that this rejects impersonator</span>
<span style="color: #5F7F5F;">;;</span><span style="color: #7F9F7F;">contracts and does not insist on flat contracts; to do either of those things,</span>
<span style="color: #5F7F5F;">;;</span><span style="color: #7F9F7F;">call coerce-contract or coerce-flat-contract instead).</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">simple-arrow-contract</span> dom rng)
  (simple-arrow (coerce-contract 'simple-arrow-contract dom)
                (coerce-contract 'simple-arrow-contract rng)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">simple-arrow-name &#30340;&#23450;&#20041;&#35201;&#27714;&#21482;&#38656;&#36820;&#22238;&#19968;&#20010;&#34920;&#31034;&#32422;&#26463;&#30340; s-expression &#23601;&#22909;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">simple-arrow-name</span> arr)
  `(-&gt; ,(contract-name (simple-arrow-dom arr))
       ,(contract-name (simple-arrow-rng arr))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#19968;&#20010;&#19968;&#33324;&#21270;&#30340; =projection=</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">simple-arrow-late-neg-proj</span> arr)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">dom-ctc</span> (get/build-late-neg-projection (simple-arrow-dom arr)))
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">rng-ctc</span> (get/build-late-neg-projection (simple-arrow-rng arr)))
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (blame)
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">dom+blame</span> (dom-ctc (blame-add-context blame
                                                  <span style="color: #CC9393;">"the argument of"</span>
                                                  <span style="color: #DCDCCC; font-weight: bold;">#:swap?</span> #t)))
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">rng+blame</span> (rng-ctc (blame-add-context blame <span style="color: #CC9393;">"the range of"</span>)))
    (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (f neg-party)
      (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (procedure? f)
               (procedure-arity-includes? f 1))
          (chaperone-procedure
           f
           (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (arg)
             (values
              (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (result) (rng+blame result neg-party))
              (dom+blame arg neg-party))))
          (raise-blame-error
           blame <span style="color: #DCDCCC; font-weight: bold;">#:missing-party</span> neg-party
           f
           '(expected <span style="color: #CC9393;">"a procedure of one argument"</span> given: <span style="color: #CC9393;">"~e"</span>)
           f)))))

(define/contract (f x)
  (simple-arrow-contract integer? boolean?)
  <span style="color: #CC9393;">"not a boolean"</span>)
</pre>
</div>
</div>
</li>


<li><a id="org4691592"></a>With All the Bels and Whistles<br>
<div class="outline-text-5" id="text-org4691592">
<p>
è®²é“ç†æ²¡æœ‰æ˜ç™½,ä»¥åå†çœ‹.
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-org8e92256" class="outline-4">
<h4 id="org8e92256">Gotchas</h4>
<div class="outline-text-4" id="text-org8e92256">
</div>
<ul class="org-ul">
<li><a id="orgfd12497"></a>Contracts and eq?<br>
<div class="outline-text-5" id="text-orgfd12497">
<p>
ä¸è¦æŠŠ <code>eq?</code> ç”¨åœ¨å¸¦æœ‰çº¦æŸçš„å€¼ä¸Šé¢,çº¦æŸä¼šå½±å“åˆ¤æ–­.
</p>
</div>
</li>

<li><a id="orgdcde427"></a>Contract boundaries and define/contract<br>
<div class="outline-text-5" id="text-orgdcde427">
<p>
å¦‚æœæœ‰ä¸¤ä¸ªå—åˆ°çº¦æŸçš„å€¼è¦äº¤äº’(æ¯”å¦‚å‡½æ•°Aè°ƒç”¨å‡½æ•°B),æŠŠå®ƒä»¬æ”¾åˆ°ä¸åŒçš„æ¨¡å—(ä½¿ç”¨æ¨¡å—è¾¹ç•Œ)æˆ–è€…ä½¿ç”¨ <code>define/contract</code> çš„ <code>#:freevar</code> (åµŒå¥—çº¦æŸè¾¹ç•Œ).
</p>
</div>
</li>

<li><a id="org7aeaa94"></a>Exists Contracts and Predicates<br>
<div class="outline-text-5" id="text-org7aeaa94">
<p>
ä¸å¤šè¯´äº†.
</p>
</div>
</li>

<li><a id="orgd3eb8e3"></a>Defining Recursive Contracts<br>
<div class="outline-text-5" id="text-orgd3eb8e3">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">stream/c</span>
  (promise/c
   (or/c
    null?
    (cons/c number? (recursive-contract stream/c))))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#19981;&#20351;&#29992;recursive-contract&#30340;&#35805;&#20250;&#25253;&#38169;.</span>
</pre>
</div>
</div>
</li>

<li><a id="org8282910"></a>Mixing set! and contract-out<br>
<div class="outline-text-5" id="text-org8282910">
<div class="org-src-container">
<pre class="src src-sh">&gt; (module server racket
    (define (inc-x!) (<span style="color: #DCDCCC; font-weight: bold;">set</span>! x (+ x 1)))
    (define x 0)
    (provide (contract-out [inc-x! (-&gt; void?)]
                           [x integer?])))
&gt; (module client racket
    (require <span style="color: #CC9393;">'server)</span>

<span style="color: #CC9393;">    (define (print-latest) (printf "x is ~s\n" x))</span>

<span style="color: #CC9393;">    (print-latest)</span>
<span style="color: #CC9393;">    (inc-x!)</span>
<span style="color: #CC9393;">    (print-latest))</span>
<span style="color: #CC9393;">&gt; (require '</span>client)
x is 0
x is 0
</pre>
</div>

<p>
è¿™é‡Œé¢è°ƒç”¨äº†ä¸€æ¬¡ <code>inc-x!</code> ,ä½†æ˜¯ç¬¬äºŒæ¬¡ <code>x</code> çš„å€¼è¿˜æ˜¯ 0, è¿™æ˜¯ä¸€ä¸ªbug,ä»¥åä¼šä¿®å¤.
</p>

<p>
è¿˜å¥½æœ‰è§£å†³æ–¹æ³•,é‚£å°±æ˜¯ç»™ <code>x</code> å®šä¹‰ä¸€ä¸ªè®¿é—®å‡½æ•° <code>get-x</code> å¹¶ä¸”å¯¼å‡ºå®ƒ.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-x</span>) x)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">inc-x!</span>) (set! x (+ x 1)))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">x</span> 0)
(provide (contract-out [inc-x! (-&gt; void?)]
                       [get-x (-&gt; integer?)]))
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-org5f8d5a9" class="outline-3">
<h3 id="org5f8d5a9">8 Input and Output</h3>
<div class="outline-text-3" id="text-org5f8d5a9">
<p>
<code>Racket</code> çš„ <code>port</code> å¯¹åº”è¿™ <code>Unix</code> ä¸­ <code>stream</code> çš„æ¦‚å¿µ.
</p>

<p>
å®ƒè¡¨ç¤ºè¿™æ•°æ®æºå¤´(source)æˆ–è€…æ•°æ®æ± (sink),æ¯”å¦‚æ–‡ä»¶,ç»ˆç«¯, <code>TCP</code> è¿æ¥æˆ–è€…ä¸€ä¸ªå†…å­˜å†…çš„å­—ç¬¦ä¸².
</p>

<p>
<code>Input ports</code> è¡¨ç¤ºç¨‹åºç”¨äºè¯»å–æ•°æ®çš„æ•°æ®æº, <code>ouput ports</code> è¡¨ç¤ºç¨‹åºç”¨äºå†™å…¥æ•°æ®çš„æ•°æ®æ± .
</p>
</div>

<div id="outline-container-orgdaceee8" class="outline-4">
<h4 id="orgdaceee8">Varieties of Ports</h4>
<div class="outline-text-4" id="text-orgdaceee8">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#25991;&#20214;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">file-out</span> (open-output-file <span style="color: #CC9393;">"file"</span>))
<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#22914;&#26524;&#25991;&#20214;&#24050;&#32463;&#23384;&#22312;,&#19978;&#38754;&#30340;&#35843;&#29992;&#23601;&#20250;&#25253;&#38169;</span>
<span style="color: #7F9F7F;">(open-output-file "file" #:exists 'truncate),&#21487;&#20197;&#22312;&#24050;&#32463;&#23384;&#22312;&#30340;&#25991;&#20214;&#21518;&#38754;&#28155;&#21152;&#20869;&#23481;;</span>
<span style="color: #7F9F7F;">(open-output-file "file" #:exists 'update),&#21487;&#20197;&#37325;&#20889;&#24050;&#32463;&#23384;&#22312;&#30340;&#25991;&#20214;</span>
<span style="color: #7F9F7F;">|#</span>

(display <span style="color: #CC9393;">"hello"</span> file-out)
(close-output-port file-out) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#20851;&#38381; output port,&#36866;&#29992;&#20110;&#25152;&#26377;&#31867;&#22411;&#30340; output port</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">file-in</span> (open-input-file <span style="color: #CC9393;">"file"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#24320; port</span>
(read-line file-in) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"hello"</span>
(close-input-port file-in) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#20851;&#38381; input port,&#36866;&#29992;&#20110;&#25152;&#26377;&#31867;&#22411; input port</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">call-with-*-file &#26159;&#19978;&#38754;&#30340;&#31616;&#21270;&#29256;&#26412;,&#33258;&#21160;&#20851;&#38381;port</span>

(<span style="color: #F0DFAF; font-weight: bold;">call-with-output-file</span> <span style="color: #CC9393;">"file"</span>
                       <span style="color: #DCDCCC; font-weight: bold;">#:exists</span> 'truncate
                       (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (out)
                         (display <span style="color: #CC9393;">"hello"</span> out)))

(<span style="color: #F0DFAF; font-weight: bold;">call-with-input-file</span> <span style="color: #CC9393;">"file"</span>
                      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (in)
                        (read-line in)))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#23383;&#31526;&#20018;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">string-out</span> (open-output-string))
(display <span style="color: #CC9393;">"hello"</span> string-out)
(get-output-string string-out) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"hello"</span>
(close-output-port string-out)

(read-line (open-input-string <span style="color: #CC9393;">"goodbye\nfarewell"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"goodbye"</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20063;&#26377;call-with-*-string &#29256;&#26412;,&#19981;&#36807;&#26377;&#28857;&#22855;&#24618;,&#25152;&#20197;&#23601;&#19981;&#28436;&#31034;&#20102;</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">TCP&#36830;&#25509;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">server</span> (tcp-listen 12345)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#30417;&#21548;&#26412;&#22320;&#30340;12345&#31471;&#21475;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (client-in client-out) (tcp-connect <span style="color: #CC9393;">"localhost"</span> 12345)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36830;&#25509;&#21040;&#26381;&#21153;&#22120;&#24182;&#19988;&#33719;&#24471;&#23458;&#25143;&#31471;&#30340;input/output ports</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (server-in server-out) (tcp-accept server)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26381;&#21153;&#22120;&#31561;&#24453;&#36830;&#25509;,&#33719;&#24471;&#26381;&#21153;&#22120;&#30340; input/ouput ports</span>
(display <span style="color: #CC9393;">"hello\n"</span> client-out)
(close-output-port client-out) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32473;&#26381;&#21153;&#22120;&#21457;&#36865;&#20449;&#24687;</span>
(close-input-port client-in)
(read-line server-in) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35835;&#21462;&#25910;&#21040;&#30340;&#20449;&#24687;</span>
(read-line server-in)
(tcp-abandon-port server-in)
(tcp-abandon-port server-out)

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#31243;&#24207;&#31649;&#36947;(Process Pipes)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20381;&#27425;&#36820;&#22238; subprocess &#21644; subprocess &#30340; stdin, stdout &#21644; stderr,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#27880;&#24847;subprocess&#30340;input&#23601;&#26159;&#25105;&#20204;&#30340;output</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (pp stdout stdin stderr)
  (subprocess #f #f #f <span style="color: #CC9393;">"/usr/bin/wc"</span> <span style="color: #CC9393;">"-w"</span>))
(display <span style="color: #CC9393;">"a b c\n"</span> stdin)
(close-output-port stdin)
(read-line stdout) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"3"</span>
(close-input-port stdout)
(close-input-port stderr)

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#20869;&#37096;&#31649;&#36947;(Internal pipes)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19982; OS level &#30340; process pipe &#19981;&#19968;&#26679;, &#20869;&#37096;&#31649;&#36947;&#26159; Racket &#19987;&#29992;&#30340;,&#19982;&#29992;&#22312;&#19981;&#21516;&#31243;&#24207;&#20043;&#38388;&#20132;&#27969;&#30340;&#30340; OS-level &#31649;&#36947;&#26080;&#20851;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (ip-in ip-out) (make-pipe))
(display <span style="color: #CC9393;">"garbage"</span> out)
(close-output-port out)
(read-line in) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"garbage"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf167bd1" class="outline-4">
<h4 id="orgf167bd1">Default Ports</h4>
<div class="outline-text-4" id="text-orgf167bd1">
<p>
ä½¿ç”¨ <code>OS-level stdin, stdout å’Œ stderr</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(display <span style="color: #CC9393;">"Hi"</span>)
(display <span style="color: #CC9393;">"Hi"</span> (current-output-port)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the same</span>
(display <span style="color: #CC9393;">"Ouch!"</span> (current-error-port))
(read-line (current-input-port)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35201;&#27714;&#36755;&#20837;</span>

(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([s (open-output-string)])
  (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-error-port s])
    (display <span style="color: #CC9393;">"Ouch!"</span> (current-error-port)))
  (get-output-string s)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"Ouch!"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org877fcf7" class="outline-4">
<h4 id="org877fcf7">Reading and Writing Racket Data</h4>
<div class="outline-text-4" id="text-org877fcf7">
<p>
<code>Racket</code> æä¾›ä¸‰ç§æ‰“å° <code>Racket</code> å€¼çš„æ–¹æ³•.
</p>

<p>
<code>print, write å’Œ display</code> ,åˆ†åˆ«å¯¹åº” <code>Racket</code> è¯­æ³•çš„è¡¨è¾¾å¼å±‚(expression layer),è¯»å–å™¨å±‚(reader layer)å’Œå­—ç¬¦å±‚(character layer).
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#34920;&#36798;&#24335;           |   &#25171;&#21360;</span>

(print 1/2)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1/2</span>
(print #\x)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#\x</span>
(print <span style="color: #CC9393;">"hello"</span>)        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"hello"</span>
(print #<span style="color: #CC9393;">"goodbye"</span>)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#"goodbye"</span>
(print '<span style="color: #CC9393;">|pea pod|</span>)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'|pea pod|</span>
(print '(<span style="color: #CC9393;">"i"</span> pod))     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'("i" pod)</span>
(print write)          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#&lt;procedure:write&gt;</span>

(write 1/2)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1/2</span>
(write #\x)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#\x</span>
(write <span style="color: #CC9393;">"hello"</span>)        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"hello"</span>
(write #<span style="color: #CC9393;">"goodbye"</span>)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#"goodbye"</span>
(write '<span style="color: #CC9393;">|pea pod|</span>)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">|pea pod|</span>
(write '(<span style="color: #CC9393;">"i"</span> pod))     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">("i" pod)</span>
(write write)          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#&lt;procedure:write&gt;</span>

(display 1/2)          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1/2</span>
(display #\x)          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">x</span>
(display <span style="color: #CC9393;">"hello"</span>)      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">hello</span>
(display #<span style="color: #CC9393;">"goodbye"</span>)   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">goodbye</span>
(display '<span style="color: #CC9393;">|pea pod|</span>)   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">pea pod</span>
(display '(<span style="color: #CC9393;">"i"</span> pod))   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(i pod)</span>
(display write)        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#&lt;procedure:write&gt;</span>
</pre>
</div>

<p>
<code>printf</code> æ”¯æŒæ ¼å¼åŒ–æ‰“å°,é‡Œé¢çš„æœ‰3ä¸ªæ ¼å¼è¯å­—ç¬¦ä¸²(format string) <code>~a,~så’Œ~v</code> åˆ†åˆ«å¯¹åº” <code>display,writeå’Œprint</code> .
</p>

<p>
ä¸ <code>display å’Œ print</code> ç›¸å¯¹, ä½¿ç”¨ <code>write</code> å†™å…¥æ•°æ®å,å¯ä»¥é€šè¿‡ <code>read</code> è¯»å–å›æ¥.
</p>

<p>
<code>print</code> å†™å…¥æ•°æ®åä¹Ÿå¯ä»¥é€šè¿‡ <code>read</code> è¯»å–,ä¸è¿‡å¯èƒ½ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„ <code>quote form</code> ,å› ä¸º <code>display forms</code> åƒè¡¨è¾¾å¼ä¸€æ ·è¢«è¯»å–.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (in out) (make-pipe))
(write <span style="color: #CC9393;">"hello"</span> out)
(read in)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"hello"</span>
(write '(<span style="color: #CC9393;">"alphabet"</span> soup) out)
(read in)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'("alphabet" soup)</span>
(write #hash((a . <span style="color: #CC9393;">"apple"</span>) (b . <span style="color: #CC9393;">"banana"</span>)) out)
(read in)

(print '(<span style="color: #CC9393;">"alphabet"</span> soup) out)
(read in)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">''("alphabet" soup)</span>

(display '(<span style="color: #CC9393;">"alphabet"</span> soup) out)
(read in)     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(alphabet soup)</span>
</pre>
</div>

<p>
ä»ä¸Šé¢çœ‹å‡ºå¯ä»¥ç”¨ <code>write</code> æ¥åºåˆ—åŒ– <code>Racket</code> æ•°æ®.
</p>
</div>
</div>

<div id="outline-container-orga892110" class="outline-4">
<h4 id="orga892110">Datatypes and Serialization</h4>
<div class="outline-text-4" id="text-orga892110">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#24207;&#21015;&#21270;&#25968;&#25454;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (in out) (make-pipe))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20869;&#32622;&#25968;&#25454;&#31867;&#22411;</span>
(write #s(sprout bean) out)
(read in)       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'#s(sprout bean)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32467;&#26500;&#20307;,&#21482;&#33021;&#26159;prefab&#31867;&#22411;&#25110;&#32773;transparent&#31867;&#22411;(prefab&#31867;&#22411;&#20063;&#26159;transparent)&#21487;&#20197;&#35835;&#21462;&#22238;&#26469;,&#20063;&#23601;&#26159;&#36825;&#20004;&#31181;&#21487;&#20197;&#24207;&#21015;&#21270;</span>
(struct posn (x y) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)
(write (posn 1 2) out)
(read in)       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'#(struct:posn 1 2)</span>

(struct prefab-posn (x y) <span style="color: #DCDCCC; font-weight: bold;">#:prefab</span>)
(write (prefab-posn 1 2) out)
(read in)       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'#s(prefab-posn 1 2)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21487;&#20197;&#21033;&#29992; serializable-struct &#23450;&#20041;&#19968;&#31181;&#29305;&#24847;&#29992;&#20110;&#24207;&#21015;&#21270;&#30340;&#32467;&#26500;&#20307;</span>
(require racket/serialize)
(serializable-struct se-posn (x y) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)
(deserialize (serialize (se-posn 1 2)))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(se-posn 1 2)</span>
(write (serialize (se-posn 1 2)) out)
(deserialize (read in)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(se-posn 1 2)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1df3d4c" class="outline-4">
<h4 id="org1df3d4c">Bytes, Characters, and Encoding</h4>
<div class="outline-text-4" id="text-org1df3d4c">
<p>
<code>read-line, read, display å’Œ write</code> å…¨éƒ¨éƒ½æ˜¯æ ¹æ®å­—ç¬¦æ¥å·¥ä½œçš„.
</p>

<p>
æ¦‚å¿µä¸Šæ¥è¯´,å®ƒä»¬æ˜¯æ ¹æ® <code>read-char</code> å’Œ <code>write-char</code> æ¥å®ç°çš„.åœ¨æ›´åº•å±‚ä¸Š, <code>ports</code> è¯»å†™ç”Ÿå­—èŠ‚è€Œä¸æ˜¯å­—ç¬¦.
</p>

<p>
å®é™…ä¸Š, <code>read-char</code> å’Œ <code>write-char</code> æ˜¯åˆ†åˆ«æ ¹æ® <code>read-byte</code> å’Œ <code>write-byte</code> å®ç°çš„.å½“å­—èŠ‚å€¼å°äº128,
</p>

<p>
å°±ä½¿ <code>ASCII</code> ç¼–ç ,å…¶å®ƒå­—èŠ‚å°±ç”¨ <code>UTF-8</code> ç¼–ç .å¦‚æœæƒ³ç”¨å…¶å®ƒç¼–ç å¯ä»¥ä½¿ç”¨ <code>reencode-input-port</code> æˆ– <code>reencode-output-port</code> ,
</p>

<p>
å…¶ä¸­ <code>reencode-input-port</code> ä¼šæŠŠæŒ‡å®šç¼–ç çš„è¾“å…¥æµè½¬åŒ–æˆ <code>UTF-8</code> æµ, <code>read-byte</code> ä¹Ÿä¼šçœ‹åˆ°é‡æ–°ç¼–ç è¿‡çš„æ•°æ®,è€Œä¸æ˜¯åŸå§‹çš„å­—èŠ‚æµ.
</p>
</div>
</div>

<div id="outline-container-orgcf802c4" class="outline-4">
<h4 id="orgcf802c4">I/O Patterns</h4>
<div class="outline-text-4" id="text-orgcf802c4">
<p>
å¦‚æœæƒ³å•ç‹¬å¤„ç†æ–‡æ¡£çš„æ¯ä¸€è¡Œ,å¯ä»¥ä½¿ç”¨ <code>for</code> å’Œ <code>in-lines</code> forms.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">call-with-input-file</span> <span style="color: #CC9393;">"file"</span>
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (in)
    (for ([l (in-lines in)])
      (display l)
      (newline))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">o</span> (open-output-string))
(copy-port (open-input-string <span style="color: #CC9393;">"broom"</span>) o)
(get-output-string o) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"broom"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7714c01" class="outline-3">
<h3 id="org7714c01">9 Regular Expressions</h3>
<div class="outline-text-3" id="text-org7714c01">
<p>
<code>#rx</code> for <code>regexp</code> , <code>#px</code> for <code>pregexp</code>,
</p>

<p>
å’Œ <code>Python</code> ä¸ä¸€æ ·, <code>Racket</code> çš„æ­£åˆ™è¡¨è¾¾å¼æ˜¯å…ˆåƒå­—ç¬¦ä¸²é‚£æ ·è¢«å¤„ç†è¿‡æ‰èƒ½ç”¨,
</p>

<p>
åœ¨ <code>Python</code> <code>\(a\), \\(a\\) æˆ–è€… r\(a\)</code> éƒ½æ˜¯å¯ä»¥åŒ¹é… <code>(a)</code> ,è€Œ <code>Racket</code> åªèƒ½ç”¨ <code>#rx\\(a\\), #px\\(a\\) æˆ–è€… \\(a\\)</code> åŒ¹é….
</p>

<p>
å¯ä»¥å‘ç° <code>Racket</code> æ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ˜¯åƒå­—ç¬¦ä¸€æ ·è§£æçš„,å…¶å® <code>Emacs Lisp</code> ä¹Ÿæ˜¯ä¸€æ ·.è¿™å°±æ˜¯ <code>Racket</code> æ­£åˆ™è¡¨è¾¾å¼è¦æ³¨æ„çš„ç‚¹.
</p>

<p>
å…·ä½“å°±ä¸è¯´äº†,æ¯é—¨è¯­è¨€çš„æ­£åˆ™è¿™ä¸œè¥¿å¤§ä½“æ˜¯ä¸€æ ·çš„.
</p>
</div>
</div>

<div id="outline-container-org2608008" class="outline-3">
<h3 id="org2608008">10 Exceptions and Control</h3>
<div class="outline-text-3" id="text-org2608008">
</div>
<div id="outline-container-org1c21f8a" class="outline-4">
<h4 id="org1c21f8a">Exceptions</h4>
<div class="outline-text-4" id="text-org1c21f8a">
<p>
æ•æ‰å¼‚å¸¸:
</p>

<ul class="org-ul">
<li><code>with-handlers</code> form</li>
</ul>

<p>
å¼•å‘å¼‚å¸¸:
</p>

<ul class="org-ul">
<li><p>
<code>error</code>
</p>

<p>
æ‰“åŒ…é”™è¯¯ä¿¡æ¯å¹¶ä¸”å¼•å‘å¼‚å¸¸
</p></li>

<li><p>
<code>raise</code>
</p>

<p>
ä»¥ä¸€ä¸ªå€¼åšä¸ºå¼•å‘å¼‚å¸¸çš„å€¼
</p></li>
</ul>

<p>
<a href="https://docs.racket-lang.org/reference/exns.html#%28def._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._exn%29%29">å†…ç½®å¼‚å¸¸ä»¥åŠå®ƒä»¬çš„ç»§æ‰¿å…³ç³»</a>,æŒ‡å®šå¼‚å¸¸çš„æ—¶å€™ä¼šç”¨å¾—ä¸Š.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(with-handlers ([(<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v) #t)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(lambda (v) #t) &#20570;&#20026;&#35859;&#35789;(predicate)&#21487;&#20197;&#25429;&#25417;&#25152;&#26377;&#24322;&#24120;,</span>
                 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (exn) 'error)])    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">exn &#26159;&#24322;&#24120;&#31867;&#22411;,&#21487;&#20197;&#35774;&#23450;&#22810;&#23545; predicate-expr handler-expr</span>
  (error <span style="color: #CC9393;">"Error raised by me"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36820;&#22238; 'error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd4a4b62" class="outline-4">
<h4 id="orgd4a4b62">Prompts and Aborts</h4>
<div class="outline-text-4" id="text-orgd4a4b62">
<p>
åœ¨ <code>REPL</code> é‡Œé¢å¯ä»¥åœ¨å‘ç”Ÿå¼‚å¸¸åè¿˜èƒ½ç»§ç»­æ‰§è¡Œ.
</p>

<p>
ä½†æ˜¯ <code>REPL</code> å¹¶ä¸æ˜¯ç”¨ <code>with-handlers</code> å®ç°è¿™åŠŸèƒ½çš„,è€Œæ˜¯ç”¨ <code>prompt</code> (æç¤º)å®ç°çš„, <code>prompt</code> æœ‰ä¸€ä¸ªé€ƒè„±ç‚¹(escape point)æ ‡è®°ç€è®¡ç®—ä¸Šä¸‹æ–‡.
</p>

<p>
å¦‚æœå¼‚å¸¸æ²¡æœ‰è¢«(<code>with-handlers</code>)æ•æ‰å°±ä¼šæ‰“å°å¼‚å¸¸ä¿¡æ¯,ç„¶åè®¡ç®—å°±ä¼šåœ¨æœ€è¿‘çš„é—­åˆæç¤º(the nearest enclosing prompt)ä¸­æ–­(abort).
</p>

<p>
åœ¨ <code>REPL</code> ä¸­,æ¯ä¸€ä¸ªæ¬¡äº¤äº’éƒ½æ˜¯è¢«åŒ…è£¹ç€ä¸€ä¸ª <code>prompt</code> .
</p>

<p>
å‡†ç¡®ç‚¹å°±æ˜¯æ¯ä¸ªæç¤ºéƒ½æœ‰ä¸€ä¸ªæç¤ºæ ‡ç­¾(prompt tag),æœªæ•æ‰å¼‚å¸¸å¤„ç†å™¨(uncaught-exception handler)ä¼šä½¿ç”¨ä¸€ä¸ªé»˜è®¤æç¤ºæ ‡ç­¾(default prompt tag)è¿›è¡Œä¸­æ–­.
</p>

<p>
è¯´çš„ç®€å•ç‚¹,è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼äº <code>C</code> çš„ <code>goto</code> è¯­å¥,è·Ÿ <code>Emacs Lisp</code> æ¯”çš„è¯å°±åƒ <code>throw</code> å’Œ <code>catch</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">escape</span> v)
    (abort-current-continuation                         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Emacs Lisp &#30340; throw form</span>
     (default-continuation-prompt-tag)                  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Emacs Lisp throw form &#30340; tag</span>
     (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () v)))                                    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Emacs Lisp throw form &#30340; value</span>

(+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (escape 0)))))))          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">0</span>

(+ 1                                                    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26368;&#21518;&#36820;&#22238; 1</span>
     (call-with-continuation-prompt                     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Emacs Lisp &#30340; catch form,&#35774;&#32622;&#22909;prompt tag</span>
      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()                                        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Emacs Lisp catch form &#30340; body</span>
        (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (+ 1 (escape 0))))))))
      (default-continuation-prompt-tag)))               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Emacs Lisp catch form &#30340; tag</span>
</pre>
</div>

<p>
è‡ªå·±å†™çš„å¦å¤–ä¸€ä¸ªä¾‹å­(å®Œå…¨å°±æ˜¯ä»¿ç…§Emacs Lispçš„æ¥å†™çš„,æœç„¶éƒ½æ˜¯Lispå®¶æ—çš„äºº).
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">my-tag</span> (make-continuation-prompt-tag))

(+ 1                                                 <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26368;&#21518;&#32467;&#26524;&#36820;&#22238;5</span>
   (call-with-continuation-prompt
    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
      (+ 1
         (abort-current-continuation
          my-tag
          (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () 4))))
    my-tag))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd51a502" class="outline-4">
<h4 id="orgd51a502">Continuations</h4>
<div class="outline-text-4" id="text-orgd51a502">
<p>
ä¸€ä¸ªç»­å»¶(continuation)å°±æ˜¯ä¸€ä¸ªå€¼,è¡¨ç¤ºè¡¨è¾¾å¼è¢«å¥—ç”¨çš„è®¡ç®—ä¸Šä¸‹æ–‡.
</p>

<p>
<code>call-with-composable-continuation</code> å‡½æ•°ä»å½“å‰å‡½æ•°è°ƒç”¨çš„å¤–å±‚åˆ°æœ€è¿‘çš„é—­åˆ <code>prompt</code> .
</p>

<p>
(æ¯ä¸€æ¬¡ <code>REPL</code> äº¤äº’éƒ½è¢«ä¸€ä¸ªçœ‹ä¸è§çš„ <code>prompt</code> åŒ…è£¹ç€).
</p>


<p>
ä¸‹é¢è¿™ä¸ªä¾‹å­åªèƒ½åœ¨ <code>REPL</code> ä¸­æ­£å¸¸è¿è¡Œ,
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">saved-k</span> #f)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">save-it!</span>)
  (call-with-composable-continuation
    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (k)       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">k &#23601;&#26159;&#34987;&#25429;&#33719;&#30340; continuation,&#25226;&#23427;&#20445;&#23384;&#22312; saved-k</span>
      (set! saved-k k)
      0)))            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35843;&#29992; save-it! &#21518;&#36820;&#22238; 0</span>

(+ 1 (+ 1 (+ 1 (save-it!))))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32467;&#26524;&#20026; 3, saved-k &#29616;&#22312;&#20026; (+ 1 (+ 1 (+ 1 []))), [] &#23601;&#26159;&#20043;&#21518;&#22635;&#20837;&#30340;&#19996;&#35199;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">saved-k &#21487;&#20197;&#36825;&#20040;&#34920;&#31034; (lambda (v) (+ 1 (+ 1 (+ 1 v))))</span>

(saved-k 0) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>

(saved-k 10) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">13</span>

(saved-k (saved-k 0)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">6</span>
</pre>
</div>

<p>
å¦‚æœæƒ³è¦åœ¨é <code>REPL</code> ä¸­ä¹Ÿèƒ½è¿è¡Œ,å°±è¦åœ¨ save-it! è°ƒç”¨çš„åœ°æ–¹åšä¸€ä¸‹æ‰‹è„š,
</p>

<p>
(è¿˜è®°å¾— <code>call-with-composable-continuation</code> æ˜¯æ€ä¹ˆæ•è·å¼‚å¸¸çš„å—?)
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">saved-k</span> #f)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">save-it!</span>)
  (call-with-composable-continuation
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (k) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">k is the captured continuation</span>
     (set! saved-k k)
     0)))

(call-with-continuation-prompt         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36825;&#26679;&#21487;&#20197;&#35774;&#32622; call-with-composable-continuation &#25429;&#33719;&#20572;&#27490;&#30340;&#22320;&#26041;</span>
 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
   (+ 1 (+ 1 (+ 1 (save-it!)))))
 (default-continuation-prompt-tag))

(saved-k 0)

(saved-k 10)

(saved-k (saved-k 0))                  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32467;&#26524;&#21644;&#21069;&#38754;&#30340;&#19968;&#26679;</span>
</pre>
</div>

<p>
<code>Racket (or Scheme)</code> æœ‰ä¸€ä¸ªä¼ ç»Ÿçš„ <code>call-with-current-continuation</code> æˆ–è€…ç®€å†™ä¸º <code>call/cc</code> ,
</p>

<p>
å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>call/cc</code> æ¥è¿è¡Œ,ä¸è¿‡ç»“æœä¼šæœ‰ç‚¹ä¸ä¸€æ ·,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">saved-k</span> #f)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">save-it!</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">call/cc</span>
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (k) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">k is the captured continuation</span>
     (set! saved-k k)
     0)
   ))

(+ 1 (+ 1 (+ 1 (save-it!))))

(saved-k 0)

(saved-k 10)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21069;&#38754;&#30340;&#32467;&#26524;&#37117;&#19968;&#26679;,&#36825;&#37324;&#32467;&#26524;&#20026;3,&#24212;&#29992;&#23436;&#31532;&#19968;&#27425;&#21518;&#23601;&#36339;&#20986;&#20102;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25991;&#26723;&#21407;&#25991;&#26377;&#19968;&#21477;&#35828;&#26126;&#20102; call/cc &#21644; call-with-composable-continuation &#30340;&#19981;&#21516;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">It is like call-with-composable-continuation,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">but applying the captured continuation first aborts (to the current prompt)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">before restoring the saved continuation.</span>
(saved-k (saved-k 0))
</pre>
</div>

<p>
è¿™ä¸ªä¾‹å­è¯´æ˜äº† <code>call-with-composable-continuation</code> å’Œ <code>call/cc</code> è¿˜æ˜¯éµå®ˆè¯­ä¹‰ä¸€è‡´çš„.
</p>
</div>
</div>
</div>

<div id="outline-container-org6612078" class="outline-3">
<h3 id="org6612078">11 Iterations and Comprehensions</h3>
<div class="outline-text-3" id="text-org6612078">
<p>
<code>for family of syntactic forms</code> æ”¯æŒç­‰å¾…(iteration over)åºåˆ—(sequences).
</p>

<p>
<code>Lists, vectors, strings, byte strings, input ports, å’Œ hash table</code> éƒ½å¯ä»¥ç”¨ä½œåºåˆ—,å¹¶ä¸”åƒ <code>in-range</code> è¿™ç§æ„é€ å‡½æ•°æä¾›æ›´å¤šç±»å‹çš„åºåˆ—.
</p>

<p>
<code>for</code> çš„åŸºæœ¬ç”¨æ³•,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for ([i '(1 2 3)]
      [j '(4 5 6)])
  (displayln (format <span style="color: #CC9393;">"~a"</span> (list i j)))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32467;&#26524;&#26159;void</span>
</pre>
</div>

<p>
<code>for/list</code> åˆ—è¡¨æ¨å¯¼å¼(list comprehension),åˆ—è¡¨æ¨å¯¼å¼å°±æ˜¯æŠŠæ¯ä¸€æ¬¡çš„è¿­ä»£ç»“æœéƒ½ç´¯ç§¯ä¸‹æ¥æˆä¸ºä¸€ä¸ªåˆ—è¡¨,
</p>

<p>
æ¯”å¦‚æŠŠä¸Šé¢çš„ä¾‹å­ç”¨ <code>for/list</code> å®è·µä¸€ä¸‹,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for/list ([i '(1 2 3)]
           [j '(4 5 6)])
  (list i j))           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32467;&#26524;&#26159; '((1 4) (2 5) (3 6)),&#19981;&#26159;void</span>
</pre>
</div>
</div>


<div id="outline-container-orgc0b75d2" class="outline-4">
<h4 id="orgc0b75d2">Sequence Constructors</h4>
<div class="outline-text-4" id="text-orgc0b75d2">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for/list ([i (in-range 4 2 -1)]) i) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(in-range start end step),start&#21644;step&#37117;&#26159;&#21487;&#36873;&#30340;,&#20998;&#21035;&#26159;0&#21644;1.</span>

(for ([i (in-naturals)])    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(in-naturals)&#20250;&#20174;0&#24320;&#22987;&#26080;&#38480;&#36845;&#20195;&#19979;&#21435;,&#21482;&#26377;&#24490;&#29615;&#20869;&#37096;&#21457;&#29983;&#20102;&#24322;&#24120;&#25110;&#32773;&#20854;&#23427;&#36867;&#33073;&#30340;&#21150;&#27861;&#25165;&#21487;&#20197;&#20572;&#27490;</span>
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (= i 10)
      (error <span style="color: #CC9393;">"too much!"</span>)
      (display i)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#29992;&#19968;&#20010;&#19981;&#24341;&#21457;&#24322;&#24120;&#30340;&#20889;&#27861;,</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">my-tag</span> (make-continuation-prompt-tag))

(call-with-continuation-prompt
 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
   (for ([i (in-naturals)])
     (<span style="color: #F0DFAF; font-weight: bold;">if</span> (= i 10)
         (abort-current-continuation
          my-tag
          (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () (void)))
         (display i))))
   my-tag)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#24179;&#34892;&#36845;&#20195;&#20004;&#20010;&#24207;&#21015;,&#36845;&#20195;&#27425;&#25968;&#26159;&#24207;&#21015;&#39033;&#26368;&#23569;&#30340;&#24207;&#21015;&#39033;&#25968;</span>
(for ([i (in-naturals 1)]                          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26080;&#38480;&#20010;&#39033;</span>
      [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Detials"</span> <span style="color: #CC9393;">"Conclusion"</span>)]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3&#20010;&#39033;,&#36845;&#20195;3&#24046;</span>
  (printf <span style="color: #CC9393;">"Chapter ~a. ~a\n"</span> i chapter))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">stop-before &#21644; stop-after &#26681;&#25454;&#32473;&#23450;&#30340;&#24207;&#21015;(sequence)&#21644;&#35859;&#35789;(predicate)&#26500;&#24314;&#19968;&#20010;&#26032;&#30340;&#24207;&#21015;</span>
(for ([i (stop-before <span style="color: #CC9393;">"abc def ghi"</span>
                      char-whitespace?)])
  (display i))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20004;&#32773;&#24046;&#19968;&#20010; #\space</span>
(sequence-&gt;list (stop-before <span style="color: #CC9393;">"abc def ghi"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(#\a #\b #\c)</span>
(sequence-&gt;list (stop-after <span style="color: #CC9393;">"abc def ghi"</span>))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(#\a #\b #\c #\space)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36824;&#26377;&#24456;&#22810;&#24207;&#21015;&#26500;&#36896;&#22120;,&#27604;&#22914; in-list, in-vector &#21644; in-string,&#22914;&#26524;&#20256;&#20837;&#30340;&#20540;&#31867;&#22411;&#38169;&#35823;&#23601;&#20250;&#24341;&#21457;&#24322;&#24120;.</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5add9d8" class="outline-4">
<h4 id="org5add9d8">for and for*</h4>
<div class="outline-text-4" id="text-org5add9d8">
<p>
<code>for</code> è¿˜æ”¯æŒ <code>#:when</code> å’Œ <code>#:unless</code> é€‰é¡¹ç­›é€‰è¿­ä»£é¡¹.
</p>

<p>
<code>for*</code> å’Œ <code>for</code> çš„ç”¨æ³•ç›¸ä¼¼,è¿­ä»£å¤šä¸ªåºåˆ—çš„æ—¶å€™,å®ƒä»¬å°±æœ‰å·®åˆ«äº†.
</p>

<p>
<code>for*</code> å¦‚æœè¿­ä»£ä¸¤ä¸ªåºåˆ— <code>m</code> å’Œ <code>n</code>,é•¿åº¦åˆ†åˆ«ä¸º <code>lm</code> å’Œ <code>ln</code> ,é‚£ä¹ˆè¿­ä»£æ¬¡æ•°ä¸º <code>lm * ln</code> ,å°±æ˜¯åµŒå¥— <code>for</code> .
</p>

<p>
å¤šä¸ªåºåˆ—çš„è¿­ä»£æ¬¡æ•°ä¸º <code>lm * ln * lo * ... * lz</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for* ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span>)]
       [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)]
       <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter <span style="color: #CC9393;">"Details"</span>)))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#24403;chapter&#19981;&#31561;&#20110;"Details"&#30340;&#26102;&#20505;&#25165;&#36845;&#20195;,&#23601;&#26159;&#31579;&#36873;&#25481;"Details"</span>
  (printf <span style="color: #CC9393;">"~a ~a\n"</span> book chapter))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25913;&#25481;&#20070;&#19978;&#30340;&#20363;&#23376;,&#25226;#:when&#25913;&#20026;#:unless</span>
(for ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span> <span style="color: #CC9393;">"Notes"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:unless</span> (equal? book <span style="color: #CC9393;">"Notes"</span>)
      [i (in-naturals 1)]
      [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span> <span style="color: #CC9393;">"Index"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:unless</span> (equal? chapter <span style="color: #CC9393;">"Index"</span>))
  (printf <span style="color: #CC9393;">"~a Chapter ~a. ~a\n"</span> book i chapter))
</pre>
</div>
</div>
</div>

<div id="outline-container-org87fc560" class="outline-4">
<h4 id="org87fc560">for/list and for*/list</h4>
<div class="outline-text-4" id="text-org87fc560">
<p>
ä¸ <code>for and for*</code> çš„å·®ä¸å¤š,åªä¸è¿‡ <code>for/list å’Œ for*/list</code> æ˜¯æ¨å¯¼å¼,æŠŠä¸Šé¢çš„ä¾‹å­æ”¹ä¸€æ”¹,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for*/list ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span>)]
       [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)]
       <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter <span style="color: #CC9393;">"Details"</span>)))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#24403;chapter&#19981;&#31561;&#20110;"Details"&#30340;&#26102;&#20505;&#25165;&#36845;&#20195;,&#23601;&#26159;&#31579;&#36873;&#25481;"Details"</span>
  (format <span style="color: #CC9393;">"~a ~a\n"</span> book chapter))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25913;&#25481;&#20070;&#19978;&#30340;&#20363;&#23376;,&#25226;#:when&#25913;&#20026;#:unless</span>
(for/list ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span> <span style="color: #CC9393;">"Notes"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:unless</span> (equal? book <span style="color: #CC9393;">"Notes"</span>)
      [i (in-naturals 1)]
      [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span> <span style="color: #CC9393;">"Index"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:unless</span> (equal? chapter <span style="color: #CC9393;">"Index"</span>))
  (format <span style="color: #CC9393;">"~a Chapter ~a. ~a\n"</span> book i chapter))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2d6af24" class="outline-4">
<h4 id="org2d6af24">for/vector and for*/vector</h4>
<div class="outline-text-4" id="text-org2d6af24">
<p>
ä¸ <code>for/list and for*/list</code> è¯­æ³•ä¸€æ ·,å·®åˆ«åœ¨äºæ¨å¯¼å¼ç»“æœå¼ä¸€ä¸ª <code>vector</code> ä¸æ˜¯ <code>list</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for*/vector ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span>)]
       [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)]
       <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter <span style="color: #CC9393;">"Details"</span>)))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#24403;chapter&#19981;&#31561;&#20110;"Details"&#30340;&#26102;&#20505;&#25165;&#36845;&#20195;,&#23601;&#26159;&#31579;&#36873;&#25481;"Details"</span>
  (format <span style="color: #CC9393;">"~a ~a\n"</span> book chapter))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25913;&#25481;&#20070;&#19978;&#30340;&#20363;&#23376;,&#25226;#:when&#25913;&#20026;#:unless</span>
(for/vector ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span> <span style="color: #CC9393;">"Notes"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:unless</span> (equal? book <span style="color: #CC9393;">"Notes"</span>)
      [i (in-naturals 1)]
      [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span> <span style="color: #CC9393;">"Index"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:unless</span> (equal? chapter <span style="color: #CC9393;">"Index"</span>))
  (format <span style="color: #CC9393;">"~a Chapter ~a. ~a\n"</span> book i chapter))
</pre>
</div>
</div>
</div>

<div id="outline-container-org781cc4b" class="outline-4">
<h4 id="org781cc4b">for/and and for/or</h4>
<div class="outline-text-4" id="text-org781cc4b">
<p>
éå†æ¯ä¸ªå…ƒç´ ,å¹¶ä¸”æ¯éå†ä¸€ä¸ªå°±ç”¨ <code>and</code> æˆ–è€… <code>or</code> è®¡ç®—è¿ç®—ç»“æœ, <code>and</code> ä¸€æ—¦é‡åˆ° <code>#f</code>, <code>or</code> ä¸€æ—¦é‡åˆ° <code>#t</code> å°±åœæ­¢è¿­ä»£å¹¶ä¸”è¿”å›å¸ƒå°”å€¼.
</p>

<p>
è¿˜æœ‰åµŒå¥—ç‰ˆæœ¬çš„ <code>for*/and</code> å’Œ <code>for*/or</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for/and ([i '(1 2 3 <span style="color: #CC9393;">"x"</span>)])
  (i . &lt; . 3))               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>

(for/and ([i '(1 2 3 4)])
  i)                         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">4</span>

(for/or ([i '(1 2 3 <span style="color: #CC9393;">"x"</span>)])
  (i . &lt; . 3))               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>

(for/or ([i '(1 2 3 4)])
  i)                         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e61567" class="outline-4">
<h4 id="org9e61567">for/first and for/last</h4>
<div class="outline-text-4" id="text-org9e61567">
<p>
åˆ†åˆ«è¿”å›ç¬¬ä¸€æ¬¡å’Œæœ€åä¸€æ¬¡è¿­ä»£çš„è¿ç®—ç»“æœ.å½“ç„¶ä¹Ÿæœ‰ <code>for*/first</code> å’Œ <code>for*/last</code> ç‰ˆæœ¬.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for/first ([chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span> <span style="color: #CC9393;">"Index"</span>)]
            <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter <span style="color: #CC9393;">"Intro"</span>)))
  (displayln chapter)
  chapter)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#36820;&#22238;"Details",&#21482;&#26159;&#36845;&#20195;&#19968;&#27425;,&#22914;&#26524;&#19968;&#27425;&#20063;&#27809;&#26377;&#36845;&#20195;&#36807;&#36820;&#22238;#f</span>


(for/last ([chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span> <span style="color: #CC9393;">"Index"</span>)]
           <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter <span style="color: #CC9393;">"Index"</span>)))
  (displayln chapter)
  chapter)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">"Conclusion",&#20840;&#37096;&#36845;&#20195;&#23436;,&#36820;&#22238;&#26368;&#21518;&#19968;&#27425;&#30340;&#36845;&#20195;&#32467;&#26524;,&#22914;&#26524;&#19968;&#27425;&#20063;&#27809;&#26377;&#36845;&#20195;&#36807;&#36820;&#22238;#f</span>

(for*/first ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span>)]
             [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span> <span style="color: #CC9393;">"Index"</span>)]
             <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter <span style="color: #CC9393;">"Intro"</span>)))
  (list book chapter))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'("Guide" "Details")</span>

(for*/last ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span>)]
            [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span> <span style="color: #CC9393;">"Index"</span>)]
            <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter <span style="color: #CC9393;">"Index"</span>)))
  (list book chapter))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'("Reference" "Conclusion")</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ca87a2" class="outline-4">
<h4 id="org3ca87a2">for/fold and for*/fold</h4>
<div class="outline-text-4" id="text-org3ca87a2">
<p>
ç±»ä¼¼å…¶å®ƒè¯­è¨€çš„ <code>while</code> å¾ªç¯,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for/fold ([prev #f]
           [counter 1])  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35774;&#23450;&#36845;&#20195;&#35201;&#29992;&#21040;&#21464;&#37327;</span>
          ([chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)] <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#29992;&#36941;&#21382;&#30340;&#24207;&#21015;</span>
           <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter prev)))
  (printf <span style="color: #CC9393;">"~a. ~a\n"</span> counter chapter)
  (values chapter (add1 counter)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25171;&#21360;&#22914;&#19979;:</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">1. Intro</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">2. Details</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">3. Conclusion</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36820;&#22238;&#32467;&#26524;:</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">"Conclusion"</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">4</span>

(for*/fold ([prev #f]
            [counter 1])  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35774;&#23450;&#36845;&#20195;&#35201;&#29992;&#21040;&#21464;&#37327;</span>
           ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Reference"</span>)]
            [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)] <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#29992;&#36941;&#21382;&#30340;&#24207;&#21015;</span>
            <span style="color: #DCDCCC; font-weight: bold;">#:when</span> (not (equal? chapter prev)))
  (printf <span style="color: #CC9393;">"~a ~a\n"</span> book chapter)
  (printf <span style="color: #CC9393;">"~a. ~a\n"</span> counter chapter)
  (values chapter (add1 counter)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25171;&#21360;&#22914;&#19979;:</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Guide Intro</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">1. Intro</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Guide Details</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">2. Details</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Guide Conclusion</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">3. Conclusion</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Reference Intro</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">4. Intro</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Reference Details</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">5. Details</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Reference Conclusion</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">6. Conclusion</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32467;&#26524;&#22914;&#19979;:</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">"Conclusion"</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">7</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org025e4e1" class="outline-4">
<h4 id="org025e4e1">Multiple-Valued Sequences</h4>
<div class="outline-text-4" id="text-org025e4e1">
<p>
å¯¹äºå¤šå€¼åºåˆ—,æ¯”å¦‚ <code>hash table</code> ,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for ([(k v) #hash((<span style="color: #CC9393;">"apple"</span> . 1) (<span style="color: #CC9393;">"banana"</span> . 3))])
  (printf <span style="color: #CC9393;">"~a count: ~a\n"</span> k v))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25171;&#21360;&#22914;&#19979;:</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">apple count: 1</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">banana count: 3</span>

(for*/list ([(k v) #hash((<span style="color: #CC9393;">"apple"</span> . 1) (<span style="color: #CC9393;">"banana"</span> . 3))]
            [(i) (in-range v)])
  (display i)
  k) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'("apple" "banana" "banana" "banana")</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ff8661" class="outline-4">
<h4 id="org5ff8661">Breaking and Iteration</h4>
<div class="outline-text-4" id="text-org5ff8661">
<p>
æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥æ‰“æ–­(break)è¿­ä»£, <code>#:break å’Œ #:finally</code> .
</p>

<p>
ä¸¤è€…çš„å·®åˆ«åœ¨äº <code>#:break</code> åˆ¤æ–­æˆåŠŸä¼šé©¬ä¸Šåœæ­¢,è€Œ <code>#:finally</code> åˆ¤æ–­æˆåŠŸåä¼šæŠŠå½“å‰çš„ä¸€æ¬¡è¿­ä»£(ä¸€æ¬¡å®Œæ•´çš„è¿­ä»£åŒ…æ‹¬æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯ä½“æ‰§è¡Œ)æ‰§è¡Œå®Œæ‰åœæ­¢.
</p>

<p>
(å¯ä»¥ç»“åˆå…¶å®ƒè¯­è¨€ <code>while</code> è¯­å¥æ¥ç†è§£).
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(for ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Story"</span> <span style="color: #CC9393;">"Reference"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:break</span> (equal? book <span style="color: #CC9393;">"Story"</span>)
      [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)])
  (printf <span style="color: #CC9393;">"~a ~a\n"</span> book chapter))

(for* ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Story"</span> <span style="color: #CC9393;">"Reference"</span>)]
       [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)])
  <span style="color: #DCDCCC; font-weight: bold;">#:break</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (equal? book <span style="color: #CC9393;">"Story"</span>)
               (equal? chapter <span style="color: #CC9393;">"Conclusion"</span>))
  (printf <span style="color: #CC9393;">"~a ~a\n"</span> book chapter))

(for ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Story"</span> <span style="color: #CC9393;">"Reference"</span>)]
      <span style="color: #DCDCCC; font-weight: bold;">#:final</span> (equal? book <span style="color: #CC9393;">"Story"</span>)
      [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)])
  (printf <span style="color: #CC9393;">"~a ~a\n"</span> book chapter))

(for* ([book '(<span style="color: #CC9393;">"Guide"</span> <span style="color: #CC9393;">"Story"</span> <span style="color: #CC9393;">"Reference"</span>)]
       [chapter '(<span style="color: #CC9393;">"Intro"</span> <span style="color: #CC9393;">"Details"</span> <span style="color: #CC9393;">"Conclusion"</span>)])
  <span style="color: #DCDCCC; font-weight: bold;">#:final</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (equal? book <span style="color: #CC9393;">"Story"</span>)
               (equal? chapter <span style="color: #CC9393;">"Conclusion"</span>))
  (printf <span style="color: #CC9393;">"~a ~a\n"</span> book chapter))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4db1372" class="outline-4">
<h4 id="org4db1372">Iteration Performance</h4>
<div class="outline-text-4" id="text-org4db1372">
<p>
<code>Racket</code> é™¤äº†ä¸Šé¢è¿™äº›è¿­ä»£æ–¹æ³•å°±åªå‰©æ‰‹å†™å¾ªç¯(<code>hand-written loop</code>)å°±æ˜¯é€’å½’å‡½æ•°è°ƒç”¨(<code>recursive-function invocation</code>)äº†.
</p>

<p>
ä¸¤ç§æ–¹æ³•çš„æ•ˆç‡éƒ½æ˜¯ä¸€æ ·çš„,ç„¶è€Œåè€…ä¸€èˆ¬åªé’ˆå¯¹ç‰¹å®šæ•°æ®,å‰è€…æœ‰å¾ˆå¤šç§é’ˆå¯¹å¯¹åº”æ•°æ®çš„è¿­ä»£å™¨.(è¿™é‡Œè‡ªå·±çœ‹æ–‡æ¡£å§).
</p>
</div>
</div>
</div>

<div id="outline-container-orgb7beb62" class="outline-3">
<h3 id="orgb7beb62">12 Pattern Matching</h3>
<div class="outline-text-3" id="text-orgb7beb62">
<p>
<code>match</code> form å¯ä»¥åŒ¹é…ä»»ä½• <code>Racket</code> å€¼,ä¸åªèƒ½ç”¨æ­£åˆ™å¯¹æ¯”å­—èŠ‚å’Œå­—ç¬¦åºåˆ—çš„ <code>regexp-match</code> ç›¸å¯¹.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(match 2
  [1 'one]
  [2 'two]
  [3 'three]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">2,&#22914;&#26524;&#27809;&#26377;&#21305;&#37197;&#21040;&#23601;&#20250;&#25253;&#38169;</span>

(match 2
  [1 'one]
  [_ 'other]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'other,&#20026;&#20102;&#36991;&#20813;&#25253;&#38169;,&#22914;&#26524;&#27809;&#26377;&#21305;&#37197;&#21040;&#23601;&#36820;&#22238; _ &#20998;&#25903;&#30340;&#20540;</span>

(match 2
  [1 'one]
  [else 'other]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'other,&#29992; else &#25913;&#20889;&#19978;&#38754;&#30340;&#20363;&#23376;&#20063;&#21487;&#20197;&#24471;&#21040;&#19968;&#26679;&#30340;&#32467;&#26524;</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#20687;cons,list&#21644;vector&#36825;&#20123;&#26500;&#36896;&#22120;&#21487;&#20197;&#29992;&#26469;&#21019;&#24314;&#21305;&#37197;pairs,lists&#21644;vectors.</span>
<span style="color: #7F9F7F;">|#</span>
(match '(1 2)
  [(list 0 1) 'one]
  [(list 1 2) 'two]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'two</span>

(match '(1 . 2)
  [(list 1 2) 'list]
  [(cons 1 2) 'pair]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'pair</span>

(match #(1 2)
  [(list 1 2) 'list]
  [(vector 1 2) 'vector]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'vector</span>

(struct posn (x y)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#29616;&#22312; posn &#20063;&#26159;&#26500;&#36896;&#22120;&#20102;</span>

(match (posn 1 2)
  [(posn 0 2) 'posn-0-2]
  [(posn 1 2) 'posn-1-2]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'posn-1-2</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">pattern&#37324;&#38754;&#30340;unquoted,non-constructor&#26631;&#31034;&#31526;&#26159;pattern&#21464;&#37327;,(&#38500;&#20102;_)&#21305;&#37197;&#25104;&#21151;&#21518;&#20250;&#21644;&#32467;&#26524;&#36827;&#34892;&#32465;&#23450;.</span>

<span style="color: #7F9F7F;">... (ellipsis),&#23601;&#20687;&#27491;&#21017;&#34920;&#36798;&#24335;&#37324;&#38754;&#30340; * &#37327;&#35789;&#19968;&#26679;,&#34987;&#20462;&#39280;&#30340;&#20803;&#32032;&#20986;&#29616;&#20219;&#24847;&#27425;</span>
<span style="color: #7F9F7F;">|#</span>

(match '(1 1 1)
  [(list 1 ...) 'one]
  [else 'other]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'one</span>

(match '(1 1 2)
  [(list 1 ...) 'one]
  [else 'other]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'other,&#22240;&#20026;&#31532;&#19968;&#20010;pattern&#21305;&#37197;&#20219;&#24847;&#20010;1</span>

(match '(1 1 2)
  [(list 1 x ...) x]
  [else 'other]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 2), &#25104;&#21151;&#21305;&#37197;&#31532;&#19968;&#20010;pattern&#24182;&#19988;&#32465;&#23450; pattern &#21464;&#37327; x</span>

(match '((! 1) (! 2 2) (! 3 3 3))
  [(list (list '! x ...) ...) x]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'((1) (2 2) (3 3 3))</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">quasiquote&#20063;&#26159;&#21487;&#20197;&#29992;&#20316;&#20026;pattern</span>
(match `{with {x 2} {+ x 1}}
  [`{with {,id ,rhs} ,body}
   `{{lambda {,id} ,body} ,rhs}]) <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">'((lambda (x) (+ x 1)) 2)</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36824;&#26377;&#24456;&#22810;&#20854;&#23427;forms</span>
(match-let ([(list x y z) '(1 2 3)])
  (list z y x))
</pre>
</div>
</div>
</div>

<div id="outline-container-org781e29f" class="outline-3">
<h3 id="org781e29f">13 Classes and Objects</h3>
<div class="outline-text-3" id="text-org781e29f">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22797;&#20064;&#19968;&#19979;Racket&#20013;&#25104;&#21592;&#30340;&#35775;&#38382;&#31561;&#32423;,&#20197;Java&#20026;&#20363;&#23376;(&#19981;&#35752;&#35770;default&#31561;&#32423;)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">1. public : &#21487;&#20197;&#32473;&#26412;&#31867;,&#21516;&#19968;&#20010;package&#20013;&#30340;&#23376;&#31867;,&#19981;&#21516;package&#20013;&#30340;&#23376;&#31867;&#20197;&#21450;&#19981;&#21516;&#21253;&#30340;&#38750;&#23376;&#31867;&#35775;&#38382;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">2. protected : &#21487;&#20197;&#26412;&#31867;,&#21516;&#19968;&#20010;package&#20013;&#30340;&#23376;&#31867;&#21644;,&#19981;&#21516;package&#20013;&#30340;&#23376;&#31867;&#35775;&#38382;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">3. private : &#21482;&#33021;&#32473;&#26412;&#31867;(&#20869;&#37096;)&#35775;&#38382;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">new-object%</span>

  (class object%     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#29238;&#31867;&#20026; object%, object% &#26159; built-in root class.</span>

    (init arg) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21021;&#22987;/&#23454;&#20363;&#21270;&#38656;&#35201;&#30340;&#21442;&#25968;,&#21482;&#33021;&#22312;&#23454;&#20363;&#21270;&#26102;&#20505;&#20351;&#29992;,&#19981;&#33021;&#22312;&#21518;&#32493;&#35775;&#38382;.</span>

    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">private-field</span> (void))
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31169;&#26377;&#23383;&#27573;,define &#21644; define-values &#23450;&#20041;&#30340;&#37117;&#26159;&#31169;&#26377;&#23383;&#27573;,&#19981;&#33021;&#30452;&#25509;&#35775;&#38382;,&#21487;&#20197;&#36890;&#36807;</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#26041;&#27861;(methods)&#35775;&#38382;.&#31169;&#26377;&#25104;&#21592;&#21482;&#33021;&#22312;&#26412;&#31867;&#20869;&#37096;&#20351;&#29992;,&#22312;&#23376;&#31867;&#20197;&#21450;&#22806;&#37096;&#19981;&#33021;&#20351;&#29992;.</span>

    (field           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#20844;&#26377;&#23383;&#27573;,&#23601;&#21487;&#20197;&#36890;&#36807;&#26041;&#27861;&#35775;&#38382;,&#20063;&#21487;&#20197;&#30452;&#25509;&#35775;&#38382;.</span>
      [public-field-1 arg]
      [public-field-2 arg])

    (super-new) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21021;&#22987;/&#23454;&#20363;&#21270;&#29238;&#31867;,&#19968;&#23450;&#35201;&#25191;&#34892;&#35813;&#35843;&#29992;,&#22240;&#20026;&#19968;&#20010;&#31867;&#24517;&#39035;&#35201;&#21796;&#37266;&#23427;&#30340;&#29238;&#31867;&#21021;&#22987;/&#23454;&#20363;&#21270;</span>

    (define/public (public-method value) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#20844;&#26377;&#26041;&#27861; public-method</span>
      (set! private-field value)             <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32473;&#31169;&#26377;&#23383;&#27573;&#36171;&#20540;</span>
      (set-field! public-field-1 this value) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32473;&#20844;&#26377;&#23383;&#27573;&#36171;&#20540;,&#36825;&#37324;&#38754;&#30340;this&#34920;&#31034;&#23454;&#20363;&#21270;&#23545;&#35937;.</span>
      (set-field! public-field-2 this value))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ins</span> (new new-object% [arg 10])) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21021;&#22987;&#21270;&#19968;&#20010;&#23454;&#20363;</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.1 Methods</span>

(send ins public-method 12)             <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35843;&#29992;&#20844;&#26377;&#26041;&#27861;&#35201;&#29992;send&#25805;&#20316;&#31526;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">newer-than-new-object%</span>          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32487;&#25215; new-object% &#31867;</span>
  (class new-object%
    (super-new)
    (inherit public-method)             <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22768;&#26126;&#32487;&#25215;&#20844;&#26377;&#26041;&#27861; public-method.&#21487;&#20197;&#19981;&#29992;&#27492;&#22768;&#26126;,&#20889;&#27861;&#22914;&#19979;</span>
    (define/public (new-public-method value)
      (public-method value))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">newer-than-new-object-without-inherit%</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19981;&#29992; inherit &#22768;&#26126;&#32487;&#25215; public-method &#26041;&#27861;,&#37027;&#20040;&#27599;&#27425;&#35843;&#29992; public-method &#26041;&#27861;&#23601;&#24471;&#29992; (send this public-method args ...) &#36825;&#31181;&#20889;&#27861;.</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#31181;&#20889;&#27861;&#26377;&#20004;&#20010;&#32570;&#28857;:</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#29238;&#31867;&#27809;&#26377;&#25552;&#20379; public-method &#26041;&#27861;,&#38500;&#38750;&#23376;&#31867;&#23454;&#20363;&#35843;&#29992;&#20102; new-public-method &#26041;&#27861;,&#21542;&#21017;&#38169;&#35823;&#19981;&#20250;&#24341;&#21457;;</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21478;&#22806;&#19968;&#20010;&#23601;&#26159;&#25928;&#29575;&#38382;&#39064;,&#23427;&#38656;&#35201;&#22312;&#36816;&#34892;&#26102;&#26597;&#25214;&#30446;&#26631;&#23545;&#35937;&#30340;&#31867;,&#32780; inherit-based &#26041;&#27861;&#21033;&#29992;&#22312;&#31867;&#26041;&#27861;&#34920;&#30340; offset &#26597;&#25214;,&#36825;&#20010;offset &#26159;&#22312;&#31867;&#21019;&#24314;&#26102;&#20505;&#35745;&#31639;&#30340;.</span>
  (class new-object%
    (super-new)
    (define/public (new-public-method value)
      (send this public-method value))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">new-ins</span> (new newer-than-new-object% [arg 11]))
(get-field public-field-1 new-ins)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25226;&#31867;&#26041;&#27861; public-method &#36716;&#21270;&#25104; generic,&#36825;&#26679;&#20351;&#29992; send-generic &#35843;&#29992;&#26041;&#27861;&#23601;&#21487;&#20197;&#36798;&#21040;&#19982; inherit-based &#19968;&#26679;&#25928;&#29575;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">generic-public-method</span> (generic new-object% public-method))

(send-generic new-ins generic-public-method 12)
(get-field public-field-1 new-ins)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#37325;&#36733; public-method</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">newer-than-new-object-with-override%</span>
  (class new-object%
    (super-new)
    (define/override (public-method) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#29992;define/public&#23450;&#20041;public-method&#20250;&#24341;&#21457;&#19968;&#20010;&#38169;&#35823;.</span>
      (displayln <span style="color: #CC9393;">"Doing nothing"</span>))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">override-ins</span> (new newer-than-new-object-with-override% [arg 9]))
(send override-ins public-method)

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.2 Initialization Arguments</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#24403;&#23376;&#31867;&#27809;&#26377;&#22768;&#26126;&#21021;&#22987;&#21270;/&#23454;&#20363;&#21270;&#23383;&#27573;&#30340;&#26102;&#20505;,&#23376;&#31867;&#23601;&#20250;&#35843;&#29992;&#29238;&#31867;&#30340;&#22768;&#26126;&#30340;&#21021;&#22987;&#21270;/&#23454;&#20363;&#21270;&#23383;&#27573;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20854;&#23454;&#19978;&#38754;&#30340;&#20363;&#23376;&#37117;&#21487;&#20197;&#25913;&#25104;&#21021;&#22987;&#21270;&#30340;&#23383;&#27573;&#21487;&#36873;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">newer-object-with-optional-arg%</span>
  (class new-object%
    (init [arg 10])                     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35774;&#23450;&#40664;&#35748;&#20540;&#20026;10</span>
    (super-new [arg arg])))             <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21021;&#22987;&#21270;&#29238;&#31867;&#26102;&#20505;&#20256;&#20837;&#20540;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">optional-ins-1</span> (new newer-object-with-optional-arg%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">optional-ins-2</span> (new newer-object-with-optional-arg% [arg 15]))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.3 Internal and External Names</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20869;&#37096;&#19982;&#22806;&#37096;&#21517;&#23383;,&#24182;&#19981;&#26159;&#31616;&#21333;&#26681;&#25454;&#20844;&#26377;&#21644;&#31169;&#26377;&#26469;&#21306;&#20998;,&#32780;&#26159;&#26681;&#25454;&#20351;&#29992;&#30340;&#19978;&#19979;&#25991;/&#20316;&#29992;&#22495;&#21306;&#20998;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">new-object%&#23454;&#20363;&#21270;&#30340;&#26102;&#20505; public-method&#26377;internal name.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">inherit-ins</span> (new newer-than-new-object% [arg 50]))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22312;&#23454;&#20363;&#35843;&#29992;&#30340;&#26102;&#20505;&#26377;external name,&#23601;&#26159;&#35828;public-method&#26082;&#26377;internal name&#20063;&#26377;external name.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30456;&#21453;arg&#21644;private-field&#21482;&#26377;internal name.</span>
(send inherit-ins public-method 60)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20854;&#27425;,internal name &#21644; external name &#30340;&#20351;&#29992;&#26041;&#24335;&#26159;&#19981;&#19968;&#26679;&#30340;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">demo-for-usage-of-name%</span>
  (class object%
    (super-new)
    (field [kfield #f])
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pfield</span> #t)
    (define/private (kmethod-1 msg) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">kmethod-1 &#26159;&#31169;&#26377;,&#25152;&#20197;&#21482;&#26377; internal name.</span>
      (printf <span style="color: #CC9393;">"pfield have only internal name because it is private\n"</span>)
      (printf <span style="color: #CC9393;">"~a\n"</span> msg))

    (define/public (kmethod-2)
      (kmethod-1 <span style="color: #CC9393;">"the usage of internal name of methods"</span>)
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(send this kmethod-1 "the usage of external name of methods")</span>
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22240;&#20026;&#21482;&#26377; internal name,&#25152;&#20197;&#19981;&#33021;&#36825;&#20040;&#29992;.</span>
      (set! kfield #t)
      (set! pfield #f)
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22312;&#20869;&#37096;&#20063;&#26159;&#21487;&#20197;&#29992;&#35775;&#38382;external name&#30340;&#26041;&#24335;&#35775;&#38382;&#26377;internal name&#21644;external name&#30340;&#23383;&#27573;.</span>
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(set-field! pfield this #f)</span>
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20294;&#26159;&#19981;&#21487;&#20197;&#29992;&#35775;&#38382;external name&#30340;&#26041;&#24335;&#35775;&#38382;&#21482;&#26377;internal name&#30340;&#23383;&#27573; pfield</span>
      (set-field! kfield this #f))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">demo-for-usage-of-name-obj</span>
  (new demo-for-usage-of-name%))
(get-field kfield demo-for-usage-of-name-obj) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22312;&#22806;&#37096;&#21482;&#33021;&#36825;&#26679;&#35775;&#38382;&#20844;&#26377;&#23383;&#27573;,&#19981;&#33021;&#35775;&#38382; pfield</span>
(send demo-for-usage-of-name-obj kmethod-2) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22312;&#22806;&#37096;&#21482;&#33021;&#36825;&#26679;&#35775;&#38382;&#20844;&#26377;&#26041;&#27861;</span>


<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.4 Interfaces</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#25509;&#21475;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">object-interface</span> (interface () interface-method-1 interface-method-2))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#20351;&#29992;&#25509;&#21475;&#30340;&#31867;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">klass-with-interface%</span>
  (class* object%
    (object-interface)
    (super-new)
    (define/public (interface-method-1)
      (displayln <span style="color: #CC9393;">"interface-method-1 has been implemented"</span>))
    (define/public (interface-method-2)
      (displayln <span style="color: #CC9393;">"interface-method-2 is not allowed to be implemented as an private method or error raised"</span>))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">kls-ins</span> (new klass-with-interface%))
(send kls-ins interface-method-1)
(send kls-ins interface-method-2)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21028;&#26029;&#23454;&#20363;&#26159;&#21542;&#26576;&#20010;&#31867;&#25110;&#32773;&#34987;&#27966;&#29983;&#30340;&#31867;&#30340;&#23454;&#20363;</span>
(is-a? kls-ins klass-with-interface%)
(is-a? kls-ins object%)
(is-a? (new object%) klass-with-interface%)
(is-a? kls-ins newer-object-with-optional-arg%)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21028;&#26029;&#31867;&#26159;&#21542;&#23454;&#29616;&#30456;&#24212;&#25509;&#21475;</span>
(implementation? klass-with-interface% object-interface)
(implementation? object% object-interface)

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.5 Final, Augment, and Inner</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22312;Java&#20013;,final&#26041;&#27861;&#19981;&#33021;&#34987;&#23376;&#31867;&#37325;&#36733;(overridden).Racket&#20063;&#26159;&#19968;&#26679;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">klass-final%</span>
  (class object%
    (super-new)
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-info</span>) (displayln <span style="color: #CC9393;">"No any info"</span>))
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-position</span>) (displayln <span style="color: #CC9393;">"What position"</span>)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">define &#23450;&#20041;&#30340;&#25104;&#21592;&#21482;&#33021;&#22312;&#31867;&#37324;&#38754;&#20351;&#29992;</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#32463;&#36807; public-final &#22768;&#26126;&#36807;&#21518;&#23601;&#26159;&#20844;&#26377;(public)&#21644;final&#20102;</span>
    (public-final get-info
                  [get-position get-position-final]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">get-position &#37325;&#21629;&#21517;&#20026; get-position-final,&#37325;&#21517;&#21518;&#23601;&#19981;&#33021;&#20877;&#35775;&#38382; get-position &#20102;.</span>
    ))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">final-ins</span> (new klass-final%))
(send final-ins get-info)
(send final-ins get-position-final)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20320;&#19981;&#21487;&#20197;&#29992;&#36825;&#27573;&#20195;&#30721;,&#22240;&#20026;final&#26041;&#27861;&#26159;&#19981;&#33021;&#36827;&#34892;&#37325;&#36733;&#30340;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define subclass-klass-final%</span>
<span style="color: #5F7F5F;">;;   </span><span style="color: #7F9F7F;">(class klass-final%</span>
<span style="color: #5F7F5F;">;;     </span><span style="color: #7F9F7F;">(super-new)</span>
<span style="color: #5F7F5F;">;;     </span><span style="color: #7F9F7F;">(define/override (get-info)</span>
<span style="color: #5F7F5F;">;;       </span><span style="color: #7F9F7F;">(displayln "Now I am get-info in subclass"))</span>
<span style="color: #5F7F5F;">;;     </span><span style="color: #7F9F7F;">(define/override (get-position-final)</span>
<span style="color: #5F7F5F;">;;       </span><span style="color: #7F9F7F;">(displayln "Now I am get-position-final in subclass"))))</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19978;&#38754;&#30340;&#20363;&#23376;&#21487;&#20197;&#25913;&#29992; override-final</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">klass-v2%</span>
  (class object%
    (super-new)
    (define/public (get-info)
      (displayln <span style="color: #CC9393;">"Still nothing"</span>))
    (define/public (get-position)
      (display <span style="color: #CC9393;">"Where am I?"</span>))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">subklass-v2%</span>
  (class klass-v2%
    (super-new)
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-info</span>)
      (displayln <span style="color: #CC9393;">"Super call get-info"</span>)
      (super get-info) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35843;&#29992;&#29238;&#31867;&#30340;get-info&#26041;&#27861;,super&#35843;&#29992;,&#31245;&#21518;&#35762;&#35299;&#36319;&#23427;&#30456;&#21453;&#30340;inner&#35843;&#29992;</span>
      (displayln <span style="color: #CC9393;">"Super call"</span>))
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-position</span>)
      (displayln <span style="color: #CC9393;">"Super call get-position"</span>)
      (super get-position)
      (displayln <span style="color: #CC9393;">"Super call"</span>))
    (override-final get-info get-position)))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30001;&#20110; klass-v2% &#27809;&#26377; get-position-final &#30340;&#26041;&#27861;,&#25152;&#20197; get-position &#19981;&#33021;&#22815;&#37325;&#21629;&#21517;&#20026; get-positioin-final</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">public-final &#21644; override-final &#30340;&#21306;&#21035;&#23601;&#26159;&#23601;&#26159;&#25226;&#24050;&#32463;&#23450;&#20041;&#30340;&#26041;&#27861;&#22768;&#26126;&#20026;final&#26041;&#27861;,&#21478;&#22806;&#19968;&#20010;&#26159;&#37325;&#36733;&#29238;&#31867;&#24050;&#32463;&#23450;&#20041;&#30340;&#26041;&#27861;&#20026;final.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21516;&#26679;&#19981;&#33021;&#22312;subklass-v2%&#30340;&#23376;&#31867;&#20013;&#37325;&#36733; get-info &#21644; get-position &#26041;&#27861;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">subklass-ins</span> (new subklass-v2%))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19968;&#33324;&#26469;&#35828;&#23376;&#31867;&#21487;&#20197;&#23450;&#20041;&#19982;&#29238;&#31867;&#26041;&#27861;&#21516;&#21517;&#26041;&#27861;&#30340;&#26102;&#20505;&#35843;&#29992;&#29238;&#31867;&#30340;&#21516;&#21517;&#26041;&#27861;,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(&#29238;&#31867;&#29992;define/public&#23450;&#20041;&#26041;&#27861;,&#23376;&#31867;&#29992;define&#23450;&#20041;&#26041;&#27861;),&#22312;Python&#23601;&#26159;super call,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21487;&#20197;&#22312;&#34987;&#35843;&#29992;&#30340;&#29238;&#31867;&#26041;&#27861;&#21069;&#21518;&#20570;&#19968;&#20123;&#21160;&#20316;,&#36825;&#26679;&#23601;&#21487;&#20197;&#22312;&#29238;&#31867;&#26041;&#27861;&#30340;&#22522;&#30784;&#19978;&#36827;&#34892;&#22686;&#24378;(augment).</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Racket&#20063;&#25903;&#25345;super call,&#20063;&#25903;&#25345;&#21478;&#22806;&#19968;&#31181;&#39118;&#26684;(beta-style)&#30340;&#25299;&#23637;&#26041;&#27861;,&#21483;&#20570;inner call,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36319;super call&#22312;&#29238;&#31867;&#26041;&#27861;&#30340;&#22522;&#30784;&#19978;&#36827;&#34892;&#21069;&#21518;&#25299;&#23637;&#19981;&#19968;&#26679;,inner call&#26159;&#22312;&#29238;&#31867;&#26041;&#27861;&#30340;&#22522;&#30784;&#19978;&#36827;&#34892;&#20869;&#37096;&#25299;&#23637;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">http://www.cs.utah.edu/plt/publications/oopsla04-gff.pdf</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#27880;&#24847;,&#22312;Racket&#37324;&#38754;,&#37325;&#36733;&#21644;&#22686;&#24378;&#19981;&#26159;&#21516;&#19968;&#20010;&#19996;&#35199;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30475;&#20195;&#30721;&#27604;&#36739;&#26126;&#20102;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">extra-klass-v2%</span>
  (class klass-v2%
    (super-new)
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-info</span>)
      (displayln <span style="color: #CC9393;">"Inner call starts"</span>)
      (inner (void) get-info)           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#25214;&#19981;&#21040;get-info&#30340;&#22686;&#24378;&#26041;&#27861;,&#37027;&#20040;&#23601;&#36820;&#22238;(void)</span>
      (displayln <span style="color: #CC9393;">"Inner call ends"</span>))
    (overment get-info)))               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">overment&#25805;&#20316;&#31526;&#21495;&#22768;&#26126;get-info&#20026;&#21487;&#22312;&#23376;&#31867;&#20013;&#34987;&#22686;&#24378;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">inner-for-extra-klass-v2%</span>
  (class extra-klass-v2%
    (super-new)
    (define/augment (get-info)          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25226;get-info&#23450;&#20041;&#20026;&#22686;&#24378;&#26041;&#27861;</span>
      (displayln <span style="color: #CC9393;">"Augment for get-info of extra-klass-v2%"</span>))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">extra-ins</span> (new extra-klass-v2%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">inner-ins</span> (new inner-for-extra-klass-v2%))
(send extra-ins get-info)
(send inner-ins get-info)

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.6 Controlling the Scope of External Names</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Racket&#26159;&#36890;&#36807;&#35789;&#27861;&#20316;&#29992;&#22495;(lexical scope)&#32780;&#19981;&#26159;&#32487;&#25215;&#23618;&#32423;(inheritance hierarchy)&#26469;&#25511;&#21046;&#22806;&#37096;&#21517;&#23383;(external names)&#30340;&#20316;&#29992;&#22495;&#30340;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20869;&#37096;&#21517;&#23383;(Internal names)&#30340;&#20316;&#29992;&#22495;&#26159;local scope,&#32780;&#22806;&#37096;&#21517;&#23383;&#30340;&#20316;&#29992;&#22495;&#40664;&#35748;&#24773;&#20917;&#19979;&#26159;global scope.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19968;&#33324;&#26469;&#35828;&#25104;&#21592;(a member of class)&#19981;&#20250;&#32465;&#23450;&#19968;&#20010;&#22806;&#37096;&#21517;&#23383;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30456;&#21453;,&#24403;&#25104;&#21592;&#21517;&#23383;&#24050;&#32463;&#32465;&#23450;&#21040;&#19968;&#20010;&#25104;&#21592;&#38190;(member key),&#25104;&#21592;&#20250;&#24341;&#29992;&#19968;&#20010;&#24050;&#32463;&#23384;&#22312;&#30340;&#22806;&#37096;&#21517;&#23383;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#26368;&#32456;&#19968;&#20010;&#31867;&#20250;&#26144;&#23556;(maps)&#25104;&#21592;&#38190;&#21040;&#26041;&#27861;,&#23383;&#27573;&#21644;&#21021;&#22987;&#21442;&#25968;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20869;&#37096;&#21517;&#23383;&#26159;&#19982;Racket&#30340;&#21517;&#23383;&#20998;&#24320;&#30340;,&#21482;&#33021;&#29992;&#20110;send,new&#21644;&#25104;&#21592;&#23450;&#20041;&#20013;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (klass-1% klass-2%)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ()
    (define-member-name get-info (generate-member-key)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#31867;&#20284;&#20110; Java &#30340; protected,&#19981;&#36807;&#26159;&#38480;&#23450;&#20110;&#35789;&#27861;&#20316;&#29992;&#22495;&#20869;</span>

    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">klass-1%</span>
      (class object%
        (super-new)
        (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">kls-2-ins</span> (new klass-2%))
        (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">my-info</span> (send kls-2-ins get-info))))

    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">klass-2%</span>
      (class object%
        (super-new)
        (define/public (get-info) <span style="color: #CC9393;">"This is the info of instances of klass-1%"</span>)))

    (displayln (format <span style="color: #CC9393;">"Member key is ~a"</span> (member-name-key get-info))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#33719;&#21462; get-info &#30340; method key,&#36825;&#20010; method key &#21487;&#20197;&#22312;&#20854;&#23427;&#20316;&#29992;&#22495;&#20351;&#29992;</span>

    (values klass-1% klass-2%)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#20010;&#34920;&#36798;&#24335;&#20250;&#25253;&#38169;,&#22240;&#20026;get-info&#21482;&#33021;&#22312;&#19978;&#38754;&#30340;&#35789;&#35821;&#20316;&#29992;&#22495;&#37324;&#38754;&#20351;&#29992;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(send (new klass-2%) get-info)</span>


<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.7 Mixins</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25152;&#35859; mixin &#23601;&#26159;&#19968;&#20010;&#26681;&#25454;&#36229;&#31867;(superclass)&#36827;&#34892;&#21442;&#25968;&#21270;&#30340;&#31867;&#25299;&#23637;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">klass-mixin</span> %)                 <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">% &#23601;&#26159;&#35201;&#20256;&#20837;&#30340; superclass</span>
  (class %
    (super-new)
    (define/override (get-info)
      (displayln <span style="color: #CC9393;">"get-info get itself overridden in mixin"</span>))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22914;&#26524; superclass &#27809;&#26377; get-info &#26041;&#27861;&#23601;&#20250;&#25253;&#38169;.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">new-klass%</span> (klass-mixin klass-v2%))<span style="color: #5F7F5F;">;;</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">The mixin form</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">status-interface</span> (interface () alive?))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">action-interface</span> (interface () eat))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">human-mixin</span>
  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#35201;&#21442;&#25968;&#21270;&#30340;superclass&#35201;&#27714;&#23454;&#29616;&#20102;status-interface&#25509;&#21475;,&#26368;&#21518;&#36820;&#22238;&#19968;&#20010;subclass,&#36825;&#20010;subclass&#35201;&#27714;&#23454;&#29616;action-interface.</span>
  (mixin (status-interface) (action-interface)
    (inherit alive?)
    (super-new)
    (define/public (eat x)
      (<span style="color: #F0DFAF; font-weight: bold;">if</span> (alive?)
          (displayln (format <span style="color: #CC9393;">"I am eating ~a"</span> x))
          (displayln <span style="color: #CC9393;">"I am not alive so can not eat anything."</span>)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">human%</span>
  (class* object% (status-interface)
    (init-field [alive #t])
    (super-new)
    (define/public (alive?)
      alive)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">hungry-human%</span> (human-mixin human%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">eater</span> (new hungry-human%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">dead-people</span> (new hungry-human% [alive #f]))
(send eater eat <span style="color: #CC9393;">"Banana"</span>)
(send dead-people eat <span style="color: #CC9393;">"Banana"</span>)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Parameterized Mixins</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#26681;&#25454;&#26041;&#27861;&#36827;&#34892;&#21442;&#25968;&#21270;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">my-from-interface</span> (interface () get-info))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-mixin-with-method</span> method-key)
  (define-member-name get-info method-key)
  (mixin (my-from-interface) ()
    (super-new)
    (inherit get-info)
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">NOTE &#36825;&#20010;inherit&#35980;&#20284;&#26159;&#38024;&#23545;&#20110;&#31532;&#19968;&#20010;interface&#38598;&#21512;&#30340;,&#25152;&#20197;&#19981;&#33021;&#20687;&#25351;&#21335;&#20013;&#30340;&#20363;&#23376;&#19968;&#26679;</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">mixin: method was referenced in definition, but is not in any of the from-interfaces method name:  member34476</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25110;&#32773;&#25226;(inherit get-info)&#21435;&#25481;,&#37319;&#29992;(send this get-info)&#36825;&#31181;&#26041;&#24335;&#35843;&#29992;</span>
    (define/public (return-info)
      (get-info)
      (displayln <span style="color: #CC9393;">"Mixin cal"</span>))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">temp-klass%</span>
  (class* object% (my-from-interface)
    (super-new)
    (define/public (get-info)
      (displayln <span style="color: #CC9393;">"Temp-klass"</span>))))

(send (new ((make-mixin-with-method (member-name-key get-info))
            temp-klass%))
      return-info)

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.8 Traits</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Trait&#31867;&#20284;&#20110;mixin,&#37117;&#26159;&#19968;&#20010;&#29992;&#26469;&#25299;&#23637;&#31867;&#19978;&#30340;&#26041;&#27861;&#38598;&#21512;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Traits&#30340;&#34920;&#31034;(representation)&#26159;&#19968;&#20010;association lists(Emacs Lisp&#20013;&#21483;a-list),&#21015;&#34920;&#30340;&#27599;&#20010;&#39033;&#30446;&#20026;"&#21517;&#23383;-&#26041;&#27861;",&#19968;&#20010;mixin.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Traits&#19981;&#21516;&#20110;mixins&#22312;&#20110; traits&#25903;&#25345;trait&#20043;&#38388;&#21512;&#24182;(trait-sum)),&#31227;&#38500;(trait-exclude),&#36171;&#20104;&#26041;&#27861;&#21035;&#21517;(trait-alias)&#36825;&#26679;&#30340;&#25805;&#20316;.</span>
(require racket/trait)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23450;&#20041;&#20004;&#20010;traits</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">a-trait</span>
  (trait
   (define/public (get-a) 'A)
   (define/public (pp-get-a) (format <span style="color: #CC9393;">"You got a ~a"</span> (get-a)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">b-trait</span>
  (trait
   (define/public (get-b) 'B)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">a+b-trait</span>
  (trait-sum                            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21512;&#24182;&#20004;&#20010;traits, a-trait &#21644; b-trait.</span>
   <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#37325;&#21629;&#21517; a-trait &#30340; get-a &#20026; get-to-a &#20197;&#21450; b-trait &#30340; get-b &#20026; get-to-b</span>
   <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#28982;&#21518;&#25226; get-a &#21644; get-b &#31227;&#38500;,&#21035;&#21517;&#25805;&#20316;&#30456;&#24403;&#20110;&#37325;&#26032;&#20811;&#38534;&#20102;&#19968;&#20221;&#24182;&#32473;&#20102;&#21478;&#22806;&#19968;&#20010;&#21517;&#23383;.</span>
   (trait-exclude (trait-alias a-trait
                               get-a get-to-a)
                  get-a)
   (trait-exclude (trait-alias b-trait
                               get-b get-to-b)
                  get-b)
   (trait
    (inherit get-to-a get-to-b)         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25903;&#25345;inherit&#25805;&#20316;</span>
    (define/public (get-points)
      (list (get-to-a) (get-to-b))))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">trait-with-traits%</span>
  ((trait-&gt;mixin a+b-trait)
   (class object%
     (super-new)
     <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#24517;&#39035;&#25552;&#20379;,get-a&#21644;get-b,&#21542;&#21017;&#20250;&#25253;&#38169;</span>
     <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">class*: superclass does not provide an expected method for inherit</span>
     <span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">inherit name: get-a</span>
     (define/public (get-a)
       'trait-with-traits-get-a)
     (define/public (get-b)
       'trait-with-traits-get-b)
     (define/public (get-class-name)
       'trait-with-traits%))))

(send (new trait-with-traits%) get-a)
(send (new trait-with-traits%) get-to-a)


<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">13.9 Class Contracts</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31867;&#32422;&#26463;&#30340;&#27010;&#24565;&#36319;&#31532;&#19971;&#31456;&#30340;&#27010;&#24565;&#19968;&#26679;,&#36825;&#37324;&#22823;&#27010;&#20889;&#20960;&#20010;&#31034;&#20363;.&#31867;&#30340;&#32422;&#26463;&#20027;&#35201;&#20998;&#20004;&#31867;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22806;&#37096;&#21644;&#20869;&#37096;&#32422;&#26463;,&#21306;&#21035;&#23601;&#26159;&#23545;&#32487;&#25215;&#20851;&#31995;&#30340;&#32422;&#26463;&#21147;&#24230;,&#21069;&#32773;&#27604;&#21518;&#32773;&#24369;,&#19979;&#38754;&#20250;&#35828;&#21040;&#22806;&#37096;&#32422;&#26463;&#30340;&#32570;&#28857;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">External Class Contracts</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">object</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">edible/c</span> (object/c (field [size positive-integer?])))

(define/contract external-animal%
  (class/c
   (field [size positive-integer?])     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35201;&#27714;size&#23383;&#27573;&#19981;&#33021;&#23567;&#20110;&#31561;&#20110;0</span>
   [eat (-&gt;m                            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">eat&#26041;&#27861;,&#35201;&#27714;&#19968;&#20010;&#21442;&#25968;,&#21442;&#25968;&#35201;&#20026;&#19968;&#20010;size&#23383;&#27573;&#20026;&#27491;&#25972;&#25968;&#30340;&#23545;&#35937;,&#36820;&#22238;void.</span>
         edible/c
         void?)])
  (class object%
    (super-new)
    (init-field [size 10])
    (define/public (eat animal)
      (<span style="color: #F0DFAF; font-weight: bold;">if</span> (&gt; size (get-field size animal))
          (set! size (+ size (get-field size animal)))
          (displayln <span style="color: #CC9393;">"This animal is not edible"</span>)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">tigger</span> (new external-animal%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">rabbit</span> (new external-animal% [size 2]))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21021;&#22987;&#21270;&#21442;&#25968;size&#20026;&#19981;&#33021;&#23567;&#20110;&#31561;&#20110;0&#30340;&#27491;&#25972;&#25968;,&#21542;&#21017;&#25253;&#38169;,&#23601;&#31639;&#23376;&#31867;&#23545;&#35937;&#20063;&#19981;&#33021;&#25171;&#30772;&#32422;&#26463;.</span>
(send tigger eat rabbit)
(get-field size tigger)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22806;&#37096;&#31867;&#32422;&#26463;&#26377;&#20004;&#20010;&#32570;&#28857;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">1. &#24403;&#21160;&#24577;&#36866;&#37197;&#30340;&#30446;&#26631;(target of dynamic dispatch)&#26159;&#21463;&#32422;&#26463;&#31867;&#30340;&#26041;&#27861;&#23454;&#29616;,&#37027;&#20040;&#32422;&#26463;&#26377;&#25928;,</span>
<span style="color: #5F7F5F;">;;    </span><span style="color: #7F9F7F;">&#22914;&#26524;&#25913;&#21464;&#20102;&#21160;&#24577;&#36866;&#37197;&#30446;&#26631;,&#32422;&#26463;(external method contracts)&#23601;&#20250;&#22833;&#25928;.</span>
<span style="color: #5F7F5F;">;;    </span><span style="color: #7F9F7F;">External field contract&#24635;&#26159;&#29983;&#25928;,&#22240;&#20026;&#23383;&#27573;&#19981;&#33021;&#34987;&#37325;&#36733;&#21644;&#36974;&#25513;(shadowed)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">2. &#32422;&#26463;&#19981;&#38480;&#21046;&#34987;&#32422;&#26463;&#31867;&#30340;&#23376;&#31867;.&#20351;&#29992;&#32487;&#25215;&#30340;&#23383;&#27573;&#21644;&#26041;&#27861;&#26159;&#19981;&#20250;&#35302;&#21457;&#36825;&#20123;&#32422;&#26463;&#30340;&#26816;&#27979;,</span>
<span style="color: #5F7F5F;">;;    </span><span style="color: #7F9F7F;">&#36890;&#36807;super&#35843;&#29992;&#36229;&#31867;(superclass)&#30340;&#26041;&#27861;&#20063;&#19981;&#20250;&#35302;&#21457;&#26816;&#27979;.</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Internal Class Contracts</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30452;&#25509;&#25226;&#25991;&#26723;&#19978;&#30340;&#20363;&#23376;copy&#19978;&#26469;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">animal%</span>
  (class object%
    (super-new)
    (field [size 10])
    (define/public (eat food)
      (set! size (+ size (get-field size food))))))

(define/contract internal-animal%
  (class/c [eat (-&gt;m edible/c edible/c)])
  (<span style="color: #F0DFAF; font-weight: bold;">begin</span>
    (define/contract glutton%
      (class/c (override [eat (-&gt;m edible/c void?)]))
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">override &#21482;&#20250;&#24433;&#21709;&#22312;&#23376;&#31867;&#20351;&#29992;&#36229;&#31867;&#20013;&#30340;&#35843;&#29992;(&#26041;&#27861;).&#36825;&#20010;&#20363;&#23376;&#20013;&#32487;&#25215;&#20102;animal%&#31867;&#30340;eat&#26041;&#27861;,</span>
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">eat&#26041;&#27861;&#22312;internal-animal%&#20013;&#34987;&#37325;&#36733;&#20102;,&#24403;internal-animal%&#30340;&#23454;&#20363;&#35843;&#29992;eat&#26041;&#27861;&#30340;&#26102;&#20505;</span>
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23601;&#20351;&#29992;&#37325;&#36733;&#36807;&#30340;eat&#26041;&#27861;,&#24403;&#35843;&#29992;gulp&#26041;&#27861;,gulp&#23601;&#20250;&#35843;&#29992;glutton%&#32487;&#25215;animal%&#30340;eat&#26041;&#27861;.</span>
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#34920;&#36798;&#24335;&#30340;&#24847;&#24605;&#23601;&#26159;glutton%&#31867;&#30340;&#32422;&#26463;&#20026;(-&gt;m edible/c void?),&#23376;&#31867;&#37325;&#36733;&#21518;&#30340;eat&#23646;&#20110;&#33258;&#24049;,</span>
      <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23376;&#31867;&#21487;&#20197;&#35843;&#29992;&#20004;&#20010;&#19981;&#21516;&#30340;eat&#26041;&#27861;,&#20294;&#26159;&#36890;&#36807;&#35843;&#29992;gulp&#26041;&#27861;&#35843;&#29992;eat&#26041;&#27861;&#20250;&#36829;&#21453;&#36319;glutton%&#30340;&#32422;&#26463;.</span>
      (class animal%
        (super-new)
        (inherit eat)
        (define/public (gulp food-list)
          (for ([f food-list])
            (eat f)))))
    (class glutton%
      (super-new)
      (inherit-field size)
      (define/override (eat f)
        (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([food-size (get-field size f)])
          (set! size (/ food-size 2))
          (set-field! size f (/ food-size 2))
          f)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pig</span> (new internal-animal%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">slop1</span> (new animal%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">slop2</span> (new animal%))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">slop3</span> (new animal%))
(send pig eat slop1)
(get-field size slop1)
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(send pig gulp (list slop1 slop2 slop3))</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#21477;&#20250;&#25253;&#38169;,&#19978;&#38754;&#35828;&#20102;,&#35843;&#29992;gulp&#20250;&#35843;&#29992;animal%&#30340;eat&#26041;&#27861;,&#23427;&#30340;&#32422;&#26463;&#36319;internal-animal%&#37325;&#36733;&#36807;&#30340;eat&#26041;&#27861;&#30340;&#32422;&#26463;&#19981;&#19968;&#26679;.</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20889;&#19968;&#20010;&#19981;&#20351;&#29992; override &#22768;&#26126;&#30340;&#21453;&#20363;</span>
(define/contract animal-t%
  (class/c (field [size positive-integer?])
           [eat (-&gt;m edible/c void?)])
  (class object%
    (super-new)
    (field [size 10])
    (define/public (eat food)
      (set! size (+ size (get-field size food))))
    (define/public (before-eat food)
      (eat food))))


(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">large-animal%</span>
  (class animal-t%
    (super-new)
    (inherit-field size)
    (set! size 'large)
    (define/override (eat food)
      (display <span style="color: #CC9393;">"Nom nom nom"</span>) 1)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">elephant</span> (new large-animal%))
(send elephant before-eat (new large-animal%))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgbd2755e" class="outline-3">
<h3 id="orgbd2755e">14 Units (Components)</h3>
<div class="outline-text-3" id="text-orgbd2755e">
<p>
å•å…ƒ(Units)æŠŠä¸€ä¸ªç¨‹åºåˆ†ä¸ºå¯ç¼–è¯‘(<code>compiable</code>)å’Œå¯é‡ç”¨(<code>reusable</code>)ç»„ä»¶.
</p>

<p>
ä¸€ä¸ªå•å…ƒå’Œä¸€ä¸ªå‡½æ•°(procedure)ç±»ä¼¼,éƒ½æ˜¯ç”¨äºæŠ½è±¡çš„ç¬¬ä¸€ç±»å¯¹è±¡å€¼(first-class values).
</p>

<p>
å‡½æ•°æŠ½è±¡å‡ºè¡¨è¾¾å¼çš„å€¼,å•å…ƒæŠ½è±¡å®šä¹‰é›†åˆçš„åå­—.
</p>

<p>
æ­£å¦‚è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ˜¯æ ¹æ®æ‰€ç»™çš„å®é™…å‚æ•°è¿ç®—å®ƒçš„çš„è¡¨è¾¾å¼,è°ƒç”¨ä¸€ä¸ªå•å…ƒæ˜¯æ ¹æ®æ‰€ç»™çš„å¯¼å…¥å˜é‡(imported variable)çš„å¼•ç”¨æ¥è¿ç®—å®ƒçš„å®šä¹‰.
</p>

<p>
ä¸åƒä¸€ä¸ªå‡½æ•°,ä¸€ä¸ªå•å…ƒçš„å¯¼å…¥å˜é‡å¯ä»¥è¢«å¦å¤–ä¸€ä¸ªå¤„äºè°ƒç”¨å‰çš„(prior bto invocation)å•å…ƒçš„å¯¼å‡ºå˜é‡è¿›è¡Œéƒ¨åˆ†é“¾æ¥.
</p>

<p>
é“¾æ¥åˆå¹¶å¤šä¸ªå•å…ƒä¸ºä¸€ä¸ªç»„åˆå•å…ƒ.ç»„åˆå•å…ƒè‡ªèº«ä¼šå¯¼å…¥ç”¨äºä¼ æ’­(propagated)åˆ°(è¢«)é“¾æ¥å•å…ƒé‡Œé¢æœªè§£æ(unresolved)çš„å¯¼å…¥å˜é‡,å¹¶ä¸”æœªä»¥åçš„é“¾æ¥è€Œé‡æ–°å¯¼å…¥è¢«é“¾æ¥å•å…ƒçš„éƒ¨åˆ†å˜é‡.
</p>
</div>

<div id="outline-container-org07609c6" class="outline-4">
<h4 id="org07609c6">Signatures and Units</h4>
<div class="outline-text-4" id="text-org07609c6">
<p>
å•å…ƒçš„æ¥å£æ˜¯æ ¹æ®ç­¾å(signatures)æ¥æè¿°çš„.æ¯ä¸ªç­¾åéƒ½æ˜¯(æ­£å¸¸æ¥è¯´,åœ¨æ¨¡å—å†…éƒ¨)ä½¿ç”¨ <code>define-signature</code> å®šä¹‰.
</p>

<p>
æ ¹æ®æƒ¯ä¾‹,ç­¾åçš„åå­—éƒ½æ˜¯ä»¥ <code>^</code> ç»“å°¾çš„.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">factory-sig.rkt</span>
#lang racket

(provide factory^)

(define-signature factory^
  (build-products <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(integer? . -&gt; . (listof product?))</span>
   product?       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(any/c . -&gt; . boolean?)</span>
   rebuild        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(-&gt; product? symbol? any/c product?)</span>
   product-info)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(product? . -&gt; . hash?)</span>
</pre>
</div>

<p>
å®ç° <code>factory^</code> çš„å•å…ƒéœ€è¦é€šè¿‡ <code>define-unit</code> form ä¸­çš„ <code>export</code> ä»å¥æŒ‡å®š <code>factory^</code> .
</p>

<p>
æ ¹æ®æƒ¯ä¾‹,å•å…ƒçš„åå­—è¦ç”¨ <code>@</code> ç»“å°¾,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">factory-unit.rkt</span>
#lang racket

(require <span style="color: #CC9393;">"factory-sig.rkt"</span>)
(provide factory@)

(define-unit factory@
  (<span style="color: #F0DFAF; font-weight: bold;">import</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">export</span> factory^)

  (printf <span style="color: #CC9393;">"Factory started.\n"</span>)

  (define-struct product (info) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">build-products</span> n)
    (for/list ([i (in-range n)])
      (make-product (make-hash))))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">rebuild</span> p s v)
    (make-product (hash-set (product-info p) s v))))
</pre>
</div>

<p>
<code>factory^</code> ç­¾åä¹Ÿå¯ä»¥è¢«ä¸€ä¸ªéœ€è¦ä½¿ç”¨ <code>factory@</code> å®ç°ä¸€äº›åŠŸèƒ½çš„å•å…ƒä½¿ç”¨,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">store-sig.rkt</span>
#lang racket

(provide store^)

(define-signature store^
  (set-stock!           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(-&gt; integer? void?)</span>
   get-stock            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(-&gt; integer?)</span>
   rebuild-them))       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(-&gt; (listof product?) s v (listof product?))</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(require <span style="color: #CC9393;">"store-sig.rkt"</span>
         <span style="color: #CC9393;">"factory-sig.rkt"</span>)
(provide store@)

(define-unit store@
  (<span style="color: #F0DFAF; font-weight: bold;">import</span> factory^)
  (<span style="color: #F0DFAF; font-weight: bold;">export</span> store^)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">inventory</span> null)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-inventory</span>) inventory)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">rebuild-them</span> products s v)
    (set! inventory (<span style="color: #F0DFAF; font-weight: bold;">map</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (p) (rebuild p s v)) products)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-stock</span>) (length inventory))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">set-stock!</span> n)
    (set! inventory
          (append inventory (build-products n)))))
</pre>
</div>

<p>
æœ‰ä¸¤ä»¶äº‹æƒ…æ–‡æ¡£ä¸Šæ²¡æœ‰è¯´åˆ°:
</p>

<ul class="org-ul">
<li>å¦‚æœå•å…ƒé‡Œé¢å­˜åœ¨ç­¾åé‡Œé¢æ²¡æœ‰çš„å®šä¹‰,é‚£ä¹ˆè¿™ä¸­å®šä¹‰ä¹‹åå€¼ä¸èƒ½åœ¨å•å…ƒå¤–å¯ç”¨çš„,æ¯”å¦‚ä¸Šé¢çš„ <code>get-inventory</code> .</li>

<li>åªè¦å•å…ƒæ²¡æœ‰å®ç°ç­¾åé‡Œé¢çš„ä»»æ„ä¸€ä¸ªæ¥å£éƒ½ä¼šå‘ç”ŸæŠ¥é”™.</li>
</ul>

<p>
ä¸ªäººæ„Ÿè§‰æ¥è¯´å®è¯ç­¾åæœ‰ç‚¹åƒæŠ½è±¡ç±»/Javaä¸­çš„æ¥å£,è€Œå•å…ƒå°±åƒå®ç°è¿™äº›ä¸œè¥¿çš„ç±».
</p>
</div>
</div>

<div id="outline-container-org709d364" class="outline-4">
<h4 id="org709d364">Invoking Units</h4>
<div class="outline-text-4" id="text-org709d364">
<p>
<code>factory@</code> æ²¡æœ‰ä»»ä½• <code>imports</code> (importä»å¥ä¸ºç©º),å®ƒå¯ä»¥ç›´æ¥é€šè¿‡ <code>invoke-unit</code> å¯åŠ¨,ä¸è¿‡å®ƒçš„å®šä¹‰æ˜¯ä¸å¯ç”¨çš„.
</p>

<p>
<code>define-values/invoke-unit/infer</code> form ä»å®ç°äº†æ¥å£çš„å•å…ƒä¸­æ¨æ–­å‡ºå®šä¹‰å¹¶ä¸”æŠŠç­¾åçš„æ ‡è¯†ç¬¦ç»‘å®šåˆ°è¿™äº›å®šä¹‰ä¸Š.
</p>

<p>
ç”±äº <code>store@</code> å¯¼å…¥äº† <code>factory^</code> ç­¾å,æ‰€ä»¥éœ€è¦å…ˆå®Œæˆ <code>factory@</code> çš„ <code>invoking</code> ä¹‹åæ‰å¯ä»¥ <code>invoke store@</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">(require <span style="color: #CC9393;">"factory-unit.rkt"</span>
         <span style="color: #CC9393;">"store-unit.rkt"</span>)
(invoke-unit factory@)                     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21551;&#21160;&#21333;&#20803;,&#20294;&#26159;&#23450;&#20041;&#19981;&#21487;&#29992;</span>

(define-values/invoke-unit/infer factory@) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21551;&#21160;&#21333;&#20803;,&#25512;&#26029;&#23450;&#20041;,&#32465;&#23450;&#23450;&#20041;</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#29616;&#22312;&#21487;&#20197;&#23545; store &#21333;&#20803;&#20570;&#21516;&#26679;&#30340;&#20107;&#24773;</span>
(define-values/invoke-unit/infer store@)
</pre>
</div>
</div>
</div>

<div id="outline-container-org02cdeba" class="outline-4">
<h4 id="org02cdeba">Linking Units</h4>
<div class="outline-text-4" id="text-org02cdeba">
<p>
æŠŠä¸¤ä¸ªå•å…ƒåˆå¹¶,ä»¥ä¸‹ä¾‹å­å®šä¹‰ä¸€ä¸ªä¸“é—¨ä¸ºæŒ‡å®šåº—ç”Ÿäº§äº§å“,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">store-specific-factory-unit.rkt</span>
#lang racket

(require <span style="color: #CC9393;">"factory-sig.rkt"</span>
         <span style="color: #CC9393;">"store-sig.rkt"</span>
         <span style="color: #CC9393;">"store-unit.rkt"</span>)
(provide
 store^
 factory^
 store@
 store-specific-factory@
 store+factory@)

(define-unit store-specific-factory@
  (<span style="color: #F0DFAF; font-weight: bold;">import</span> store^)
  (<span style="color: #F0DFAF; font-weight: bold;">export</span> factory^)

  (define-struct product (info) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">build-products</span> n)
    (for/list ([i (in-range n)])
      (make-product (make-hash
                     (list (cons 'store-name <span style="color: #CC9393;">"new-type"</span>))))))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">rebuild</span> p s v)
    (<span style="color: #F0DFAF; font-weight: bold;">unless</span> (equal? 'store-name s)
      (make-product (hash-set (product-info p) s v)))))

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#21551;&#21160; store-specific-factory@ &#21333;&#20803;&#38656;&#35201;&#32473;&#23427;&#25552;&#20379; store^ &#30340;&#32465;&#23450;,</span>
<span style="color: #7F9F7F;">&#28982;&#32780; store^ &#30340;&#32465;&#23450;&#38656;&#35201;&#21551;&#21160; store@, &#32780; store@ &#38656;&#35201; factory^ &#30340;&#32465;&#23450;.</span>
<span style="color: #7F9F7F;">&#23427;&#20204;&#26159;&#30456;&#20114;&#20381;&#36182;&#30340;,&#22240;&#27492;&#19981;&#33021;&#22815;&#22312;&#20219;&#20309;&#19968;&#20010;&#20043;&#21069;&#21551;&#21160;&#23545;&#26041;&#30340;&#20381;&#36182;.</span>
<span style="color: #7F9F7F;">|#</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21807;&#19968;&#21150;&#27861;&#23601;&#26159;&#25226;&#21333;&#20803;&#36830;&#25509;&#36215;&#26469;</span>

(define-compound-unit/infer store+factory@
  (<span style="color: #F0DFAF; font-weight: bold;">import</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">export</span> factory^ store^)
  (link store-specific-factory@
        store@))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5c91921" class="outline-4">
<h4 id="org5c91921">First-Class Units</h4>
<div class="outline-text-4" id="text-org5c91921">
<p>
<code>define-unit</code> form æ˜¯ <code>define</code> å’Œ <code>unit</code> çš„æ··åˆ,å¹¶ä¸”ç»™å®šä¹‰çš„æ ‡è¯†ç¬¦å·é™„åŠ é™æ€ä¿¡æ¯.
</p>

<p>
é™æ€ä¿¡æ¯æ˜¯ç”¨äºç»™ <code>define-values/invoke-unit/infer</code> è¿™æ ·çš„ <code>/infer</code> forms æ ¹æ®æ ‡è¯†ç¬¦æ¨æ–­ç­¾åçš„æ¥å£.
</p>

<p>
å¦‚æœå•å…ƒæ²¡æœ‰é™æ€ä¿¡æ¯å°±ä¸èƒ½ç”¨ <code>define-values/invoke-unit/infer</code> å¯åŠ¨äº†.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">factory-maker.rkt</span>
#lang racket

(require <span style="color: #CC9393;">"factory-sig.rkt"</span>)
(provide factory@-maker)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">factory</span>@-maker
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (pinfo)
    (unit
      (<span style="color: #F0DFAF; font-weight: bold;">import</span>)
      (<span style="color: #F0DFAF; font-weight: bold;">export</span> factory^)

      (printf <span style="color: #CC9393;">"Factory started.\n"</span>)

      (define-struct product (info) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

      (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">build-products</span> n)
        (for/list ([i (in-range n)])
          (make-product pinfo)))

      (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">rebuild</span> p s v)
        (make-product (hash-set (product-info p) s v))))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">u</span> (factory@-maker (make-hash (list (cons 'name <span style="color: #CC9393;">"711"</span>)))))

(define-values/invoke-unit u
  (<span style="color: #F0DFAF; font-weight: bold;">import</span>)               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#22914;&#26524;&#26377;&#32473;&#23450;&#30340;&#31614;&#21517;,&#23601;&#20174;&#19978;&#19979;&#25991;&#20013;&#26597;&#25214;&#31526;&#21512;&#32473;&#23450;&#31614;&#21517;&#30340;&#21517;&#23383;/&#25509;&#21475;</span>
  (<span style="color: #F0DFAF; font-weight: bold;">export</span> factory^))     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25351;&#23450;&#23548;&#20986;&#30340;&#31614;&#21517;, u &#23454;&#29616;&#20102; factory^, &#25152;&#20197;&#36825;&#37324;&#26159; factory^.</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">products</span> (build-products 5))
</pre>
</div>

<p>
<code>define-compound-unit/infer</code> ä¹Ÿå¯ä»¥æ‹†å¼€ä¸º <code>define</code> , <code>compound-unit</code> ä»¥åŠé™„åŠ é™æ€ä¿¡æ¯ 3 ä¸ªåŠ¨ä½œ,ç°åœ¨å®šä¹‰ä¸€ä¸ªæ–°çš„ <code>new-store-factory@</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(require <span style="color: #CC9393;">"store-specific-factory-unit.rkt"</span>)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">new-store+factory</span>@
  (compound-unit
    (<span style="color: #F0DFAF; font-weight: bold;">import</span>)
    (<span style="color: #F0DFAF; font-weight: bold;">export</span> F S) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">F S &#20998;&#21035;&#26159;&#32465;&#23450; factory^ &#21644; store^ &#30340;&#26631;&#35782;&#31526;,&#22312;&#21518;&#38754;&#36827;&#34892;&#32465;&#23450;</span>
    (link [((F : factory^)) store-specific-factory@ S]
          [((S : store^)) store@ F])))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb727cf1" class="outline-4">
<h4 id="orgb727cf1">Whole-module Signatures and Units</h4>
<div class="outline-text-4" id="text-orgb727cf1">
<p>
æŠŠä¸Šé¢çš„ <code>factory^</code> å’Œ <code>factory@</code> åˆ†åˆ«æ”¹ä¸ºæ¨¡å—,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">factory-sig.rkt</span>
#lang racket/signature

build-products <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(integer? . -&gt; . (listof product?))</span>
product?       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(any/c . -&gt; . boolean?)</span>
rebuild        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(-&gt; product? symbol? any/c product?)</span>
product-info   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(product? . -&gt; . hash?)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">factory-unit.rkt</span>
#lang racket/unit

(require <span style="color: #CC9393;">"factory-sig.rkt"</span>)

(<span style="color: #F0DFAF; font-weight: bold;">import</span>)
(<span style="color: #F0DFAF; font-weight: bold;">export</span> factory^)

(printf <span style="color: #CC9393;">"Factory started.\n"</span>)

(define-struct product (info) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">build-products</span> n)
  (for/list ([i (in-range n)])
    (make-product (make-hash))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">rebuild</span> p s v)
  (make-product (hash-set (product-info p) s v)))
</pre>
</div>

<p>
ç­¾å <code>factory^</code> å’Œå•å…ƒ <code>factory@</code> åˆ†åˆ«è‡ªåŠ¨è¢«æ¨¡å—æä¾›, <code>Racket</code> ä¼šé€šè¿‡æ›¿æ¢å®ƒä»¬çš„æ–‡ä»¶ååç¼€æ¥æ¨æ–­,
</p>

<p>
æ¯”å¦‚æ›¿æ¢ <code>factory-sig.rkt</code> çš„ <code>-sig.rkt</code> ä¸º <code>^</code> , <code>factory-unit.rkt</code> çš„ <code>-unit.rkt</code> ä¸º <code>@</code> .
</p>
</div>
</div>

<div id="outline-container-org4d43661" class="outline-4">
<h4 id="org4d43661">Contracts for Units</h4>
<div class="outline-text-4" id="text-org4d43661">
</div>
<ul class="org-ul">
<li><a id="org3e3b802"></a>Adding Contracts to Signatures<br>
<div class="outline-text-5" id="text-org3e3b802">
<p>
ç»™ç­¾åæ·»åŠ çº¦æŸ,(æ–‡æ¡£ä¸Šçš„ä¾‹å­æ˜¯æœ‰é—®é¢˜çš„,åªèƒ½æ”¹ç§°è¿™æ ·).
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">factory-sig.rkt</span>
#lang racket

(provide factory^
         product
         product-info)

(define-struct product (info) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

(define-signature factory^
  ((contracted
    [build-products  (-&gt; integer? (listof product?))]
    [product?        (-&gt; any/c boolean?)]
    [rebuild         (-&gt; product? symbol? any/c product?)]
    [product-info    (-&gt; product? hash?)])))
</pre>
</div>

<p>
ç„¶åå•å…ƒå’Œå¹³å¸¸ä¸€æ ·ä½¿ç”¨.
</p>
</div>
</li>


<li><a id="orgd4246bb"></a>Adding Contracts to Units<br>
<div class="outline-text-5" id="text-orgd4246bb">
<p>
é™¤äº†ç»™ç­¾åæ·»åŠ çº¦æŸ,ä¹Ÿå¯ä»¥é€šè¿‡å¯¹å•å…ƒæ·»åŠ çº¦æŸ,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">factory-unit.rkt</span>
#lang racket

(require <span style="color: #CC9393;">"factory-sig.rkt"</span>)
(provide factory@)

(define-unit/contract factory@
  (<span style="color: #F0DFAF; font-weight: bold;">import</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">export</span> (factory^
           [build-products  (-&gt; integer? (listof product?))]
           [product?        (-&gt; any/c boolean?)]
           [rebuild         (-&gt; product? symbol? any/c product?)]
           [product-info    (-&gt; product? hash?)]))

  (printf <span style="color: #CC9393;">"Factory started.\n"</span>)

  (define-struct product (info) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">build-products</span> n)
    (for/list ([i (in-range n)])
      (make-product (make-hash))))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">rebuild</span> p s v)
    (make-product (hash-set (product-info p) s v))))
</pre>
</div>

<p>
å¯¹äºç¬¬ä¸€ç±»å¯¹è±¡å€¼çš„å•å…ƒ,å¯ä»¥ç”¨ <code>unit/c</code> .
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orga19877a" class="outline-4">
<h4 id="orga19877a">unit versus module</h4>
<div class="outline-text-4" id="text-orga19877a">
<p>
ä¸¤è€…éƒ½æ˜¯ <code>Racket</code> çš„æ¨¡å—åŒ–(<code>modularity</code>) åŠŸèƒ½, <code>unit</code> è¡¥å…¨äº† <code>module</code> .
</p>

<ul class="org-ul">
<li><code>module</code> ä¸»è¦ç”¨æ¥ç®¡ç†ä¸€ä¸ªç»Ÿä¸€çš„å‘½åç©ºé—´(<code>universal namespace</code>).</li>

<li><code>unit</code> ä¸»è¦ç”¨äºå…³äºå¤§å¤šæ•°ä»»ä½•è¿è¡Œæ—¶çš„å€¼æ¥å‚æ•°åŒ–ä»£ç ç‰‡æ–­(<code>code fragment</code>).</li>
</ul>

<p>
<code>unit</code> æŠŠå®šä¹‰å’Œå®ç°åˆ†å¼€(è¿è¡Œæ—¶éƒ¨åˆ†),å½“éœ€è¦å‚æ•°åŒ–å‡½æ•°,æ•°æ®ç±»å‹å’Œç±»çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ <code>unit</code> ,è€Œ <code>module</code> ä¸èƒ½æŠŠå®šä¹‰å’Œå®ç°åˆ†å¼€.
</p>
</div>
</div>
</div>

<div id="outline-container-orgbdab07a" class="outline-3">
<h3 id="orgbdab07a">15 Reflection and Dynamic Evaluation</h3>
<div class="outline-text-3" id="text-orgbdab07a">
<p>
<code>Racket</code> æ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€,æä¾›å¾ˆå¤š(numerous)ç”¨æ¥åŠ è½½(loading),ç¼–è¯‘(compiling)ç”šè‡³æ˜¯åœ¨è¿è¡Œæ—¶æ„å»ºæ–°çš„ä»£ç (constructing new code at run time)çš„åŠŸèƒ½.
</p>

<p>
ä¸‹é¢çš„ä¾‹å­éƒ½åªèƒ½åœ¨äº¤äº’ç¯å¢ƒä¸­ä½¿ç”¨,ç­‰ä¸€ä¸‹è¯´æ˜åŸå› .
</p>
</div>

<div id="outline-container-org3c18322" class="outline-4">
<h4 id="org3c18322">Eval</h4>
<div class="outline-text-4" id="text-org3c18322">
<p>
<code>eval</code> form æ¥å—"quoted" formæˆ–è€…è¯­æ³•å¯¹è±¡(syntax object)ä½œä¸ºè¦è¿ç®—çš„è¡¨è¾¾å¼.
</p>

<p>
<code>REPL</code> æ˜¯è¯»å–ç”¨æˆ·è¾“å…¥çš„è¡¨è¾¾å¼ç„¶åç”¨ <code>eval</code> æ¥è¿ç®—å®ƒä»¬.
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (<span style="color: #DCDCCC; font-weight: bold;">eval</span> <span style="color: #CC9393;">'(+ 1 2))</span>
<span style="color: #CC9393;">3</span>
<span style="color: #CC9393;">&gt; (define (eval-formula formula)</span>
<span style="color: #CC9393;">    (eval `(let ([x 2]</span>
<span style="color: #CC9393;">                 [y 3])</span>
<span style="color: #CC9393;">             ,formula)))</span>
<span style="color: #CC9393;">&gt; (eval-formula '</span>(+ x y))
5
&gt; (eval-formula <span style="color: #CC9393;">'(+ (* x y) y))</span>
<span style="color: #CC9393;">9</span>
</pre>
</div>

<p>
<code>eval</code> ç»å¸¸è¢«ç›´æ¥å’Œç€é—´æ¥ä½¿ç”¨åœ¨æ•´ä¸ªæ¨¡å—ä¸Š.æ¯”å¦‚ä¸€ä¸ªç¨‹åºå¯ä»¥é€šè¿‡ä½¿ç”¨ <code>dynamic-require</code> æŒ‰ç…§è¦æ±‚åŠ è½½æ¨¡å—,=dynamic-require= å°±æ˜¯ä¸€ä¸ªåŒ…è£¹ç€ <code>eval</code> çš„ wrapper.
</p>
</div>

<ul class="org-ul">
<li><a id="org428873c"></a>Local Scopes<br>
<div class="outline-text-5" id="text-org428873c">
<p>
å½“ä½¿ç”¨ <code>eval</code> è¿ç®—çš„æ—¶å€™æ˜¯ä¸èƒ½çœ‹åˆ°ä¸Šä¸‹æ–‡é‡Œé¢çš„æœ¬åœ°ç»‘å®š(local bindings).å› ä¸º <code>eval</code> æ˜¯ä¸€ä¸ªå‡½æ•°,å¹¶ä¸” <code>Racket</code> æ˜¯ä¸€ä¸ªé—¨é‡‡ç”¨è¯æ³•ç»‘å®šçš„,æ˜¯ä¸å¯èƒ½çœ‹åˆ°è¿è¡Œä¸Šä¸‹æ–‡ä¸­çš„æœ¬åœ°ç»‘å®š.
</p>

<p>
ä¸‹é¢è¿™ä¸ªä¾‹å­å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°æ˜¯ä¸è¡Œçš„,è¯å®äº†ä¸Šé¢çš„è¯´æ³•.
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (define (broken-eval-formula formula)
    (let ([x 2]
          [y 3])
      (<span style="color: #DCDCCC; font-weight: bold;">eval</span> formula)))
&gt; (broken-eval-formula <span style="color: #CC9393;">'(+ x y))</span>
<span style="color: #CC9393;">&gt; (define x 1)</span>
<span style="color: #CC9393;">&gt; (define y 2)</span>
<span style="color: #CC9393;">&gt; (define (eval-formula-z z)</span>
<span style="color: #CC9393;">    (eval '</span>(+ x y z)))
&gt; (eval-formula-z 3)
</pre>
</div>
</div>
</li>

<li><a id="org506fb51"></a>Namespaces<br>
<div class="outline-text-5" id="text-org506fb51">
<p>
<code>Racket</code> é‡Œé¢çš„å‘½åç©ºé—´(<code>namespace</code>)æ˜¯æŒ‡åŠ¨æ€åˆ¤æ–­å¯ç”¨çš„ç»‘å®š,ä¸èƒ½åƒå…¶å®ƒè¯­è¨€ä¸€æ ·è·Ÿ <code>environment</code> æˆ–è€… <code>scope</code> äº¤æ›¿ä½¿ç”¨,ä¸åº”è¯¥å’Œé™æ€è¯æ³•(static lexical)æ¦‚å¿µææ··.
</p>

<p>
<code>Racket</code> çš„å‘½åç©ºé—´æ˜¯ä¸€ä¸ªå›Šæ‹¬å¯ç”¨äºåŠ¨æ€è¿ç®—çš„ç»‘å®šçš„ç¬¬ä¸€ç±»(first-class)å€¼. <code>eval</code> æ¥å—ä¸€ä¸ªå¯é€‰å‚æ•°,é‚£å°±æ˜¯å‘½åç©ºé—´,é»˜è®¤ä½¿ç”¨å½“å‰çš„å‘½åç©ºé—´.
</p>

<p>
åœ¨ <code>REPL</code> ä¸­ä½¿ç”¨ <code>eval</code> çš„æ—¶å€™å°±æ˜¯ä½¿ç”¨ <code>REPL</code> çš„å‘½åç©ºé—´.
</p>

<p>
ä¸Šé¢ä¹‹æ‰€ä»¥ä¼šè¯´ä¸èƒ½åœ¨äº¤äº’æ¨¡å¼ä»¥å¤–çš„åœ°æ–¹è¿è¡Œä¾‹å­,æ˜¯å› ä¸ºåˆå§‹çš„å½“å‰æ¨¡å—ä¸ºç©º.
</p>

<p>
æ€»çš„æ¥è¯´,ä¸ç®¡æ˜¯å¦å®‰è£…å‘½åç©ºé—´çš„æƒ…å†µä¸‹ <code>eval</code> ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„.æ˜¾å¼åˆ›å»ºä¸€ä¸ªå‘½åç©ºé—´æ¥è°ƒç”¨ <code>eval</code> æ‰æ˜¯å¥½åŠæ³•.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(eval '(cons 1 2)) ; not work</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ns</span> (make-base-namespace)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21019;&#24314;&#19968;&#20010;&#25317;&#26377; racket/base &#32465;&#23450;&#30340;&#21629;&#21517;&#31354;&#38388;.</span>

(eval '(cons 1 2) ns) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">works</span>
</pre>
</div>
</div>
</li>

<li><a id="orgdcd1c5e"></a>Namespaces and Modules<br>
<div class="outline-text-5" id="text-orgdcd1c5e">
<p>
<code>Racket</code> å¯ä»¥æŠŠæ¨¡å—(module)åå°„(reflect)è¿›ä¸€ä¸ªå‘½åç©ºé—´å†….
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (module m racket/base
    (define x 11))
&gt; (require <span style="color: #CC9393;">'m)</span>
<span style="color: #CC9393;">&gt; (define ns (module-&gt;namespace ''m))</span>
<span style="color: #CC9393;">&gt; (eval '</span>x ns)
11
</pre>
</div>

<p>
<code>module-&gt;namespace</code> çš„å‚æ•°æ˜¯ä¸€ä¸ªå¸¦å¼•å·çš„æ¨¡å—è·¯å¾„(quoted module path), <code>'m</code> æ˜¯æ¨¡å—è·¯å¾„,æ‰€ä»¥å®å‚æ˜¯ <code>''m</code> .
</p>

<p>
<code>module-&gt;namespace</code> æ ¹æ®è·¯å¾„æŠŠæ¨¡å—çš„å®šä¹‰åŠ è½½åˆ°å‘½åç©ºé—´é‡Œé¢.
</p>

<p>
ä¸Šé¢çš„ä¾‹å­æ˜¯åœ¨æ¨¡å—å¤–ä½¿ç”¨çš„,åœ¨å¤–éƒ¨å¯ä»¥çŸ¥é“æ¨¡å—å…¨å,ä½†æ˜¯åœ¨å†…éƒ¨æ˜¯ä¸å¤ªå¯èƒ½çš„,å› ä¸ºè¿™éœ€è¦åœ¨åŠ è½½çš„æ—¶å€™çŸ¥é“æ¨¡å—çš„æºåœ¨å“ª.
</p>

<p>
åœ¨æ¨¡å—å†…æŠŠæ¨¡å—åŠ è½½è¿›å‘½åç©ºé—´,å°±è¦ç”¨ <code>define-namespace-anchor</code> å®šä¹‰ä¸€ä¸ªé’©å­å’Œç”¨ <code>namespace-anchor-&gt;namespace</code> åœ¨æ¨¡å—çš„å‘½åç©ºé—´æ‹‰å–(reel).
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(define-namespace-anchor a)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">ns</span> (namespace-anchor-&gt;namespace a))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">x</span> 1)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">y</span> 2)

(eval '(cons x y) ns) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 .2)</span>
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org575d1f0" class="outline-4">
<h4 id="org575d1f0">Manipulating Namespaces</h4>
<div class="outline-text-4" id="text-org575d1f0">
<p>
ä¸€ä¸ªå‘½åç©ºé—´å›Šæ‹¬ä¸¤å—ä¿¡æ¯:
</p>

<ul class="org-ul">
<li><p>
æ ‡è¯†ç¬¦(identifiers)åˆ°ç»‘å®š(bindings)çš„æ˜ å°„(mapping).
</p>

<p>
æ¯”å¦‚ä¸€ä¸ªå‘½åç©ºé—´å¯ä»¥æ˜ å°„æ ‡è¯†ç¬¦ <code>lambda</code> åˆ° <code>lambda</code> form.
</p>

<p>
ä¸€ä¸ªç©ºçš„å‘½åç©ºé—´æŠŠæ¯ä¸€ä¸ªæ ‡è¯†ç¬¦æ˜ å°„åˆ°ä¸€ä¸ªä½åˆå§‹åŒ–çš„ top-level å˜é‡.
</p></li>

<li><p>
æ¨¡å—åå­—(module names)åˆ°æ¨¡å—å£°æ˜(declarations)å’Œå®ä¾‹(instances).
</p>

<p>
æ˜¯çš„,æ¨¡å—ä¹Ÿæ˜¯éœ€è¦åƒç±»ä¸€æ ·å®ä¾‹åŒ–çš„.åœ¨è®²åˆ° <code>macro</code> çš„ <code>phase</code> é—®é¢˜æ—¶å€™ä¼šæåŠåˆ°.
</p></li>
</ul>


<p>
ç¬¬ä¸€ä¸ªæ˜ å°„ç”¨åœ¨åœ¨ top-level ä¸Šä¸‹æ–‡ä¸­è¿ç®—è¡¨è¾¾å¼çš„æ—¶å€™,æ¯”å¦‚ <code>(eval '(lambda (x) (+ x 1)))</code> ,å«æ ‡è¯†ç¬¦æ˜ å°„.
</p>

<p>
ç¬¬äºŒä¸ªæ˜ å°„,æ¯”å¦‚è¢« <code>dynamic-require</code> ç”¨äºå®šä½æ¨¡å—,å«æ¨¡å—æ˜ å°„.
</p>

<p>
ä¸€æ¬¡ä½¿ç”¨ä¸¤ä¸ªæ˜ å°„,æ¯”å¦‚ <code>(eval '(require racket/base))</code> .æ ‡è¯†ç¬¦æ˜ å°„å†³å®š <code>require</code> çš„ç»‘å®š,åŒæ—¶ <code>require</code> ç”¨æ¥å®šä½ <code>racket/base</code> æ¨¡å—.
</p>

<p>
<code>Racket</code> çš„æ ¸å¿ƒè¿è¡Œæ—¶ç³»ç»Ÿé‡Œé¢,æ‰€æœ‰è¿ç®—éƒ½æ˜¯å¯åå°„(reflective)çš„.
</p>
</div>

<ul class="org-ul">
<li><a id="orgd27bc21"></a>Creating and Installing Namespaces<br>
<div class="outline-text-5" id="text-orgd27bc21">
<p>
ä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜¯åˆ©ç”¨åå°„çš„æ–¹å¼ä» <code>racket/serialize</code> è·å¾— <code>serialize</code> å‡½æ•°.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-binding-from-serialize</span>)
  <span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">  &#36824;&#26377;&#19968;&#20010; make-empty-namespace &#21019;&#24314;&#31354;&#21629;&#21517;&#31354;&#38388;,&#20294;&#26159;&#23427;&#19981;&#21253;&#25324;Racket&#24314;&#31435;&#30340;&#22522;&#26412;&#27169;&#22359;,&#26102;&#19981;&#21487;&#29992;&#30340;&#21629;&#21517;&#31354;&#38388;.</span>
<span style="color: #7F9F7F;">  make-base-empty-namespace &#21019;&#24314;&#30340;&#21629;&#21517;&#31354;&#38388; = &#31354;&#30340;&#21629;&#21517;&#31354;&#38388; + racket/base&#27169;&#22359;,&#21629;&#21517;&#31354;&#38388;&#36824;&#26159;&#31354;&#30340;,</span>
<span style="color: #7F9F7F;">  &#22240;&#20026;&#26631;&#35782;&#31526;&#26144;&#23556;&#36824;&#26159;&#31354;&#30340;,&#21482;&#26377;&#27169;&#22359;&#26144;&#23556;&#27809;&#31354;.</span>
<span style="color: #7F9F7F;">  parameterize &#26159;&#19981;&#20250;&#24433;&#21709;&#20307;&#20869;&#30340; namespace-require &#36825;&#31181;&#26469;&#33258;&#38381;&#21512;&#19978;&#19979;&#25991;(&#36825;&#37324;&#26159;&#25972;&#20010;&#27169;&#22359;)&#26631;&#35782;&#31526;&#30340;&#23450;&#20041;&#21644;&#20351;&#29992;,</span>
<span style="color: #7F9F7F;">  &#21482;&#24433;&#21709;&#21160;&#24577;(dynamic)&#36816;&#31639;&#30456;&#20851;&#30340;&#34920;&#36798;&#24335;,&#27604;&#22914;(load "file"),(eval 'x)&#36825;&#31181;.</span>

<span style="color: #7F9F7F;">  &#36824;&#26377;&#19968;&#20010;&#24494;&#22937;&#30340;&#22320;&#26041;&#22312;&#20110;&#20351;&#29992;(namespace-require 'racket/serialize)&#32780;&#19981;&#26159;(eval '(require racket/serialize)),</span>
<span style="color: #7F9F7F;">  &#22240;&#20026; make-base-empty-namespace &#21019;&#24314;&#30340;&#21629;&#21517;&#31354;&#38388;&#30340;&#26631;&#35782;&#31526;&#26144;&#23556;&#26159;&#31354;&#30340;,&#25152;&#20197;&#19981;&#33021;&#20351;&#29992;require form,</span>
<span style="color: #7F9F7F;">  &#32780;namespace-require&#20989;&#25968;&#30452;&#25509;&#23548;&#20837;&#25351;&#23450;&#27169;&#22359;&#21040;&#24403;&#21069;&#30340;&#21629;&#21517;&#31354;&#38388;.</span>
<span style="color: #7F9F7F;">  |#</span>
  (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-namespace (make-base-empty-namespace)])
    (namespace-require 'racket/serialize)
    (eval 'serialize)))

(get-binding-from-serialize) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#&lt;procedure:serialize&gt;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">serialize</span> (get-binding-from-serialize))
</pre>
</div>
</div>
</li>

<li><a id="org60fda60"></a>Sharing Data and Code Across Namespaces<br>
<div class="outline-text-5" id="text-org60fda60">
<p>
å¦‚æœæ¨¡å—æ²¡æœ‰è¢«é™„åŠ (attached)åˆ°æ–°çš„å‘½åç©ºé—´ä¸Š,å½“è¿ç®—(evaluation)éœ€è¦å®ƒä»¬çš„æ—¶å€™,å®ƒä»¬å°±ä¼šè¢«åŠ è½½(loaded)å’Œé‡æ–°å®ä¾‹åŒ–(instantiated).
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(require racket/class)
(class? object%)       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(class?
  (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-namespace (make-base-empty-namespace)])
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">racket/class&#27809;&#26377;&#38468;&#21152;&#21040;&#26032;&#30340;&#21629;&#21517;&#31354;&#38388;&#19978;,&#20877;&#27425;&#21152;&#36733;&#21644;&#37325;&#26032;&#23454;&#20363;&#21270;,&#29983;&#25104;&#19968;&#20010;&#19981;&#21516;&#30340;&#31867;&#25968;&#25454;&#31867;&#22411;</span>
    (namespace-require 'racket/class)
    (eval 'object%)))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
</pre>
</div>

<p>
å¦‚æœæƒ³è¦å…±äº«å½“å‰ä¸Šä¸‹æ–‡çš„æ•°æ®åˆ°åˆ«çš„å‘½åç©ºé—´,é‚£å°±è¦ç”¨ <code>namespace-attach-module</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(require racket/class)

(class?
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([ns (make-base-empty-namespace)])
     <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20174;&#25351;&#23450;&#21629;&#21517;&#31354;&#38388;&#25277;&#21462;&#27169;&#22359;&#21040;&#21035;&#30340;&#21629;&#21517;&#31354;&#38388;&#19978;</span>
     (namespace-attach-module (current-namespace)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#28304;&#21629;&#21517;&#31354;&#38388;</span>
                              'racket/class        <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35201;&#25277;&#21462;&#30340;&#27169;&#22359;</span>
                              ns)                  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26032;&#21629;&#21517;&#31354;&#38388;</span>
     (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-namespace ns])
        (namespace-require 'racket/class)
        (eval 'object%))))         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22312;&#27169;&#22359;&#20869;&#37096;,&#29992; define-namespace-anchor &#21644; namespace-anchor-&gt;empty-namespace &#20250;&#26356;&#22909;</span>

(define-namespace-anchor a)
(class?
 (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([ns (make-base-empty-namespace)])
   <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36830;&#25509;&#34987;&#21152;&#36733;&#27169;&#22359;&#30340;&#21629;&#21517;&#31354;&#38388;&#36816;&#34892;&#26102;,&#21487;&#33021;&#20250;&#19982;&#24403;&#21069;&#21629;&#21517;&#31354;&#38388;&#19981;&#19968;&#26679;,</span>
   <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">namespace-nachor-&gt;empty-namespace &#36820;&#22238; racket/class &#30340;&#23454;&#20363;,&#36825;&#20010;&#23454;&#20363;&#19982; (require racket/class) &#23548;&#20837;&#30340;&#26159;&#21516;&#19968;&#20010;.</span>
   (namespace-attach-module (namespace-anchor-&gt;empty-namespace a)
                            'racket/class
                            ns)
   (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-namespace ns])
     (namespace-require 'racket/class)
     (eval 'object%))))            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org1dc4984" class="outline-4">
<h4 id="org1dc4984">Scripting Evaluation and Using load</h4>
<div class="outline-text-4" id="text-org1dc4984">
<p>
ç”±äºå†å²åŸå› , <code>Lisp</code> çš„å®ç°ä¸æä¾›æ¨¡å—ç³»ç»Ÿ.ç›¸åå¤§çš„ç¨‹åºéƒ½æ˜¯ä»¥åœ¨ <code>REPL</code> æŒ‰ç…§ç‰¹å®šçš„é¡ºåºè¿è¡Œç¨‹åºç‰‡æ–­çš„æ–¹å¼å†™è„šæœ¬å®Œæˆçš„.
</p>

<p>
å³ä½¿ç°åœ¨æœ‰äº†æ¨¡å—ç³»ç»Ÿ,è¿™ç§æ–¹å¼æœ‰æ—¶å€™è¿˜æ˜¯æŒºæœ‰ç”¨çš„.
</p>

<p>
è¿™æ¬¡çš„ä¸»è§’æ˜¯ <code>load</code> , <code>load</code> é€šè¿‡ <code>read</code> ä¸€è¡Œä¸€è¡Œçš„ä»æºä»£ç æ–‡ä»¶è¯»å– S-expressions å¹¶ä¸”æŠŠå®ƒä»¬äº¤ç»™ <code>eval</code> è¿›è¡Œè¿ç®—.
</p>

<p>
å› æ­¤, <code>load</code> éœ€è¦æ³¨æ„å’Œ <code>eval</code> ä¸€æ ·çš„å‘½åç©ºé—´é—®é¢˜.ä½†æ˜¯å’Œ <code>eval</code> ä¸ä¸€æ ·, <code>load</code> ä¸æ¥å—å‘½åç©ºé—´åšä¸ºå‡½æ•°.
</p>


<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">here.rkt</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19981;&#38656;&#35201;&#22768;&#26126;&#35821;&#35328;,&#20063;&#19981;&#38656;&#35201;provide</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">here</span> <span style="color: #CC9393;">"Morporkia"</span>)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">go!</span>) (set! here there))
</pre>
</div>

<p>
æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ <code>load</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">there</span> <span style="color: #CC9393;">"Utopia"</span>)

(define-namespace-anchor a)
(<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-namespace (namespace-anchor-&gt;namespace a)])
  (load <span style="color: #CC9393;">"here.rkt"</span>)
  (eval '(go!))
  (eval '(displayln here)))    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; Utopia</span>
</pre>
</div>

<p>
<code>Racket</code> æä¾›äº† <code>racket/load</code> è¯­è¨€,å®ƒçš„ <code>load</code> å¯ä»¥æŠŠæ¨¡å—çš„æ‰€æœ‰å†…å®¹çœ‹åšæ˜¯åŠ¨æ€çš„,æŠŠå®ƒä»¬å…¨éƒ¨äº¤ç»™ <code>eval</code> è¿ç®—,
</p>

<p>
<code>eval</code> ä½¿ç”¨çš„å‘½åç©ºé—´æ˜¯ä»¥ <code>racket</code> åŸºç¡€åˆå§‹åŒ–çš„,ç»“æœå°±æ˜¯æ¨¡å—é‡Œé¢å¯ä»¥çœ‹åˆ°åŠ¨æ€å‘½åç©ºé—´å†…çš„ç»‘å®š.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket/load

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">there</span> <span style="color: #CC9393;">"Utopia"</span>)
(load <span style="color: #CC9393;">"here.rkt"</span>)
(go!)
(printf <span style="color: #CC9393;">"~a\n"</span> here)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org511051b" class="outline-3">
<h3 id="org511051b">16 Macros</h3>
<div class="outline-text-3" id="text-org511051b">
<p>
å®(macro)æ˜¯ä¸è½¬æ¢å™¨(transformer)å…³è”çš„ <code>syntactic form</code> ,è½¬æ¢å™¨ä¼šæŠŠåŸæ¥çš„ <code>form</code> å±•å¼€ä¸ºå·²ç»å­˜åœ¨çš„ <code>forms</code> .
</p>

<p>
ç®€å•æ¥è¯´,å®æ˜¯ <code>Racket compiler</code> çš„æ‹“å±•.
</p>

<p>
(å¦‚æœä½ æ˜ç™½ç¼–è¯‘å™¨çš„ä¸»è¦å·¥ä½œå°±æ˜¯æŠŠè¯­è¨€Aç¿»è¯‘æˆè¯­è¨€Bçš„è¯,ä½ å°±èƒ½ç†è§£äº†,å·®åˆ«å°±åœ¨äºå®æŠŠè¯­è¨€Açš„ä¸œè¥¿ç¿»è¯‘æˆè¯­è¨€Aé‡Œé¢çš„å¦å¤–ä¸€ç§è¯´æ³•).
</p>

<p>
æ¯”è¾ƒæ¨èåœ¨è¿‡å®Œå…³äºå®˜æ–¹çš„ <code>Guide</code> åè®¤çœŸè¯»ä¸€é <a href="http://www.greghendershott.com/fear-of-macros/all.html">Fear of Macros</a> ä½œä¸ºè¡¥å……,ä¸Šé¢æ€»ç»“äº†ä¸å°‘å®é™…ä¼šé‡åˆ°çš„é—®é¢˜,
</p>

<p>
ç¼ºç‚¹å°±æ˜¯ä¸€äº›æ¦‚å¿µä¸å¤ªæ¸…æ¥š,ä¸è¿‡ <code>Guide</code> å·²ç»ä»‹ç»äº†ç›¸å…³æ¦‚å¿µäº†,æ‰€ä»¥è¯»å®Œ <code>Guide</code> å†è¯»å®ƒå°±æ²¡é—®é¢˜äº†.
</p>
</div>

<div id="outline-container-orgf1e20c5" class="outline-4">
<h4 id="orgf1e20c5">Pattern-Based Macros</h4>
<div class="outline-text-4" id="text-orgf1e20c5">
<p>
æ‰€è°“ <code>pattern-based macros</code> å°±æ˜¯æ ¹æ® <code>patten</code> åŒ¹é…è¯­æ³•ç„¶åæ ¹æ®æ¨¡æ¿(template)è¿›è¡Œå±•å¼€(expansion).
</p>

<p>
<code>macro pattern</code> ç±»ä¼¼ <code>Pattern Matching</code> æåˆ°çš„ <code>pattern</code> .
</p>
</div>

<ul class="org-ul">
<li><a id="orga15cad5"></a>define-syntax-rule<br>
<div class="outline-text-5" id="text-orga15cad5">
<p>
åˆ›å»ºå®çš„æœ€ç®€å•æ–¹æ³•å°±æ˜¯ç”¨ <code>define-syntax-rule</code> form.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(define-syntax-rule (swap x y)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">pattern</span>
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp x])                <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">template</span>
    (set! x y)
    (set! y tmp)))

(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (a b) (values 1 2))

(swap a b)

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">a &#21644; b &#30340;&#20540;&#20132;&#25442;&#20102;,&#22914;&#26524; swap &#26159;&#20989;&#25968;&#30340;&#35805;&#23601;&#19981;&#34892;&#20102;.</span>
<span style="color: #7F9F7F;">&#22240;&#20026;&#35789;&#27861;&#20316;&#29992;&#22495;&#30340;&#32536;&#25925;&#26159;&#19981;&#33021;&#30475;&#21040;&#22806;&#38754;&#30340;&#32465;&#23450;&#30340;,&#20063;&#23601;&#26159;&#35828;&#20316;&#20026;&#20989;&#25968;&#21442;&#25968;&#20256;&#20837;&#30340;a&#21644;b&#21482;&#26159;&#20540;&#20256;&#36882;&#32780;&#24050;.</span>
<span style="color: #7F9F7F;">|#</span>
(printf <span style="color: #CC9393;">"a is ~s, b is ~s\n"</span> a b)
</pre>
</div>
</div>
</li>

<li><a id="org889736f"></a>Lexical Scope<br>
<div class="outline-text-5" id="text-org889736f">
<p>
è¯æ³•ä½œç”¨åŸŸåæ˜¯ä¸ä¼šå½±å“å®çš„è¿ä½œçš„. <code>Racket</code> çš„ <code>pattern-based macros</code> ä¼šè‡ªåŠ¨ç»´æŠ¤è¯æ³•ä½œç”¨åŸŸå,æ¨ç†å®ä¸­å˜é‡çš„å¼•ç”¨,è¿™æ ·èƒ½å¤Ÿå’Œå‡½æ•°ä¸€æ ·ä½¿ç”¨.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp 5]
      [other 6])
  (swap tmp other)
  (list tmp other)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32467;&#26524;&#26159; '(6 5)</span>
</pre>
</div>

<p>
åœ¨è¿è¡Œçš„æ—¶å€™å®ä¼šè¢«å±•å¼€,ä½†æ˜¯ä¸ä¼šå±•å¼€æˆè¿™æ ·,å¦åˆ™ç»“æœå°±æ˜¯ <code>'(5 6)</code> äº†.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp 5]
      [other 6])
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp tmp])
    (set! tmp other)
    (set! other tmp))
  (list tmp other))
</pre>
</div>

<p>
æ­£ç¡®åº”è¯¥æ˜¯å±•å¼€æˆç±»ä¼¼è¿™æ ·,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp 5]
      [other 6])
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp_1 tmp])
    (set! tmp other)
    (set! other tmp_1))
  (list tmp other))
</pre>
</div>

<p>
è¿˜æœ‰ä¸€ä¸ªä¾‹å­,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([set! 5]
      [other 6])
  (swap set! other)
  (list set! other))
</pre>
</div>

<p>
å±•å¼€æ—¶è‡ªåŠ¨æ¨ç†å‡º <code>set!</code> çš„å¼•ç”¨,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([set!_1 5]
      [other 6])
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp_1 set!_1])
    (set! set!_1 other)
    (set! other tmp_1))
  (list set!_1 other))
</pre>
</div>
</div>
</li>

<li><a id="org03a3d0a"></a>define-syntax and syntax-rules<br>
<div class="outline-text-5" id="text-org03a3d0a">
<p>
<code>define-syntax-rule</code> åªèƒ½å®šä¹‰ä¸€ä¸ª <code>pattern</code> ,å¦‚æœè¦å®šä¹‰å¤šä¸ª <code>pattern</code> å°±è¦ç”¨åˆ° <code>define-syntax</code> å’Œ <code>syntax-rules</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#25509;&#30528;&#19978;&#38754;&#30340; swap</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">rotate</span>
  (<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> ()
    [(rotate a b) (swap a b)]
    [(rotate a b c) (<span style="color: #F0DFAF; font-weight: bold;">begin</span>
                     (swap a b)
                     (swap b c))]))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">c</span> 3)
(rotate a b c)
(printf <span style="color: #CC9393;">"a: ~s, b: ~s, c: ~a"</span> a b c) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">a: 1, b: 3, c: 2</span>
</pre>
</div>
</div>
</li>

<li><a id="orge1d786b"></a>Matching Sequences<br>
<div class="outline-text-5" id="text-orge1d786b">
<p>
æ¼”ç¤ºå¦‚ä½•åœ¨ <code>pattern</code> å’Œ <code>template</code> ä¸­ä½¿ç”¨ <code>...</code> è¿›è¡ŒåŒ¹é…å’Œå±•å¼€ .
</p>

<p>
æ”¹ä¸€ä¸‹ <code>rotate</code> çš„å®šä¹‰,è®©å®ƒæ”¯æŒæ¥å—2æˆ–è€…ä»¥ä¸Šä¸ªå‚æ•°.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">rotate</span>
  (<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> ()
    [(rotate a b) (swap a b)]
    [(rotate a b c ...) (<span style="color: #F0DFAF; font-weight: bold;">begin</span>
                          (swap a b)
                          (rotate b c ...))]))
</pre>
</div>

<p>
è¿™ä¸ªä¾‹å­å°±æ˜¯æŠŠä»ä¸€ä½ä¸€ç›´äº¤è¿˜åˆ°æœ€åä¸€ä¸ªä½,è¿™æ ·çš„æ•ˆç‡ä¸å‹å¥½,æ”¹å†™ä¸€ä¸‹,
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">rotate</span>
  (<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> ()
    [(rotate a b ...)
     (shift-to (b ... a) (a b ...))]))

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">shift-to</span>
  (<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> ()
    [(shift-to (from0 from ...) (to0 to ...))
     (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp from0])
       (set! to from) ... <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23637;&#24320;&#20026;&#22810;&#27425;&#36171;&#20540;&#25805;&#20316;, to &#21644; from &#30340;&#25968;&#37327;&#35201;&#30456;&#21516;,&#21542;&#21017;&#20250;&#25253;&#38169;.</span>
       (set! to0 tmp))]))
</pre>
</div>
</div>
</li>

<li><a id="org113b084"></a>Identifier Macros<br>
<div class="outline-text-5" id="text-org113b084">
<p>
ä¸Šé¢å®šä¹‰çš„å®å¿…é¡»ç´§è·Ÿå·¦æ‹¬å·åé¢,å¦åˆ™è¯­æ³•é”™è¯¯.
</p>

<p>
è¿˜æœ‰ä¸€ç§å«åšæ ‡è¯†ç¬¦å®(identifier macro),æ˜¯ä¸€ç§å¯ä»¥ä¸ç”¨éœ€è¦æ‹¬å·å°±å¯ä»¥ä½¿ç”¨çš„ <code>pattern-matching</code> å®.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">val</span>
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (stx)
    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">syntax &#20250;&#23581;&#35797;&#21305;&#37197;val&#20135;&#29983;&#30340;&#35821;&#27861;&#23545;&#35937;,&#36825;&#37324;&#23450;&#20041;&#20026;&#25104;&#21151;&#21305;&#37197;&#19968;&#20010;val&#21028;&#26029;&#23427;&#26159;&#21542;&#26631;&#35782;&#31526;,</span>
   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#26159;&#30340;&#35805;&#23601;&#26159;&#36820;&#22238; (get-val) &#30340;&#35821;&#27861;&#23545;&#35937;.&#20043;&#21518;&#20250;&#35762;&#35821;&#27861;&#23545;&#35937;&#21644;,syntax-case&#30340;&#29992;&#27861;.</span>
    (syntax-case stx ()
      [val (identifier? (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> val)) (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (get-val))])))

(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (get-val put-val!)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([private-val 0])
    (values (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () private-val)
            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v) (set! private-val v)))))

val <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">0</span>
(+ val 3) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>
</pre>
</div>
</div>
</li>

<li><a id="orgcca9251"></a>set! Transformers<br>
<div class="outline-text-5" id="text-orgcca9251">
<p>
ä¸Šé¢çš„ <code>val</code> æ˜¯ä¸å¯ä»¥ä½¿ç”¨ <code>set!</code> ä¿®æ”¹çš„,è™½ç„¶ä¸Šé¢å¯ä»¥ç”¨ <code>put-val!</code> ä¿®æ”¹,ä¸è¿‡å¤ªéº»çƒ¦äº†,ç”¨ <code>make-set!-transformer</code> å®šä¹‰ä¸€ä¸ªå¯ä»¥ç”¨ <code>set!</code> ä¿®æ”¹çš„å®.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (get-val put-val!)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([private-val 0])
    (values (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () private-val)
            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v) (set! private-val v)))))

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">val2</span>
  (make-set!-transformer
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (stx)
     (syntax-case stx (set!)
       [val2 (identifier? (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> val2)) (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (get-val))]
       [(set! val2 e) (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (put-val! e))]))))

val2 <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">0</span>
(+ val2 3) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">3</span>
(set! val2 10) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">val2 is 10 now</span>
</pre>
</div>
</div>
</li>

<li><a id="orga4f44c2"></a>Macro-Generating Macros<br>
<div class="outline-text-5" id="text-orga4f44c2">
<p>
å¦‚æœä¸æƒ³åƒ <code>val</code> å’Œ <code>val2</code> é‚£æ ·æœ‰ä¸€å¤§å † <code>accessor</code> å’Œ <code>mutator</code> å‡½æ•°,å¯ä»¥è¿™æ ·æ”¹,ç”¨å®æ¥äº§ç”Ÿå®.
</p>

<p>
è¿™ç§å®å«åš <code>macro-generating macro</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (get-val put-val!)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([private-val 0])
    (values (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () private-val)
            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v) (set! private-val v)))))

(define-syntax-rule (define-get/put-id id get put!)
  (<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">id</span>
    (make-set!-transformer
      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (stx)
        (syntax-case stx (set!)
          [id (identifier? (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> id)) (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (get))]
          [(set! id e) (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (put! e))])))))

(define-get/put-id val3 get-val put-val!)

(set! val3 10)
val3 <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">10</span>
</pre>
</div>

<p>
å†è¡¥ä¸€ä¸ªç®€å•çš„ä¾‹å­,é‡æ–°å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„ <code>define</code> form(ä¸€èˆ¬ä¸æ˜¯è¿™ä¹ˆå®šä¹‰çš„),
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(define-syntax-rule (mydefine (id arg ...) body ...)
  (<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">id</span>
    (<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> ()
      [(id arg ...)
       (<span style="color: #F0DFAF; font-weight: bold;">begin</span> body ...)])))

(mydefine (f x y)
          (+ x y) (+ y 1))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">res</span> (f 1 0))
res <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">1</span>
</pre>
</div>
</div>
</li>

<li><a id="org05b1ab4"></a>Extended Example: Call-by-Reference Functions<br>
<div class="outline-text-5" id="text-org05b1ab4">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(define-syntax-rule (swap x y)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp x])
    (set! x y)
    (set! y tmp)))

(define-syntax-rule (define-get/put-id id get put!)
  (<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">id</span>
    (make-set!-transformer
     (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (stx)
       (syntax-case stx (set!)
         [id (identifier? (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> id)) (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (get))]
         [(set! id e) (<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (put! e))])))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">do-f</span> get-a get-b put-a! put-b!)
  (define-get/put-id a get-a put-a!)
  (define-get/put-id b get-b put-b!)
  (swap a b))

(define-syntax-rule (define-cbr (id arg ...) body)
  (<span style="color: #F0DFAF; font-weight: bold;">begin</span>
    (<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">id</span>
      (<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> ()
        [(id actual (... ...))
         (do-f (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () actual)
               (... ...)
               (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v)
                 (set! actual v))
               (... ...))]))
    (define-for-cbr do-f (arg ...)
      ()
      body)))

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">define-for-cbr</span>
  (<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> ()
    [(define-for-cbr do-f (id0 id ...)
       (gens ...) body)
     (define-for-cbr do-f (id ...)
       (gens ... (id0 get put)) body)]
    [(define-for-cbr do-f ()
       ((id get put) ...) body)
     (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">do-f</span> get ... put ...)
       (define-get/put-id id get put) ...
       body)]))

(define-cbr (f a b)
  (swap a b))

(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([x 1] [y 2])
  (f x y)
  (list x y))
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-org98063eb" class="outline-4">
<h4 id="org98063eb">General Macro Transformers</h4>
<div class="outline-text-4" id="text-org98063eb">
<p>
<code>define-syntax</code> ä¸ºä¸€ä¸ªæ ‡è¯†ç¬¦åˆ›å»ºä¸€ä¸ªè½¬æ¢å™¨ç»‘å®š(transformer binding),å®ƒå¯ä»¥ç”¨åœ¨ç¼–è¯‘æ—¶å±•å¼€,è€Œå±•å¼€åçš„è¡¨è¾¾å¼ä¼šåœ¨è¿è¡Œæ—¶è¿ç®—.
</p>

<p>
ä¸è½¬æ¢å™¨å…³è”çš„è¿è¡Œæ—¶çš„(compile-time)å€¼å¯ä»¥æ˜¯ä»»ä½•å€¼,å¦‚æœæ˜¯ä¸€ä¸ªæ¥å—åªä¸€ä¸ªå‚æ•°çš„å‡½æ•°,é‚£ä¹ˆè¿™ä¸ªç»‘å®šå°±æ˜¯ä¸€ä¸ªå®(macro),è¿™ä¸ªå‡½æ•°å°±æ˜¯å®è½¬æ¢å™¨(macro transformer).
</p>
</div>

<ul class="org-ul">
<li><a id="orgf6a83e0"></a>Syntax Objects<br>
<div class="outline-text-5" id="text-orgf6a83e0">
<p>
ä¸€ä¸ªè¯­æ³•å¯¹è±¡(Syntax object)ç”±ä¸€ä¸ªquotedè¡¨è¾¾å¼(quoted form of expression),æºä½ç½®ä¿¡æ¯(source-location information)ä»¥åŠ <code>form</code> æ¯ä¸€éƒ¨åˆ†çš„è¯æ³•ç»‘å®šä¿¡æ¯(lexical-binding information).
</p>

<p>
quotedè¡¨è¾¾å¼å°±æ˜¯è¯­æ³•å¯¹è±¡å¯¹åº”çš„form,æºä½ç½®ä¿¡æ¯ä½¿ç”¨äºæŠ¥é”™çš„æ—¶å€™æç¤ºé”™è¯¯ä½ç½®,è¯æ³•ç»‘å®šä¿¡æ¯æ˜¯ç»™å®ç»´æŠ¤è¯æ³•ä½œç”¨åŸŸ.
</p>

<p>
ä¸€ä¸ª macro transformer çš„ <code>input</code> å’Œ <code>output</code> éƒ½æ˜¯ <code>syntax objects</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">syntax</span> (+ 1 2))
#'(+ 1 2)       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the same</span>
(identifier? #'car) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#t</span>
(identifier? #'(+ 1 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#f</span>
(free-identifier=? #'car #'cdr)  <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">#f</span>
(free-identifier=? #'car #'car)  <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">#t</span>
(require (only-in racket/base [car also-car]))
(free-identifier=? #'car #'aslo-car) <span style="color: #5F7F5F;">;</span><span style="color: #7F9F7F;">#t</span>
(syntax-&gt;datum #'(+ 1 2)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(+ 1 2), syntax-&gt;datum &#36820;&#22238;&#35821;&#27861;&#23545;&#35937;&#30340;form</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">'(.#&lt;syntax:14:13 +&gt; .#&lt;syntax:14:15 1&gt; .#&lt;syntax:14:17 2&gt;)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31867;&#20284;&#20110; syntax-&gt;datum,&#19981;&#36807;&#21482;&#26159;&#21435;&#25481;&#19968;&#23618;&#28304;&#20301;&#32622;&#21644;&#35789;&#27861;&#32465;&#23450;&#20449;&#24687;.</span>
(syntax-e #'(+ 1 2))
(datum-&gt;syntax #'lex '(+1 2) #'srcloc) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25226;datum &#36716;&#20026;&#35821;&#27861;&#23545;&#35937;,#'lex&#26159;&#35789;&#27861;&#32465;&#23450;,#'srcloc&#26159;&#28304;&#20301;&#32622;.</span>
</pre>
</div>
</div>
</li>

<li><a id="orgd6760a7"></a>Macro Transformer Procedures<br>
<div class="outline-text-5" id="text-orgd6760a7">
<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">syntax-rule &#36820;&#22238;&#30340;&#20063;&#26159;&#19968;&#20010;&#23439;&#36716;&#25442;&#22120;</span>
(<span style="color: #F0DFAF; font-weight: bold;">syntax-rules</span> () [(nothing) something]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">#&lt;procedure&gt;</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#29992; define-syntax &#21644; lambda &#20889;&#19968;&#20010;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> <span style="color: #DFAF8F;">self-as-string-lambda</span>
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (stx)
    (datum-&gt;syntax stx
                   (format <span style="color: #CC9393;">"~s"</span> (syntax-&gt;datum stx)))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20063;&#21487;&#20197;&#29992;define&#19968;&#26679;&#30340;shortcut</span>
(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> (<span style="color: #DFAF8F;">self-as-string</span> stx)
  (datum-&gt;syntax stx
                 (format <span style="color: #CC9393;">"~s"</span> (syntax-&gt;datum stx))))
</pre>
</div>
</div>
</li>

<li><a id="orgfffbae7"></a>Mixing Patterns and Expressions: syntax-case<br>
<div class="outline-text-5" id="text-orgfffbae7">
<p>
ç”± <code>syntax-rules</code> äº§ç”Ÿçš„å‡½æ•°å†…éƒ¨ä½¿ç”¨ <code>syntax-e</code> è§£æ„(deconstruct)æŒ‡å®šçš„è¯­æ³•å¯¹è±¡(syntax object),ç„¶åç”¨ <code>datum-&gt;syntax</code> æ„é€ (construct)ç»“æ„.
</p>

<p>
<code>syntax-case</code> å¯ä»¥è®©ä½ æ··åˆæ¨¡å¼åŒ¹é…(pattern matching),æ¨¡æ¿æ„å»º(template construction)å’Œä»»æ„è¡¨è¾¾å¼(arbitrary expressions).
</p>

<p>
<code>syntax-rules</code> æ˜¯ä¸èƒ½æ··åˆè¡¨è¾¾å¼çš„,å› æ­¤ <code>syntax-case</code> æ›´çµæ´».
</p>

<p>
ä¸åƒ <code>syntax-rules</code> é‚£æ ·ç”Ÿæˆå‡½æ•°,è€Œæ˜¯æ ¹æ®è¯­æ³•è¡¨è¾¾å¼(stx-expr)å’Œ <code>pattern</code> åˆ¤æ–­è¯­æ³•å¯¹è±¡,
</p>

<p>
æ¯ä¸€ä¸ª <code>syntax-case</code> ä»å¥éƒ½ç”±ä¸€ä¸ªæ¨¡å¼(pattern)å’Œè¡¨è¾¾å¼(expr),è€Œä¸æ˜¯æ¨¡å¼å’Œæ¨¡æ¿(template),è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªè¯­æ³•å¯¹è±¡,å®ƒä¼šåˆ‡æ¢åˆ°ä¹‹åçš„æ¨¡æ¿æ„é€ æ¨¡å¼(template-construction mode).
</p>

<p>
ä¸‹é¢è¿™ä¸ªä¾‹å­æŠŠæ¨¡å¼å’Œè¡¨è¾¾å¼æ··åˆåœ¨ä¸€èµ·, <code>swap</code> é‡Œé¢çš„è¯­æ³•å¯¹è±¡å°±æ˜¯æ¨¡æ¿, å³ä½¿ <code>#'x å’Œ #'y</code> ä¸ä¼šä½œä¸º <code>macro transformer</code> çš„ç»“æœ.
</p>

<p>
æ³¨æ„çš„æ˜¯æ¨¡å¼å˜é‡(pattern variable)åœ¨è¡¨è¾¾å¼é‡Œé¢ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦æ˜¯è¯­æ³•å¯¹è±¡,è¿™ä¹Ÿæ˜¯è·Ÿ <code>syntax-rules</code> å’Œ <code>define-syntax-rule</code> ä¸åŒçš„åœ°æ–¹,çœ‹èµ·æ¥ä¸åƒå®šä¹‰å‡½æ•°çš„å†™æ³•.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> (<span style="color: #DFAF8F;">swap</span> stx)
  (syntax-case stx ()
    [(swap x y)
     (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">and</span> (identifier? #'x)
              (identifier? #'y))
         #'(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([tmp x])
             (set! x y)
             (set! y tmp))
         (raise-syntax-error #f
                             <span style="color: #CC9393;">"not an identifier"</span>
                             stx
                             (<span style="color: #F0DFAF; font-weight: bold;">if</span> (identifier? #'x)
                                 #'y
                                 #'x)))]))
</pre>
</div>
</div>
</li>

<li><a id="orgc26f8ef"></a>with-syntax and generate-temporaries<br>
<div class="outline-text-5" id="text-orgc26f8ef">
<p>
ä¸Šé¢çš„ <code>Call-by-Reference Functions</code> çš„ <code>define-for-cbr</code> å¯ä»¥ç”¨ <code>syntax-case</code> ç®€åŒ–.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#25509;&#30528; Call-by-Reference Functions= &#20013;&#30340;&#20363;&#23376;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> (<span style="color: #DFAF8F;">define-for-cbr/v2</span> stx)
  (syntax-case stx ()
    [(_ do-f (id ...) body)
     <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">with-syntax &#30456;&#24403;&#20110;&#27169;&#26495;&#21464;&#37327;&#29256;&#26412;&#30340; let,</span>
     <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">generate-temporaries &#25226;&#19968;&#20010;&#26631;&#35782;&#31526;&#24207;&#21015;&#36716;&#21270;&#20026;&#29983;&#25104;&#26631;&#35782;&#31526;&#24207;&#21015;</span>
     (with-syntax ([(get ...) (generate-temporaries #'(id ...))]
                   [(put ...) (generate-temporaries #'(id ...))])
       #'(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">do-f</span> get ... put ...)
           (define-get/put-id id get put) ...
           body))]))
</pre>
</div>

<p>
å†ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­çœ‹ä¸€ä¸‹ <code>generate-temporaries</code> äº§ç”Ÿçš„ç»“æœæ˜¯æ€ä¹ˆæ ·çš„,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> (<span style="color: #DFAF8F;">print-generated-temporaries</span> stx)
  (syntax-case stx ()
      [(_ (id ...))
       (with-syntax ([(nid ...) (generate-temporaries #'(id ...))])
         #'(quote (nid ...)))]))

(print-generated-temporaries (a b c))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(a1 b2 c3)</span>
</pre>
</div>
</div>
</li>

<li><a id="orgb37c562"></a>Compile and Run-Time Phases<br></li>
<li><a id="org65e13ba"></a>General Phase Levels<br>
<div class="outline-text-5" id="text-org65e13ba">
<p>
ç”±äºä¹‹å‰å·²ç»å†™è¿‡å…³äº phase levels çš„<a href="../07/macros.html">ç¬”è®°</a>äº†,æ‰€ä»¥è¿™ä¸¤ä¸ªç« èŠ‚å°±ä¸å†™äº†.
</p>
</div>
</li>

<li><a id="org8fe4f15"></a>Syntax Taints<br>
<div class="outline-text-5" id="text-org8fe4f15">
<p>
ä¸å¤ªç†è§£è¯­æ³•æ±¡æŸ“æ—¶åšä»€ä¹ˆçš„,ä¹‹åå†ç ”ç©¶.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide go)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">unchecked-go</span> n x)
  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">to avoid disaster, n must be a number</span>
  (+ n 17))

(<span style="color: #F0DFAF; font-weight: bold;">define-syntax</span> (<span style="color: #DFAF8F;">go</span> stx)
  (syntax-case stx ()
    [(_ x)
     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">(syntax-protect #'(unchecked-go 8 x))</span>
     #'(unchecked-go 8 x)
     ]))
</pre>
</div>

<p>
å¦‚æœ <code>unchecked-go</code> çš„å¼•ç”¨æ˜¯ä» <code>(go 'a)</code> çš„å±•å¼€æå–å‡ºæ¥çš„,,é‚£ä¹ˆå®ƒæœ‰å¯èƒ½è¢«ä¼šæ’å…¥åˆ°ä¸€ä¸ªæ–° <code>(unchecked-go #f 'a)</code> çš„è¡¨è¾¾å¼ä¸­,æ‰§è¡Œå¯¼è‡´ä¸Šé¢è¯´çš„ç¾éš¾.
</p>

<p>
ä¸ºäº†é˜»æ­¢å¯¹ <code>unchecked-go</code> çš„æ»¥ç”¨,å¯ä»¥ç”¨ <code>syntax-protect</code> æ±¡æŸ“ä» <code>go</code> æå–å‡ºæ¥çš„è¯­æ³•å¯¹è±¡,
</p>

<p>
å®å±•å¼€å™¨(<code>macro expander</code>)ä¼šæ‹’ç»å—æ±¡æŸ“çš„æ ‡è¯†ç¬¦,æ‰€ä»¥è¯•å›¾ä» <code>(go 'a)</code> æå– <code>unchecked-go</code> ä¼šäº§ç”Ÿä¸€ä¸ªä¸èƒ½ç”¨äºæ„å»ºæ–°è¡¨è¾¾å¼çš„æ ‡è¯†ç¬¦.
</p>

<p>
<code>syntax-rules, syntax-id-rule å’Œ define-syntax-rule</code> forms ä¼šè‡ªåŠ¨ä¿æŠ¤å®ƒä»¬çš„å±•å¼€å¼ç»“æœ.
</p>

<p>
å‡†ç¡®æ¥è¯´, <code>syntax-protect</code> ä¼šç»™è¯­æ³•å¯¹è±¡è£…å¤‡ä¸€ä¸ªæŸ“è‰²åŒ…(dye pack),å¦‚æœä¸€ä¸ªè¯­æ³•å¯¹è±¡è¢«è£…å¤‡,é‚£ä¹ˆ syntax-e ä¼šæ±¡æŸ“ç»“æœé‡Œé¢çš„ä»»ä½•è¯­æ³•å¯¹è±¡.
</p>

<p>
ç±»ä¼¼çš„,å½“ <code>datum-&gt;syntax</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°è£…å¤‡äº†æŸ“è‰²åŒ…,é‚£ä¹ˆå®ƒçš„ç»“æœå°±è¢«æ±¡æŸ“.ä¸€ä¸ª <code>quoted</code> è¯­æ³•å¯¹è±¡çš„ä»»ä½•ä¸€ä¸ªéƒ¨åˆ†è¢«æ±¡æŸ“äº†,
</p>

<p>
é‚£ä¹ˆç»“æœçš„å¯¹åº”éƒ¨åˆ†ä¹Ÿæ˜¯å—åˆ°æ±¡æŸ“çš„.
</p>

<p>
å½“ç„¶å®å±•å¼€å™¨è‡ªèº«æ˜¯å¯ä»¥è§£é™¤ä¸€ä¸ªè¯­æ³•å¯¹è±¡çš„æ±¡æŸ“,å› æ­¤å®ƒå¯ä»¥å±•å¼€ä¸€ä¸ªè¡¨è¾¾å¼æˆ–è€…å®ƒçš„å­è¡¨è¾¾å¼.
</p>

<p>
å—åˆ°æ±¡æŸ“çš„è¯­æ³•å¯¹è±¡çš„æŸ“è‰²åŒ…éƒ½æ˜¯å’Œä¸€ä¸ªå¯ä»¥ç”¨æ¥è§£é™¤è£…å¤‡æŸ“è‰²åŒ…çš„æ£€æŸ¥å™¨(inspector).
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(syntax-protect stx)
(syntax-arms stx #f #t)
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgb253b0b" class="outline-4">
<h4 id="orgb253b0b">Module Instantiations and Visits</h4>
<div class="outline-text-4" id="text-orgb253b0b">
<p>
æ¨¡å—çš„å£°æ˜(declaration)å’Œåˆå§‹åŒ–(instantiation)æ˜¯åˆ†å¼€çš„,ç¬¬6ç« æœ‰æåˆ°è¿‡.ä¹Ÿä¸æ‰“ç®—è¯¦ç»†å†™.
</p>
</div>

<ul class="org-ul">
<li><a id="org667b562"></a>Declaration versus Instantiation<br>
<div class="outline-text-5" id="text-org667b562">
<p>
è¿™é‡Œä¸»è¦æ¶‰åŠ3ä¸ªforms.
</p>

<p>
<code>module</code> form å®šä¹‰æ¨¡å—; <code>require</code> å¯¼å…¥æ¨¡å—,è§¦å‘åˆå§‹åŒ–,è¿™ä¸ªæ—¶å€™ <code>module</code> å®šä¹‰çš„ä»£ç æ‰è¿è¡Œ,å¹¶ä¸”åŠ è½½å‘½åç©ºé—´;
</p>

<p>
<code>dynamic-require</code> ä¼šåœ¨ <code>module</code> æ²¡æœ‰è¢«åˆå§‹åŒ–çš„æƒ…å†µä¸‹åˆå§‹åŒ–, <code>dynamic-require</code> çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>#f</code> çš„æ—¶å€™å¯ä»¥åªè§¦å‘åˆå§‹åŒ–çš„å‰¯ä½œç”¨(ä¸åŠ è½½å‘½åç©ºé—´).
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (module mod racket
  (provide pa)
  (define (pa)
    (displayln <span style="color: #CC9393;">"Print a"</span>))
  (pa))
&gt; (dynamic-require <span style="color: #CC9393;">''</span>mod <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">f)</span>
Print a
&gt; pa
pa: undefined;
cannot reference an identifier before its definition
</pre>
</div>

<p>
è¿˜æœ‰ä½¿ç”¨ <code>require</code> çš„æ¨¡å—åˆå§‹åŒ–æ˜¯å¯ä¼ é€’çš„.ä¹Ÿå°±æ˜¯è¯´,å¦‚æœ <code>require</code> çš„æ¨¡å—Aè¢«åˆå§‹åŒ–äº†,é‚£ä¹ˆè¢«æ¨¡å—A <code>require</code> çš„æ¨¡å— <code>B, C</code> ç­‰ç­‰(å¦‚æœæ²¡æœ‰åˆå§‹åŒ–è¿‡çš„è¯)ä¹Ÿä¼šè¢«åˆå§‹åŒ–.
</p>
</div>
</li>

<li><a id="orgcf60654"></a>Compile-Time Instantiation<br>
<div class="outline-text-5" id="text-orgcf60654">
<p>
(æ²¡å†™å®Œ)
</p>

<p>
å£°æ˜ä¸€ä¸ªæ¨¡å—ä¼šå±•å¼€å’Œç¼–è¯‘æ¨¡å—.å¦‚æœä¸€ä¸ªæ¨¡å—é€šè¿‡ <code>(require (for-syntax ...))</code> å¯¼å…¥å¦å¤–ä¸€ä¸ªæ¨¡å—,é‚£ä¹ˆè¢«å¯¼å…¥çš„æ¨¡å—ä¸€å®šè¦åœ¨å±•å¼€çš„æ—¶å€™åˆå§‹åŒ–.
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgf3e8392" class="outline-3">
<h3 id="orgf3e8392">17 Creating Languages</h3>
<div class="outline-text-3" id="text-orgf3e8392">
<p>
å®çš„åŠŸèƒ½åœ¨ä¸¤ä¸ªæ–¹é¢å—é™:
</p>

<ul class="org-ul">
<li>å®ä¸èƒ½ä¸¥æ ¼é™åˆ¶ä¸Šä¸‹æ–‡ä¸­å¯ç”¨çš„è¯­æ³•æˆ–è€…æ”¹å˜æ”¹å˜å‘¨å›´çš„ <code>forms</code> çš„å®šä¹‰.</li>

<li>ä¸€ä¸ªå®åªèƒ½åœ¨è¯­è¨€çš„è¯æ³•è§„èŒƒçš„å‚æ•°(parameters)æ‹“å±•è¯­è¨€çš„è¯­æ³•,æ¯”å¦‚ä½¿ç”¨æ‹¬å·ç»™å®åå’Œå®ƒçš„ <code>subforms</code> åˆ†ç»„,ä»¥åŠä½¿ç”¨æ ‡è¯†ç¬¦,å…³é”®è¯å’Œå­—é¢å€¼çš„æ ¸å¿ƒè¯­æ³•.</li>
</ul>

<p>
ä¹Ÿå°±æ˜¯è¯´,å®åªèƒ½æ‹“å±•è¯­è¨€,å¹¶ä¸”åªèƒ½åœ¨å±•å¼€å™¨å±‚(<code>expander layer</code>)å®Œæˆ. <code>Racket</code> æä¾›é¢å¤–çš„åŠŸèƒ½ç”¨,åœ¨å±•å¼€å™¨å±‚çš„å®šä¹‰ä¸€ä¸ªèµ·ç‚¹,
</p>

<p>
æ‹“å±•è¯»å–å™¨å±‚(<code>reader layer</code>),åœ¨è¯»å–å™¨å±‚å®šä¹‰ä¸€ä¸ªèµ·ç‚¹ä»¥åŠæ‰“åŒ…è¯»å–å™¨å’Œå±•å¼€å™¨çš„èµ·ç‚¹æ‰“åŒ…è¿›ä¸€é—¨æœ‰ç€è§„èŒƒå‘½åçš„è¯­è¨€ä¸­.
</p>
</div>

<div id="outline-container-orgb01e0c3" class="outline-4">
<h4 id="orgb01e0c3">Module Languages</h4>
<div class="outline-text-4" id="text-orgb01e0c3">
<p>
å› ä¸ºåˆå§‹å¯¼å…¥çš„æ¨¡å—(initial-import module)æä¾›ç€æœ€åŸºç¡€çš„ç»‘å®š,æ‰€ä»¥åˆå§‹å¯¼å…¥å¯ä»¥è¢«ç§°ä¸ºæ¨¡å—è¯­è¨€(module language).
</p>

<p>
å¸¸è§çš„æ¨¡å—è¯­è¨€æœ‰ <code>racket</code> æˆ–è€… <code>racket/base</code> .ä¹Ÿå¯ä»¥æ ¹æ®è¿™äº›è¯­è¨€ä¿®æ”¹ç»‘å®šæ¥å®šä¹‰ä¸€é—¨è‡ªå·±çš„æ¨¡å—è¯­è¨€.
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; (module mylang racket
    (provide (except-out (all-from-out racket) lambda)
             (rename-out [lambda <span style="color: #F0DFAF; font-weight: bold;">function</span>])))
&gt; (module client <span style="color: #CC9393;">'mylang</span>
<span style="color: #CC9393;">    ((function () "I am the mylang language")))</span>
<span style="color: #CC9393;">&gt; (require '</span>client)
<span style="color: #CC9393;">"I am the mylang language"</span>
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="orgacee84a"></a>Implicit Form Bindings<br>
<div class="outline-text-5" id="text-orgacee84a">
<p>
å®šä¹‰ä¸€é—¨æ¨¡å—è¯­è¨€å¿…é¡»æä¾› <code>#%module-begin</code> è¿™ä¸ª <code>implicit form binding</code> ,å®ƒæ˜¯ç”¨æ¥åŒ…è£¹(wraps)æ¨¡å—ä½“çš„.
</p>

<p>
å…¶å®ƒçš„è¿™ç±» <code>implicit form binding</code> ,è¿˜æœ‰ <code>#%app, #%datum, #%top</code> ç­‰ç­‰,è¿™ä¸‰ä¸ªåˆ†åˆ«æ˜¯ç”¨äºå‡½æ•°è°ƒç”¨,å­—é¢å€¼å’Œæ²¡æœ‰ç»‘å®šçš„æ ‡è¯†ç¬¦.
</p>

<p>
å®šä¹‰ä¸€é—¨æ–°çš„æ¨¡å—è¯­è¨€æ¨ªæ‰«é‡æ–°å®šä¹‰(redefine) <code>#%app, #%datum å’Œ #%top</code> ,é‡æ–°å®šä¹‰ <code>#%module-begin</code> ä¼šæ›´åŠ æœ‰ç”¨.
</p>

<p>
æ¯”å¦‚å®šä¹‰ä¸€é—¨ <code>html</code> çš„æ¨¡å—è¯­è¨€,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">html.rkt</span>
(module html racket
  (require racket/date)
  (provide (except-out (all-from-out racket)
                       #%module-begin)
           (rename-out [module-begin #%module-begin])
           now)

  (define-syntax-rule (module-begin expr ...)
    (#%module-begin
     (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">page</span> `(html expr ...))
     (provide page)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">now</span>)
    (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([date-display-format 'iso-8601])
      (date-&gt;string (seconds-&gt;date (current-seconds))))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">&gt; (module client <span style="color: #CC9393;">"html.rkt"</span>
    (title <span style="color: #CC9393;">"Killer Queen"</span>)
    (p <span style="color: #CC9393;">"Updated: "</span> ,(now)))
&gt; (require <span style="color: #CC9393;">'client)</span>
<span style="color: #CC9393;">&gt; page</span>
<span style="color: #CC9393;">'</span>(html (title <span style="color: #CC9393;">"Killer Queen"</span>) (p <span style="color: #CC9393;">"Updated: "</span> <span style="color: #CC9393;">"2018-09-18"</span>))
</pre>
</div>
</div>
</li>

<li><a id="org6472be8"></a>Using #lang s-exp<br>
<div class="outline-text-5" id="text-org6472be8">
<p>
ç”¨ <code>#lang</code> å®šä¹‰æ¨¡å—è¯­è¨€æ¯”ç”¨ <code>module</code> å®šä¹‰è¦å¤æ‚ä¸€ç‚¹,å› ä¸ºå®ƒæœ‰æ›´å¤šçš„æ§åˆ¶;ä¸¤è€…ç”¨æ³•æ¯”è¾ƒå¦‚ä¸‹,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang s-exp module-name
form ...
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(module name module-name
  form ...)
</pre>
</div>

<p>
<code>s-exp</code> è¯­è¨€å°±åƒç”¨äºä½¿ç”¨ä¸€é—¨æä¾› <code>#lang shorthand</code> çš„å…ƒè¯­è¨€(meta-language),æ˜¯"S-expression"çš„ç®€å†™,
</p>

<p>
å®ƒæ˜¯ <code>Racket</code> çš„è¯»å–çº§åˆ«(reader-level)çš„è¯æ³•è§„èŒƒçš„ä¼ ç»Ÿåå­—,è¿™äº›è§„èŒƒåŒ…æ‹¬æ‹¬å·,æ ‡è¯†ç¬¦,æ•°å­—,åŒå¸¦å¼•å·å­—ç¬¦ä¸²,ç­‰ç­‰.
</p>

<p>
ä½¿ç”¨ <code>#lang s-exp</code> å’Œ <code>html.rkt</code> ,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang s-exp <span style="color: #CC9393;">"html.rkt"</span>

(title <span style="color: #CC9393;">"Killer Queen"</span>)
(p <span style="color: #CC9393;">"Updated: "</span> ,(now))
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org0ddb047" class="outline-4">
<h4 id="org0ddb047">Reader Extensions</h4>
<div class="outline-text-4" id="text-org0ddb047">
<p>
<code>Racket</code> çš„è¯»å–å™¨å±‚(reader layer)å¯ä»¥é€šè¿‡ <code>#reader form</code> æ‹“å±•.ä¸€ä¸ªè¯»å–å™¨æ‹“å±•ä»¥æ¨¡å—çš„å½¢å¼å½¢å¼,æ¨¡å—åå­—è·Ÿåœ¨ <code>#reader</code> åé¢.
</p>

<p>
è¿™ä¸ªæ¨¡å—å¯¼å‡ºè§£æç”Ÿå­—ç¬¦ä¸ºä¸€ä¸ªå¯ä»¥è¢«å±•å¼€å™¨å±‚(expander layer)æ¶ˆè´¹çš„ <code>form</code> .
</p>

<p>
<code>#reader</code> çš„è¯­æ³•:
</p>

<pre class="example" id="orgc35be63">
#reader â€¹module-pathâ€º â€¹reader-specificâ€º

&lt;module-path&gt; æ˜¯æä¾›readå’Œread-syntaxå‡½æ•°çš„æ¨¡å—,ä¹Ÿå°±æ˜¯reader.

&lt;reader-specific&gt; æ˜¯è¢«readerçš„readerå’Œread-syntaxè§£æçš„å­—ç¬¦åºåˆ—.
</pre>

<p>
ä¸€ä¸ªç®€å•çš„ä¾‹å­,å®šä¹‰ä¸€ä¸ªå«"five"ç®€å•çš„reader,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">five.rkt</span>
(module five racket/base
  (provide read read-syntax)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">read</span> in)
    (list (read-string 5 in)))
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">read-syntax</span> src in)
    (list (read-string 5 in))))
</pre>
</div>

<p>
ç„¶åå®¢æˆ·ç¨‹åº,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket/base
'(1 #reader <span style="color: #CC9393;">"five.rkt"</span> 234 56) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 (" 234 ") 56)</span>
'(1 #reader<span style="color: #CC9393;">"five.rkt"</span>234 56) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(1 ("234 5") 6)</span>
</pre>
</div>
</div>

<ul class="org-ul">
<li><a id="orgf58803f"></a>Source Locations<br>
<div class="outline-text-5" id="text-orgf58803f">
<p>
<code>read</code> å’Œ <code>read-syntax</code> çš„ä¸åŒä¹‹å¤„åœ¨äº, <code>read</code> æ˜¯ç”¨æ¥è¯»å–æ•°æ®,è€Œ <code>read-syntax</code> æ˜¯ç”¨æ¥è§£ææ•´ä¸ªç¨‹åº.
</p>

<p>
å‡†ç¡®ç‚¹è¯´,å½“è°ƒç”¨ <code>Racket</code> çš„ <code>read</code> æˆ–è€… <code>read-syntax</code> , å°±ä¼šåˆ†åˆ«è°ƒç”¨ <code>reader</code> æä¾›çš„ <code>read</code> å’Œ <code>read-syntax</code> .
</p>

<p>
ä¸è¦æ±‚ <code>read</code> å’Œ <code>read-syntax</code> ä¸€å®šè¦ä»¥åŒæ ·çš„æ–¹å¼è§£æè¾“å…¥,ä¸è¿‡ä»¥ä¸åŒçš„æ–¹å¼å®ç°ä¼šå›°æƒ‘ç¨‹åºå‘˜å’Œå·¥å…·.
</p>

<p>
<code>read-syntax</code> è¿”å›çš„å€¼æœ€å¥½æ˜¯è¯­æ³•å¯¹è±¡,å› ä¸ºè¯­æ³•å¯¹è±¡åŒ…å«è¡¨è¾¾å¼çš„æºä½ç½®ä¿¡æ¯;ç„¶å <code>read</code> å¯ä»¥å»æ‰ <code>read-syntax</code> è¿”å›çš„è¯­æ³•å¯¹è±¡çš„ä¿¡æ¯å¾—åˆ°ä¸€ä¸ªç”Ÿç»“æœ(raw result).
</p>

<p>
å®ç°ä¸€ä¸ªå¤„ç†æ•°å­¦ç®—æœ¯çš„reader, <code>"arith.rkt"</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">arith.rkt</span>
(module arith racket
  (require syntax/readerr)
  (provide read read-syntax)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">read</span> in)
    (syntax-&gt;datum (read-syntax #f in)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">read-syntax</span> src in)
    (skip-whitespace in)
    (read-arith src in))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">skip-whitespace</span> in)
    (regexp-match #px<span style="color: #CC9393;">"^\\s*"</span> in))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">read-arith</span> src in)
    (<span style="color: #F0DFAF; font-weight: bold;">define-values</span> (line col pos) (port-next-location in))

    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">expr-match</span>
      (regexp-match
       #px<span style="color: #CC9393;">"^([a-z]|[0-9]+)(?:[-+*/]([a-z]|[0-9]+))*(?![-+*/])"</span>
       in))

    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">to-syntax</span> v delta span-str)
      (datum-&gt;syntax #f v (make-srcloc delta span-str)))
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-srcloc</span> delta span-str)
      (<span style="color: #F0DFAF; font-weight: bold;">and</span> line
           (vector src line (+ col delta) (+ pos delta)
                   (string-length span-str))))

    (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">parse-expr</span> s delta)
      (match (<span style="color: #F0DFAF; font-weight: bold;">or</span> (regexp-match #rx<span style="color: #CC9393;">"^(.*?)([+-])(.*)$"</span> s)
                 (regexp-match #rx<span style="color: #CC9393;">"^(.*?)([*/])(.*)$"</span> s))
        [(list _ a-str op-str b-str)
         (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">a-len</span> (string-length a-str))
         (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">a</span> (parse-expr a-str delta))
         (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">b</span> (parse-expr b-str (+ delta 1 a-len)))
         (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">op</span> (to-syntax (string-&gt;symbol op-str)
                               (+ delta a-len) op-str))
         (to-syntax (list op a b) delta s)]
        [_ (to-syntax (<span style="color: #F0DFAF; font-weight: bold;">or</span> (string-&gt;number s)
                          (string-&gt;symbol s))
                      delta s)]))

    (<span style="color: #F0DFAF; font-weight: bold;">unless</span> expr-match
      (raise-read-error <span style="color: #CC9393;">"bad arithmetic syntax"</span>
                        src line col pos
                        (<span style="color: #F0DFAF; font-weight: bold;">and</span> pos (- (file-position in) pos))))
    (parse-expr (bytes-&gt;string/utf-8 (car expr-match)) 0)))
</pre>
</div>

<p>
å®¢æˆ·ç¨‹åº
</p>

<div class="org-src-container">
<pre class="src src-scheme">#reader <span style="color: #CC9393;">"arith.rkt"</span> 1*2+3 <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">5</span>
'#reader <span style="color: #CC9393;">"arith.rkt"</span> 1*2+3 <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">'(+ (* 1 2) 3)</span>
</pre>
</div>
</div>
</li>

<li><a id="org9aa527f"></a>Readtables<br>
<div class="outline-text-5" id="text-org9aa527f">
<p>
<code>Racket</code> é€šè¿‡å®æ‹“å±•å±•å¼€å™¨å±‚,é€šè¿‡è¯»å–è¡¨(<code>readtable</code>)æ‹“å±•è¯»å–å™¨å±‚.
</p>

<p>
<code>Racket</code> è¯»å–å™¨æ˜¯ä¸€ä¸ªé€’å½’å‘ä¸‹çš„è§£æå™¨(a recursive-descent parser), è¯»å–è¡¨æ˜ å°„å­—ç¬¦åˆ°è§£æå¤„ç†å™¨(parsing handlers).
</p>

<p>
<code>current-readtable paremeter</code> å†³å®šè¢« <code>read</code> æˆ–è€… <code>read-syntax</code> ä½¿ç”¨çš„è¯»å–è¡¨.ç„¶å <code>Racket</code> ç›´æ¥è§£æç”Ÿå­—ç¬¦,
</p>

<p>
ä¸€ä¸ªè¯»å–å™¨æ‹“å±•å¯ä»¥å®‰è£…ä¸€ä¸ªè¢«æ‹“å±•æ‹–çš„è¯»å–è¡¨,å¹¶ä¸”é“¾åˆ° <code>read</code> æˆ–è€… <code>read-syntax</code> .
</p>

<p>
<code>make-readtable</code> å‡½æ•°å¯ä»¥åœ¨ç°æœ‰è¯»å–è¡¨çš„åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„è¯»å–è¡¨.
</p>

<p>
æ–°å»ºä¸€ä¸ª <code>dollar</code> è¯»å–å™¨,åšä¸ºä½¿ç”¨ <code>readtable</code> çš„æ¼”ç¤º,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">dollar.rkt</span>
(module dollar racket

  (require syntax/readerr
           (prefix-in arith: <span style="color: #CC9393;">"arith.rkt"</span>))

  (provide (rename-out [$-read read]
                       [$-read-syntax read-syntax]))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">$-read</span> in)
    (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-readtable (make-$-readtable)])
      (read in)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">$-read-syntax</span> src in)
    (<span style="color: #F0DFAF; font-weight: bold;">parameterize</span> ([current-readtable (make-$-readtable)])
      (read-syntax src in)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-$-readtable</span>)
    (make-readtable (current-readtable)
                    #\$ 'terminating-macro read-dollar))  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25226; #\s &#20316;&#20026;&#20998;&#38548;&#31526;,&#36935;&#21040; #\s &#23601;&#35302;&#21457;</span>

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">read-dollar</span>
    (<span style="color: #F0DFAF; font-weight: bold;">case-lambda</span>
      [(ch in)
       (check-$-after (arith:read in) in (object-name in))]
      [(ch in src line col pos)
       (check-$-after (arith:read-syntax src in) in src)]))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">check-$-after</span> val in src)
    (regexp-match #px<span style="color: #CC9393;">"^\\s*"</span> in) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">skip whitespace</span>
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([ch (peek-char in)])
      (<span style="color: #F0DFAF; font-weight: bold;">unless</span> (equal? ch #\$) (bad-ending ch src in))
      (read-char in))
    val)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">bad-ending</span> ch src in)
    (<span style="color: #F0DFAF; font-weight: bold;">let-values</span> ([(line col pos) (port-next-location in)])
      ((<span style="color: #F0DFAF; font-weight: bold;">if</span> (eof-object? ch)
           raise-read-error
           raise-read-eof-error)
       <span style="color: #CC9393;">"expected a closing `$'"</span>
       src line col pos
       (<span style="color: #F0DFAF; font-weight: bold;">if</span> (eof-object? ch) 0 1)))))
</pre>
</div>

<p>
å®¢æˆ·ç¨‹åº,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#reader<span style="color: #CC9393;">"dollar.rkt"</span> (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([a $1*2+3$] [b $5/6$]) $a+b$) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">35/6</span>
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgb4c3cce" class="outline-4">
<h4 id="orgb4c3cce">Defining new #lang Languages</h4>
<div class="outline-text-4" id="text-orgb4c3cce">
</div>
<ul class="org-ul">
<li><a id="orgba9d4fa"></a>Designating a #lang Language<br>
<div class="outline-text-5" id="text-orgba9d4fa">
<p>
<code>#lang åè®®</code>
</p>

<ul class="org-ul">
<li><p>
è¯­è¨€çš„åå­—åªèƒ½ç”± <code>a-z, A-Z, 0-9</code> (ä¸èƒ½ç”¨äºå¼€å¤´æˆ–è€…ç»“å°¾), <code>_, - å’Œ +</code> å­—ç¬¦ç»„æˆ.
</p>

<p>
å› ä¸º <code>#lang</code> åªèƒ½æ¥å— <code>racket, racket/base</code> è¿™ç§æ ‡è¯†ç¬¦æ¨¡å—è·¯å¾„.
</p></li>

<li><p>
ä¸è¿‡ä¹Ÿæä¾›äº†å¦å¤–ä¸€ä¸ªæ›´è‡ªç„¶çš„æ–¹æ³•,æ¯”å¦‚ <code>#lang s-exp</code> ,å®ƒå¯ä»¥æ—¶å€™é€šç”¨çš„æ¨¡å—è·¯å¾„,æ¯”å¦‚å­—ç¬¦ä¸²è·¯å¾„,åŒæ—¶è´Ÿè´£è¯­è¨€çš„è¯»å–å™¨çº§.
</p>

<p>
<code>s-exp</code> ä¸èƒ½åƒ <code>racket</code> é‚£æ ·ä½œä¸º <code>require</code> çš„å‚æ•°.
</p></li>

<li><p>
<code>#lang language</code> ä¸æ˜¯ç›´æ¥ä½œä¸ºæ¨¡å—è·¯å¾„çš„,é¦–å…ˆä¼šå¯»æ‰¾è¯­è¨€ä¸»æ¨¡å—çš„è¯»å–å™¨å­æ¨¡å—(<code>reader submodule</code>),
</p>

<p>
å¦‚æœå®ƒä¸æ˜¯åˆæ³•çš„æ¨¡å—è·¯å¾„,é‚£ä¹ˆè¯­è¨€å°±ä¼šåŠ ä¸Š <code>/lang/reader</code> åç¼€,å¦‚æœè¿˜ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„æ¨¡å—è·¯å¾„å°±å¼•å‘ä¸€ä¸ªé”™è¯¯.
</p></li>
</ul>
</div>
</li>

<li><a id="org67521d7"></a>Using #lang reader<br>
<div class="outline-text-5" id="text-org67521d7">
<p>
<code>#lang</code> çš„ <code>reader</code> ç±»ä¼¼äº <code>s-exp</code> ,å®ƒæ˜¯ä½œä¸ºä¸€ç§å…ƒè¯­è¨€(meta language).
</p>

<p>
<code>s-exp</code> è®©ç¨‹åºå‘˜åœ¨è§£æçš„å±•å¼€å™¨å±‚ä¸ŠæŒ‡å®šä¸€ä¸ªé—¨æ¨¡å—è¯­è¨€(ä¹Ÿå°±æ˜¯æŒ‡#readerçš„ä½¿ç”¨ä½ç½®), <code>reader</code> è®©ç¨‹åºå‘˜åœ¨è¯»å–å™¨çº§ä¸ŠæŒ‡å®šä¸€é—¨è¯­è¨€(å½±å“æ•´ä¸ªç¨‹åº).
</p>

<p>
<code>#lang reader</code> åé¢ä¸€å®šè¦è·Ÿç€ä¸€ä¸ªæ¨¡å—è·¯å¾„,å¹¶ä¸”æä¾›çš„æ¨¡å—å¿…é¡»è¦å’Œ <code>#reader</code> çš„åè®®ä¸€æ ·æä¾› <code>read</code> å’Œ <code>read-syntax</code> å‡½æ•°.
</p>

<p>
ä¸åŒçš„æ˜¯ <code>#lang reader</code> æŒ‡å®šæ¨¡å—æä¾›çš„ <code>read</code> å’Œ <code>read-syntax</code> å‡½æ•°å¿…é¡»è¦è¿”å›ä¸€ä¸ªåŸºäºæ¨¡å—è¾“å…¥æ–‡ä»¶å‰©ä½™éƒ¨åˆ†çš„ <code>module form</code> .
</p>

<p>
æ¯”å¦‚,å®ç°ä¸€é—¨èƒ½å¤ŸæŠŠä»£ç æ–‡ä»¶çš„æ–‡æœ¬å¯¼å‡ºåˆ°ä¸€ä¸ªå˜é‡ä¸Šé¢:
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">literal.rkt</span>
(module literal racket
  (require syntax/strip-context)

  (provide (rename-out [literal-read read]
                       [literal-read-syntax read-syntax]))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read</span> in)
    (syntax-&gt;datum
      (literal-read-syntax #f in)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read-syntax</span> src in)
    (with-syntax ([str (port-&gt;string in)])
      (strip-context
        #'(module anything racket    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">module form &#26159;&#38656;&#35201;&#30340;,&#19982; #reader&#21327;&#35758;&#30340;&#21306;&#21035;</span>
            (provide data)
            (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">data</span> 'str))))))
</pre>
</div>

<p>
åœ¨å®¢æˆ·ç¨‹åºä¸­,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang reader <span style="color: #CC9393;">"literal.rkt"</span>
Hello
Hi
</pre>
</div>
</div>
</li>

<li><a id="org014832c"></a>Using #lang s-exp syntax/module-reader<br>
<div class="outline-text-5" id="text-org014832c">
<p>
è§£ææ¨¡å—ä½“ä¸ä¼šåƒ <code>"literal.rkt"</code> é‚£æ ·æ™®é€š.ä¸€ä¸ªå…¸å‹çš„æ¨¡å—è§£æå™¨ä¸€å®šä¼šéå†æ¨¡å—ä½“çš„å¤šä¸ª <code>forms</code> .
</p>

<p>
ä¸€é—¨è¯­è¨€ä¹Ÿå¯èƒ½æ˜¯é€šè¿‡ <code>readtable</code> è€Œä¸æ˜¯æ›¿æ¢ <code>Racket</code> è¯­æ³•æ¥æ‹“å±• <code>Racket</code> è¯­æ³•.
</p>

<p>
<code>syntax/module-reader</code> æ¨¡å—è¯­è¨€æŠ½è±¡äº†è¯­è¨€çš„å¸¸è§å®ç°éƒ¨åˆ†æ¥ç®€åŒ–ä¸€é—¨è¯­è¨€çš„åˆ›å»º,å®ƒä½¿ç”¨çš„è¯»å–å™¨å±‚ä¸ <code>Racket</code> çš„ä¸€æ ·.
</p>

<p>
ä¾‹å­ä¸€,å®ç° <code>raquet</code> è¯­è¨€,æŠŠ <code>lambda</code> æ¢æˆ <code>function</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">raquet-mlang.rkt</span>
#lang racket
(provide (except-out (all-from-out racket) lambda)
         (rename-out [lambda function]))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">raquet.rkt</span>
#lang s-exp syntax/module-reader
<span style="color: #CC9393;">"raquet-mlang.rkt"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">client.rkt</span>
#lang reader <span style="color: #CC9393;">"raquet.rkt"</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">identify</span> (function (x) x))
(provide identity)
</pre>
</div>

<p>
ä¾‹å­äºŒ,åŸºäºä¸Šé¢çš„ <code>dollar.rkt</code> (ä½¿ç”¨äº† <code>readtables</code>) çš„ <code>#reader</code> æä¾›çš„ <code>read</code> å’Œ <code>read-syntax</code> å®ç°ä¸€é—¨ <code>dollar-racket</code> è¯­è¨€,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">dollar-racket.rkt</span>
#lang s-exp syntax/module-reader
racket
<span style="color: #DCDCCC; font-weight: bold;">#:read</span> $-read
<span style="color: #DCDCCC; font-weight: bold;">#:read-syntax</span> $-read-syntax

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">#:read &#21644; #:read-syntax &#20998;&#21035;&#29992;&#20110;&#35774;&#23450;&#21035;&#30340; =read= &#21644; =read-syntax= .</span>
<span style="color: #7F9F7F;">|#</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">syntax/module-reader &#30340;&#37197;&#32622;&#19968;&#23450;&#35201;&#20986;&#29616;&#22312;&#20219;&#20309;&#23548;&#20837;&#25110;&#32773;&#23450;&#20041;&#21069;&#38754;.</span>
(require (prefix-in $- <span style="color: #CC9393;">"dollar.rkt"</span>))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">store.rkt</span>
#lang reader <span style="color: #CC9393;">"dollar-racket.rkt"</span>

(provide cost)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">cost</span> n h)
  $n*107/100+h$)
</pre>
</div>
</div>
</li>

<li><a id="orga41a69e"></a>Installing a Language<br>
<div class="outline-text-5" id="text-orga41a69e">
<p>
å®‰è£…è¯­è¨€,ä¹Ÿå°±æ˜¯æ‰“æˆåŒ….
</p>

<p>
ç”¨ä¸Šé¢çš„ <code>literal</code> ä¸ºä¾‹å­,æ–°å»ºä¸€ä¸ª <code>literal</code> ç›®å½•,æŠŠ <code>literal.rkt</code> ç§»åˆ°è¿™ä¸ªç›®å½•ä¸‹å¹¶ä¸”æ”¹åä¸º <code>main.rkt</code> ,ä¿®æ”¹ <code>main.rkt</code> å¦‚ä¸‹,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">literal/main.rkt</span>
#lang racket

(module reader racket
  (require syntax/strip-context)

  (provide (rename-out [literal-read read]
                       [literal-read-syntax read-syntax]))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read</span> in)
    (syntax-&gt;datum
     (literal-read-syntax #f in)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read-syntax</span> src in)
    (with-syntax ([str (port-&gt;string in)])
      (strip-context
       #'(module anything racket
           (provide data)
           (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">data</span> 'str))))))
</pre>
</div>

<p>
å®‰è£…åŒ…å¯ä»¥å‚è€ƒ <code>Modules</code> é‚£ä¸€ç« .
</p>
</div>
</li>

<li><a id="org4a8be97"></a>Source-Handling Configuration<br>
<div class="outline-text-5" id="text-org4a8be97">
<p>
è¿™ä¸ªç« èŠ‚æ˜¯ä»‹ç»å¦‚ä½•æ ¹æ®æ¨¡å—çš„æºæ–‡æœ¬(source text)ä¸ºè¯­è¨€é…ç½® <code>DrRacket</code> IDE ç¯å¢ƒçš„,æ¯”å¦‚é…ç½®è¯­æ³•ç€è‰²,IDEå·¥å…·æ¡,ç­‰ç­‰,æ‹“å±•ä¸Šé¢çš„ <code>main.rkt</code> ,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">literal/main.rkt</span>
#lang racket

(module reader racket
  (require syntax/strip-context)

  (provide (rename-out [literal-read read]
                       [literal-read-syntax read-syntax])
           get-info)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read</span> in)
    (syntax-&gt;datum
     (literal-read-syntax #f in)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read-syntax</span> src in)
    (with-syntax ([str (port-&gt;string in)])
      (strip-context
       #'(module anything racket
           (provide data)
           (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">data</span> 'str)))))

  <span style="color: #7F9F7F;">#| &#22914;&#26524;&#25552;&#20379;&#20102; get-info, DrRacket&#20250;&#35843;&#29992;&#36825;&#20010;&#20989;&#25968;,</span>
<span style="color: #7F9F7F;">     get-info &#30340;&#36820;&#22238;&#20540;&#26159;&#19968;&#20010;2&#20010;&#21442;&#25968;&#20989;&#25968;,&#31532;&#19968;&#20010;&#26159;&#35821;&#35328;&#30340;&#24037;&#20855;&#35831;&#27714;,&#31532;&#20108;&#20010;&#26159;&#35821;&#35328;&#19981;&#35748;&#35782;&#36825;&#20010;&#35831;&#27714;&#26102;&#20505;&#36820;&#22238;&#40664;&#35748;&#20540;.</span>
<span style="color: #7F9F7F;">     &#19979;&#38754;&#36825;&#20010;&#20363;&#23376;&#23601;&#26159;&#26597;&#35810;'color-lexer&#24037;&#20855;,&#26159;&#19968;&#20010;&#35821;&#27861;&#30528;&#33394;&#24037;&#20855;,&#36824;&#26377;&#24456;&#22810;&#20854;&#23427;&#31867;&#22411;&#30340;&#26597;&#35810;,&#27604;&#22914;,'drracket:toolbar-buttons,</span>
<span style="color: #7F9F7F;">     &#21028;&#26029;&#25353;&#38062;&#26159;&#21542;&#21487;&#29992;.</span>
<span style="color: #7F9F7F;">   |#</span>

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-info</span> in mod line col pos)
    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (key default)
      (<span style="color: #F0DFAF; font-weight: bold;">case</span> key
        [(color-lexer)
         (dynamic-require 'syntax-color/default-lexer
                          'default-lexer)]
        [else default]))))
</pre>
</div>

<p>
<code>syntax/module-reader</code> å¯ä»¥è®©ä½ é€šè¿‡ <code>#:info</code> æŒ‡å®š <code>get-info</code> å‡½æ•°.
</p>
</div>
</li>

<li><a id="orge4c5fcf"></a>Module-Handling Configuration<br>
<div class="outline-text-5" id="text-orge4c5fcf">
<p>
å¦‚ä½ æ‰€çŸ¥, <code>Racket</code> ç¼–è¯‘å™¨é™¤äº† <code>racket</code> è¿˜æ”¯æŒ <code>scheme</code> ,ä¸¤é—¨è¯­è¨€çš„è¯­æ³•å·®ä¸å¤šå¯ä»¥å…¼å®¹,
</p>

<p>
æ¯”å¦‚ <code>scheme</code> å®ç°çš„æ¨¡å—å¯ä»¥å¯¼å…¥ <code>racket</code> å®ç°çš„æ¨¡å—,åè¿‡æ¥ä¹Ÿä¸€æ ·.
</p>

<p>
ä¸è¿‡æœ‰ä¸€äº›ç‰¹æ€§åªæœ‰ <code>racket</code> æ‰æ”¯æŒçš„,ä¸‹é¢ä¸¤ä¸ªä¾‹å­ä½œå¯¹æ¯”,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">list-by-racket.rkt</span>
#lang racket
(list <span style="color: #CC9393;">"A"</span> <span style="color: #CC9393;">"list"</span> <span style="color: #CC9393;">"constructed"</span> <span style="color: #CC9393;">"by"</span> <span style="color: #CC9393;">"the"</span> <span style="color: #CC9393;">"list"</span> <span style="color: #CC9393;">"form"</span>)
</pre>
</div>

<p>
è¿è¡Œ <code>list-by-racket.rkt</code> ,è¿”å› <code>'("A" "list" "constructed" "by" "the" "list" "form")</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">list-by-scheme.rkt</span>
#lang scheme
(require <span style="color: #CC9393;">"list-by-racket.rkt"</span>)
</pre>
</div>

<p>
è¿è¡Œ <code>list-by-scheme.rkt</code> è¿”å› <code>("A" "list" "constructed" "by" "the" "list" "form")</code> ,å°‘ <code>list-by-racket.rkt</code> ç»“æœä¸€ä¸ª <code>quote</code> .
</p>

<p>
é™¤äº†ä¸Šé¢çš„ç»“æœæ˜¾ç¤ºé£æ ¼ä»¥å¤–,è¿˜æœ‰ä¸€ä¸ªä¾‹å­å°±æ˜¯ <code>REPL</code> çš„è¡Œä¸º,è¿™äº›ç‰¹æ€§æ˜¯è¯­è¨€çš„ <code>run-time configuration</code> çš„ä¸€éƒ¨åˆ†.
</p>

<p>
ä¸ä»£è¡¨æ¨¡å—æºæ–‡æœ¬(source text)çš„å±æ€§(æ¯”å¦‚ä¸Šæ–‡æåˆ°çš„è¯­æ³•ç€è‰²)ç›¸å¯¹, <code>run-time configuration</code> æ˜¯æ¯ä¸€ä¸ªæ¨¡å—çš„å±æ€§.
</p>

<p>
å› ä¸ºè¿™ä¸ªåŸå› ,å³ä½¿æ¨¡å—è¢«ç¼–è¯‘æˆå­—èŠ‚ç å½¢å¼å¹¶ä¸”æºæ–‡ä»¶ä¸å¯ç”¨,æ¨¡å—çš„ <code>run-time configuration</code> ä¹Ÿè¦å¯ç”¨.
</p>

<p>
å› æ­¤ <code>run-time configuration</code> æ˜¯ä¸èƒ½é€šè¿‡è¯­è¨€ <code>parser</code> æ¨¡å—æä¾›çš„  <code>get-info</code> å‡½æ•°(è¿è¡Œæ—¶ä¸­)å¤„ç†.
</p>

<p>
ç›¸åå®ƒå¯ä»¥è¢«éœ€è¦è§£æçš„æ¨¡å—çš„ <code>configure-runtime</code> å­æ¨¡å—å¤„ç†.å½“ä¸€ä¸ªæ¨¡å—ç›´æ¥é€šè¿‡ <code>racket</code> å‘½ä»¤è¿è¡Œ,
</p>

<p>
<code>racket</code> å‘½ä»¤å°±ä¼šæŸ¥æ‰¾æ¨¡å—é‡Œé¢çš„ <code>configure-runtime</code> å­æ¨¡å—,å¦‚æœå­˜åœ¨ <code>racket</code> æ‰ä¼šè¿è¡Œè¿™ä¸ªå­æ¨¡å—;
</p>

<p>
å¦‚æœè¿™ä¸ªæ¨¡å—è¢«å¯¼å…¥åˆ°åˆ«çš„æ¨¡å—ä¸­, <code>configure-runtime</code> å­æ¨¡å—å°±ä¼šè¢«å¿½ç•¥.
</p>

<p>
ä¹Ÿå°±æ˜¯è¯´ <code>configure-runtime</code> å­æ¨¡å—å¯ä»¥ç”¨æ¥å¤„ç†ä¸€äº›åœ¨ç›´æ¥è¿è¡Œæ¨¡å—æ—¶å€™çš„ç‰¹åˆ«çš„é…ç½®ä»»åŠ¡.
</p>

<p>
å›åˆ°ä¸Šé¢çš„ <code>literal</code> è¯­è¨€,å¯ä»¥è°ƒæ•´å®ƒç›´æ¥è¿è¡Œä¸€ä¸ª <code>literal</code> æ¨¡å—çš„æ—¶å€™ä¼šæ‰“å°å‡ºå®ƒçš„å­—ç¬¦ä¸²,è€Œç”¨äºå¤§å‹ç¨‹åºä¸­å°±åªæ˜¯è¿”å›æ•°æ®ä¸æ‰“å°.
</p>

<p>
ä¸‹é¢ç»™ <code>literal</code> æ–°å¢ä¸€ä¸ª <code>show.rkt</code> æ¥åšä¸ºå®ƒçš„å­æ¨¡å—.
</p>

<p>
<code>literal/show.rkt</code> æä¾› <code>show</code> å‡½æ•°ç”¨äºæ‰“å° <code>literal</code> æ¨¡å—çš„å­—ç¬¦ä¸²å†…å®¹,å¹¶ä¸”æä¾›ä¸€ä¸ª <code>show-enabled parameter</code> æ§åˆ¶ <code>show</code> æ˜¯å¦æ‰“å°ç»“æœ.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">literal/main.rkt</span>
#lang racket

(module reader racket
  (require syntax/strip-context)

  (provide (rename-out [literal-read read]
                       [literal-read-syntax read-syntax])
           get-info)

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read</span> in)
    (syntax-&gt;datum
     (literal-read-syntax #f in)))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">literal-read-syntax</span> src in)
    (with-syntax ([str (port-&gt;string in)])
      (strip-context
       #'(module anything racket
           (module configure-runtime racket
             (require literal/show)
             (show-enabled #t))
           (require literal/show)
           (provide data)
           (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">data</span> 'str)
           (show data)))))

  (<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">get-info</span> in mod line col pos)
    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (key default)
      (<span style="color: #F0DFAF; font-weight: bold;">case</span> key
        [(color-lexer)
         (dynamic-require 'syntax-color/default-lexer
                          'default-lexer)]
        [else default]))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">literal/show.rkt</span>
#lang racket

(provide show show-enabled)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">show-enabled</span> (make-parameter #f))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">show</span> v)
  (<span style="color: #F0DFAF; font-weight: bold;">when</span> (show-enabled)
    (display v)))
</pre>
</div>

<p>
å®¢æˆ·ç¨‹åº,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">client.rkt</span>
#lang literal
Hello!
Hi!
</pre>
</div>

<p>
ç›´æ¥è¿è¡Œè¿™ä¸ªæ¨¡å—ä¼šæŠŠç»“æœæ‰“å°å‡ºæ¥.ç„¶è€Œå½“è¿™ä¸ªæ¨¡å—è¢«åˆ«çš„æ¨¡å—å¯¼å…¥å°±ä¸ä¼šæ‰“å°.
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org4a67f63" class="outline-3">
<h3 id="org4a67f63">18 Concurrency and Synchronization</h3>
<div class="outline-text-3" id="text-org4a67f63">
<p>
<code>Racket</code> ä»¥ <code>çº¿ç¨‹(thread)</code> çš„å½¢å¼æä¾›å¹¶å‘(concurrency),å¹¶ä¸”ä¹Ÿæä¾›è¿™å¸¸è§„çš„åŒæ­¥å‡½æ•°(sync function),
</p>

<p>
ç”¨æ¥åŒæ­¥çº¿ç¨‹å’Œå…¶å®ƒå«è“„å½¢å¼çš„å¹¶å‘,æ¯”å¦‚ <code>ports</code> .
</p>
</div>

<div id="outline-container-orgc379862" class="outline-4">
<h4 id="orgc379862">Threads</h4>
<div class="outline-text-4" id="text-orgc379862">
<p>
å¹¶å‘åœ°æ‰§è¡Œä¸€ä¸ªç¨‹åº(procedure),ä½¿ç”¨ <code>thread</code> form åˆ›å»ºæ–°çº¿ç¨‹.
</p>

<p>
è¿™ä¸ªä¾‹å­çš„çº¿ç¨‹é¢„å®šä¼šæ— é™æ‰§è¡Œ,åœ¨è¿è¡Œ2.5ç§’åæ€æ‰è¿›ç¨‹.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(displayln <span style="color: #CC9393;">"This is the original thread"</span>)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">worker</span> (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
                         (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
                           (displayln <span style="color: #CC9393;">"Working..."</span>)
                           (sleep 0.2)
                           (loop)))))
(sleep 2.5)
(kill-thread worker)
</pre>
</div>

<p>
è¿™ä¸ªä¾‹å­ä¼šè¿è¡Œå¤§æ¦‚100ç§’,ä¸»çº¿ç¨‹ä¼šç­‰å¾…å®ƒæ‰§è¡Œå®Œæ¯•ç„¶åé€€å‡º.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(displayln <span style="color: #CC9393;">"This is the original thread"</span>)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">worker</span> (thread
                 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
                   (for ([i 100])
                     (sleep 1)
                     (printf <span style="color: #CC9393;">"Working hard... ~a~n"</span> i)))))
(thread-wait worker)  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#31561;&#24453;&#32447;&#31243;&#25191;&#34892;&#23436;&#27605;.</span>
(displayln <span style="color: #CC9393;">"Worker finished"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb0bd86" class="outline-4">
<h4 id="orgcb0bd86">Thread Mailboxes</h4>
<div class="outline-text-4" id="text-orgcb0bd86">
<p>
æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªé‚®ç®±(mailbox)ç”¨æ¥æ¥å—æ¶ˆæ¯.
</p>

<p>
ç”¨ <code>thread-send</code> ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹å‘æ¶ˆæ¯,å¦å¤–ä¸€ä¸ªçº¿ç¨‹ç”¨ <code>thread-receive</code> æ¥å—æ¶ˆæ¯.
</p>

<p>
è¿™ä¸ªä¾‹å­å‘é€äºŒåä¸ªæ•°å­—ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹ <code>worker-thread</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">worker-thread</span> (thread
                       (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
                         (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
                           <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">thread-receive&#36820;&#22238;&#32467;&#26524;&#26159;&#21035;&#30340;&#32447;&#31243;&#21457;&#36865;&#30340;&#28040;&#24687;,</span>
                           <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23427;&#30340;&#25968;&#25454;&#31867;&#22411;&#26159;&#19982;&#21457;&#36865;&#36807;&#26469;&#30340;&#28040;&#24687;&#30340;&#25968;&#25454;&#31867;&#22411;&#26159;&#19968;&#33268;&#30340;,</span>
                           <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20063;&#23601;&#26159;&#35828;&#21457;&#36865;&#36807;&#26469;&#28040;&#24687;&#26159;&#20160;&#20040;,(thread-receive)&#23601;&#26159;&#20160;&#20040;.</span>
                           (match (thread-receive)
                             [(? number? num)
                              (printf <span style="color: #CC9393;">"Processing ~a~n"</span> num)
                              (loop)]
                             ['done
                              (printf <span style="color: #CC9393;">"Done~n"</span>)])))))

(for ([i 20])                          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#20027;&#32447;&#31243;&#21457;&#36865;&#25968;&#23383;&#32473;worker-thread&#32447;&#31243;</span>
  (sleep 1)
  (thread-send worker-thread i))
(thread-send worker-thread 'done)
(thread-wait worker-thread)
</pre>
</div>

<p>
åœ¨è¿™ä¸ªä¾‹å­ä¸­,ä¸»çº¿ç¨‹å‘é€ <code>rator</code> , <code>rand</code> å’Œå½“å‰çº¿ç¨‹ç»™ç®—æœ¯çº¿ç¨‹;ç®—æœ¯çº¿ç¨‹æ ¹æ®æ¥å—çš„çº¿ç¨‹å‘é€è¿ç®—ç»“æœ.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-arithmetic-thread</span> operation)
  (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
            (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
              (match (thread-receive)
                [(list oper1 oper2 result-thread)
                 (thread-send result-thread
                              (format <span style="color: #CC9393;">"~a + ~a = ~a"</span>
                                      oper1
                                      oper2
                                      (operation oper1 oper2)))
                 (loop)])))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">addition-thread</span> (make-arithmetic-thread +))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">subtraction-thread</span> (make-arithmetic-thread -))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">worklist</span> '((+ 1 1) (+ 2 2) (- 3 2) (- 4 1)))
(for ([item worklist])
  (match item
    [(list '+ o1 o2)
     (thread-send addition-thread
                  (list o1 o2 (current-thread)))]           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">current-thread&#36820;&#22238;&#24403;&#21069;&#32447;&#31243;.&#36825;&#37324;&#26159;&#20027;&#32447;&#31243;.</span>
    [(list '- o1 o2)
     (thread-send subtraction-thread
                  (list o1 o2 (current-thread)))]))

(for ([i (length worklist)])
  (displayln (thread-receive)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org80863d4" class="outline-4">
<h4 id="org80863d4">Semaphores</h4>
<div class="outline-text-4" id="text-org80863d4">
<p>
ä¿¡å·é‡(semaphores)å®ç°åŒæ­¥è®¿é—®ä»»æ„å…±äº«èµ„æº.å½“å¤šä¸ªçº¿ç¨‹è¦å¯¹åŒä¸€ä¸ªèµ„æºæ‰§è¡ŒéåŸå­(non-atomic)æ“ä½œçš„æ—¶å€™ä½¿ç”¨ä¿¡å·é‡.
</p>

<p>
ä¸ä½¿ç”¨ä¿¡å·é‡,è¾“å‡ºç»“æœä¼šä¸€å›¢ä¹±.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-thread</span> name)
  (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
            (for [(i 10)]
              (printf <span style="color: #CC9393;">"thread ~a: ~a~n"</span> name i)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">threads</span>
  (<span style="color: #F0DFAF; font-weight: bold;">map</span> make-thread '(A B C)))
(<span style="color: #F0DFAF; font-weight: bold;">for-each</span> thread-wait threads)
</pre>
</div>

<p>
ä½¿ç”¨ä¿¡å·é‡å®ç°äº’æ–¥,ä¿è¯è¾“å‡ºåŒæ­¥.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">output-semaphore</span> (make-semaphore 1))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-thread</span> name)
  (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
            (for [(i 10)]
              (semaphore-wait output-semaphore)
              (printf <span style="color: #CC9393;">"thread ~a: ~a~n"</span> name i)
              (semaphore-post output-semaphore)
              ))))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">threads</span>
  (<span style="color: #F0DFAF; font-weight: bold;">map</span> make-thread '(A B C)))
(<span style="color: #F0DFAF; font-weight: bold;">for-each</span> thread-wait threads)
</pre>
</div>

<p>
ä½¿ç”¨ <code>call-with-semaphore</code> ç®€åŒ–ä¸Šé¢çš„ä»£ç ,å°±åƒ <code>Python</code> çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">output-semaphore</span> (make-semaphore 1))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-thread</span> name)
  (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
            (for [(i 10)]
              (call-with-semaphore
               output-semaphore
               (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
                (printf <span style="color: #CC9393;">"thread ~a: ~a~n"</span> name i)))))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">threads</span>
  (<span style="color: #F0DFAF; font-weight: bold;">map</span> make-thread '(A B C)))
(<span style="color: #F0DFAF; font-weight: bold;">for-each</span> thread-wait threads)
</pre>
</div>

<p>
ä¿¡å·é‡æ˜¯ä¸€ç§ low-level æŠ€æœ¯.æœ€å¥½çš„è§£å†³æ–¹æ³•æ˜¯é™åˆ¶èµ„æºåªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è®¿é—®.
</p>

<p>
æ¯”å¦‚ç”¨ä¸“é—¨çº¿ç¨‹å»ç®¡ç† <code>output</code> æ¯”åŒæ­¥è®¿é—® <code>output</code> å¥½.
</p>
</div>
</div>

<div id="outline-container-org1a6579f" class="outline-4">
<h4 id="org1a6579f">Channels</h4>
<div class="outline-text-4" id="text-org1a6579f">
<p>
å½“ä¸€ä¸ªå€¼è¢«ä¸€ä¸ªçº¿ç¨‹ä¼ å…¥åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹,å¯ä»¥ä½¿ç”¨channelsåŒæ­¥ä¸¤ä¸ªçº¿ç¨‹.
</p>

<p>
è·Ÿé‚®ç®±ä¸ä¸€æ ·,ä¸€ä¸ªchannelå¯ä»¥ç»™å¤šä¸ªçº¿ç¨‹å‘é€æ¶ˆæ¯, <code>Racket</code> çš„ <code>channel</code> å°±æ˜¯åŒæ­¥é˜Ÿåˆ—.
</p>

<p>
ä¸‹é¢è¿™ä¸ªä¾‹å­,ä½¿ç”¨ä¸¤ä¸ª <code>channels</code> ,ä¸€ä¸ªæ˜¯ç”¨äºå‚¨å­˜ä»»åŠ¡,ä¸€ä¸ªæ˜¯ç”¨äºå‚¨å­˜ç»“æœ.
</p>

<p>
ç”±äºæ˜¯åŒæ­¥é˜Ÿåˆ—, <code>channel-get</code> ä¼šç­‰å¾… <code>channel-put</code> æ‰§è¡Œåæ‰ä¼šæ‰§è¡Œ,åŒæ · <code>channel-put</code> æ‰§è¡Œåéœ€è¦ç­‰å¾… <code>channel-get</code> æ‰§è¡Œå®Œæ‰èƒ½ <code>put</code> ä¸‹ä¸€ä¸ªæ¶ˆæ¯.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">result-channel</span> (make-channel))                     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">make-channel &#36820;&#22238;&#19968;&#20010; channel</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">result-thread</span>
        (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
                  (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
                    (displayln (channel-get result-channel)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">channel-get &#33719;&#21462; channel &#30340;&#20219;&#21153;</span>
                    (loop)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">work-channel</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-worker</span> thread-id)
  (thread
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
     (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
       (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">item</span> (channel-get work-channel))               <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#33719;&#21462; work-channel &#30340;&#20219;&#21153;,&#24182;&#19988;&#23436;&#25104;&#20219;&#21153;</span>
       (<span style="color: #F0DFAF; font-weight: bold;">case</span> item
         [(DONE)
          (channel-put result-channel                         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#23436;&#25104;&#20219;&#21153;&#21518;&#32473; result-channel &#21457;&#36865;&#32467;&#26524;.</span>
                       (format <span style="color: #CC9393;">"Thread ~a done"</span> thread-id))]
         [else
          (channel-put result-channel
                       (format <span style="color: #CC9393;">"Thread ~a processed ~a"</span>
                               thread-id
                               item))
          (loop)])))))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">work-threads</span> (<span style="color: #F0DFAF; font-weight: bold;">map</span> make-worker '(1 2)))
(for ([item '(A B C D E F G H DONE DONE)])
  (channel-put work-channel item))                           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#32473; work-channel &#21457;&#36865;&#20219;&#21153;</span>
(<span style="color: #F0DFAF; font-weight: bold;">for-each</span> thread-wait work-threads)
</pre>
</div>
</div>
</div>

<div id="outline-container-org343a511" class="outline-4">
<h4 id="org343a511">Buffered Asynchronous Channels</h4>
<div class="outline-text-4" id="text-org343a511">
<p>
ä¸Šé¢çš„æ˜¯åŒæ­¥é˜Ÿåˆ—, <code>Racket</code> ä¹Ÿæœ‰å¼‚æ­¥é˜Ÿåˆ—.
</p>

<p>
å¼‚æ­¥é˜Ÿåˆ—çš„ <code>async-channel-put</code> ä¸éœ€è¦ç­‰å¾… <code>async-channel-get</code> æ‰§è¡Œæ‰èƒ½ <code>put</code> ä¸‹ä¸€ä¸ªæ¶ˆæ¯,é™¤é <code>channel</code> è®¾å®šäº†ç¼“å­˜åŒºé™åˆ¶(buffer limit)å¹¶ä¸”è¾¾åˆ°é™åˆ¶.
</p>

<p>
(æ³¨æ„, <code>async-channel-get</code> éœ€è¦ç­‰åˆ°é˜Ÿåˆ—æœ‰æ¶ˆæ¯æ‰å¯ä»¥æ‰§è¡Œ,å¦åˆ™block.)
</p>

<p>
ä¸‹é¢è¿™ä¸ªä¾‹å­,ä¸»çº¿ç¨‹ç»™ <code>work channel</code> å‘é€æ¶ˆæ¯, <code>work channel</code> æœ€å¤§æ¶ˆæ¯æ•°é‡é™åˆ¶ä¸º3, <code>worker</code> çº¿ç¨‹ä» <code>work channel</code> è·å–æ¶ˆæ¯å¹¶ä¸”å¤„ç†.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(require racket/async-channel)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">print-thread</span>
  (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
            (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
              (displayln (thread-receive))
              (loop)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">safer-printf</span> . items)
  (thread-send print-thread
               (apply format items)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">work-channel</span> (make-async-channel 3))    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#21019;&#24314;channel,&#35774;&#23450;&#38480;&#21046;&#20026;3</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-worker-thread</span> thread-id)
  (thread
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
     (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
       (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">item</span> (async-channel-get work-channel))
       (safer-printf <span style="color: #CC9393;">"Thread ~a processing item: ~a"</span> thread-id item)
       (loop)))))

(<span style="color: #F0DFAF; font-weight: bold;">for-each</span> make-worker-thread '(1 2 3))
(for ([item '(a b c d e f g h i j k l m)])
  (async-channel-put work-channel item))
</pre>
</div>
</div>
</div>

<div id="outline-container-org89212b7" class="outline-4">
<h4 id="org89212b7">Synchronizable Events and sync</h4>
<div class="outline-text-4" id="text-org89212b7">
<p>
é™¤äº†ä¸Šé¢ä»‹ç»çš„çº¿ç¨‹åŒæ­¥æ–¹æ³•,è¿˜æœ‰å¯ä»¥ä½¿ç”¨ <code>sync</code> å‡½æ•°è®©çº¿ç¨‹ä¹‹é—´é€šè¿‡åŒæ­¥äº‹ä»¶(synchronizable events)æ¥åè°ƒ.
</p>

<pre class="example" id="orga46b4e7">

äº‹ä»¶æ˜¯å¤šç§ç±»å‹çš„å€¼(è¿™äº›å€¼è‡ªèº«ä¹Ÿæ˜¯äº‹ä»¶)çš„ç»„åˆ,åŒ…æ‹¬ =channels, ports, threads å’Œ alarms= .

è¿™å…è®¸å®ç°ä¸€å¥—ä½¿ç”¨ä¸åŒç±»å‹çš„å€¼æ¥åŒæ­¥çº¿ç¨‹çš„ç»Ÿä¸€æ–¹æ³•.

äº‹ä»¶çš„çŠ¶æ€æœ‰ä¸¤ç§, åŒæ­¥å°±ç»ª(ready for synchronization)å’ŒåŒæ­¥è¿˜æ²¡å°±ç»ª.

è¿™å–å†³äºäº‹ä»¶çš„ç±»å‹ä»¥åŠå®ƒæ˜¯æ€ä¹ˆè¢«å…¶å®ƒçº¿ç¨‹ä½¿ç”¨çš„,ä¸€ä¸ªäº‹ä»¶å¯ä»¥åœ¨ä»»ä½•æ—¶å€™åˆ‡æ¢çŠ¶æ€.

å¦‚æœä¸€ä¸ªçº¿ç¨‹é€šè¿‡ä¸€ä¸ªåŒæ­¥å°±ç»ªçš„äº‹ä»¶æ¥åŒæ­¥,é‚£ä¹ˆäº‹ä»¶å°±ä¼šäº§ç”Ÿä¸€ä¸ªåŒæ­¥ç»“æœ(synchronization result).

</pre>

<p>
è¿™ä¸ªå°èŠ‚å±•ç¤ºå¦‚ä½•é€šè¿‡ç»„åˆ <code>events, threads å’Œ sync</code> æ¥å®ç°ä¸€å¥—ä»»æ„å¤æ‚çš„é€šä¿¡åè®®(arbitrarily sophisticated communication protocols)æ¥åè°ƒä¸€ä¸ªç¨‹åºçš„å¹¶å‘éƒ¨åˆ†.
</p>

<p>
è¿™ä¸ªä¾‹å­å°†ä¼šç”¨ <code>channel</code> å’Œ <code>alarm</code> ç»„åˆæ¥åšä¸ºåŒæ­¥äº‹ä»¶: è®¾å®šä¸€ä¸ª <code>alarm</code> äº‹ä»¶
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">main-thread</span> (current-thread))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">alarm</span> (alarm-evt (+ 3000 (current-inexact-milliseconds)))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#35774;&#23450;alarm&#20107;&#20214;&#22312;3000&#27627;&#31186;(3&#31186;)&#21518;&#28608;&#27963;(&#20063;&#23601;&#26159;&#21464;&#25104;&#23601;&#32490;&#29366;&#24577;).</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">channel</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-worker-thread</span> thread-id)
  (thread
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
     (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">evt</span> (sync channel alarm))   <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">sync &#36820;&#22238;&#19968;&#20010;Event&#23545;&#35937;,&#36825;&#37324;&#25226;channel&#21644;alarm &#32452;&#21512;&#25104;&#19968;&#20010;Event&#20102;</span>
     (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
       <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#24403; alarm &#20107;&#20214;&#35302;&#21457;&#30340;&#26102;&#20505;&#23601;&#20250;&#32473;&#20027;&#32447;&#31243;&#21457;&#36865;&#28040;&#24687;,&#28982;&#21518;&#20027;&#32447;&#31243;&#32467;&#26463;.</span>
       <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#35201;&#27714;worker&#32447;&#31243;&#25968;&#37327;&#35201;&#27604;channel&#30340;&#39033;&#22810;&#19968;&#20010;,&#22810;&#20986;&#26469;&#30340;worker&#32473;&#20027;&#32447;&#31243;&#21457;&#36865;alarm&#30340;&#28040;&#24687;.</span>
       [(equal? evt alarm)
        (thread-send main-thread 'alarm)]
       [else
        (thread-send main-thread
                     (format <span style="color: #CC9393;">"Thread ~a received ~a"</span>
                             thread-id
                             evt))]))))
(make-worker-thread 1)
(make-worker-thread 2)
(make-worker-thread 3)
(channel-put channel 'A)
(channel-put channel 'B)
(<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
  (match (thread-receive)
    ['alarm
     (displayln <span style="color: #CC9393;">"Done"</span>)]
    [result
     (displayln result)
     (loop)]))
</pre>
</div>

<p>
ä¸‹é¢è¿™ä¸ªä¾‹å­ç”¨ä¸€ä¸ª TCP echo server æ¥åšæ¼”ç¤º.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">server</span>
#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">serve</span> in-port out-port)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> []
    (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">evt</span> (sync/timeout 2                            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25351;&#23450;&#31561;&#24453;&#20107;&#20214;&#30340;&#26368;&#22823;&#26102;&#38388;</span>
                              (read-line-evt in-port 'any) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">read-line-evt &#36820;&#22238;&#19968;&#20010;&#20107;&#20214;&#31561;&#24453;&#25351;&#23450;&#30340;input port&#26377;input.</span>
                              (thread-receive-evt)))       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#24403;thread-receive&#27809;&#26377;block&#30340;&#26102;&#20505;(thread-receive-evt)&#30340;&#32467;&#26524;&#23601;&#20250;&#23601;&#32490;</span>
    (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
      [(not evt)
       (displayln <span style="color: #CC9393;">"Timed out, exiting"</span>)
       (tcp-abandon-port in-port)            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#20851;&#38381; in-port</span>
       (tcp-abandon-port out-port)]          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#20851;&#38381; out-port</span>
      [(string? evt)
       (fprintf out-port <span style="color: #CC9393;">"~a~n"</span> evt)
       (flush-output out-port)
       (loop)]
      [else
       (printf <span style="color: #CC9393;">"Received a message in mailbox: ~a~n"</span>
               (thread-receive))
       (loop)])))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">port-num</span> 4321)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">start-server</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">listener</span> (tcp-listen port-num))
  (thread
    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
      (<span style="color: #F0DFAF; font-weight: bold;">define-values</span> [in-port out-port] (tcp-accept listener))
      (serve in-port out-port))))

(start-server)

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">client</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">client-thread</span>
  (thread
   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> ()
     (<span style="color: #F0DFAF; font-weight: bold;">define-values</span> [in-port out-port] (tcp-connect <span style="color: #CC9393;">"localhost"</span> port-num))
     (display <span style="color: #CC9393;">"first\nsecond\nthird\n"</span> out-port)
     (flush-output out-port)
     <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">copy-port will block until EOF is read from in-port</span>
     (copy-port in-port (current-output-port)))))

(thread-wait client-thread)
</pre>
</div>

<p>
è¿˜å¯ä»¥ç»™äº‹ä»¶æ·»åŠ å›è°ƒ.
</p>

<p>
ä¸‹ä¸€ä¸ªä¾‹å­åˆ©ç”¨3ä¸ª <code>channels</code> è¿›è¡Œçº¿ç¨‹åŒæ­¥,æ¯ä¸€ä¸ª <code>channel</code> å¤„ç†å·¥ä½œéƒ½ä¸ä¸€æ ·.
</p>

<p>
å…¶ä¸­ <code>handle-evt</code> å¯ä»¥å…³è”ä¸€ä¸ªæŒ‡å®šäº‹ä»¶å’Œå›è°ƒ(callback),å½“ <code>sync</code> é€‰æ‹©äº†æŒ‡å®šäº‹ä»¶å°±ä¼šè°ƒç”¨å›è°ƒäº§ç”ŸåŒæ­¥ç»“æœ,
</p>

<p>
è€Œä¸æ˜¯ä½¿ç”¨äº‹ä»¶çš„åŒæ­¥ç»“æœ.å› ä¸ºäº‹ä»¶æ˜¯åœ¨å›è°ƒé‡Œé¢è¢«å¤„ç†çš„,æ‰€ä»¥æ²¡æœ‰å¿…è¦é€‚é…(dispatch) <code>sync</code> è¿”å›çš„å€¼.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">add-channel</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">multiply-channel</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">append-channel</span> (make-channel))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">work</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ()
    (sync (handle-evt add-channel
                      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (list-of-numbers)
                        (printf <span style="color: #CC9393;">"Sum of ~a is ~a~n"</span>
                                list-of-numbers
                                (apply + list-of-numbers))))
          (handle-evt multiply-channel
                      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (list-of-numbers)
                        (printf <span style="color: #CC9393;">"Product of ~a is ~a~n"</span>
                                list-of-numbers
                                (apply * list-of-numbers))))
          (handle-evt append-channel
                      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (list-of-strings)
                        (printf <span style="color: #CC9393;">"Concatenation of ~s is ~s~n"</span>
                                list-of-strings
                                (apply string-append list-of-strings)))))
    (loop)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">worker</span> (thread work))
(channel-put add-channel '(1 2))
(channel-put multiply-channel '(3 4))
(channel-put multiply-channel '(5 6))
(channel-put add-channel '(7 8))
(channel-put append-channel '(<span style="color: #CC9393;">"a"</span> <span style="color: #CC9393;">"b"</span>))
</pre>
</div>

<p>
ç”±äº <code>handle-evt</code> ä¼šæ ¹æ® <code>sync</code> åœ¨å°¾éƒ¨ä½ç½®(tail position)å”¤é†’å›è°ƒ,æ‰€ä»¥ä½¿ç”¨é€’å½’æ˜¯æ²¡æœ‰é—®é¢˜çš„.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">control-channel</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">add-channel</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">subtract-channel</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">work</span> state)
  (printf <span style="color: #CC9393;">"Current state: ~a~n"</span> state)
  (sync (handle-evt add-channel
                    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (number)
                      (printf <span style="color: #CC9393;">"Adding: ~a~n"</span> number)
                      (work (+ state number))))
        (handle-evt subtract-channel
                    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (number)
                      (printf <span style="color: #CC9393;">"Subtracting: ~a~n"</span> number)
                      (work (- state number))))
        (handle-evt control-channel
                    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (kill-message)
                      (printf <span style="color: #CC9393;">"Done~n"</span>)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">worker</span> (thread (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () (work 0))))
(channel-put add-channel 2)
(channel-put subtract-channel 3)
(channel-put add-channel 4)
(channel-put add-channel 5)
(channel-put subtract-channel 1)
(channel-put control-channel 'done)
(thread-wait worker)
</pre>
</div>

<p>
<code>wrap-evt</code> åƒ <code>handle-evt</code> ä¸€æ ·,é™¤äº†å›è°ƒä¸ä¼šæ ¹æ® <code>sync</code> åœ¨å°¾éƒ¨ä½ç½®è°ƒç”¨,è¿˜æœ‰ <code>wrap-evt</code> åœ¨è°ƒç”¨å›è°ƒæ—¶å€™ç¦ç”¨äº†break exceptions.
</p>
</div>
</div>

<div id="outline-container-org6f5d205" class="outline-4">
<h4 id="org6f5d205">Building Your Own Synchronization Patterns</h4>
<div class="outline-text-4" id="text-org6f5d205">
<p>
äº‹ä»¶è¿˜å…è®¸åœ¨ä¸€ä¸ªç¨‹åºä¸åŒçš„å¹¶å‘éƒ¨åˆ†å®ç°é€šä¿¡æ¨¡å¼(communication patterns).
</p>

<p>
å…¶ä¸­ä¸€ä¸ªå¸¸ç”¨çš„æ¨¡å¼å°±æ˜¯ç”Ÿäº§è€…-æ¶ˆè´¹è€…(producer-consumer).
</p>

<p>
æ¥ä¸‹æ¥è¿˜æœ‰ä¸Šé¢ä¾‹å­çš„åšæ³•å»å®ç°ä¸€ä¸ªå˜ç§çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹.
</p>

<p>
å…·ä½“åšæ³•å°±æ˜¯åˆ©ç”¨ <code>sync</code> å®ç°ä¸€ä¸ªç­‰å¾…è¾“å…¥ç„¶åå¤„ç†çš„ <code>server loops</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(define/contract (produce x)
  (-&gt; any/c void?)
  (channel-put producer-chan x))


(define/contract (consume)
  (-&gt; any/c)
  (channel-get consumer-chan))


<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">private state and server loop</span>


(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">producer-chan</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">consumer-chan</span> (make-channel))
(void
 (thread
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> ()
    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the items variable holds the items that</span>
    <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">have been produced but not yet consumed</span>
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([items '()])
      (sync

       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">wait for production</span>
       (handle-evt
        producer-chan
        (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (i)
          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">if that event was chosen,</span>
          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">we add an item to our list</span>
          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">and go back around the loop</span>
          (loop (cons i items))))

       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">wait for consumption, but only</span>
       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">if we have something to produce</span>
       (handle-evt
        (<span style="color: #F0DFAF; font-weight: bold;">if</span> (null? items)
            never-evt
            (channel-put-evt consumer-chan (car items)))
        (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (_)
          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">if that event was chosen,</span>
          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">we know that the first item item</span>
          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">has been consumed; drop it and</span>
          <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">and go back around the loop</span>
          (loop (cdr items)))))))))

(void
   (thread (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> () (sleep (/ (random 10) 100)) (produce 1)))
   (thread (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> () (sleep (/ (random 10) 100)) (produce 2))))

(list (consume) (consume))
</pre>
</div>

<p>
ä¸€ä¸ªæ›´åŠ å¤æ‚çš„ä¾‹å­(å®˜æ–¹æ–‡æ¡£éƒ½å·²ç»æœ‰å¾ˆè¯¦ç»†çš„æ³¨é‡Šäº†,ç›´æ¥çœ‹ä»£ç å°±å¥½)
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(define/contract (produce x)
  (-&gt; any/c void?)
  (channel-put producer-chan x))

(define/contract (consume)
  (-&gt; any/c)
  (channel-get consumer-chan))

(define/contract (wait-at-least n)
  (-&gt; natural? void?)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">c</span> (make-channel))
  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">we send a new channel over to the</span>
  <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">main loop so that we can wait here</span>
  (channel-put wait-at-least-chan (cons n c))
  (channel-get c))


(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">producer-chan</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">consumer-chan</span> (make-channel))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">wait-at-least-chan</span> (make-channel))
(void
 (thread
  (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> ()
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([items '()]
               [total-items-seen 0]
               [waiters '()])
      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">instead of waiting on just production/</span>
      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">consumption now we wait to learn about</span>
      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">threads that want to wait for a certain</span>
      <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">number of elements to be reached</span>
      (apply
       sync
       (handle-evt
        producer-chan
        (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (i) (loop (cons i items)
                     (+ total-items-seen 1)
                     waiters)))
       (handle-evt
        (<span style="color: #F0DFAF; font-weight: bold;">if</span> (null? items)
            never-evt
            (channel-put-evt consumer-chan (car items)))
        (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (_) (loop (cdr items) total-items-seen waiters)))

       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">wait for threads that are interested</span>
       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">the number of items produced</span>
       (handle-evt
        wait-at-least-chan
        (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (waiter) (loop items total-items-seen (cons waiter waiters))))

       <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">for each thread that wants to wait,</span>
       (for/list ([waiter (in-list waiters)])
         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">we check to see if there has been enough</span>
         <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">production</span>
         (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
           [(&gt;= (car waiter) total-items-seen)
            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">if so, we send a mesage back on the channel</span>
            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">and continue the loop without that item</span>
            (handle-evt
             (channel-put-evt
              (cdr waiter)
              (void))
             (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> (_) (loop items total-items-seen (remove waiter waiters))))]
           [else
            <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">otherwise, we just ignore that one</span>
            never-evt])))))))


<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">an example (non-deterministic) interaction</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">thds</span>
  (for/list ([i (in-range 10)])
    (thread (<span style="color: #F0DFAF; font-weight: bold;">&#955;</span> ()
              (produce i)
              (wait-at-least 10)
              (display (format <span style="color: #CC9393;">"~a -&gt; ~a\n"</span> i (consume)))))))

(for ([thd (in-list thds)])
  (thread-wait thd))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9f2bfec" class="outline-3">
<h3 id="org9f2bfec">19 Performance</h3>
<div class="outline-text-3" id="text-org9f2bfec">
</div>
<div id="outline-container-orga966c27" class="outline-4">
<h4 id="orga966c27">Performance in DrRacket</h4>
<div class="outline-text-4" id="text-orga966c27">
<p>
å…³äºå¦‚ä½•æ­£ç¡®ä½¿ç”¨ Racket æä¾›çš„å·¥å…·.
</p>

<p>
<code>DrRacket</code> çš„å¾ˆå¤šåŠŸèƒ½,åŒ…æ‹¬,è°ƒè¯•å™¨(<code>debugger</code>)å’Œæ ˆè·Ÿè¸ª(<code>stacktrace</code>)çš„ä¼šå½±å“æ€§èƒ½.
</p>

<p>
æŠŠåœ¨ä¸¤ä¸ªç¦ç”¨åæ€§èƒ½ä¼šæ¯”è¾ƒæ¥è¿‘åŸæœ¬çš„ <code>racket</code> å‘½ä»¤è¡Œ.
</p>

<p>
<code>racket</code> å’Œ <code>DrRacket</code> éƒ½æ˜¯ç”¨åŒä¸€ä¸ª <code>Racket virtual machine</code> ,
</p>

<p>
æ‰€ä»¥åœ¨ <code>DrRacket</code> è¿è¡Œç¨‹åºæ—¶å€™,åƒåœ¾å›æ”¶æ¬¡æ•°ä¼šæ¯”ç›´æ¥åœ¨ <code>racket</code> è¿è¡Œæ—¶çš„å›æ”¶æ¬¡æ•°è¦å¤š,
</p>

<p>
å¹¶ä¸” <code>Racket</code> ä¼šé˜»æ­¢å’Œå»¶è¿Ÿçº¿ç¨‹çš„æ‰§è¡Œ,ä¸ºäº†å¯é çš„ç»“æœåº”è¯¥é‡‡ç”¨ <code>racket</code> å‘½ä»¤è¡Œéƒ¨ç½².
</p>

<p>
è¿˜æœ‰å°±æ˜¯ä½¿ç”¨ <code>non-interactive</code> æ¨¡å¼ä»æ¨¡å—ç³»ç»Ÿä¸­è·ç›Š,è€Œä¸æ˜¯ä½¿ç”¨ <code>REPL</code> .
</p>
</div>
</div>

<div id="outline-container-org97a51f3" class="outline-4">
<h4 id="org97a51f3">The Bytecode and Just-in-Time (JIT) Compilers</h4>
<div class="outline-text-4" id="text-org97a51f3">
<p>
<code>Racket</code> çš„æ¯ä¸€æ ·èƒ½å¤Ÿè¿è¡Œçš„å®šä¹‰æˆ–è€…è¡¨è¾¾å¼éƒ½å¯ä»¥è¢«ç¼–è¯‘æˆå†…éƒ¨çš„å­—èŠ‚ç æ ¼å¼.
</p>

<p>
åœ¨ <code>interactive</code> æ¨¡å¼ä¸­,ç¼–è¯‘(compilation)ä¼šè‡ªåŠ¨å¯ç”¨å¹¶ä¸”ä¸é—´æ–­åœ°æ‰§è¡Œ(on-the-fly).
</p>

<p>
<code>raco make</code> å’Œ <code>raco setup</code> å‘½ä»¤å¯ä»¥æŠŠå­—èŠ‚ç ç¼–è¯‘æˆæ–‡ä»¶,è¿™ä¹ˆè¿è¡Œç¨‹åºçš„æ—¶å€™å°±ä¸éœ€è¦æ¯æ¬¡éƒ½ç¼–è¯‘äº†.
</p>

<p>
äº‹å®ä¸Šå¤§éƒ¨ä»½éœ€è¦ç¼–è¯‘çš„éƒ½æ˜¯åœ¨å®å±•å¼€(macro expansion)çš„æ—¶å€™,ä»å®Œå…¨å±•å¼€çš„ä»£ç ä¸­ç”Ÿæˆå­—èŠ‚ç æ—¶ç›¸å½“å¿«çš„.
</p>

<p>
å­—èŠ‚ç¼–è¯‘å™¨ä¼šä½¿ç”¨æ‰€æœ‰æ ‡å‡†çš„ä¼˜åŒ–,æ¯”å¦‚å¸¸é‡ä¼ æ’­(constant propagation),å¸¸é‡æŠ˜å (constant folding),
</p>

<p>
å†…è”(inline)å’Œæ­»ä»£ç æ¶ˆé™¤(dead-code elimination):
</p>

<ul class="org-ul">
<li>å¸¸é‡ä¼ æ’­å°±æ˜¯èƒ½å¤Ÿè®¡ç®—å‡ºç»“æœçš„å˜é‡æ›¿æ¢ä¸ºå¸¸é‡;</li>

<li>å¸¸é‡æŠ˜å å°±æ˜¯åœ¨å¤šä¸ªå˜é‡è¿›è¡Œè®¡ç®—å¹¶ä¸”èƒ½å¤Ÿè®¡ç®—å‡ºçš„æ—¶å€™,æŠŠç»“æœæ›¿æ¢ä¸ºå¸¸é‡.</li>

<li>å†…è”å°±æ˜¯å‡½æ•°è°ƒç”¨å˜æˆå‡½æ•°çš„å®šä¹‰å†…åµŒ,æœ‰ç‚¹åƒ <code>macro</code> å±•å¼€.</li>

<li>æ­»ä»£ç æ¶ˆé™¤å°±æ˜¯æŠŠä¸å¯èƒ½è¿è¡Œåˆ°çš„ä»£ç æ¶ˆé™¤æ‰.</li>
</ul>


<p>
åœ¨ä¸€äº›å¹³å°ä¸Šé¢è¿˜ä¼šä½¿ç”¨ <code>JIT(just-in-time)</code> ç¼–è¯‘å™¨æŠŠå­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç (native code).
</p>

<p>
<code>JIT</code> ç¼–è¯‘å™¨å¤§é‡çš„åŠ é€Ÿäº†ç¨‹åºæ‰§è¡Œå¯†é›†å¾ªç¯(tight loops),å°çš„æ•´æ•°å’Œä¸ç²¾ç¡®å®æ•°çš„è¿ç®—.
</p>

<p>
å¯ä»¥é€šè¿‡ <code>eval-jit-enabled</code> form æˆ–è€… <code>--no-jit/-j</code>  racketå‘½ä»¤å‚æ•°ç¦ç”¨ <code>JIT</code> ç¼–è¯‘å™¨.
</p>


<p>
éšç€å‡½æ•°è°ƒç”¨å¢å¤š, <code>JIT</code> ç¼–è¯‘å™¨çš„å·¥ä½œé‡ä¹Ÿä¼šå¢å¤š,ä¸è¿‡å½“ç¼–è¯‘å‡½æ•°çš„æ—¶å€™ <code>JIT</code> ç¼–è¯‘å™¨ä¼šæœ‰é™çš„è¿è¡Œæ—¶ä¿¡æ¯(run-time information),
</p>

<p>
ä¹Ÿå°±æ˜¯ä½¿ç”¨æœ‰é™èµ„æº,å› ä¸ºæ¨¡å—ä½“(module body)çš„ä»£ç æˆ–è€… <code>lambda</code> æŠ½è±¡åªä¼šç¼–è¯‘ä¸€æ¬¡.
</p>

<p>
<code>JIT</code> ç¼–è¯‘å™¨çš„ç¼–è¯‘ç²’åº¦(granularity of compilation)æ˜¯å‡½æ•°ä½“(a single procedure body),ä¸ç®—è¯æ³•åµŒå¥—å‡½æ•°.
</p>

<p>
<code>JIT</code> ç¼–è¯‘çš„å¼€é”€(overhead)å¾ˆå°æ‰€ä»¥å¾ˆéš¾æ£€æµ‹åˆ°.
</p>
</div>
</div>

<div id="outline-container-org5bea670" class="outline-4">
<h4 id="org5bea670">Modules and Performance</h4>
<div class="outline-text-4" id="text-org5bea670">
<p>
æ¨¡å—ç³»ç»Ÿ(module system)é€šè¿‡ä¿è¯æ ‡è¯†ç¬¦æœ‰æ­£å¸¸ç»‘å®šæ¥ååŠ©ä¼˜åŒ–.
</p>

<p>
æ¯”å¦‚, <code>racket/base</code> æä¾›çš„ <code>+</code> ä¼šè¢«ç¼–è¯‘å™¨è¯†åˆ«å¹¶ä¸”è¢«å†…è”.ç›¸å,åœ¨ä¼ ç»Ÿçš„äº¤äº’(interactive) <code>Scheme</code> ç³»ç»Ÿé‡Œ,
</p>

<p>
<code>top-level</code> çš„ <code>+</code> ç»‘å®šå¯èƒ½ä¼šè¢«é‡å®šä¹‰,å› æ­¤ç¼–è¯‘å™¨ä¸èƒ½è®¤ä¸ºå®ƒæ˜¯åŸæ¥(å›ºå®š)çš„ <code>+</code> .
</p>

<p>
åœ¨ <code>top-level</code> ç¯å¢ƒé‡Œé¢é€šè¿‡ <code>require</code> å°±å¯ä»¥å¯ç”¨ä¸€äº›å†…è”ä¼˜åŒ–.
</p>

<p>
åœ¨æ¨¡å—é‡Œé¢,å†…è”å’Œå¸¸é‡ä¼ æ’­ä¼˜åŒ–å……åˆ†åˆ©ç”¨äº†"å¦‚æœç¼–è¯‘æ—¶æ¨¡å—æ²¡æœ‰ <code>set!</code> æ“ä½œ,æ¨¡å—é‡Œçš„å®šä¹‰å°±ä¸ä¼šè¢«ä¿®æ”¹"è¿™ä¸€ä¸ªç‰¹ç‚¹.
</p>

<p>
åœ¨ <code>top-level</code> ç¯å¢ƒè¿™äº›ä¼˜åŒ–æ˜¯ä¸æ”¯æŒçš„.
</p>

<p>
å³ä½¿åšå‡ºäº†ä¼˜åŒ–,ä½†æ˜¯å®ƒä¹Ÿé˜²ç¢äº†äº¤äº’å¼çš„å¼€å‘å’Œæ¢ç´¢,æ¯”å¦‚æ¨¡å—ä¸èƒ½é‡æ–°å®šä¹‰ <code>module</code> ,ä¸è¿‡å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>compile-enforce-module-constants</code> ç¦ç”¨ <code>JIT</code> ç¼–è¯‘å™¨çš„è¿™ä¸€ç‰¹æ€§.
</p>

<p>
ç¼–è¯‘å™¨å¯èƒ½ä¼šåœ¨æ¨¡å—è¾¹ç•Œä¸­å†…è”å‡½æ•°æˆ–è€…ä¼ æ’­å¸¸é‡.ä¸ºäº†é¿å…å› ä¸ºå‡½æ•°å†…è”è€Œäº§ç”Ÿå¤ªå¤šä»£ç ,ç¼–è¯‘å™¨ä¼šåœ¨é€‰æ‹©å‡½æ•°è¿›è¡Œè·¨æ¨¡å—å†…è”(cross-module)çš„æ—¶å€™å˜å¾—ä¿å®ˆ.ä¸‹é¢å°èŠ‚ä¼šè¯´.
</p>
</div>
</div>

<div id="outline-container-org4adeef0" class="outline-4">
<h4 id="org4adeef0">Function-Call Optimizations</h4>
<div class="outline-text-4" id="text-org4adeef0">
<p>
å½“ç¼–è¯‘å™¨æ£€æµ‹åˆ°ä¸€ä¸ªå¯¹ä¸€ä¸ªå¯è§å‡½æ•°è¿›è¡Œè°ƒç”¨,å®ƒå°±ä¼šç”Ÿæˆæ›´åŠ æœ‰æ•ˆç‡çš„ä»£ç è€Œä¸æ˜¯ä¸€èˆ¬çš„è°ƒç”¨,ç‰¹åˆ«æ˜¯å°¾é€’å½’.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">letrec</span> ([odd (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x)
                (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
                    #f
                    (even (sub1 x))))]
         [even (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x)
                 (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
                     #t
                     (odd (sub1 x))))])
  (odd 40000000))
</pre>
</div>

<p>
ç¼–è¯‘å™¨ä¼šæ£€æµ‹åˆ° <code>odd-even</code> çš„å¾ªç¯å¹¶ä¸”é€šè¿‡å±•å¼€å¾ªç¯å’Œç›¸å…³ä¼˜åŒ–çš„æ–¹å¼äº§ç”Ÿå¯ä»¥è¿è¡Œçš„æ›´å¿«çš„ä»£ç .
</p>

<p>
å¦‚æœåœ¨åŒä¸€ä¸ªæ¨¡å—å†…åˆ†åˆ«å®šä¹‰ <code>odd</code> å’Œ <code>even</code>, å¦‚ä¸‹
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">mod.rkt</span>
#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">odd</span> x)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
      #f
      (even (sub1 x))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">even</span> x)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
      #t
      (odd (sub1 x))))

(odd 40000000)
</pre>
</div>

<p>
åœ¨åŒä¸€æ¨¡å—å†…å®šä¹‰çš„å˜é‡å°±åƒåœ¨ <code>letrec</code> ä¸€æ ·çš„è¯æ³•ä½œç”¨åŸŸä¸€æ ·,ä¸€ä¸ªæ¨¡å—å†…çš„å®šä¹‰å…è®¸è°ƒç”¨ä¼˜åŒ–,æ‰€ä»¥ä¸Šé¢ä¸¤ä¸ªä¾‹å­çš„æ€§èƒ½æ˜¯ä¸€æ ·çš„.
</p>

<p>
å¯¹äºæœ‰å…³é”®è¯(keyword)å‚æ•°çš„å‡½æ•°è°ƒç”¨,ç¼–è¯‘å™¨ä¼šæ£€æŸ¥é™æ€åœ°å…³é”®è¯å‚æ•°ç„¶åäº§ç”Ÿä¸€ä¸ªæ— å…³é”®è¯(non-keyword)çš„å˜ç§å‡½æ•°è¿›è¡Œè°ƒç”¨,è¿™æ ·å¯ä»¥å‡å°‘è¿è¡Œæ—¶çš„æ£€æµ‹å…³é”®è¯çš„å¼€é”€.
</p>

<p>
è¿™ä¸ªä¼˜åŒ–åªä¼šå¼•ç”¨äºé€šè¿‡ <code>define</code> ç»‘å®šçš„ <code>keyword-accepting</code> å‡½æ•°.
</p>

<p>
å¦‚æœè°ƒç”¨çš„å‡½æ•°è¶³å¤Ÿå°,ç¼–è¯‘å™¨ä¼šé€šè¿‡æŠŠæ›¿æ¢è°ƒç”¨çš„å‡½æ•°ä½“æ¥å†…è”å‡½æ•°.
</p>

<p>
é™¤äº†ç›®æ ‡å‡½æ•°ä½“çš„å¤§å°ä»¥å¤–,ç¼–è¯‘å™¨çš„ç­–ç•¥(heuristics)ä¼šè€ƒè™‘(take into)è°ƒç”¨ä½ç½®çš„å·²æ‰§è¡Œå†…è”æ•°é‡,ä¸ç®¡è¢«è°ƒç”¨çš„å‡½æ•°è‡ªå·±æ˜¯å¦è°ƒç”¨å‡½æ•°è€Œä¸æ˜¯ç®€å•çš„åŸç”Ÿçš„(<code>primitive</code>)æ“ä½œ.
</p>

<p>
å½“ç¼–è¯‘æ¨¡å—çš„æ—¶å€™,å®šä¹‰åœ¨ <code>module level</code> çš„å‡½æ•°æ‰ä¼šè¢«è€ƒè™‘å†…è”åˆ°å…¶å®ƒæ¨¡å—;ä¸€èˆ¬æ¥è¯´,åªæœ‰çç¢çš„(trivial)å‡½æ•°æ‰ä¼šè¢«è€ƒè™‘è·¨æ¨¡å—å†…è”,
</p>

<p>
ä¸è¿‡ç¨‹åºå‘˜å¯ä»¥ç”¨ <code>begin-encourage-inline</code> åŒ…è£¹ä¸€ä¸ªå‡½æ•°çš„å®šä¹‰æ¥ä¿ƒè¿›å‡½æ•°çš„å†…è”.
</p>

<p>
åƒ <code>pair?, car?</code> å’Œ <code>cdr</code> çš„åŸç”Ÿæ“ä½œæ˜¯è¢« <code>JIT</code> ç¼–è¯‘å™¨å†…è”åœ¨ <code>machine-code level</code> .
</p>
</div>
</div>

<div id="outline-container-orga2361bd" class="outline-4">
<h4 id="orga2361bd">Mutation and Performance</h4>
<div class="outline-text-4" id="text-orga2361bd">
<p>
ç”¨ <code>set!</code> ä¿®æ”¹ä¸€ä¸ªå˜é‡ä¼šé™ä½æ€§èƒ½.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket/base

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">subtract-one-set!</span> x)
  (set! x (sub1 x))
  x)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">subtract-one-without-set!</span> x)
  (sub1 x))

(time
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([n 4000000])
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? n)
        'done
        (loop (subtract-one-set! n)))))


(time
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([n 4000000])
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? n)
        'done
        (loop (subtract-one-without-set! n)))))
</pre>
</div>

<p>
è¿è¡Œåç»“æœæ˜¯æ²¡æœ‰ <code>set!</code> çš„ <code>subtract-one-without-set!</code> å›ä¼šå¿«ä¸€ç‚¹,
</p>

<p>
å› ä¸º <code>subtract-one-set!</code> ä¼šåœ¨æ¯ä¸€æ¬¡è¿­ä»£çš„æ—¶å€™ä¸º <code>x</code> åˆ†é…ä¸€ä¸ªæ–°çš„ä½ç½®,è¿™å¯¼è‡´äº†æ€§èƒ½ä¸å¥½.
</p>

<p>
ä¸€ä¸ªèªæ˜çš„ç¼–è¯‘å™¨ä¼šå–æ¶ˆ(unravel) <code>subtract-one-set!</code> é‡Œé¢ <code>set!</code> çš„ä½¿ç”¨,ä¸è¿‡ä¿®æ”¹(mutation)æ˜¯ä¸é¼“åŠ±çš„åšæ³•.
</p>

<p>
é™¤æ­¤ä»¥å¤–,ä¿®æ”¹ä¼šåœ¨å†…è”å’Œå¸¸é‡ä¼ æ’­æ¨¡ç³Šçš„æ—¶å€™(obscure)ç»‘å®š.
</p>
</div>
</div>

<div id="outline-container-org3fa0fec" class="outline-4">
<h4 id="org3fa0fec">letrec Performance</h4>
<div class="outline-text-4" id="text-org3fa0fec">
<p>
<code>letrec</code> å¯ä»¥ç”¨æ¥è¯æ³•ç»‘å®šå‡½æ•°å’Œå˜é‡,ç¼–è¯‘å™¨ä¼šä»¥æœ€ä¼˜çš„æ–¹å¼å¯¹å¾…è¿™äº›ç»‘å®š.
</p>

<p>
ç„¶è€Œ,å½“å…¶å®ƒç±»å‹çš„ç»‘å®šäºå‡½æ•°ç»‘å®šæ··åˆåœ¨ä¸€èµ·çš„æ—¶å€™,ç¼–è¯‘å™¨å°±éš¾ä»¥ç¡®å®šæ§åˆ¶æµ(control flow).
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20302;&#25928;&#29256;&#26412;</span>
<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#32534;&#35793;&#22120;&#24456;&#21487;&#33021;&#19981;&#30693;&#36947;display&#19981;&#20250;&#35843;&#29992;loop.</span>
<span style="color: #7F9F7F;">&#22914;&#26524;&#35843;&#29992;&#20102;loop,&#37027;&#20040;loop&#26377;&#21487;&#33021;&#22312;&#32465;&#23450;&#21487;&#29992;&#20043;&#21069;&#24341;&#29992;next.</span>
<span style="color: #7F9F7F;">|#</span>
(<span style="color: #F0DFAF; font-weight: bold;">letrec</span> ([loop (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x)
                (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
                    'done
                    (loop (next x))))]
         [junk (display loop)]
         [next (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) (sub1 x))])
  (loop 40000000))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#39640;&#25928;&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">letrec</span> ([loop (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x)
                (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? x)
                    'done
                    (loop (next x))))]
         [next (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) (sub1 x))])
  (loop 40000000))
</pre>
</div>

<p>
è¿™ä¸ª <code>letrec</code> çš„è­¦å‘Š(caveat)åŒæ ·é€‚ç”¨äº(ä¸ç®¡æ˜¯å¦åœ¨æ¨¡å—å†…çš„)å‡½æ•°çš„å®šä¹‰å’Œä½œä¸ºå¸¸é‡çš„å†…éƒ¨å®šä¹‰.
</p>

<p>
æ¨¡å—ä½“çš„å®šä¹‰æ¬¡åºç±»ä¼¼äº <code>letrec</code> çš„ç»‘å®šæ¬¡åº,å¹¶ä¸”æ¨¡å—ä½“å†…çš„éå¸¸é‡è¡¨è¾¾å¼ä¼šå¹²æ¶‰(interfere)ä¹‹åç»‘å®šçš„ä¼˜åŒ–.
</p>
</div>
</div>

<div id="outline-container-orgcc996dd" class="outline-4">
<h4 id="orgcc996dd">Fixnum and Flonum Optimizations</h4>
<div class="outline-text-4" id="text-orgcc996dd">
<p>
<code>Fixnum</code> æ˜¯å°çš„ç²¾ç¡®æ•´æ•°."å°"å–å†³äºå¹³å°.åœ¨32ä½æœºå™¨ä¸Š,æ•°å­—å¯ä»¥ç”¨30ä½åŠ ä¸Šä¸€ä¸ªæ ‡è®°(sign)ä½è¡¨ç¤º <code>fixnums</code> ;åœ¨64ä½æœºå™¨ä¸Š,åˆ™æ˜¯62ä½åŠ ä¸Šä¸€ä¸ªæ ‡è®°ä½.
</p>

<p>
<code>Flonum</code> ç”¨æ‰€æœ‰éç²¾ç¡®æ•°.åœ¨æ‰€æœ‰å¹³å°ä¸Šéƒ½å¯¹åº”64ä½çš„IEEEæ ‡å‡†æµ®ç‚¹æ•°.
</p>

<p>
å†…è” <code>fixnum</code> å’Œ <code>flonum</code> è¿ç®—æ“ä½œæ˜¯ <code>JIT</code> ç¼–è¯‘å™¨é‡è¦çš„ä¼˜åŠ¿ä¹‹ä¸€.æ¯”å¦‚ <code>+</code> çš„å‚æ•°éƒ½æ˜¯ <code>fixnums</code> æˆ–è€…éƒ½æ˜¯ <code>flonums</code> åˆ™ç›´æ¥ç”¨æœºå™¨çš„è¿ç®—æ“ä½œ.
</p>

<p>
<code>Flonums</code> é€šå¸¸è¢«ç§°ä¸º <code>boxed</code> ,å®ƒçš„æ„æ€æ˜¯åˆ†é…å†…å­˜å»å­˜æ”¾æ¯ä¸ª <code>flonum</code> è®¡ç®—çš„ç»“æœ.
</p>

<p>
å¹¸å¥½æ–°ä¸€ä»£çš„åƒåœ¾å›æ”¶å™¨(generational garbage collector)ä¼šè®©é‚£äº›ç»™ <code>short-lived</code> ç»“æœçš„åˆ†é…å˜å¾—åˆç†ä¾¿å®œ.
</p>

<p>
ç›¸å <code>fixnums</code> ç»å¯¹ä¸æ˜¯ <code>boxed</code> çš„,æ‰€ä»¥å¯ä»¥æ­£å¸¸ä½¿ç”¨.
</p>

<p>
<code>racket/flonum</code> åº“æä¾›ç‰¹å®šçš„ <code>flonum</code> æ“ä½œå’Œ <code>flonum</code> æ“ä½œçš„ç»„åˆ(combinations)æ¥å…è®¸ <code>JIT</code> ç¼–è¯‘å™¨ç”Ÿæˆå¯ä»¥é¿å… <code>boxing</code> å’Œ <code>unboxing</code> ä¸­é—´ç»“æœçš„ä»£ç .
</p>

<p>
é™¤äº†å½“å‰ç»„åˆé‡Œé¢çš„ç»“æœå¤–,ç”¨ <code>let</code> ç»‘å®šå¹¶ä¸”è¢«ä¹‹å <code>flonum-specific</code> æ“ä½œæ¶ˆè€—çš„  <code>flonum-specific</code> ç»“æœä¼šåœ¨ä¸´æ—¶å‚¨å­˜é‡Œé¢ <code>unboxed</code> .
</p>

<p>
æœ€åç¼–è¯‘å™¨ä¼šæ£€æµ‹åˆ°ä¸€äº› <code>flonum-valued</code> å¾ªç¯ç´¯åŠ å™¨ (<code>flonum-valued loop accmulators</code>)å¹¶ä¸”é¿å…ç´¯åŠ å™¨çš„ <code>boxing</code> .
</p>

<p>
å­—èŠ‚ç åç¼–è¯‘å™¨å™¨(<code>the bytecode decompiler</code>)ä¼šç”¨ <code>%flonum, #%as-flonum å’Œ #%from-flonum</code> æ ‡è®° <code>JIT</code> å¯ä»¥é¿å… <code>boxes</code> ç»„åˆçš„åœ°æ–¹.
</p>


<p>
<code>racket/unsafe/ops</code> åº“æä¾› <code>unchecked fixnum- å’Œ flonum-specific</code> æ“ä½œ.
</p>

<p>
<code>Unchecked flonum-specific</code> æ“ä½œå…è®¸ <code>unboxing</code> å’Œæœ‰æ—¶å€™å…è®¸ç¼–è¯‘å™¨é‡æ’(reorder)è¡¨è¾¾å¼æ¥æé«˜æ€§èƒ½.
</p>
</div>
</div>

<div id="outline-container-org298326f" class="outline-4">
<h4 id="org298326f">Unchecked, Unsafe Operations</h4>
<div class="outline-text-4" id="text-org298326f">
<p>
<code>racket/unsafe/ops</code> æä¾›ç±»ä¼¼äº <code>racket/base</code> æä¾›çš„å‡½æ•°,è¿™äº›å‡½æ•°è®¤ä¸º(ä¸æ˜¯æ£€æŸ¥)è¾“å…¥çš„å‚æ•°çš„ç±»å‹æ˜¯æ­£ç¡®çš„.
</p>

<p>
æ¯”å¦‚ <code>unsafe-vector-ref</code> å°±æ˜¯ <code>vector-ref</code> çš„ <code>unchecked</code> ç‰ˆæœ¬,æ ¹æ®ç´¢å¼•è®¿é—® <code>vector</code> çš„å…ƒç´ ,
</p>

<p>
ç„¶è€Œ <code>unsafe-vector-ref</code> ä¸ä¼šæ£€æŸ¥ç´¢å¼•æ˜¯å¦åœ¨è®¿é—®çš„ <code>vector</code> çš„è¾¹ç•Œå†….
</p>

<p>
åœ¨å¯†é›†å‹çš„å¾ªç¯é‡Œé¢ä½¿ç”¨ <code>unchecked</code> ç‰ˆæœ¬çš„å‡½æ•°å¯ä»¥æé«˜è®¡ç®—é€Ÿåº¦,ä¸è¿‡ä¸åŒçš„ <code>unchecked</code> å‡½æ•°å’Œä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­æ•ˆæœä¸ä¸€æ ·.
</p>

<p>
å¦‚å®ƒçš„åå­—"unsafe"æ‰€è¯´,é”™è¯¯ä½¿ç”¨è¿™äº›å‡½æ•°ä¼šå¯¼è‡´å´©æºƒ(crashes)æˆ–è€…å†…å­˜æŸå(memory corruption).
</p>
</div>
</div>

<div id="outline-container-org65dee6d" class="outline-4">
<h4 id="org65dee6d">Foreign Pointers</h4>
<div class="outline-text-4" id="text-org65dee6d">
<p>
<code>ffi/unsafe</code> åº“æä¾›å‡½æ•°ç”¨æ¥ä¸å®‰å…¨çš„è¯»å†™ä»»æ„çš„æŒ‡é’ˆå€¼(pointer values).
</p>

<p>
<code>JIT</code> ä¼šè®¤è¯† <code>ptr-ref</code> å’Œ <code>ptr-set!</code> çš„ä½¿ç”¨,å®ƒä»¬çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä»¥ä¸‹å†…ç½®C types= ä¹‹ä¸€çš„ç›´æ¥å¼•ç”¨:
</p>

<p>
<code>_int8, _int16, _int32, _int64, _double, _float å’Œ _pointer</code> .
</p>

<p>
ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª <code>C</code> æŒ‡é’ˆ(pointer, not a byte string),ç„¶åæŒ‡é’ˆçš„è¯»å†™æ“ä½œå°†ä¼šåœ¨ç”Ÿæˆçš„ä»£ç é‡Œå†…è”æ‰§è¡Œ.
</p>

<p>
å­—èŠ‚ç ç¼–è¯‘å™¨ä¼šä¼˜åŒ–æ•´æ•°ç¼©å†™(integer abbreviation),æ¯”å¦‚ <code>_int32</code> ä¼šç¼©å†™æˆ <code>_int</code> ,åœ¨è·¨å¹³å°çš„æ—¶å€™å®ƒä»¬æ˜¯å¸¸é‡,å¹¶ä¸” <code>JIT</code> å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è®¿é—®è¿™äº› <code>C types</code> .
</p>

<p>
<code>_long æˆ–è€… _inptr</code> å½“å‰è¿˜ä¸èƒ½è¢« <code>JIT</code> è¯†åˆ«,å› ä¸ºå®ƒä»¬åœ¨è·¨å¹³å°åœ°æ—¶å€™ä¸æ˜¯å¸¸é‡. <code>_float å’Œ _double</code> å½“å‰ä¸æ˜¯ unboxing ä¼˜åŒ–çš„ä¸»é¢˜.
</p>
</div>
</div>

<div id="outline-container-orge813de8" class="outline-4">
<h4 id="orge813de8">Regular Expression Performance</h4>
<div class="outline-text-4" id="text-orge813de8">
<p>
å½“ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…å­—èŠ‚ä¸²æä¾›ç»™åƒ <code>regexp-match</code> çš„å‡½æ•°æ—¶å€™,å®ƒå°±ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ª <code>regexp</code> å€¼.
</p>

<p>
æœ€å¥½å…ˆç”¨ <code>regexp, byte-regexp, pregexp æˆ–è€… byte-pregexp</code> æŠŠå®ƒç¼–è¯‘æˆ <code>regexp</code> å†ä¼ å…¥ <code>regexp-match</code> .
</p>

<p>
å¦‚æœæ˜¯å¸¸é‡å­—ç¬¦ä¸²æˆ–è€…å­—èŠ‚ä¸²,å¯ä»¥é€šè¿‡ <code>#rx</code> æˆ–è€… <code>#px</code> å‰ç¼€æ¥æ„å»º <code>regexp</code> å€¼.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">slow-matcher</span> str)
  (regexp-match? <span style="color: #CC9393;">"[0-9]+"</span> str))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">fast-matcher</span> str)
  (regexp-match? #rx<span style="color: #CC9393;">"[0-9]+"</span> str))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-slow-matcher</span> pattern-str)
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (str)
    (regexp-match? pattern-str str)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">make-fast-matcher</span> pattern-str)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">pattern-rx</span> (regexp pattern-str))
  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (str)
    (regexp-match? pattern-rx str)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4c9476d" class="outline-4">
<h4 id="org4c9476d">Memory Management</h4>
<div class="outline-text-4" id="text-org4c9476d">
<p>
<code>Racket</code> æœ‰3ç§å˜ç§å®ç°: <code>3m, CGC å’Œ CS</code> .
</p>

<p>
<code>3m å’Œ CS</code> å˜ç§ä½¿ç”¨ä¸€ä¸ªç°ä»£,æ–°ä¸–ä»£(generational)åƒåœ¾å›æ”¶å™¨,è¿™ç§å›æ”¶å™¨å¯¹ short-lived å¯¹è±¡çš„åˆ†é…å˜å¾—ä¾¿å®œ.
</p>

<p>
<code>CGC</code> å˜ç§ä½¿ç”¨ä¸€ä¸ªä¿å®ˆçš„(conservative)åƒåœ¾å›æ”¶å™¨,è¿™ç§å›æ”¶å™¨ä»¥ä¸€ä¸ªç²¾ç¡®å’Œæœ‰é€Ÿåº¦ä¿è¯çš„è´¹ç”¨æ¥ä¸ <code>C</code> çš„äº¤äº’.
</p>

<p>
<code>3m</code> æ˜¯å½“å‰çš„æ ‡å‡†.
</p>

<p>
å³ä¾¿å†…å­˜åˆ†é…ä¾¿å®œåˆç†,ä½†æ˜¯é¿å…å¤§é‡åˆ†é…ä¼šå¿«æ›´å¤š.é—­åŒ…å†…æ˜¯ä¸€ä¸ªé¿å…åˆ†é…çš„å¥½åœ°æ–¹,å› ä¸ºå®ƒåŒ…å«è‡ªç”±å˜é‡.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([n 40000000] [prev-thunk (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () #f)])
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? n)
      (prev-thunk)
      (loop (sub1 n)
            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () n)))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#27599;&#27425;&#36845;&#20195;&#20026; n &#20998;&#37197;&#19968;&#20010;&#38381;&#21253;(closure),(lambda () n).</span>

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#32534;&#35793;&#22120;&#21487;&#20197;&#33258;&#21160;&#28040;&#38500;&#22823;&#37327;&#38381;&#21253;,&#19979;&#38754;&#36825;&#20010;&#20363;&#23376;&#20013;&#27809;&#26377;&#20026; prev-thunk &#21019;&#24314;&#36807;&#38381;&#21253;(&#23601;&#26159;&#22806;&#23618;let),</span>
<span style="color: #7F9F7F;">&#22240;&#20026;&#23427;&#30340;&#35843;&#29992;&#26159;&#21487;&#35265;,&#25152;&#20197;&#23427;&#26159;&#20869;&#23884;&#30340;.</span>
<span style="color: #7F9F7F;">|#</span>
(<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([n 40000000] [prev-val #f])
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([prev-thunk (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () n)])
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? n)
        prev-val
        (loop (sub1 n) (prev-thunk)))))

<span style="color: #7F9F7F;">#|</span>
<span style="color: #7F9F7F;">&#36825;&#20010;&#20363;&#23376;&#31867;&#20284;&#19978;&#38754;&#30340;&#20363;&#23376;,&#23450;&#20041; m-loop&#30340; let form &#30340;&#23637;&#24320;&#24335;&#28041;&#21450;&#20102;&#19968;&#20010;&#21253;&#21547; n &#30340;&#38381;&#21253;,</span>
<span style="color: #7F9F7F;">&#19981;&#36807;&#32534;&#35793;&#22120;&#20250;&#33258;&#21160;&#25226;&#38381;&#21253;&#36716;&#25442;&#28982;&#21518;&#25226;n&#20316;&#20026;&#21442;&#25968;&#20256;&#20837;.</span>
<span style="color: #7F9F7F;">|#</span>
(<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">n-loop</span> ([n 400000])
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? n)
      'done
      (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">m-loop</span> ([m 100])
        (<span style="color: #F0DFAF; font-weight: bold;">if</span> (zero? m)
            (n-loop (sub1 n))
            (m-loop (sub1 m))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org74d11c2" class="outline-4">
<h4 id="org74d11c2">Reachability and Garbage Collection</h4>
<div class="outline-text-4" id="text-org74d11c2">
<p>
æ€»çš„æ¥è¯´,å½“ <code>GC(garbage collector)</code> å¯ä»¥è¯æ˜æŸä¸ªå¯¹è±¡ä¸èƒ½ä»åˆ«çš„å€¼åˆ°è¾¾,é‚£ä¹ˆ <code>Racket</code> å°±ä¼šé‡æ–°ä½¿ç”¨(re-use)è¿™ä¸ªå‚¨å­˜å¯¹è±¡çš„ç©ºé—´.
</p>

<p>
<code>Reachability</code> æ˜¯ä¸€ä¸ªä½å±‚(low-level),æŠ½è±¡æ¦‚å¿µ(abstraction breaking concept,æ€ä¹ˆç¿»è¯‘),
</p>

<p>
å› æ­¤éœ€è¦ç†è§£å¾ˆå¤šå…³äºè¿è¡Œæ—¶ç³»ç»Ÿå¦‚ä½•ç²¾ç¡®åˆ¤æ–­å€¼æ˜¯å¦ä»å¯ä»¥å¦å¤–ä¸€ä¸ªå€¼å¯ä»¥åˆ°è¾¾(reachable)çš„å®ç°ç»†èŠ‚,
</p>

<p>
ç®€å•æ¥è¯´,å¦‚æœæœ‰ä¸€äº›æ“ä½œå¯ä»¥ä»å¦ä¸€ä¸ªå€¼Bæ¢å¤AåŸæœ¬çš„å€¼,é‚£ä¹ˆAå°±æ˜¯å¯ä»¥åˆ°è¾¾çš„.
</p>

<p>
<code>Racket</code> æä¾› <code>make-weak-box</code> å’Œ <code>weak-box-value</code> ,åˆ†åˆ«æ˜¯ <code>GC</code> ç‰¹åˆ«å¯¹å¾…çš„ç»“æ„ä½“çš„ <code>creator</code> å’Œ <code>accessor</code> .
</p>

<p>
<code>weak box</code> é‡Œé¢å¯¹è±¡ä¸èƒ½åˆ°è¾¾çš„æ—¶å€™, <code>weak-box-value</code> å°±ä¼šè¿”å› <code>#f</code> .
</p>

<p>
é™¤éåƒåœ¾å›æ”¶å‘ç”Ÿäº†,å¦åˆ™å³ä½¿å€¼ä¸å¯ä»¥åˆ°è¾¾, <code>weak box</code> é‡Œé¢çš„å€¼è¿˜ä¼šåœ¨.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(struct fish (weight color) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">f</span> (fish 7 'blue))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">b</span> (make-weak-box f))
(printf <span style="color: #CC9393;">"b has ~s\n"</span> (weak-box-value b)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; b has #(struct:fish 7 blue)</span>
(collect-garbage)
(printf <span style="color: #CC9393;">"b has ~s\n"</span> (weak-box-value b)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; b has #(struct:fish 7 blue)</span>

(set! f #t)                              <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#34429;&#28982; fish &#30340;&#20540;&#36824;&#22312;,&#20294;&#26159; f &#30340;&#20540;&#21464;&#20102;,&#19981;&#33021;&#20174; b &#24341;&#29992; fish &#20102;.</span>
(collect-garbage)
(printf <span style="color: #CC9393;">"b has ~s\n"</span> (weak-box-value b)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; b has #f</span>
</pre>
</div>

<p>
æ‰€æœ‰ <code>Racket</code> çš„å€¼ä¸€å®šéœ€è¦åˆ†é…å¹¶ä¸”å’Œ <code>fish</code> æœ‰ç€ç±»ä¼¼çš„è¡Œä¸º,é™¤äº†ä»¥ä¸‹å‡ ä¸ª:
</p>

<ul class="org-ul">
<li><code>Fixnum?</code> åœ¨æ— é¡»åˆ†é…çš„æƒ…å†µä¸‹å¯ç”¨çš„.</li>

<li><code>Procedures</code> ,å¯ä»¥è¢«ç¼–è¯‘å™¨çœ‹åˆ°çš„è°ƒç”¨åœ°å€(call sites)çš„å‡½æ•°ç»å¯¹ä¸éœ€è¦åˆ†é…ç©ºé—´(å› ä¸ºå†…è”,ä¹Ÿå°±æ˜¯è¯´å‡½æ•°è°ƒç”¨å¯è§çš„è¯å°±ä¼šå‘ç”Ÿå†…è”).å…¶å®ƒç±»å‹çš„å€¼ä¹Ÿä¸€æ ·.</li>

<li><code>Intered symbols</code> ,æ¯ä¸ªåœ°æ–¹åªä¼šåˆ†é…ä¸€æ¬¡å†…éƒ¨ç¬¦å·. <code>Racket</code> é‡Œé¢æœ‰ä¸€ç§è¡¨ç”¨æ¥è·Ÿè¸ªå®ƒä»¬çš„åˆ†é…,æ‰€ä»¥å®ƒä»¬ä¸å¯èƒ½ç§°ä¸ºåƒåœ¾.</li>

<li><code>Reachability</code> æ¥è¿‘ <code>CGC</code> å›æ”¶å™¨,ä¹Ÿå°±æ˜¯å¦‚æœå€¼å¯¹äºå›æ”¶å™¨æ¥è¯´æ˜¯å¯ä»¥åˆ°è¾¾çš„,é‚£ä¹ˆå°±æ˜¯å¯ä»¥åˆ°è¾¾,æ²¡æœ‰åˆ«çš„æ–¹å¼å¯ä»¥åˆ°è¾¾.</li>
</ul>
</div>
</div>

<div id="outline-container-orgea794ed" class="outline-4">
<h4 id="orgea794ed">Weak Boxes and Testing</h4>
<div class="outline-text-4" id="text-orgea794ed">
<p>
<code>weak boxes</code> ä¸€ä¸ªé‡è¦ç”¨æ³•å°±æ˜¯æ˜¯åˆ¤æ–­æœ‰æ²¡æœ‰é‡Šæ”¾é‚£äº›ä¸å†éœ€è¦çš„æ•°æ®çš„ç©ºé—´.
</p>

<p>
ä¸‹é¢ä¸¤ä¸ªä¾‹å­ä½œä¸ºå¯¹æ¯”,
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(struct fish (weight color) <span style="color: #DCDCCC; font-weight: bold;">#:transparent</span>)

(<span style="color: #F0DFAF; font-weight: bold;">let*</span> ([fishes (list (fish 8 'red)
                     (fish 7 'blue))]
       [wb (make-weak-box (list-ref fishes 0))])
  (collect-garbage)
  (printf <span style="color: #CC9393;">"still there? ~s\n"</span> (weak-box-value wb))) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; "still there? #f"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(<span style="color: #F0DFAF; font-weight: bold;">let*</span> ([fishes (list (fish 8 'red)
                     (fish 7 'blue))]
       [wb (make-weak-box (list-ref fishes 0))])
  (collect-garbage)
  (printf <span style="color: #CC9393;">"still there? ~s\n"</span> (weak-box-value wb)) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25171;&#21360; still there? #(struct:fish 8 red)</span>
  (printf <span style="color: #CC9393;">"fishes is ~s\n"</span> fishes))
</pre>
</div>

<p>
å·®åˆ«åœ¨äºç¬¬äºŒä¸ªä¾‹å­å¼•ç”¨äº†ä¸€æ¬¡ <code>fishes</code> ,åœ¨ç¬¬ä¸€ä¸ªä¾‹å­é‡Œé¢, <code>fishes</code> ä½†æ˜¯ä¸å¯ä»¥åˆ°è¾¾,å› ä¸ºè¢« <code>(collect-garbage)</code> å›æ”¶äº†.
</p>

<p>
ç¬¬äºŒä¸ªä¾‹å­æœ€åå¼•ç”¨å°±æ„æˆäº†ä¸€ä¸ªå¯¹ <code>fishes</code> å¼•ç”¨(constitutes),ä¿è¯äº† <code>fished</code> ä¸ä¼šè¢« <code>(collect-garbage)</code> å›æ”¶.
</p>
</div>
</div>

<div id="outline-container-org33458d5" class="outline-4">
<h4 id="org33458d5">Reducing Garbage Collection Pauses</h4>
<div class="outline-text-4" id="text-org33458d5">
<p>
<code>Racket</code> æœ‰ä¸¤ç§æ£€æµ‹å›æ”¶çš„æ–¹æ¡ˆ, <code>frequent minor collections å’Œ infrequent major collections</code> ,å‰è€…åªæ£€æµ‹æœ€è¿‘åˆ†é…çš„å¯¹è±¡,åè€…ä¼šé‡æ–°æ£€æµ‹æ‰€æœ‰å†…å­˜.
</p>

<p>
ä¸¤ç§æ–¹æ¡ˆçš„åœé¡¿æ—¶é—´ä¸ä¸€æ ·,å‰è€…ä¼šåœ¨ä¸€é˜µçŸ­æš‚åœé¡¿åé‡æ–°æ£€æµ‹,åè€…çš„åœé¡¿å°±å¾ˆé•¿.
</p>

<p>
å¯¹äºä¸€äº›åº”ç”¨æ¥è¯´, æ¯”å¦‚åŠ¨ç”»å’Œæ¸¸æˆ, <code>major collection</code> çš„é•¿æ—¶é—´é—´éš”æ˜¯ä¸èƒ½æ¥å—çš„.
</p>

<p>
ä¸ºäº†å‡å°‘è¿™ä¸ªé—´éš”, <code>Racket</code> çš„åƒåœ¾å›æ”¶å™¨æ”¯æŒå¢é‡åƒåœ¾å›æ”¶æ¨¡å¼(incremental garbage collection mode).
</p>

<p>
åœ¨è¿™ä¸ªæ¨¡å¼é‡Œé¢,å¯ä»¥åˆ©ç”¨ <code>minor collections</code> ä¸º(toward)ä¸‹ä¸€æ¬¡ <code>major collection</code> æ‰§è¡Œé¢å¤–çš„å·¥ä½œæ¥ç»™ <code>minor collections</code> å¢åŠ åœé¡¿æ—¶é—´(ç„¶è€Œè¿˜æ˜¯æ¯”è¾ƒçŸ­).
</p>

<p>
å¦‚æœä¸€åˆ‡éƒ½æ²¡æœ‰é—®é¢˜,é‚£ä¹ˆ <code>major collection</code> çš„å¤§éƒ¨ä»½å·¥ä½œéƒ½ä¼šè¢« <code>minor collection</code> åœ¨ <code>major collection</code> éœ€è¦æ—¶é—´å†…å®Œæˆ,æ‰€ä»¥ <code>major collection</code> çš„åœé¡¿å’Œ <code>minor collection</code> çš„ä¸€æ ·çŸ­.
</p>

<p>
æ€»çš„æ¥çœ‹,åœ¨è¿™ä¸ªæ¨¡å¼ä¸­ç¨‹åºä¼šè¿è¡Œæ›´æ…¢,å´æœ‰ç€æ›´ä¸ºä¸€è‡´çš„å®æ—¶è¡Œä¸º.
</p>

<p>
æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å¯ç”¨è¿™ä¸ªæ¨¡å¼:
</p>

<ol class="org-ol">
<li>åœ¨ç¨‹åºå¯åŠ¨ä¹‹å‰æŠŠç¯å¢ƒå˜é‡ <code>PLT_INCREMENTAL_GC</code> çš„å€¼è®¾å®šä¸ºä»¥ <code>1/y/Y</code> å¼€å¤´çš„å€¼.</li>

<li>å¯¹äºç‰¹å®šç¨‹åºæˆ–è€…ç¨‹åºçš„ç‰¹å®šéƒ¨åˆ†,å¯ä»¥ä½¿ç”¨ <code>(collect-garbage 'incremental)</code> å¯åŠ¨.</li>
</ol>

<p>
ç¬¬äºŒç§æ–¹æ³•ä¸ä¼šé©¬ä¸Šæ‰§è¡Œåƒåœ¾å›æ”¶,è€Œæ˜¯è¯·æ±‚æ¯æ¬¡ <code>minor collection</code> æ‰§è¡Œå¢é‡çš„å·¥ä½œç›´åˆ°ä¸‹ä¸€æ¬¡ <code>major collection</code> å‘ç”Ÿ.
</p>

<p>
è¯·æ±‚ä¼šåœ¨ä¸‹ä¸€æ¬¡ <code>major collection</code> ä¸­è¿‡æœŸ.åœ¨ç¨‹åºçš„ä»»ä½•ä¸€ä¸ªé‡å¤çš„ä»»åŠ¡ä¸­è°ƒç”¨ <code>(collect-garbage 'incremental)</code> éœ€è¦å®æ—¶å“åº”.
</p>

<p>
åœ¨åˆå§‹çš„ <code>(collect-garbage 'incremental)</code> è°ƒç”¨ <code>(collect-garbage)</code> å¼ºè¿«å‘ç”Ÿä¸€æ¬¡å…¨é¢å›æ”¶.
</p>

<p>
æ£€æŸ¥å¢é‡æ¨¡å¼æ˜¯å¦åœ¨ä½¿ç”¨å’Œå®ƒä½¿æ€ä¹ˆå½±å“åœé¡¿æ—¶é—´,å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤,
</p>

<div class="org-src-container">
<pre class="src src-sh">racket -W <span style="color: #CC9393;">"debug@GC error"</span> code.rkt
</pre>
</div>

<p>
è¾“å‡ºå¦‚ä¸‹,
</p>

<div class="org-src-container">
<pre class="src src-sh">GC: 0:min @ 1,483K(+148K)[+192K]; free 1,037K(-5,133K) 1ms @ 15
GC: 0:min @ 1,783K(+3,944K)[+216K]; free 585K(-1,881K) 1ms @ 19
GC: 0:min @ 4,180K(+3,579K)[+232K]; free 1,535K(-1,535K) 1ms @ 24
GC: 0:min @ 4,914K(+2,845K)[+236K]; free 1,164K(-6,556K) 3ms @ 31
GC: 0:min @ 7,572K(+6,059K)[+264K]; free 1,981K(-3,277K) 3ms @ 42
GC: 0:min @ 9,758K(+5,537K)[+304K]; free 2,423K(-3,719K) 3ms @ 50
GC: 0:min @ 12,838K(+4,121K)[+320K]; free 2,849K(-12,337K) 5ms @ 65
GC: 0:min @ 17,518K(+9,937K)[+336K]; free 4,292K(-9,684K) 4ms @ 83
GC: 0:min @ 20,980K(+11,867K)[+452K]; free 4,648K(-7,240K) 7ms @ 108
GC: 0:min @ 26,297K(+10,310K)[+928K]; free 5,760K(-8,352K) 9ms @ 145
GC: 0:min @ 32,428K(+6,771K)[+1,272K]; free 7,464K(-26,440K) 11ms @ 184
GC: 0:min @ 40,609K(+18,206K)[+1,684K]; free 9,757K(-13,645K) 16ms @ 236
GC: 0:MAJ @ 46,020K(+16,683K)[+2,404K]; free 18,156K(-18,156K) 34ms @ 304
GC: 0:MAJ @ 27,866K(+34,837K)[+2,404K]; free 9K(+4,726K) 46ms @ 338
GC: 0:atexit peak 46,020K; alloc 89,545K; major 2; minor 12; 144ms
</pre>
</div>

<p>
<code>min</code> è¡Œè¡¨ç¤º <code>minor collections</code> , <code>mIn</code> è¡Œè¡¨ç¤º <code>increment mode minor</code> , <code>MAJ</code> è¡Œè¡¨ç¤º <code>major collections</code> .
</p>
</div>
</div>
</div>

<div id="outline-container-org5e10185" class="outline-3">
<h3 id="org5e10185">20 Parallelism</h3>
<div class="outline-text-3" id="text-org5e10185">
<p>
<code>Racket</code> æä¾›ä¸¤ç§å¹¶è¡Œå½¢å¼: <code>futures</code> å’Œ <code>places</code> .åœ¨ä¸€ä¸ªæä¾›å¤šå¤„ç†å™¨çš„å¹³å°ä¸Š,å¹¶è¡Œå¯ä»¥æé«˜ä¸€ä¸ªç¨‹åºçš„è¿è¡Œæ—¶æ€§èƒ½.
</p>
</div>

<div id="outline-container-org65829ed" class="outline-4">
<h4 id="org65829ed">Parallelism with Futures</h4>
<div class="outline-text-4" id="text-org65829ed">
<p>
<code>racket/future</code> æä¾› <code>future</code> å’Œ <code>touch</code> å‡½æ•°,å¯ä»¥ç”¨äºå®ç°å¹¶è¡Œæé«˜æ€§èƒ½.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">any-double?</span> l)
  (for/or ([i (in-list l)])
    (for/or ([i2 (in-list l)])
      (= i2 (* 2 i)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">l1</span> (for/list ([i (in-range 5000)])
             (+ (* 2 i) 1)))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">l2</span> (for/list ([i (in-range 5000)])
             (- (* 2 i) 1)))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#25928;&#29575;&#24456;&#20302;</span>
(<span style="color: #F0DFAF; font-weight: bold;">or</span> (any-dobule? l1)
    (any-double? l2))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#24182;&#34892;&#36816;&#31639;,&#22312;&#22810;&#22788;&#29702;&#22120;&#30340;&#26426;&#22120;&#19978;&#30340;&#36816;&#34892;&#26102;&#38388;&#20250;&#20943;&#23569;&#19968;&#21322;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([f (future (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () (any-double? l2)))]) <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">&#25226;l2&#30340;&#36816;&#31639;&#23553;&#35013;&#25104;future</span>
  (<span style="color: #F0DFAF; font-weight: bold;">or</span> (any-double? l1)
      (touch f)))                                <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">touch&#21551;&#21160;future</span>
</pre>
</div>

<p>
åªè¦å¯ä»¥ä¿è¯ <code>future safe</code> <code>future</code> å¯ä»¥å¹¶è¡Œ, <code>future safe</code> å’Œ <code>future unsafe</code> ä¸æ˜¯é‚£ä¹ˆè¡¨é¢çš„æ¦‚å¿µ.
</p>

<p>
ä¸‹é¢é€šè¿‡ä½¿ç”¨ <code>future-visualizer</code> å’Œè®¡ç®—æ›¼å¾·å‹ƒæ´›ç‰¹é›†åˆ(Mandelbrot set)æ¥å±•ç¤ºå®ƒä»¬çš„åŒºåˆ«.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">mandelbrot</span> iterations x y n)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([ci (- (/ (* 2.0 y) n) 1.0)]
        [cr (- (/ (* 2.0 x) n) 1.5)])
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([i 0] [zr 0.0] [zi 0.0])
      (<span style="color: #F0DFAF; font-weight: bold;">if</span> (&gt; i iterations)
          i
          (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([zrq (* zr zr)]
                [ziq (* zi zi)])
            (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
              [(&gt; (+ zrq ziq) 4) i]
              [else (loop (add1 i)
                          (+ (- zrq ziq) cr)
                          (+ (* 2 zr zi) ci))]))))))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#38750;&#24120;&#24930;</span>
(list (mandelbrot 10000000 62 500 1000)
      (mandelbrot 10000000 62 501 1000))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">&#28982;&#32780;&#36825;&#27425;&#20351;&#29992; future &#24182;&#27809;&#26377;&#25552;&#39640;&#24615;&#33021;</span>
(<span style="color: #F0DFAF; font-weight: bold;">let</span> ([f (future (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () (mandelbrot 10000000 62 501 1000)))])
  (list (mandelbrot 10000000 62 500 1000)
        (touch f)))

<span style="color: #7F9F7F;">#| &#20351;&#29992;future-visualizer&#21487;&#35270;&#21270;</span>
<span style="color: #7F9F7F;">&#25191;&#34892;&#25171;&#24320;&#19968;&#20010;&#36319;&#36394;&#35745;&#31639;&#30340;&#22270;&#24418;&#35270;&#22270;,&#39030;&#37096;&#26102;&#25191;&#34892;timeline.</span>
<span style="color: #7F9F7F;">&#27599;&#19968;&#34892;&#20195;&#34920;&#36825;&#19968;&#20010;OS-level&#32447;&#31243;,&#39068;&#33394;&#28857;&#20195;&#34920;&#25191;&#34892;&#36807;&#31243;&#20013;&#37325;&#35201;&#30340;&#20107;&#24773;.</span>
<span style="color: #7F9F7F;">&#34013;&#33394;&#34920;&#31034;future&#21019;&#24314;&#30340;&#26102;&#38388;,&#32511;&#33394;&#26465;(green bar)&#34920;&#31034;future&#25191;&#34892;&#26102;&#38388;,&#32418;&#33394;&#28857;&#20195;&#34920;&#38459;&#22622;&#25805;&#20316;,&#27225;&#33394;&#28857;&#20195;&#34920;&#21516;&#27493;&#25805;&#20316;.</span>
<span style="color: #7F9F7F;">|#</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#36825;&#20010;&#20363;&#23376;&#20013;future&#21482;&#25191;&#34892;&#20102;&#19968;&#19979;&#23601;&#26242;&#20572;&#32473;&#36816;&#34892;&#26102;&#32447;&#31243;&#25191;&#34892;future-unsafe&#25805;&#20316;.</span>
(require future-visualizer)
(visualize-futures
 (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([f (future (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () (mandelbrot 10000000 62 501 1000)))])
   (list (mandelbrot 10000000 62 500 1000)
         (touch f))))
</pre>
</div>

<p>
åœ¨ <code>Racket</code> çš„å®ç°ä¸­, <code>future-unsafe</code> æ“ä½œåˆ†æˆä¸¤ç±»: é˜»å¡æ“ä½œ(blocking operation)å’ŒåŒæ­¥æ“ä½œ(synchronized operation).
</p>

<p>
ç›¸åŒçš„,ä¸¤è€…éƒ½ä¼šæš‚åœ(halt) <code>future</code> çš„è¿ç®—,
</p>

<p>
ä¸åŒåœ¨äºå‰è€…å¯ä»¥é€šè¿‡ <code>touch</code> è®©å®ƒç»§ç»­æ‰§è¡Œ,åœ¨ <code>touch</code> å†…çš„æ“ä½œå®Œæˆä¹‹å, <code>future</code> å‰©ä¸‹çš„å·¥ä½œå°±ä¼šè¢«è¿è¡Œæ—¶çº¿ç¨‹æ‰§è¡Œ;
</p>

<p>
è€Œåœ¨åè€…ä¸­,è¿è¡Œæ—¶çº¿ç¨‹å¯èƒ½ä¼šåœ¨ä»»ä½•ç‚¹(time end)æ‰§è¡Œæ“ä½œ,åªæœ‰æ“ä½œå®Œæˆå <code>future</code> æ‰ä¼šç»§ç»­å¹¶è¡Œè¿è¡Œ,å†…å­˜åˆ†é…å’Œ <code>JIT</code> ç¼–è¯‘å°±æ˜¯ä¸¤ä¸ªå¸¸è§çš„åŒæ­¥æ“ä½œä¾‹å­.
</p>

<p>
æŠŠé¼ æ ‡ç§»åŠ¨åˆ°ç‚¹ä¸Šå°±å¯ä»¥çœ‹åˆ°å¯¼è‡´é˜»å¡æˆ–è€…åŒæ­¥çš„æ“ä½œ,ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸ºä¸ç²¾ç¡®æ•°çš„å¤§é‡ä½¿ç”¨å¯¼è‡´é¢‘ç¹åˆ†é…å’Œ <code>*</code> æ“ä½œç¬¦å·é—®é¢˜.
</p>

<p>
ä¼˜åŒ–åå¦‚ä¸‹(è¿™ä¸ªç¨‹åºéœ€è¦ç”¨ <code>racket</code> è¿è¡Œæ‰æ˜¯çœŸæ­£çš„å¹¶è¡Œ),
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(require racket/flonum)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">mandelbrot</span> iterations x y n)
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([ci (fl- (fl/ (* 2.0 (-&gt;fl y)) (-&gt;fl n)) 1.0)]
        [cr (fl- (fl/ (* 2.0 (-&gt;fl x)) (-&gt;fl n)) 1.5)])
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #93E0E3;">loop</span> ([i 0] [zr 0.0] [zi 0.0])
      (<span style="color: #F0DFAF; font-weight: bold;">if</span> (&gt; i iterations)
          i
          (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([zrq (fl* zr zr)]
                [ziq (fl* zi zi)])
            (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
              [(fl&gt; (fl+ zrq ziq) 4.0) i]
              [else (loop (add1 i)
                          (fl+ (fl- zrq ziq) cr)
                          (fl+ (fl* 2.0 (fl* zr zi)) ci))]))))))

(require future-visualizer)
(visualize-futures
 (<span style="color: #F0DFAF; font-weight: bold;">let</span> ([f (future (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> () (mandelbrot 10000000 62 501 1000)))])
   (list (mandelbrot 10000000 62 500 1000)
         (touch f))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga7aada4" class="outline-4">
<h4 id="orga7aada4">Parallelism with Places</h4>
<div class="outline-text-4" id="text-orga7aada4">
<p>
<code>racket/place</code> åº“æä¾› <code>place</code> form æ¥å®ç°å¹¶è¡Œæé«˜æ€§èƒ½. <code>place</code> åˆ›å»ºä¸€ä¸ª <code>place</code> å¯¹è±¡,å°±æ˜¯å¹¶è¡Œç‰ˆçš„ <code>channel</code> .
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(provide main)

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">any-double?</span> l)
  (for/or ([i (in-list l)])
    (for/or ([i2 (in-list l)])
      (= i2 (* 2 i)))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">main</span>)
  (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">p</span>
    (place ch                           <span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">ch &#26159;&#32465;&#23450; place channel &#30340;&#26631;&#35782;&#31526;, place&#20307;&#23601;&#26159;&#19968;&#20010;&#26032; place,&#24182;&#19988;place&#20307;&#30340;&#34920;&#36798;&#24335;&#36890;&#36807; =ch= &#26469;&#21644;&#20854;&#23427; place &#20132;&#27969;.</span>
      (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">l</span> (place-channel-get ch))
      (<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">l-double?</span> (any-double? l))
      (place-channel-put ch l-double?)))

  (place-channel-put p (list 1 2 4 8))

  (place-channel-get p))
</pre>
</div>

<p>
<code>place form</code> æœ‰ä¸¤ä¸ªå¾®å¦™çš„ç‰¹æ€§.
</p>

<p>
ç¬¬ä¸€,å®ƒå°†placeä½“æå‡ä¸ºä¸€ä¸ªåŒ¿åçš„æ¨¡å—çº§çš„å‡½æ•°,è¿™æ„å‘³ç€placeä½“çš„å¼•ç”¨ä»»ä½•ç»‘å®šéƒ½å¿…é¡»åœ¨æ¨¡å—çš„ <code>top level</code> å¯ç”¨.
</p>

<p>
ç¬¬äºŒ, <code>place form</code> åœ¨æ–°åˆ›å»ºçš„ <code>place</code> åŠ¨æ€åŠ è½½(dynamic-require)é—­åˆæ¨¡å—,
</p>

<p>
ä½œä¸º <code>dynamic-require</code> çš„ä¸€éƒ¨åˆ†,å½“å‰æ¨¡å—ä½“ä¼šåœ¨æ–°çš„ <code>place</code> è¿ç®—.
</p>

<p>
ç¬¬äºŒä¸ªç‰¹æ€§çš„åæœæ˜¯, place ä¸åº”è¯¥ç›´æ¥å‡ºç°æ¨¡å—ä¸­æˆ–åœ¨æ¨¡å— <code>top-level</code> è°ƒç”¨çš„å‡½æ•°ä¸­,å¦åˆ™è°ƒç”¨æ¨¡å—å°†åœ¨ä¸€ä¸ªæ–° <code>place</code> ä¸­è°ƒç”¨ç›¸åŒçš„æ¨¡å—,
</p>

<p>
è¿™è§¦å‘ä¸€ç³»åˆ—çš„ place åˆ›å»ºè¡Œä¸ºä»è€Œå¾ˆå¿«è€—å°½å†…å­˜.
</p>
</div>
</div>

<div id="outline-container-org3e5f80e" class="outline-4">
<h4 id="org3e5f80e">Distributed Places</h4>
<div class="outline-text-4" id="text-org3e5f80e">
<p>
<code>racket/place/distributed</code> æä¾›åˆ†å¸ƒå¼ç¼–ç¨‹çš„æ”¯æŒ,ç›´æ¥çœ‹æ–‡æ¡£çš„ä¾‹å­,æ²¡ä»€ä¹ˆå¥½è®°å½•çš„.
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: saltb0rn (<a href="mailto:asche34@outlook.com">asche34@outlook.com</a>)</p>
<p class="date">Date: 2018-09-20</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.4.6)</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
