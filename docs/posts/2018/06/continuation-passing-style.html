<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-09-30 ÖÜËÄ 13:08 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Continuation Passing Style</title>
<meta name="generator" content="Org mode">
<meta name="author" content="saltb0rn">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"> -->
<meta name="referrer" content="same-origin">
<link rel="stylesheet" type="text/css" href="../../../css/stylesheet.css"/>
<link rel="icon" type="image/png" href="../../../img/icon.png" />
<!-- <script type="text/javascript" src="../../../js/live.js" defer></script> -->
<script src="../../../js/main.js" defer></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
    <nav>
        <a href="../../../"><img src="../../../img/logo.png" alt="Logo is on the way"/></a>
        <ul>
            <li><a accesskey="H" href="../../../"> Home </a></li>
            <li><a accesskey="T" href="../../../tags"> Tags </a></li>
            <li><a accesskey="A" href="../../../about"> About </a></li>
            <li><a accesskey="L" href="../../../todos"> Todos </a></li>
        </ul>
    </nav>
</div>
<div id="content">
<h1 class="title">Continuation Passing Style</h1>
<div class="abstract" id="orgc8020be">
<p>
å†™ä¸€å†™è‡ªå·±å¯¹ <code>CPS</code> çš„ç†è§£,ä¸ªäººç»å†æœ‰é™,éš¾å…ä¼šæœ‰é”™è¯¯æˆ–è€…è®¤è¯†ä¸å…¨,æ‰€ä»¥è¯·è§è°….
</p>

</div>

<pre class="example" id="orga3adfda">
æ›´æ–°äº 2018-11-12
</pre>

<div id="outline-container-orga0c351b" class="outline-2">
<h2 id="orga0c351b">å¶é‡ CPS</h2>
<div class="outline-text-2" id="text-orga0c351b">
<p>
æœ‰å¾ˆä¹…ä¸€æ®µæ—¶é—´æ²¡æœ‰å†™ <code>Python</code> äº†,è¯­æ³•è™½å¥½,ä¸è¿‡è¯­æ³•ç³–å®åœ¨å¤ªå¤š,æ–­æ–­ç»­ç»­çš„æ¥è§¦äº†ä¸€æ®µæ—¶é—´çš„ <code>Lisp</code>, ä»ä¸€å¼€å§‹çš„ <code>Common Lisp</code>,åˆ°ç°åœ¨çš„ <code>Emacs Lisp</code> å’Œ <code>Racket</code>,ç»è¿‡è¿™æ®µæ´—ç¤¼ä»¥å,æœ‰ä¸€ç§"ä¸å†™ <code>Python</code> äº†,å¹²è„†å†™ <code>Lisp</code> ä¸ºç”Ÿç®—äº†"çš„æƒ³æ³•(ä¸è¿‡æƒ³ç”Ÿæ´»çš„è¯,è¿˜æ˜¯å†™ <code>Python</code> é è°±ç‚¹,éƒ½å­¦å°±æœ€å¥½),æˆ‘ä¸æ˜¯ <code>Lisp</code> çš„ä½¼ä½¼è€…,ä¸è¿‡åº”è¯¥ä¹Ÿç®—æ˜¯ä¸ª <code>Lisp fanboy</code> äº†å§.
</p>

<p>
ä¹‹æ‰€ä»¥å­¦ <code>Lisp</code> æ˜¯å› ä¸ºå½“æ—¶çœ‹äº†ç‹å çš„åšå®¢è€Œæœ‰äº†æƒ³å»äº†è§£ <code>Programming Language</code> çš„æ¬²æœ›.åˆšå¥½å‰ä¸€æ®µæ—¶é—´å¤§æ¦‚çš„è¯»äº† <code>Semantics Engineering</code> å’Œ <code>EOPL 3rd</code>,å¯¹è¿™ä¸€å—æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£.ç›®å‰è¿˜åœ¨è¡¥ EOPL ä¸Šçš„ä¹ é¢˜,è¿™æœ¬ä¹¦ä¸Šæœ‰ä¸€ä¸ªæˆ‘æŒºæ„Ÿå…´è¶£çš„å†…å®¹,çœ‹åˆ°ç›®å½•ä¸Šæœ‰è¿™ä¸ªçš„æ—¶å€™æˆ‘å½“åœºå°±å…´å¥‹ä¸å·²,"ç»ˆäºæ‰¾åˆ°æœ‰è®²è¿™ä¸€å—çš„ä¹¦äº†","è¿™ä¸€å—"å°±æ˜¯ <code>Continuation Passing Style</code>,ç®€ç§° <code>CPS</code>.
</p>
</div>
</div>


<div id="outline-container-org8dcf350" class="outline-2">
<h2 id="org8dcf350">Continuation</h2>
<div class="outline-text-2" id="text-org8dcf350">
<p>
åœ¨è®²ä»€ä¹ˆæ˜¯ <code>CPS</code> ä¹‹å‰,å¾—å…ˆè¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯ <code>continuation</code>.
</p>

<p>
åœ¨ <code>Lisp</code> çš„æ–¹è¨€ä¹‹ä¸€ <code>Racket</code> çš„é‡Œé¢,å®ƒæ˜¯ä¸€ä¸ªç‰¹æ€§,è®°å½•ä¸‹è®¡ç®—è¿‡ç¨‹ä¸­çš„æŸä¸ªæ‰§è¡Œç‚¹çš„ä¸Šä¸‹æ–‡.
</p>

<p>
æ¥ä¸‹æ¥æˆ‘ä¼šç”¨ <code>Racket</code> æ¥è®²è§£,æ”¾å¿ƒ,æˆ‘ä¼šç®€å•åœ°è®²ä¸€ä¸‹è¦ç”¨åˆ°çš„ä¸€äº› <code>forms</code>,ä¸ä¼šçœŸçš„æ¶‰åŠåˆ° <code>Racket</code> çš„ <code>continuation</code> çš„å®é™…æ“ä½œ,åªæ˜¯è®²å®ƒçš„æ„åƒ.
</p>
</div>

<div id="outline-container-orgd182783" class="outline-3">
<h3 id="orgd182783">ç®€å•çš„ Lisp</h3>
<div class="outline-text-3" id="text-orgd182783">
<p>
<code>Racket</code> é‡Œé¢ä¸€èˆ¬æ˜¯è¿™æ ·å®šä¹‰å‡½æ•°çš„,ä»¥å®šä¹‰ä¸€ä¸ªå½¢å¼å‚æ•°ä¸º <code>a</code> å’Œ <code>b</code> çš„æ•´å‹åŠ æ³•å‡½æ•° <code>add</code> ,å’Œä¸€ä¸ªå‡æ³•å‡½æ•° <code>sub</code> ä¸ºä¾‹å­.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">add</span> a b) (+ a b))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">sub</span> a b) (- a b))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#20063;&#21487;&#20197;&#21033;&#29992;lambda&#34920;&#36798;&#24335;&#23450;&#20041;&#20989;&#25968;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(define add (lambda (a b) (+ a b)))</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">call it with 1 and 2, then returns 3 as the result</span>
(add 1 2)
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">call it with 3 and 2, then returns 1 as the result</span>
(sub 3 2)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">if condition then true-branch else false-branch</span>
(<span style="color: #F0DFAF; font-weight: bold;">if</span> (&gt; (sub 3 2) 0)
    (sub 3 2)
    (add 1 2))
</pre>
</div>

<p>
ä¸Šé¢æ³¨é‡Šçš„ <code>lambda</code> è¡¨è¾¾å¼ç»‘å®šç»™ <code>add</code> å‡½æ•°,è€Œ <code>lambda</code> è¡¨è¾¾å¼å°±åƒæ˜¯åŒ¿åå‡½æ•°,åæ˜ äº† <code>Racket</code> æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹.ç®€å•ç‚¹è¯´å°±æ˜¯è¿‡ç¨‹ä¸æ•°æ®æœ‰ç€åŒç­‰åœ°ä½,è¿™ä¸ªç‰¹æ€§åé¢ä¼šç”¨ä¸Š.
</p>

<p>
æ¥ä¸‹æ¥ç”¨ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­,å®šä¹‰ä¸€ä¸ªåä¸º <code>ans</code> çš„å‡½æ•°,æ¥æ”¶ä¸‰ä¸ªæ•´å‹å½¢å‚ <code>x,y,z</code> è¿”å›ç»“æœä¸º <code>(add (sub x y) z)</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">ans</span> x y z)
   (add (sub x y) z))
</pre>
</div>
</div>
</div>


<div id="outline-container-org69258b1" class="outline-3">
<h3 id="org69258b1">æ§åˆ¶ä¸Šä¸‹æ–‡(Control context)</h3>
<div class="outline-text-3" id="text-org69258b1">
<p>
å¥½äº†,ä»‹ç»ä»€ä¹ˆæ˜¯ <code>continuation</code> ä¹‹å‰å…ˆä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯æ§åˆ¶ä¸Šä¸‹æ–‡?é¦–å…ˆè¦å…ˆäº†è§£ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡,æ‰€è°“ä¸Šä¸‹æ–‡å°±æ˜¯è´¯ç©¿æ•´ä¸ªè¿‡ç¨‹çš„ä¸€ä¸ªæ„åƒ,åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­çš„æ¯ä¸€ä¸ªç‚¹ä¸Š,ä¸Šä¸‹æ–‡çš„çŠ¶æ€éƒ½ä¸ä¸€æ ·.
</p>

<p>
è€Œæ§åˆ¶ä¸Šä¸‹æ–‡å°±åƒ <code>stack</code>,å‡å¦‚è°ƒç”¨ <code>(ans 1 2 3)</code>,é‚£ä¹ˆä¼šå‘ç”Ÿä»¥ä¸‹å‡ ä»¶äº‹æƒ…,
</p>

<ol class="org-ol">
<li>å½¢å¼å‚æ•°å’Œå®é™…å‚æ•°å‘ç”Ÿç»‘å®š: <code>x=1, y=2, z=3</code>.</li>

<li>è®¡ç®— <code>(sub x y)</code>, ç»“æœä¸º <code>-1</code>.</li>

<li>è®¡ç®— <code>(add 1 3)</code>, ç»“æœä¸º <code>2</code>.</li>
</ol>

<p>
æ•´ä¸€ä¸ªè®¡ç®—è¿‡ç¨‹éœ€è¦è®°ä½å˜é‡çš„å€¼,è¿™éœ€è¦ä¸€ä¸ªå«åš <code>environment</code> çš„ä¸œè¥¿è¿›è¡Œå‚¨å­˜,å®ƒå°±æ˜¯ä¸€ä¸ªä»å˜é‡åˆ°å€¼çš„æ˜ å°„, <code>environment</code> æ˜¯æ•°æ®ä¸Šä¸‹æ–‡(data context)çš„ä¸€ä¸ªæŠ½è±¡.
</p>

<p>
é™¤äº†æ•°æ®ä¸Šä¸‹æ–‡,è¿˜æœ‰å¦å¤–ä¸€ç§ä¸Šä¸‹æ–‡,ä¸Šé¢çš„æ•´ä¸ªè®¡ç®—è¿‡ç¨‹ä¸­çš„ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥,æ¯æ¬¡æ‰§è¡Œä¸€æ­¥éƒ½éœ€è¦è®°å½•ä¸‹ä¸€æ­¥è¦ä»å“ªé‡Œå¼€å§‹,è¿™ä¸ªå°±æ˜¯æ‰€è°“çš„æ§åˆ¶ä¸Šä¸‹æ–‡.äº‹å®ä¸Šè¿˜å¯ä»¥æƒ³è±¡ä¸€ä¸‹ç”¨è°ƒè¯•å™¨çš„é€æ­¥è°ƒè¯•çš„è¿‡ç¨‹,æ¯ä¸€æ­¥éƒ½æ˜¯ä¸€ä¸ªæ‰§è¡Œç‚¹,é€æ­¥æ‰§è¡Œç›´åˆ°è®¡ç®—ç»“æŸ.
</p>

<p>
è€Œ <code>continuation</code> å°±æ˜¯æ§åˆ¶ä¸Šä¸‹æ–‡çš„ä¸€ä¸ªæŠ½è±¡,å®ƒå°±åƒ <code>stack</code> çš„å¸§(frame). <code>Environment</code> æ˜¯ä¸€ä¸ªæ˜ å°„,å®ƒçš„ <code>representation</code> æœ‰å¾ˆå¤šé€‰æ‹©:å“ˆå¸Œè¡¨,å…³è”é“¾è¡¨ç­‰ç­‰,é‚£ä¹ˆ <code>continuation</code> çš„ <code>representation</code> åˆæ˜¯ä»€ä¹ˆå‘¢?
</p>
</div>
</div>


<div id="outline-container-org0edf158" class="outline-3">
<h3 id="org0edf158">Continuation çš„ representation</h3>
<div class="outline-text-3" id="text-org0edf158">
<p>
åœ¨ç»™ <code>continuation</code> é€‰æ‹© <code>representation</code> ä¹‹å‰å…ˆç»™æ¯ä¸€ä¸ªæ‰§è¡Œç‚¹é€‰æ‹©ä¸€ç§ <code>representation</code>.æ¯ä¸€æ‰§è¡Œç‚¹ç›¸å½“äºä¸€ä¸ªè¿‡ç¨‹,æ¯æ‰§è¡Œä¸€ä¸ªç‚¹å°±æ˜¯ä¸€æ¬¡è°ƒç”¨.
</p>

<p>
æ¯”å¦‚è°ƒç”¨ <code>(ans 1 2 3)</code>, è¿™æ ·çš„è¯ <code>(sub 1 2)</code> çš„ç»“æœ <code>-1</code>,ä¸è¿‡ <code>-1</code> ä¸æ˜¯ä¸€ä¸ªè¿‡ç¨‹,åœ¨ <code>Racket</code> é‡Œé¢,ä¸€ä¸ªå‡½æ•°(procedure here, not function)å…¶å®å°±æ˜¯ä¸€ä¸ªè¿‡ç¨‹,æ‰€ä»¥è¿™ä¸€æ­¥å¯ä»¥è¿™æ ·è¡¨ç¤º,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31532;&#19968;&#27493;,&#25226;&#31532;&#19968;&#27493;&#20445;&#23384;&#22312;first-step</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">first-step</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (pre-step-res) (sub 1 2)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25191;&#34892;&#31532;&#19968;&#27493;&#30456;&#24403;&#20110;&#20197;&#19979;,void&#26159;Racket&#37324;&#38754;&#30340;&#19968;&#20010;&#20540;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">res1</span> (first-step void))
</pre>
</div>

<p>
ç¬¬äºŒæ­¥éœ€è¦ç­‰å¾…ç¬¬ä¸€æ­¥çš„è¿ç®—ç»“æœ,
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#31532;&#20108;&#27493;,&#25226;&#31532;&#20108;&#27493;&#20445;&#23384;&#22312;second-step</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">second-step</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (pre-step-res) (add pre-step-res 3)))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#25191;&#34892;&#31532;&#20108;&#27493;</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">res2</span> (second-step res1))
</pre>
</div>

<p>
æœ€åä¸€æ­¥å°±æ˜¯è¿”å›ä¸Šä¸€æ­¥çš„ç»“æœåšä¸ºæ•´ä¸ªè®¡ç®—çš„è¿”å›å€¼,
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">last-step</span> (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v) v))
</pre>
</div>

<p>
é™¤äº†ç”¨å‡½æ•°ä½œä¸º <code>representation</code> å¤–,è¿˜å¯ä»¥é€‰æ‹©æ•°æ®ç»“æ„ä½œä¸º <code>representation</code>,è¿™ä¸ªæ•°æ®ç»“æ„åŒ…å«äº†ä¸‹ä¸€æ­¥éœ€è¦çš„ä¿¡æ¯,æ¯”å¦‚ <code>environment</code>, <code>expression</code>, <code>value</code>, <code>procedure</code> å’Œ <code>continuation</code>.
</p>

<p>
å…¶ä¸­ <code>expression</code> æ˜¯ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„è¡¨è¾¾å¼, <code>environment</code> å°±æ˜¯è¯¥ <code>expression</code> æ‰§è¡Œçš„ <code>environment</code>, <code>continuation</code> å°±æ˜¯è¯¥ <code>expression</code> çš„ <code>continuation</code>,å¦‚æ­¤ç±»æ¨.
</p>

<p>
æˆ‘æƒ³ä½ åº”è¯¥å¤šå°‘èƒ½çœ‹å‡ºæ¥äº†è¿™æ˜¯ä¸€ä¸ªé€’å½’.ä¸‹é¢å¼€å§‹æ¼”ç¤ºå¦‚ä½•ç¼–å†™ <code>CPS</code> ç¨‹åº.
</p>
</div>
</div>
</div>


<div id="outline-container-orgbe7a512" class="outline-2">
<h2 id="orgbe7a512">Continuation Passing Style</h2>
<div class="outline-text-2" id="text-orgbe7a512">
</div>
<div id="outline-container-orgc2d1b95" class="outline-3">
<h3 id="orgc2d1b95">ä»€ä¹ˆæ˜¯ CPS</h3>
<div class="outline-text-3" id="text-orgc2d1b95">
<p>
é¡¾åæ€æ„, <code>CPS</code> å°±æ˜¯ä¸€ç§é£æ ¼,è¿™ç§é£æ ¼å°±æ˜¯æŠŠ <code>continuation</code> ä½œä¸ºå‚æ•°ä¼ é€’.ç±»ä¼¼çš„è¿˜æœ‰ <code>Environment Passing Style</code>.
</p>

<p>
ç”¨è¿™ä¸ªå‚æ•°è®°å½•è¿è¡Œæ—¶çš„å†…å®¹.
</p>
</div>
</div>


<div id="outline-container-org6a3be26" class="outline-3">
<h3 id="org6a3be26">CPS çš„æ„ä¹‰</h3>
<div class="outline-text-3" id="text-org6a3be26">
<p>
å…¶å®å°±æ˜¯å¯¹æ§åˆ¶ä¸Šä¸‹æ–‡(control context)è¿›è¡ŒæŠ½è±¡å’Œå®ä¾‹åŒ–ä»¥åŠæŠŠé€’å½’è½¬åŒ–æˆå°¾é€’å½’.
</p>

<p>
å¯¹æ§åˆ¶ä¸Šä¸‹æ–‡è¿›è¡ŒæŠ½è±¡å°±æ˜¯è¯´ç¨‹åºæ‰§è¡Œçš„ä¸‹ä¸€æ­¥å¯ä»¥è¢«æŠ½è±¡æˆæ•°æ®è¡¨ç¤º,å°±åƒä¸Šé¢çš„è¯´æ˜ä¾‹å­é‚£æ ·,å°±æ˜¯ä½¿ç”¨äº†å‡½æ•°æ¥è¡¨ç¤ºä¸‹ä¸€æ­¥è¦æ‰§è¡Œçš„åŠ¨ä½œ.
</p>

<p>
ç„¶åå°±æ˜¯èƒ½å¤ŸæŠŠé€’å½’å˜æˆå°¾é€’å½’,åœ¨æ”¯æŒå°¾é€’å½’ä¼˜åŒ–çš„è¯­è¨€ä¸­æ˜¯å¯ä»¥è·å¾—ä¼˜åŒ–çš„.
</p>
</div>
</div>


<div id="outline-container-org8202e5b" class="outline-3">
<h3 id="org8202e5b">æŠŠä¸Šé¢çš„ ans æ”¹å†™æˆ CPS ç¨‹åº ans/k</h3>
<div class="outline-text-3" id="text-org8202e5b">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">ans/k</span> x y z cont)
   (sub/k x y
      (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res1)
         (add/k res1 z
            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res2)
               (cont res2))))))
</pre>
</div>

<p>
è¿™æ˜¯è¿™ä¸ªä¾‹å­çš„æœ€ç»ˆç»“æœ.ç°åœ¨å¼€å§‹è¯´æ”¹å†™çš„æ€è·¯,ä¹Ÿå°±æ˜¯ä¸€å¥—æŠŠç¨‹åºè½¬æ¢ <code>CPS</code> ç¨‹åºçš„ç®—æ³•.
</p>
</div>
</div>


<div id="outline-container-org0f413e5" class="outline-3">
<h3 id="org0f413e5">Simple Expression and Tail Form Expression</h3>
<div class="outline-text-3" id="text-org0f413e5">
<p>
è¦è½¬å˜æˆ <code>CPS</code>,åˆ™è¦ç†è§£ <code>CPS</code> å¯¹è¡¨è¾¾å¼åšå‡ºçš„åˆ’åˆ†: <code>SimpleExp</code> ä»¥åŠ <code>TfExp</code> (Tail Form Expression).
</p>

<p>
<code>SimpleExp</code> åŒ…æ‹¬å¸¸é‡ä»¥åŠå˜é‡: <code>1</code>, <code>a</code>, <code>(- 2 x)</code>, <code>(lambda (v) v)</code> ä»¥åŠ <code>(zero? x)</code> ç­‰ç­‰
<code>TfExp</code> åˆ™æ˜¯ç”± <code>SimpleExp</code> ç»„åˆè€Œæˆçš„å¤æ‚è¡¨è¾¾å¼(<code>ComplexExp</code>), æœ‰: <code>(f x)</code>, <code>(if (exp1) exp2 exp3)</code> ç­‰ç­‰.
ç”±äº <code>TfExp</code> æ˜¯å¯ä»¥æ‹†åˆ†æˆå¤šä¸ª <code>SimpleExp</code> çš„,è€Œ <code>SimpleExp</code> æ˜¯ä¸å¯å†åˆ†çš„,æ‰€ä»¥ <code>SimpleExp</code> ä¹Ÿå¯ä»¥å« <code>AtomicExp</code>.
</p>

<p>
å…³ç³»å¤§è‡´å°±åƒè¿™æ ·:
</p>

<div class="org-src-container">
<pre class="src src-example">SimpleExp    ::= Constant || Variable
TfExp        ::= (SimpleExp SimpleExp*)
</pre>
</div>

<p>
è¿™æ ·å°±å¯ä»¥ä¿è¯ <code>TfExp</code> å¤„äºå‡½æ•°çš„ <code>tail position</code>, <code>tail position</code> å°±æ˜¯å‡½æ•°çš„é€€å‡ºçš„ä½ç½®,ä¹Ÿå°±æ˜¯ç»“æŸçš„åœ°æ–¹,
</p>

<p>
è¿™ä¸€æ­¥çš„ <code>continuation</code> å’Œæ•´ä¸ªå‡½æ•°çš„ <code>continuation</code> æ˜¯ä¸€æ ·çš„,ä¹Ÿå°±æ˜¯è¯´æ ˆç©ºé—´æ²¡æœ‰å‘ç”Ÿæ”¹å˜,åœ¨è¿™ç§åœ°æ–¹çš„è°ƒç”¨å°±æ˜¯å°¾è°ƒç”¨(tail call),è¿™æ ·çš„å‡½æ•°ç§°ä¸º <code>tail form</code> çš„.
</p>
</div>
</div>


<div id="outline-container-orge958f41" class="outline-3">
<h3 id="orge958f41">ä¸€å¥—æŠŠç¨‹åºè½¬åŒ–ä¸º CPS ç¨‹åºçš„ç®—æ³•</h3>
<div class="outline-text-3" id="text-orge958f41">
<p>
å…ˆç¤ºèŒƒå¦‚ä½•æŠŠ <code>ans</code> æ”¹å†™æˆ <code>CPS</code>,ä¹Ÿå°±æ˜¯æŠŠè¡¨è¾¾å¼æ”¹å†™æˆ <code>TfExp</code>.
</p>

<ol class="org-ol">
<li>æŠŠ <code>(ans x y z)</code> æ”¹å†™ <code>(ans/k x y z cont)</code>,</li>

<li>åœ¨ <code>(ans x y z)</code> æ•´ä¸ªçš„è®¡ç®—è¿‡ç¨‹é‡Œé¢, <code>(sub x y)</code> æ˜¯ç¬¬ä¸€ä¸ªè¿›è¡Œè¿ç®—çš„,åŒæ—¶å®ƒä¹Ÿæ˜¯ä¸€ä¸ª <code>non-simple expression</code>,æ‰€ä»¥å…ˆå¯¹å®ƒçš„è°ƒç”¨è¿›è¡Œæ”¹å†™, <code>(sub/k x y cont1)</code>, <code>cont1</code> å°±æ˜¯è¦æ‰§è¡Œçš„ä¸‹ä¸€æ­¥,</li>

<li>è®¡ç®—å®Œ <code>(sub x y)</code>,ä¸‹ä¸€æ­¥å°±æ˜¯è®¡ç®—æ•´ä¸ªç»“æœäº†,å‡è®¾ä¸Šä¸€æ­¥çš„ <code>(sub x y)</code> çš„ç»“æœä¸º <code>res1</code>,é‚£ä¹ˆä¸‹ä¸€æ­¥å°±æ˜¯ <code>(add res1 z)</code> çš„è®¡ç®—äº†, å®ƒåŠæ˜¯ç¬¬äºŒä¸ª <code>non-simple expression</code>, å¯¹å®ƒè¿›è¡Œæ”¹å†™ <code>(add/k res1 z cont2)</code>,</li>

<li><p>
å›åˆ° <code>cont1</code> å’Œ <code>cont2</code> ä¸Š,åœ¨ç¬¬2æ­¥ä¸Šé¢è¯´åˆ° <code>cont1</code> æ˜¯ä¸‹ä¸€æ­¥,è€Œ <code>(add res1 z)</code> åˆšå¥½ä¹Ÿæ˜¯ <code>(sub x y)</code> çš„ä¸‹ä¸€æ­¥,é‚£ä¹ˆ <code>cont1</code> å°±æ˜¯ <code>(lambda (res1) (add res1 z))</code>,ä¸è¦å¿˜è®°æŠŠ <code>(add res1 z)</code> æ”¹å†™æˆ <code>(add/k res1 z cont2)</code>;
</p>

<p>
<code>cont2</code> å°±æ˜¯ <code>(add res1 z)</code> çš„ä¸‹ä¸€æ­¥,å®ƒçš„ä¸‹ä¸€æ­¥å°±æ˜¯è¿”å›ç»“æœ,å‡è®¾ <code>(add res1 z)</code> çš„ç»“æœä¸º <code>res2</code>,é‚£ä¹ˆ <code>cont2</code> å°±æ˜¯ <code>(lambda (res2) res2)</code>?,ä¸,è¿™æ˜¯é”™çš„!æ­£ç¡®æ˜¯ <code>(lambda (res2) (cont res2))</code>,ä¸è¦å¿˜è®°äº† <code>(ans/k x y z cont)</code> é‡Œé¢çš„ <code>cont</code>,
</p>

<p>
è¿™æ˜¯æ‰æ˜¯æ•´ä¸ªè®¡ç®—è¿‡ç¨‹çš„çœŸæ­£æœ€åä¸€æ­¥,è¿™ä¸€æ­¥ä¹Ÿæ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰åš,å°±æ˜¯è¿”å›ç»“æœ,æ‰€ä»¥å®ƒåº”è¯¥æ˜¯è¿™æ ·çš„ <code>(lambda (res) res)</code>,è¿™ä¹Ÿè¢«å«åšç©ºå»¶ç»­.
</p></li>

<li><p>
æœ€åè¿˜è¦æŠŠ <code>add</code> å’Œ <code>sub</code> çš„å®šä¹‰ä¹Ÿè¦æ”¹å†™,æ³¨æ„ <code>+</code> å’Œ <code>-</code> æ˜¯ <code>primitive operators</code>,ä¸èƒ½å¯¹å®ƒä»¬çš„å®šä¹‰è¿›è¡Œä¿®æ”¹,æ‰€ä»¥å®ƒä»¬å°±ä¸ç”¨æ”¹å†™,
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">add/k</span> x y cont) (cont (+ x y)))
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">sub/k</span> x y cont) (cont (- x y)))
</pre>
</div></li>
</ol>


<p>
<code>CPS</code> çš„ç¨‹åºå®é™…ä¸Šåæ˜ äº†è¿™ç¨‹åºçš„è®¡ç®—è¿‡ç¨‹,è¿™ä¸€æ­¥åˆ°ä¸‹ä¸€æ­¥,å¦‚æ­¤ç±»æ¨,ç›´åˆ°è®¡ç®—å®Œæ¯•.
</p>


<p>
<code>EOPL</code> ä¸­æœ‰ä¸€æ®µ <code>The CPS Recipe</code> æœ‰å¯¹è¿™å¥—ç®—æ³•è¿›è¡Œæ€»ç»“,å†…å®¹å¤§æ¦‚å¦‚ä¸‹:
</p>

<ol class="org-ol">
<li>æŠŠæ¯ä¸ªå­ç¨‹åºçš„å®šä¹‰éœ€è¦å¤šä¸€ä¸ªå‚æ•°,è¿™ä¸ªå‚æ•°è¡¨ç¤ºçš„æ˜¯ <code>continuation</code>, ä¸€èˆ¬å«åš <code>cont</code> æˆ–è€… <code>k</code>;</li>
<li>å½“å­ç¨‹åºçš„è¿”å›å€¼æ˜¯å¸¸é‡æˆ–è€…å˜é‡ <code>v</code>,éƒ½è¦æ”¹æˆè¿”å› <code>continuation</code> çš„è¿”å›å€¼,ä¹Ÿå°±æ˜¯ <code>(cont v)</code> æˆ–è€… <code>(k v)</code>;</li>
<li>å½“ä¸€ä¸ªå­ç¨‹åºçš„è°ƒç”¨ <code>(proc x)</code> å‡ºç°åœ¨ <code>tail position</code>,ä¹Ÿå°±æ˜¯å­ç¨‹åºè¿”å›çš„åœ°æ–¹,é‚£ä¹ˆæ”¹æˆå°±ä½¿ç”¨åŒä¸€ä¸ª <code>cont</code> æ¥è°ƒç”¨å‡½æ•°, <code>(proc x cont)</code>;</li>
<li>å½“ä¸€ä¸ªå­ç¨‹åºçš„è°ƒç”¨ <code>(proc x)</code> å‡ºç°åœ¨ <code>operand position</code>,ä¹Ÿå°±æ˜¯å‚æ•°ä½ç½®,æ¯”å¦‚ <code>(operator (proc x))</code>, é‚£ä¹ˆå…ˆè¦åœ¨ä¸€ä¸ªæ–°çš„ <code>continuation</code> ä¸‹è¿ç®—å®Œè¿™ä¸ªè°ƒç”¨,
ç»™å®ƒçš„è¿ç®—ç»“æœä¸€ä¸ªåå­—,æ¯”å¦‚ <code>v1,v2...</code>, å¹¶ä¸”ç»§ç»­è®¡ç®—.</li>
</ol>

<p>
ä¹¦ä¸­çš„ä¾‹å­è¿˜æ˜¯å¾ˆç»å…¸çš„,æ‰€ä»¥å°±æŠ„ä¸‹æ¥äº†:
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket

(<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x)
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    [(zero? x) 17]
    [(= x 1) (f x)]
    [(= x 2) (+ 22 (f x))]
    [(= x 3) (g 22 (f x))]
    [(= x 4) (+ (f x) 33 (g y))]
    [else (h (f x) (- 44 y) (g y))]))


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">after transforming</span>

(<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x cont)
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    [(zero? x) (cont 17)]
    [(= x 1) (f x cont)]
    [(= x 2)
     (f x
        (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v)
           (+ 22 v)))]
    [(= x 3)
     (f x
        (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v)
           (g 22 v cont)))]
    [(= x 4)
     (f x
        (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v1)
           (g y
              (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v2)
                 (cont (+ v1 33 v2))))))]
    [else (f x
             (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v1)
                (g y
                   (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v2)
                      (h v1 (- 44 y) v2 cont)))))]))
</pre>
</div>

<p>
æ­£å¦‚ä¸Šé¢çš„ä»£ç æ‰€å±•ç¤ºä¸€æ ·,ä¸€æ—¦æŠŠå­ç¨‹åºè½¬åŒ–æˆ <code>CPS</code>,é‡Œé¢è°ƒç”¨çš„æ‰€æœ‰å­ç¨‹åºéƒ½è¦å¯¹åº”çš„å˜åŒ–æˆ <code>CPS</code>.
</p>
</div>
</div>


<div id="outline-container-org8676133" class="outline-3">
<h3 id="org8676133">æœ€åä¸€ä¸ªä¾‹å­</h3>
<div class="outline-text-3" id="text-org8676133">
<p>
åˆ†åˆ«å®šä¹‰ç´¯åŠ ä»1åˆ°nçš„å‡½æ•° <code>bad-acc,acc-tailå’Œacc</code>, ä»¥åŠ(Fibonacci) <code>bad-fib</code> å’Œ <code>fib</code>.
</p>

<div class="org-src-container">
<pre class="src src-scheme">#lang racket
(require racket/trace)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">bad acc</span>
(trace-define (bad-acc n)
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (= n 0)
        0
        (+ n (bad-acc (- n 1)))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">tail form</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">acc-tail</span> n)
    (acc-tail-inner n 0))

(trace-define (acc-tail-inner n res)
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (= n 0)
        res
        (acc-tail-inner (- n 1) (+ res n))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">cps</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">acc</span> n)
    (acc/k n (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (val) val)))

(trace-define (acc/k n cont)
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (= n 0)
        (cont 0)
        (acc/k (- n 1)
               (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res) (cont (+ n res))))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">BONUS: even tail form can be convert into cps</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">acc-tail-inner/k</span> n res cont)
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (= n 0)
        (cont res)
        (acc-tail-inner/k
          (- n 1) (+ res n) cont)))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">bad fib</span>
(trace-define (bad-fib n)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      1
      (+ (bad-fib (- n 2)) (bad-fib (- n 1)))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">cps</span>
(trace-define (fib/k n cont)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      (cont 1)
      (fib/k
       (- n 2)
       (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res1)
         (fib/k
          (- n 1)
          (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res2)
            (cont (+ res1 res2))))))))

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">fib</span> n)
    (fib/k n (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (val) val)))

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">tests</span>
(bad-acc 10)

(acc-tail 10)

(acc 10)

(bad-fib 7)

(fib 7)
</pre>
</div>

<p>
åˆ©ç”¨ <code>racket/trace</code> ä¸­çš„ <code>trace</code> è·Ÿè¸ªè®¡ç®—è¿‡ç¨‹,ä¼šå‘ç°åœ¨3è€…ä¸­, <code>acc-tail</code> å’Œ <code>acc</code> çš„è®¡ç®—è¡Œä¸ºå’Œè¿­ä»£æ˜¯ä¸€æ ·çš„,å¯¹äº <code>bad-acc</code>,å¯ä»¥æ˜æ˜¾è§‚å¯Ÿåˆ°æ¯ä¸€æ­¥,å¹¶ä¸”æœ‰æ˜æ˜¾çš„èµ·ä¼.
</p>

<p>
è¿™æ˜¯å› ä¸º <code>Racket</code> æ”¯æŒå°¾é€’å½’ä¼˜åŒ–,æŠŠå°¾é€’å½’ä¼˜åŒ–æˆè¿­ä»£,æ˜¾ç„¶ <code>bad-acc</code> æ²¡èƒ½ä¼˜åŒ–æˆåŠŸ.
</p>

<p>
è¿™ä¸‹é¢æ˜¯è®¡ç®—æ—¶å€™çš„è¿›å‡ºæ ˆçš„å˜åŒ–,å¯ä»¥çœ‹åˆ° <code>bad-acc</code> ä»¥åŠ <code>fib</code> çš„æ ˆæ·±æ˜¯å…ˆå¢é•¿åç¼©å°.
</p>

<p>
è€Œç»è¿‡ <code>cps</code> è½¬æ¢çš„åˆ™æ˜¯æ ˆæ·±æ²¡æœ‰å‘ç”Ÿä»»ä½•æ”¹å˜.
</p>

<div class="org-src-container">
<pre class="src src-sh">Welcome to Racket v7.5.
racket@&gt; ,enter <span style="color: #CC9393;">"/home/saltb0rn/.config/emacs/site-lisp/test.rkt"</span>
&gt;(bad-acc 10)
&gt; (bad-acc 9)
&gt; &gt;(bad-acc 8)
&gt; &gt; (bad-acc 7)
&gt; &gt; &gt;(bad-acc 6)
&gt; &gt; &gt; (bad-acc 5)
&gt; &gt; &gt; &gt;(bad-acc 4)
&gt; &gt; &gt; &gt; (bad-acc 3)
&gt; &gt; &gt; &gt; &gt;(bad-acc 2)
&gt; &gt; &gt; &gt; &gt; (bad-acc 1)
&gt; &gt; &gt; &gt;[10] (bad-acc 0)
&lt; &lt; &lt; &lt;[10] 0
&lt; &lt; &lt; &lt; &lt; 1
&lt; &lt; &lt; &lt; &lt;3
&lt; &lt; &lt; &lt; 6
&lt; &lt; &lt; &lt;10
&lt; &lt; &lt; 15
&lt; &lt; &lt;21
&lt; &lt; 28
&lt; &lt;36
&lt; 45
&lt;55
55
&gt;(acc-tail-inner 10 0)
&gt;(acc-tail-inner 9 10)
&gt;(acc-tail-inner 8 19)
&gt;(acc-tail-inner 7 27)
&gt;(acc-tail-inner 6 34)
&gt;(acc-tail-inner 5 40)
&gt;(acc-tail-inner 4 45)
&gt;(acc-tail-inner 3 49)
&gt;(acc-tail-inner 2 52)
&gt;(acc-tail-inner 1 54)
&gt;(acc-tail-inner 0 55)
&lt;55
55
&gt;(acc/k 10 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:78:13&gt;)</span>
&gt;(acc/k 9 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 8 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 7 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 6 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 5 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&gt;(acc/k 0 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:84:15&gt;)</span>
&lt;55
55
&gt;(bad-fib 7)
&gt; (bad-fib 5)
&gt; &gt;(bad-fib 3)
&gt; &gt; (bad-fib 1)
&lt; &lt; 1
&gt; &gt; (bad-fib 2)
&lt; &lt; 1
&lt; &lt;2
&gt; &gt;(bad-fib 4)
&gt; &gt; (bad-fib 2)
&lt; &lt; 1
&gt; &gt; (bad-fib 3)
&gt; &gt; &gt;(bad-fib 1)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&lt; &lt; 2
&lt; &lt;3
&lt; 5
&gt; (bad-fib 6)
&gt; &gt;(bad-fib 4)
&gt; &gt; (bad-fib 2)
&lt; &lt; 1
&gt; &gt; (bad-fib 3)
&gt; &gt; &gt;(bad-fib 1)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&lt; &lt; 2
&lt; &lt;3
&gt; &gt;(bad-fib 5)
&gt; &gt; (bad-fib 3)
&gt; &gt; &gt;(bad-fib 1)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&lt; &lt; 2
&gt; &gt; (bad-fib 4)
&gt; &gt; &gt;(bad-fib 2)
&lt; &lt; &lt;1
&gt; &gt; &gt;(bad-fib 3)
&gt; &gt; &gt; (bad-fib 1)
&lt; &lt; &lt; 1
&gt; &gt; &gt; (bad-fib 2)
&lt; &lt; &lt; 1
&lt; &lt; &lt;2
&lt; &lt; 3
&lt; &lt;5
&lt; 8
&lt;13
13
&gt;(fib/k 7 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:112:13&gt;)</span>
&gt;(fib/k 5 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 6 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 5 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 4 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 3 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&gt;(fib/k 1 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:105:7&gt;)</span>
&gt;(fib/k 2 <span style="color: #5F7F5F;">#</span><span style="color: #7F9F7F;">&lt;procedure:...te-lisp/test.rkt:108:10&gt;)</span>
&lt;13
13
racket@test.rkt&gt; 
</pre>
</div>

<p>
å’Œå‰é¢ä¸‰ä¸ªå‡½æ•°çš„è¿­ä»£è®¡ç®—è¡Œä¸ºä¸ä¸€æ ·, <code>Fibonacci</code> çš„è®¡ç®—è¡Œä¸ºæ˜¯æ ‘å½¢é€’å½’,åŒæ ·å¯ä»¥é€šè¿‡ <code>CPS</code> å¾—åˆ°ä¼˜åŒ–.
</p>

<p>
ä»”ç»†çœ‹ä½ ä¼šå‘ç° <code>acc-tail-inner/k</code> çš„ <code>cont</code> æ˜¯å¤šä½™çš„,åœ¨å®é™…å¼€å‘ä¸­å¦‚æœé‡åˆ°å°¾é€’å½’çš„è¯å¯ä»¥ç»•è·¯ä¸å†™,å› ä¸ºé‚£æ ·æ„ä¹‰ä¸å¤§,å› ä¸º <code>CPS</code> çš„å…¶ä¸­ä¸€ä¸ªç›®çš„å°±æ˜¯ä¸ºäº†ä¿è¯å°¾é€’å½’çš„å‘ç”Ÿ,å°±æ²¡å¿…è¦æ”¹æˆ <code>CPS</code> äº†.
</p>

<p>
<code>CPS</code> åªèƒ½ä¿è¯å°¾è°ƒç”¨,åƒåœ¨ <code>Python</code> å’Œ <code>Emacs Lisp</code> è¿™ç§æœ‰â€å…ˆå¤©ç¼ºé™·â€œ (ä¸æ”¯æŒå°¾é€’å½’ä¼˜åŒ– Tail Call Optimization, abbr. TCO) çš„è¯­è¨€ä¸­,å°¾é€’å½’ä¹Ÿä¸èƒ½è§£å†³çˆ†æ ˆçš„é—®é¢˜,
</p>

<p>
ä¸è¿‡æ—¢ç„¶æ”¹æˆ <code>CPS</code> äº†,é‚£å°±å¾ˆå®¹æ˜“åœ°æŠŠ <code>CPS</code> è½¬åŒ–æˆè¿­ä»£/å¾ªç¯,å¹¶ä¸” <code>Python</code> å’Œ <code>Emacs Lisp</code> è¿™äº›è¯­è¨€éƒ½æœ‰å¾ªç¯è¯­å¥.
</p>
</div>
</div>
</div>


<div id="outline-container-org6f09d0a" class="outline-2">
<h2 id="org6f09d0a">Trampoline å’Œ Bounce</h2>
<div class="outline-text-2" id="text-org6f09d0a">
<pre class="example" id="orgad19d3f">
å†™äº 2019/4/8
</pre>

<p>
<code>Python</code> å’Œ <code>Emacs Lisp</code> è¿™ç±»è¯­è¨€ä¹‹æ‰€ä»¥ä¼šå› ä¸ºé€’å½’è€Œçˆ†æ ˆ,å½’æ ¹åˆ°åº•æ˜¯å› ä¸ºè¿™äº›è¯­è¨€ä¸­å‡½æ•°ä¼šå‘ç”Ÿå¤šæ¬¡ä¸è¿”å›çš„è°ƒç”¨(å°±æ˜¯æ²¡æ¥å¾—åŠè¿”å›å°±å¼€å§‹æ–°çš„è°ƒç”¨).
</p>

<p>
è¿™ä¸ªæ—¶å€™ç›´è¯‘å™¨å°±ä¼šåœ¨æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™è®°å½•ä¸‹å‡½æ•°çš„è°ƒç”¨çŠ¶æ€å’Œå…¶ä»–ä¿¡æ¯,è¿™ä¸ªæ—¶å€™æ ˆå°±ä¼šä¸€ç›´ä¸Šæ¶¨,åœ¨ä¸åŠ ä»¥é™åˆ¶çš„æƒ…å†µä¸‹,è‹¥é€’å½’é€»è¾‘å‡ºé”™å°±ä¼šå¼•å‘å´©æºƒ.
</p>

<p>
è€Œå¦‚æœè¯­è¨€æ”¯æŒå°¾é€’å½’ä¼˜åŒ–,é‚£ä¹ˆå‡½æ•°çš„è°ƒç”¨çŠ¶æ€ä¿¡æ¯å°±ä¼šåªè¿›æ ˆä¸€æ¬¡,é€’å½’è¿‡ç¨‹ä¸­åªæ˜¯ä¿®æ”¹æ ˆä¸Šçš„çŠ¶æ€ä¿¡æ¯,å’Œè¿­ä»£ä¸€æ ·,å°±å’Œä¸Šé¢ <code>Racket</code> çš„ <code>acc</code> ä¾‹å­ä¸€æ ·.
</p>

<p>
æ—¢ç„¶å‡½æ•°è°ƒç”¨ä¼šå‹æ ˆ,é‚£ä¹ˆåœ¨å‡½æ•°è°ƒç”¨é“¾å¢é•¿çš„æ—¶å€™æ–­å¼€ä¸€ä¸‹å°±å¥½äº†,è€Œä¸”å°¾é€’å½’ä¼˜åŒ–çš„è¯­è¨€ä¸­å°¾é€’å½’å’Œè¿­ä»£æ•ˆç‡ä¸€æ ·,é‚£å°± <b>æŠŠå°¾é€’å½’æ”¹æˆè¿­ä»£</b>.
</p>

<p>
ä¸ºæ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå«åš <code>Trampoline</code> çš„ <code>continuation</code> "è°ƒåº¦å™¨" (æ¯•ç«Ÿå’Œäº‹ä»¶å¾ªç¯æŒºåƒçš„) ä»¥åŠä¸€ä¸ªå«åš <code>bounce</code> å¯¹è±¡, è¯¥å¯¹è±¡ <b>åŒ…å«ä¸Šä¸€æ­¥çš„è®¡ç®—ç»“æœå’Œä¸‹ä¸€æ­¥çš„ <code>continuation</code></b>.
</p>

<p>
æ¯”å¦‚æˆ‘ä»¬æŠŠä¸Šé¢çš„ <code>acc/k</code> æ”¹å†™æˆå¯ä»¥ä¾› <code>Trampoline</code> ä½¿ç”¨çš„å½¢å¼,ä¹Ÿå°±æ˜¯æŠŠ <code>acc/k</code> æ”¹æˆ <code>bounce</code> ç‰ˆæœ¬ <code>acc-bounce</code>.
</p>

<p>
ä¸ºäº†æ–­å¼€å‡½æ•°è°ƒç”¨é“¾,æˆ‘ä»¬éœ€è¦ <b>æŠŠ <code>acc/k</code> ä¸­æ‰€æœ‰çš„å°¾è°ƒç”¨æ¢æˆ <code>bounce</code> å€¼,ä¹Ÿå°±æ˜¯è¯´æŠŠè¿”å›å€¼éœ€è¦å˜ä¸º <code>bounce</code></b> ,è¿™æ˜¯ä½¿ç”¨ <code>Trampoline</code> æŠ€æœ¯çš„å…³é”®.
</p>

<p>
(è‡³äº <code>Fibonacci</code> çš„,è¿™é‡Œåªç»™å‡º <code>Racket</code> ç‰ˆæœ¬,ä¸€æ˜¯ä¸ºäº†ä¼˜å…ˆä¸“æ³¨äºç®€å•çš„ <code>acc-bounce</code>,äºŒæ˜¯æˆ‘æ‡’)
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">bounce &#30340;&#23450;&#20041;,</span>
(struct bounce (res cont))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#23545; acc/k &#36827;&#34892;&#20462;&#25913;,&#35201;&#28857;&#20043;&#19968;&#23601;&#26159;&#25226;&#25152;&#26377; acc/k &#30340;&#35843;&#29992;(&#20063;&#23601;&#26159;&#36820;&#22238;&#20540;)&#25442;&#25104;bounce&#20540;.</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21487;&#20197;&#36825;&#20040;&#24819;,&#36825;&#20040;&#20570;&#26159;&#25226;&#21407;&#26412;&#30340;&#35843;&#29992;&#32473;&#25286;&#24320;&#20102;.</span>
(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">acc-bounce</span> n cont)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (= n 0)
      (bounce 0 cont) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= (cont 0), &#30452;&#25509;&#25286;</span>
      (bounce n       <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= (acc-bounce (- n 1) (lambda (res) (cont (+ n res)))), &#36825;&#37324;&#25286;&#30340;&#22320;&#26041;&#26159; (cont (+ n res)),</span>
              (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (t)  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#21644; (cont 0) &#19981;&#19968;&#26679;,&#36825;&#20010;&#38656;&#35201;&#20808;&#25226; n &#30452;&#25509;&#25552;&#21040;&#22806;&#38754;&#28982;&#21518;&#24471;&#21040;&#19968;&#20010;&#26032;&#30340; continuation: (lambda (t) (acc-bounce (- t 1) (cont (+ t res)))), &#26368;&#21518;&#25286; (cont (+ t res)) &#21464;&#25104; (bounce (+ t res) cont)</span>
                (acc-bounce (- t 1)
                            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res) (bounce (+ t res) cont)))))))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30001;&#20110; Racket &#27809;&#26377;&#20160;&#20040;&#31867;&#20284;&#19982; Python while statement &#37027;&#31181;&#19996;&#35199;,&#25152;&#20197;&#25105;&#36824;&#26159;&#29992;&#20102;&#36882;&#24402;,&#22312; Python &#20013;&#21487;&#20197;&#25913;&#20889;&#25104; while</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> (<span style="color: #93E0E3;">fib-bounce</span> n cont)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      (bounce 1 cont) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= (cont 0), &#30452;&#25509;&#25286;</span>
      (bounce n       <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= &#25286;&#24320;&#31532;&#19968;&#20010;&#35843;&#29992; (fib/k (- n 2) ...)</span>
              (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (t)
                (fib-bounce
                 (- t 2)
                 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res1)
                   (bounce  <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= &#25286;&#24320;&#31532;&#20108;&#20010;&#35843;&#29992; (fib/k (-n 1) ...),&#36825;&#37324;&#20854;&#23454;&#21487;&#20197;&#19981;&#25286;,</span>
                    (- t 1) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#19981;&#36807;&#20026;&#20102;&#21644;&#25226;&#23614;&#35843;&#29992;&#25442;&#25104;bounce&#30340;&#35828;&#27861;&#20445;&#25345;&#19968;&#33268;,&#24212;&#35813;&#25286;&#24320;</span>
                    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (t1)
                      (fib-bounce
                       t1
                       (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res2)
                         (bounce (+ res1 res2) cont))))))))))) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&lt;= &#26368;&#21518;&#19968;&#27425;&#25286;&#24320;</span>

(<span style="color: #F0DFAF; font-weight: bold;">define</span> <span style="color: #93E0E3;">trampoline</span>
  [lambda (b)
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">let* &#25805;&#20316;&#31526;&#21487;&#20197;&#26242;&#26102;&#29702;&#35299;&#20026;&#20854;&#23427;&#35821;&#35328;&#20013;&#30340;&#23616;&#37096;&#23450;&#20041;</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">kont = bounce-cont(b)</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">n    = bounce-res(b)</span>
    <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">res  = kont(n)</span>
    (<span style="color: #F0DFAF; font-weight: bold;">let*</span> ([kont (bounce-cont b)]
           [n (bounce-res b)]
           [res (kont n)])
      (<span style="color: #F0DFAF; font-weight: bold;">if</span> (bounce? res)
          (trampoline res)
          res))])

(trampoline (acc-bounce 10000000 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) x))

(trampoline (fib-bounce 7 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (x) x))
</pre>
</div>

<p>
ç”±äº <code>Racket</code> æœ¬èº«å°±æ”¯æŒå°¾é€’å½’ä¼˜åŒ–,æ‰€ä»¥ä¸Šé¢çš„ä»£ç å…¶å®åªè¦èƒ½ä¿è¯å°¾é€’å½’å°±èƒ½ç”¨çš„äº†,æ ¹æœ¬ä¸éœ€è¦ç¡®ä¿ <code>bounce</code> ç‰ˆçš„ <code>acc/k</code> å»æ‰æ‰€æœ‰è°ƒç”¨.
</p>

<p>
æ¥ä¸‹æ¥,æˆ‘ä¼šæŒ‰ç…§è¿™æ®µä»£ç çš„æ€è·¯ç”¨ <code>Python</code> å’Œ <code>JavaScript</code> å®ç°ä¸€è¾¹,è¿™ä¸¤é—¨è¯­è¨€éƒ½æ˜¯ä¸æ”¯æŒå°¾é€’å½’ä¼˜åŒ–çš„.
</p>

<p>
è²Œä¼¼é»˜è®¤æœ€å¤§é€’å½’å±‚æ•°éƒ½ä¸ºä¸€åƒ(<code>Python</code> ç¡®å®š, <code>JavaScript</code> æ²¡è¯´),å¦‚æœä¸Šé¢çš„æ–¹æ³•èƒ½è¡Œé‚£ä¹ˆçªç ´äº†é™åˆ¶çš„çš„è®¡ç®—è§„æ¨¡å°±å¯ä»¥é€šè¿‡è®¡ç®—äº†.
</p>

<p>
<code>Python</code> ç‰ˆæœ¬:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Bounce</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">__init__</span><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">self</span>, res, cont<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">self</span>.res = res
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">self</span>.cont = cont


<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">trampoline</span><span style="color: #DCDCCC;">(</span>bounce<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">while</span> 1:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">res</span> = bounce.cont<span style="color: #DCDCCC;">(</span>bounce.res<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #DCDCCC; font-weight: bold;">isinstance</span><span style="color: #DCDCCC;">(</span>res, Bounce<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">bounce</span> = res
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> res


<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">acc_bounce</span><span style="color: #DCDCCC;">(</span>n, cont<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">if</span> n == 0:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> Bounce<span style="color: #DCDCCC;">(</span>n, cont<span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">else</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">kont</span><span style="color: #DCDCCC;">(</span>t<span style="color: #DCDCCC;">)</span>:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> acc_bounce<span style="color: #DCDCCC;">(</span>t-1, <span style="color: #F0DFAF; font-weight: bold;">lambda</span> res: Bounce<span style="color: #BFEBBF;">(</span>t+res, cont<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">return acc_bounce(t-1, lambda res: cont(t+res)) # &#36825;&#26679;&#20381;&#28982;&#20250;&#29190;&#26632;,&#20063;&#23601;&#26159;&#25105;&#19978;&#38754;&#35828;&#30340;&#19968;&#23450;&#35201;&#25226;&#25152;&#26377;&#35843;&#29992;&#25442;&#25104; bounce</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> Bounce<span style="color: #DCDCCC;">(</span>n, kont<span style="color: #DCDCCC;">)</span>


<span style="color: #DFAF8F;">bounce</span> = acc_bounce<span style="color: #DCDCCC;">(</span>50000, <span style="color: #F0DFAF; font-weight: bold;">lambda</span> x: x<span style="color: #DCDCCC;">)</span>  <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#25105;&#20915;&#23450;&#32473;&#20010;50000&#36816;&#31639;&#35268;&#27169;</span>
<span style="color: #F0DFAF; font-weight: bold;">print</span><span style="color: #DCDCCC;">(</span>trampoline<span style="color: #BFEBBF;">(</span>bounce<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>

<p>
æˆ‘è¿˜å‘ç°æœ‰ä¸€ä¸ªæ›´åŠ é«˜çº§çš„å®ç°æ–¹æ³•,ç›´æ¥å¯¹ <code>AST</code> å®ç°å˜æ¢: <a href="https://github.com/0x65/trampoline">https://github.com/0x65/trampoline</a>.
</p>

<p>
<code>JavaScript</code> ç‰ˆæœ¬:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">trampoline</span>(<span style="color: #DFAF8F;">bounce</span>) {
    <span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #DFAF8F;">res</span>;
    <span style="color: #F0DFAF; font-weight: bold;">while</span> (1) {
        res = bounce.cont(bounce.res);
        <span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">typeof</span>(res) == <span style="color: #CC9393;">'object'</span>)
            bounce = res;
        <span style="color: #F0DFAF; font-weight: bold;">else</span>
            <span style="color: #F0DFAF; font-weight: bold;">return</span> res;
    }
}

<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">accBounce</span>(<span style="color: #DFAF8F;">n</span>, <span style="color: #DFAF8F;">cont</span>) {
    <span style="color: #F0DFAF; font-weight: bold;">if</span> (n == 0) {
        <span style="color: #F0DFAF; font-weight: bold;">return</span> {
            res: n,
            cont: cont
        };
    } <span style="color: #F0DFAF; font-weight: bold;">else</span> {
        <span style="color: #F0DFAF; font-weight: bold;">return</span> {
            res: n,
            <span style="color: #93E0E3;">cont</span>: <span style="color: #F0DFAF; font-weight: bold;">function</span>(<span style="color: #DFAF8F;">t</span>) {
                <span style="color: #F0DFAF; font-weight: bold;">return</span> accBounce(
                    t-1,
                    res =&gt; {
                        <span style="color: #F0DFAF; font-weight: bold;">return</span> {
                            cont: cont,
                            res: t+res
                        };
                    });
            }
        };
    }
}

console.log(trampoline(accBounce(50000, x =&gt; x)));
</pre>
</div>
</div>

<div id="outline-container-orga83b352" class="outline-3">
<h3 id="orga83b352">Emacs Lisp çªç ´ Fibonacci çš„é€’å½’é™åˆ¶</h3>
<div class="outline-text-3" id="text-orga83b352">
<p>
ä¸ªäººä¹Ÿè¿˜æŒºå–œæ¬¢ <code>Emacs Lisp</code>,æ‰€ä»¥å±•ç¤ºä¸€ä¸ªåœ¨ <code>Emacs Lisp</code> ä¸‹çš„ <code>fib</code> é€æ¸æ”¹æˆ <code>fib-bounce</code> çš„è¿‡ç¨‹.
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">bounce</span>
(defstruct (bounce
            (<span style="color: #DCDCCC; font-weight: bold;">:constructor</span> nil)
            (<span style="color: #DCDCCC; font-weight: bold;">:constructor</span> bounce (res cont)))
  res cont)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">tampoline</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">tampoline</span> (b)
  (<span style="color: #F0DFAF; font-weight: bold;">let*</span> ((kont (bounce-cont b))
         (val (bounce-res b))
         (res (funcall kont val)))
    (<span style="color: #F0DFAF; font-weight: bold;">while</span> (bounce-p res)
      (<span style="color: #F0DFAF; font-weight: bold;">setq</span>
       kont (bounce-cont res)
       val (bounce-res res)
       res (funcall kont val)))
    res))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#24120;&#35268;&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">fib</span> (n)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      1
    (+ (fib (- n 2)) (fib (- n 1)))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">cps&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">fib/k</span> (n cont)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      (funcall cont 1)
    (fib/k (- n 2)
           (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res1)
             (fib/k (- n 1)
                    (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res2)
                      (funcall cont (+ res1 res2))))))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#22522;&#20110;cps&#25913;&#20889;&#30340;bounce&#29256;&#26412;</span>
(<span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">fib-bounce</span> (n cont)
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (= n 1) (= n 2))
      (bounce 1 cont)
    (bounce n
            (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (t1)
              (fib-bounce
               (- t1 2)
               (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res1)
                 (bounce
                  (- t1 1)
                  (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (t2)
                    (fib-bounce
                     t2
                     (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (res2)
                       (bounce (+ res1 res2) cont)))))))))))

(fib 1000) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#30452;&#25509;&#25253;&#38169;: Lisp nesting exceeds &#8216;</span><span style="color: #BFEBBF;">max-lisp-eval-depth</span><span style="color: #7F9F7F;">&#8217;</span>
(tampoline (fib-bounce 1000 (<span style="color: #F0DFAF; font-weight: bold;">lambda</span> (v) v))) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">&#38656;&#35201;&#24456;&#38271;&#26102;&#38388;&#26469;&#24471;&#20986;&#35745;&#31639;&#32467;&#26524;,&#20294;&#26159;&#19981;&#20250;&#35302;&#21457;&#36882;&#24402;&#38480;&#21046;&#32780;&#25253;&#38169;</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgfc4c5c0" class="outline-2">
<h2 id="orgfc4c5c0">ç»“è¯­</h2>
<div class="outline-text-2" id="text-orgfc4c5c0">
<p>
è¿˜æ˜¯è§‰å¾—è¿™ç¯‡ä¸œè¥¿æœ‰å¾ˆå¤šåœ°æ–¹æœ‰æ¬ ç¼º,ä¹Ÿè¯´æ˜äº†æˆ‘å¯¹ <code>CPS</code> çš„ç†è§£è¿˜ä¸å¤Ÿæ·±å…¥.çªç„¶è§‰å¾— <code>EOPL</code> å†™çš„å¾ˆå¥½,å› ä¸ºæˆ‘èƒ½æ˜ç™½ç»™æˆ‘ä¼ è¾¾çš„çŸ¥è¯†,åŸæ¥å†™ä¸€ç¯‡æ˜“æ‡‚çš„ç§‘æ™®æ–‡æ˜¯å¦‚æ­¤è‰°éš¾,çœŸçš„æ˜¯ä½©æœè¿™äº›è€å‰è¾ˆ.
</p>

<p>
<code>EOPL</code> è¿™æœ¬ä¹¦éƒ½å†™åˆ°äº†è¿™äº›å†…å®¹,ä¸ªäººååˆ†æ¨èå»é˜…è¯»è¿™æœ¬ä¹¦,æ€»çš„æ¥è¯´, <code>CPS</code> å¯ä»¥ä¿è¯å°¾é€’å½’å‘ç”Ÿ,è€Œ <code>Trampoline</code> å¯ä»¥ä¿è¯ä¸æ”¯æŒå°¾é€’å½’çš„è¯­è¨€è¿è¡Œå°¾é€’å½’ä¸ä¼šå‘ç”Ÿçˆ†æ ˆ,ä¹Ÿå°±æ˜¯è¯´è¿™ä¸¤é¡¹æŠ€æœ¯å¯ä»¥å®ç°å°¾é€’å½’ä¼˜åŒ–,ç”¨åœ¨ç›´è¯‘å™¨ä¸Šé¢å°±ä¸è¨€è€Œå–»äº†.
</p>

<p>
æœ€åç»™å‡ºåˆ«çš„ä¸€äº›æ–‡ç« ä½œä¸ºå‚è€ƒèµ„æ–™: <a href="http://matt.might.net/articles/cps-conversion/">http://matt.might.net/articles/cps-conversion/</a>,é¡ºä¾¿æ¨èä¸€ä¸‹ <code>Matt Might</code> çš„åšå®¢(ä¹Ÿå°±æ˜¯æ¨èæ–‡ç« çš„å‡ºå¤„),å†…å®¹éƒ½ååˆ†ä¸é”™,åŸºæœ¬éƒ½æ˜¯å’Œ <code>PLT</code> ç›¸å…³çš„,æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: saltb0rn (<a href="mailto:asche34@outlook.com">asche34@outlook.com</a>)</p>
<p class="date">Date: 2018-06-20</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.4.6)</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
